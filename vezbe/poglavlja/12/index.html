<!DOCTYPE html>
<html lang="rs">
<head>
    <title>12. Napredno kreiranje upita pomoću JPA Criteria API | Programiranje baza podataka</title>
    <meta charset="utf-8">

    <link rel="stylesheet" type="text/css" href="/resources/semantic/semantic.min.css">
    <script src="/resources/jquery/jquery-3.5.1.min.js"></script>
    <script src="/resources/semantic/semantic.min.js"></script>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <script src="https://semantic-ui.com/javascript/library/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
        $(document).ready(() => {
            $("table").addClass('ui celled table');
        });
    </script>
</head>

<body>
    <div class="ui sticky black big launch right attached fixed button" id="pageSticky">
        <i class="content icon"></i>
        <span class="text">Prikaži sadržaj</span>
    </div>

    <div class="ui sidebar vertical menu" id="sideMenu">
        <div class="item">
            <h3>Sadržaj</h3>
        </div>
        <a class="item" href="/vezbe/predgovor">Predgovor</a>
        <a class="item" href="/vezbe/poglavlja/1">1. Uvod u programiranje baza podataka</a>
        <a class="item" href="/vezbe/poglavlja/2">2. Osnovni koncepti programiranja C/SQL aplikacija</a>
        <a class="item" href="/vezbe/poglavlja/3">3. Programiranje korišćenjem kursora</a>
        <a class="item" href="/vezbe/poglavlja/4">4. Aplikacije sa dinamičkim SQL naredbama</a>
        <a class="item" href="/vezbe/poglavlja/5">5. Implementiranje transakcija</a>
        <a class="item" href="/vezbe/poglavlja/6">6. Aplikacije u višekorisničkom okruženju</a>
        <a class="item" href="/vezbe/poglavlja/7">7. Povezivanje aplikacija na više baza podataka</a>
        <a class="item" href="/vezbe/poglavlja/8">8. Osnovni koncepti programiranja Java/SQL aplikacija sa
            dinamičkim SQL naredbama (JDBC)</a>
        <a class="item" href="/vezbe/poglavlja/9">9. Napredne tehnike razvijanja Java/SQL aplikacija</a>
        <a class="item" href="/vezbe/poglavlja/10">10. Uvod u razvojno okruženje Hibernate</a>
        <a class="item" href="/vezbe/poglavlja/11">11. Napredna objektno-relaciona preslikavanja</a>
        <a class="item" href="/vezbe/poglavlja/12">12. Napredno kreiranje upita pomoću JPA Criteria API</a>
        <a class="item" href="/vezbe/poglavlja/13">13. Programiranje SQL rutina</a>
        <a class="item" href="/vezbe/poglavlja/14">14. Korisnički-definisane funkcije</a>
        <a class="item" href="/vezbe/poglavlja/15">15. Ugrađene procedure</a>
        <a class="item" href="/vezbe/poglavlja/16">16. Okidači</a>
    </div>

    <div class="ui justified container">
        <img class="ui centered small image" src="/resources/matf-srb.png">
        <header class="ui center aligned block header">
            <h1><a href="/">Programiranje baza podataka</a></h1>
        </header>

        <div class="ui divider"></div>

        <div id="pageContent">
            <h2>12. Napredno kreiranje upita pomoću JPA Criteria API</h2>


<div class="ui warning message">
    <div class="header">
        Ova stranica je pod konstrukcijom!
    </div>
    Ako pronađete grešku ili propust, molimo Vas da nam skrenete pažnju otvaranjem primedbe na <a href="https://github.com/MATF-PBP/matf-pbp.github.io"><i class="github icon"></i>zvaničnom GitHub repozitorijumu</a>.
</div>


<p>U prethodnom poglavlju smo diskutovali o korišćenju jezika HQL, specifičnog za potrebe aplikacija sa Hibernate podrškom, za izdvajanje skupova podataka iz relacione baze podataka. Videli smo da se HQL konceptualno zasniva za jeziku SQL, sa razlikom da, umesto baratanja tabelama u relacionoj bazi podataka, sve restrikcije, projekcije, spajanja itd. koriste Java klase za postavljanje ograničenja koja rezultati upita moraju da ispunjavaju.</p>

<p>Sličan koncept, ali nešto opštiji u smislu upotrebe, predstavlja JPA Criteria API. Ideja je da se umesto navođenja imena pod niskom (što je bio slučaj u HQL upitima), koriste napredniji koncepti za konstrukciju dinamičkih upita. Prednost ovog načina korišćenja jeste upravo u tome što se umesto korišćenja niski za zadavanje upita, koriste inteligentne programerske tehnike, kao što je ulančavanje metoda. Dodatno, koriste se prednosti programskog jezika Java.</p>

<h2 id="121-kratak-pregled-jpa-criteria-api">12.1 Kratak pregled JPA Criteria API</h2>

<p>Započnimo ovo poglavlje davanjem primera sa ciljem da ilustrujemo promenu u razmišljanju između konstrukcije HQL upita i korišćenja JPA Criteria API. Naredni HQL upit izdvaja sve zaposlene u kompaniji čije je ime <em>“John Smith”</em>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">hql</span> <span class="o">=</span> <span class="s">"FROM Employee e WHERE e.name = \"John Smith\""</span><span class="o">;</span>
<span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">query</span><span class="o">.</span><span class="na">Query</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">upit</span> <span class="o">=</span> 
    <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">hql</span><span class="o">,</span> <span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div>

<p>Ekvivalentan rezultat koji se dobija korišćenjem JPA Criteria API je:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaBuilder</span> <span class="n">cb</span>          <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
<span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">c</span>   <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">emp</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">emp</span><span class="o">)</span>
 <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span> <span class="s">"John Smith"</span><span class="o">));</span>
</code></pre></div></div>

<p>Očigledno, ovi pristupi se jasno razlikuju. HQL upit se konstruiše na isti način kao i SQL upit - navođenjem odgovarajuće sintakse u cilju konstrukcije niske koja sadrži sve informacije. Za razliku od toga, pristup koji se oslanja na JPA Criteria API koristi metode i refleksiju za konstrukciju uslova koje rezultati upita moraju da zadovolje. Kroz ovo poglavlje ćemo se detaljno upoznati sa ovim konceptima.</p>

<p>Radi kompletnosti, objasnimo nešto detaljnije prethodni kod. Za početak primećujemo da se kreira instanca interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> tako što se nad objektom klase <code class="language-plaintext highlighter-rouge">Session</code> poziva metod <code class="language-plaintext highlighter-rouge">getCriteriaBuilder()</code>. Instanca <code class="language-plaintext highlighter-rouge">cb</code> interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> sadrži veliki broj metoda koji se koriste za definisanje ograničenja rezultata upita. Na primer, pozivom metoda <code class="language-plaintext highlighter-rouge">createQuery</code> nad objektom <code class="language-plaintext highlighter-rouge">cb</code> kreira jedan novi objekat klase <code class="language-plaintext highlighter-rouge">CriteriaQuery</code> koji reprezentuje kostur JPA Criteria API upita. Drugi primer upotrebe klase <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> jeste u kreiranju jednakosnog ograničenja koji odgovara izrazu <code class="language-plaintext highlighter-rouge">e.name = \"John Smith\"</code> u HQL upitu, pozivom metoda <code class="language-plaintext highlighter-rouge">equal()</code>.</p>

<p>Kada imamo kostur novog upita, ostatak koda je manje-više pravolinijski. Potrebno je ustanoviti koren upita, odnosno, klasu od koje se započinje zadavanje ograničenja - u našem primeru to je klasa <code class="language-plaintext highlighter-rouge">Employee</code> - što se izvršava pozivanjem metoda <code class="language-plaintext highlighter-rouge">from()</code> nad upitom i prosleđivanjem klase koja predstavlja koren. Ovo je ekvivalentno deklarisanju alijasa <code class="language-plaintext highlighter-rouge">e</code> u HQL upitu i objekat klase <code class="language-plaintext highlighter-rouge">Root</code> predstavlja osnovu za izgradnju ostatka upita. Naredni korak jeste izvršavanje projekcije pozivom metoda <code class="language-plaintext highlighter-rouge">select()</code> nad upitom i prosleđivanjem konstruisanog korena upita. Konačno, potrebno je zadati odgovarajuće restrikcije nad upitom, što se izvodi ulančavanjem metoda <code class="language-plaintext highlighter-rouge">where()</code> nad projekcijom upita i navođenjem ograničenja restrikcije. S obzirom da se vrši restrikcija nad poljem <code class="language-plaintext highlighter-rouge">name</code> klase <code class="language-plaintext highlighter-rouge">Employee</code>, sve što je potrebno uraditi jeste pronaći to ime pozivom metoda <code class="language-plaintext highlighter-rouge">get()</code> nad korenom upita.</p>

<p>Iako smo napisali više koda u odnosu na pristup zasnovan na HQL jeziku, primetimo sledeće. Ukoliko bismo želeli da dinamički postavljamo uslove restrikcije u upitu, u pristupu koji koristi HQL jezik morali bismo da upravljamo niskama za konstruisanje upita, na primer:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">hql</span> <span class="o">=</span> <span class="s">"FROM Employee e WHERE "</span><span class="o">;</span>
<span class="k">if</span> <span class="o">(</span><span class="n">nameRestriction</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">hql</span> <span class="o">+=</span> <span class="s">"e.name = \"John Smith\""</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">salaryRestriction</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">hql</span> <span class="o">+=</span> <span class="s">"e.salary = 20000"</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">else</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">query</span><span class="o">.</span><span class="na">Query</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">upit</span> <span class="o">=</span> 
    <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">hql</span><span class="o">,</span> <span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div>

<p>Ovakav pristup za kreiranje dinamičkih upita ima veliki broj problema. Umesto toga, mnogo je prirodnije osloniti se na mogućnosti samog programskog jezika u kojem se vrši razvoj aplikacije, što nam JPA Criteria API omogućava:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaBuilder</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
<span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">emp</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="nc">String</span> <span class="n">attribute</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">restriction</span><span class="o">;</span>
<span class="k">if</span> <span class="o">(</span><span class="n">nameRestriction</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">attribute</span> <span class="o">=</span> <span class="s">"name"</span><span class="o">;</span>
    <span class="n">restriction</span> <span class="o">=</span> <span class="s">"John Smith"</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">salaryRestriction</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">attribute</span> <span class="o">=</span> <span class="s">"salary"</span><span class="o">;</span>
    <span class="n">restriction</span> <span class="o">=</span> <span class="s">"20000"</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">else</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">emp</span><span class="o">)</span>
 <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">attribute</span><span class="o">),</span> <span class="n">restriction</span><span class="o">));</span>
</code></pre></div></div>

<p>Na ovaj način ne moramo da vodimo računa da li smo ispravno konstruisali niske od kojih upit zavisi zato što se <em>način izdvajanja rezultata u poslednjoj liniji nikad ne menja</em>!</p>

<h2 id="122-konstrukcija-jpa-criteria-api-upita">12.2 Konstrukcija JPA Criteria API upita</h2>

<p>Kao što smo demonstrirali u prethodnoj sekciji, srž JPA Criteria API-ja je u interfejsu <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code>, koji se dobija pozivom metoda <code class="language-plaintext highlighter-rouge">getCriteriaBuilder()</code> nad objektom sesije. Ovaj interfejs je poprilično širok i služi u razne svrhe u okviru JPA Criteria API-ja. Cilj ovog poglavlja jeste da se upoznamo sa njim.</p>

<p>Interfejs <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> nudi tri metoda za kreiranje novog upita, u zavisnosti od željenog tipa rezultata upita:</p>
<ol>
  <li>Metod <code class="language-plaintext highlighter-rouge">createQuery(Class&lt;T&gt;)</code> prihvata klasu koja odgovara rezultatu upita.</li>
  <li>Metod <code class="language-plaintext highlighter-rouge">createQuery()</code>, bez parametara, odgovara rezultatu tipa klase <code class="language-plaintext highlighter-rouge">Object</code>.</li>
  <li>Metod <code class="language-plaintext highlighter-rouge">createTupleQuery()</code> koristi se za projekcije ili u slučaju kada <code class="language-plaintext highlighter-rouge">SELECT</code> klauza sadrži više od jednog izraza i želimo da radimo sa rezultatom u strogo tipiziranom maniru. Zapravo, taj metod predstavlja skraćenicu za poziv prvog metoda <code class="language-plaintext highlighter-rouge">createQuery(Tuple.class)</code>. Primetimo da je <code class="language-plaintext highlighter-rouge">Tuple</code> interfejs koji sadrži različite objekte ili podatke i primenuje tipiziranost nad agregatnim delovima. Može biti korišćen kada je rezultat upita više podataka, pri čemu želimo da ih kombinujemo u jedinstveni tipizirani objekat.</li>
</ol>

<p>JPA Criteria API se sastoji od velikog broja interfejsa koji rade zajedno u cilju modeliranja strukture JPA upita. Kako budemo prolazili kroz ovo poglavlje, biće korisno pratiti dijagram na narednoj slici i posmatrati odnose između interfejsa.</p>

<div class="text-center">
  <p><img src="/vezbe/poglavlja/12/Slike/criteria-interfejsi.png" alt="Interfejsi u JPA Criteria API" /></p>
</div>

<h2 id="123-osnovna-struktura">12.3 Osnovna struktura</h2>

<p>U prethodnom poglavlju smo videli da u jeziku HQL možemo koristiti narednih šest klauza za konstrukciju klasičnih <code class="language-plaintext highlighter-rouge">SELECT</code> upita: <code class="language-plaintext highlighter-rouge">SELECT</code>, <code class="language-plaintext highlighter-rouge">FROM</code>, <code class="language-plaintext highlighter-rouge">WHERE</code>, <code class="language-plaintext highlighter-rouge">ORDER BY</code>, <code class="language-plaintext highlighter-rouge">GROUP BY</code> and <code class="language-plaintext highlighter-rouge">HAVING</code>. Svaka od ovih HQL klauza ima ekvivalentan metod nad nekim od JPA Criteria API interfejsa. Naredna tabela sumira ove metode.</p>

<table>
  <thead>
    <tr>
      <th>HQL klauza</th>
      <th>Interfejs iz JPA Criteria API</th>
      <th>Metod kojim se ostvaruje</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SELECT</code></td>
      <td><code class="language-plaintext highlighter-rouge">CriteriaQuery</code></td>
      <td><code class="language-plaintext highlighter-rouge">select()</code></td>
    </tr>
    <tr>
      <td> </td>
      <td><code class="language-plaintext highlighter-rouge">Subquery</code></td>
      <td><code class="language-plaintext highlighter-rouge">select()</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">FROM</code></td>
      <td><code class="language-plaintext highlighter-rouge">AbstractQuery</code></td>
      <td><code class="language-plaintext highlighter-rouge">from()</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">WHERE</code></td>
      <td><code class="language-plaintext highlighter-rouge">AbstractQuery</code></td>
      <td><code class="language-plaintext highlighter-rouge">where()</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ORDER BY</code></td>
      <td><code class="language-plaintext highlighter-rouge">CriteriaQuery</code></td>
      <td><code class="language-plaintext highlighter-rouge">orderBy()</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">GROUP BY</code></td>
      <td><code class="language-plaintext highlighter-rouge">AbstractQuery</code></td>
      <td><code class="language-plaintext highlighter-rouge">groupBy()</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">HAVING</code></td>
      <td><code class="language-plaintext highlighter-rouge">AbstractQuery</code></td>
      <td><code class="language-plaintext highlighter-rouge">having()</code></td>
    </tr>
  </tbody>
</table>

<p>A newly created <code class="language-plaintext highlighter-rouge">CriteriaQuery</code> object is basically an empty shell. With the exception of defining the result type of the query, no additional content has yet been added to fill out the query. As with HQL queries, the developer is responsible for defining the various clauses of the query necessary to fetch the desired data from the database. Semantically speaking, there is no difference between HQL and Criteria API query definitions. Both have <code class="language-plaintext highlighter-rouge">SELECT</code>, <code class="language-plaintext highlighter-rouge">FROM</code>, <code class="language-plaintext highlighter-rouge">WHERE</code>, <code class="language-plaintext highlighter-rouge">GROUP BY</code>, <code class="language-plaintext highlighter-rouge">HAVING</code>, and <code class="language-plaintext highlighter-rouge">ORDER BY</code> clauses; only the manner of defining them is different. Before we can fill in the various clauses of the query definition, let’s first revisit two key concepts and look at the equivalent Criteria API syntax for those concepts.</p>

<h3 id="1231-koreni-upita">12.3.1 Koreni upita</h3>

<p>The first fundamental concept to revisit is the identification variable used in the <code class="language-plaintext highlighter-rouge">FROM</code> clause of HQL queries to alias declarations that cover entity, embeddable, and other abstract schema types. In HQL, the identification variable takes on a central importance, as it is the key to tying the different clauses of the query together. But with the Criteria API we represent query components with objects and therefore rarely have aliases with which to concern ourselves. Still, in order to define a <code class="language-plaintext highlighter-rouge">FROM</code> clause, we need a way to express which abstract schema types we are interested in querying against.</p>

<p>Interfejs <code class="language-plaintext highlighter-rouge">AbstractQuery</code> (roditelj interfejsa <code class="language-plaintext highlighter-rouge">CriteriaQuery</code>) nudi metod <code class="language-plaintext highlighter-rouge">from()</code> za definisanje apstraktne sheme koja formira osnovu našeg upita. Ovaj metod prihvata tip entiteta kao parametar i dodaje novi koren u upitu. Koren u upitu koresponsira identifikacionoj promenljivoj u HQL-u, koja dalje koresponsira deklaraciji ranga (tj. skupu iz kojeg se podaci izdvajaju) ili izrazu spajanja. Naredni kod ilustruje kako možemo dobiti koren upita:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">c</span>    <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">emp</span>           <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div>

<p>Metod <code class="language-plaintext highlighter-rouge">from()</code> vraća objekat interfejsa <code class="language-plaintext highlighter-rouge">Root</code> koja odgovara tipu entiteta. Interfejs <code class="language-plaintext highlighter-rouge">Root</code> je dete interfejsa <code class="language-plaintext highlighter-rouge">From</code>, koji nam nudi funkcionalnosti spajanja. Interfejs <code class="language-plaintext highlighter-rouge">From</code> je dete interfejsa <code class="language-plaintext highlighter-rouge">Path</code>, koji je dalje dete <code class="language-plaintext highlighter-rouge">Expression</code>, pa <code class="language-plaintext highlighter-rouge">Selection</code>, kojim se omogućava da se koren koristi u drugim delovima definicije upita. Uloga svih ovih interfejsa će biti detaljnije opisana u kasnijim sekcijama.</p>

<p>Pozivi metoda <code class="language-plaintext highlighter-rouge">from()</code> su aditivni. To znači da svaki poziv dodaje novi koren u upitu, što rezultuje u Dekartovom proizvodu kada je više od jednog korena definisan, ako nema daljih ograničenja u <code class="language-plaintext highlighter-rouge">WHERE</code> klauzi. Naredni primer demonstrira višekoreni upit, koji zamenjuju savremenija spajanja tradacionalnijim SQL pristupom:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="k">DISTINCT</span> <span class="n">s</span>
<span class="k">FROM</span>    <span class="n">Student</span> <span class="n">s</span><span class="p">,</span> 
        <span class="n">Ispit</span> <span class="n">i</span>
<span class="k">WHERE</span>   <span class="n">s</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">indeks</span>
</code></pre></div></div>

<p>Da bismo pretvorili ovaj upit u JPA Criteria API, potrebno je da pozovemo metod <code class="language-plaintext highlighter-rouge">from()</code> dvaput, dodajući entitete <code class="language-plaintext highlighter-rouge">Student</code> i <code class="language-plaintext highlighter-rouge">Ispit</code> kao korene upita:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">c</span>    <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>          <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Ispit</span><span class="o">&gt;</span> <span class="n">ispit</span>           <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Ispit</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">stud</span><span class="o">)</span>
 <span class="o">.</span><span class="na">distinct</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
 <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">stud</span><span class="o">,</span> <span class="n">ispit</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"indeks"</span><span class="o">)));</span>
</code></pre></div></div>

<h3 id="1232-izrazi-nad-putanjama">12.3.2 Izrazi nad putanjama</h3>

<p>The second fundamental concept to revisit is the path expression. The path expression is the key to the power and flexibility of the HQL language, and it is likewise a central piece of the Criteria API.</p>

<p>Govorili smo o korenima upita u prethodnoj podsekciji, ali svi koreni zapravo predstavljaju specijalni tip izraza putanje. Posmatrajmo naredni jednostavan HQL upit koji vraća sve studente koji su upisani na studijskom programu Informatika:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">s</span>
<span class="k">FROM</span>    <span class="n">Student</span> <span class="n">s</span>
<span class="k">WHERE</span>   <span class="n">s</span><span class="p">.</span><span class="n">studijskiProgram</span><span class="p">.</span><span class="n">naziv</span> <span class="o">=</span> <span class="s1">'Informatika'</span>
</code></pre></div></div>

<p>Razmišljajući u terminima JPA Criteria API, koren ovog izraza je entitet <code class="language-plaintext highlighter-rouge">Student</code> i neka je on predstavljen objektom <code class="language-plaintext highlighter-rouge">stud</code>. Ovaj upit takođe sadrži izraz putanje u <code class="language-plaintext highlighter-rouge">WHERE</code> klauzi. Da bismo predstavili ovaj izraz putanje korišćenjem JPA Criteria API, koristimo naredni izraz:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"studijskiProgram"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">"naziv"</span><span class="o">)</span>
</code></pre></div></div>

<p>Metod <code class="language-plaintext highlighter-rouge">get()</code> je izveden iz interfejsa <code class="language-plaintext highlighter-rouge">Path</code> proširenog interfejsom <code class="language-plaintext highlighter-rouge">Root</code> i ekvivalentan je operatoru tačke koji se koristi u HQL izrazima putanje radi navigacije kroz putanju. S obzirom da metod <code class="language-plaintext highlighter-rouge">get()</code> vraća objekat interfejsa <code class="language-plaintext highlighter-rouge">Path</code>, pozivi metoda se mogu ulančavati, što će nam biti veoma korisna tehnika pri izgradnji upita, jer time izbegavamo uvođenje privremenih lokalnih promenljivih (koji nam ne služe praktično ničemu). Argument metoda <code class="language-plaintext highlighter-rouge">get()</code> je naziv atributa entiteta za koji smo zainteresovani. Zbog toga što je rezultat konstruisanja izraza putanje objekat interfejsa <code class="language-plaintext highlighter-rouge">Expression</code> koji mi možemo da koristimo za izgradnju uslovnih izraza, možemo prethodni HQL upit izraziti na sledeći način:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">c</span>    <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>          <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">stud</span><span class="o">)</span>
 <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"studijskiProgram"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">"naziv"</span><span class="o">),</span> <span class="s">"Informatika"</span><span class="o">));</span>
</code></pre></div></div>

<p>Much like HQL, path expressions may be used throughout the different clauses of the query definition. With the Criteria API, it is necessary to hold onto the root object in a local variable and use it to form path expressions where required. Once again it is worth emphasizing that the <code class="language-plaintext highlighter-rouge">from()</code> method of <code class="language-plaintext highlighter-rouge">AbstractQuery</code> should never be invoked more than once for each desired root. Invoking it multiple times will result in additional roots being created and a <code class="language-plaintext highlighter-rouge">Cartesian</code> product if not careful. Always store the <code class="language-plaintext highlighter-rouge">root</code> objects locally and refer to them when necessary.</p>

<h2 id="124-klauza-select">12.4 Klauza <code class="language-plaintext highlighter-rouge">SELECT</code></h2>

<p>Postoji nekoliko formi koje klauza <code class="language-plaintext highlighter-rouge">SELECT</code> može da uzima u upitu. Najjednostavnija forma predstavlja izdvajanje jednog izraza, dok neke druge forme rade sa više izraza ili koriste konstruktorskih izraza radi kreiranja novih instancnih objekata. Svaka forma je na drugi način predstavljena u JPA Criteria API.</p>

<h3 id="1241-izdvajanje-jednog-izraza">12.4.1 Izdvajanje jednog izraza</h3>

<p>Metod <code class="language-plaintext highlighter-rouge">select()</code> interfejsa <code class="language-plaintext highlighter-rouge">CriteriaQuery</code> se koristi radi formiranja <code class="language-plaintext highlighter-rouge">SELECT</code> klauze u JPA Criteria API definicijama upita. Sve forme <code class="language-plaintext highlighter-rouge">SELECT</code> klauze se mogu predstaviti metodom <code class="language-plaintext highlighter-rouge">select()</code>, premda postoje bolji načini korišćenjem specijalizovanih metoda radi pojednostavljivanja kodiranja. Metod <code class="language-plaintext highlighter-rouge">select()</code> prihvata argument interfejsa <code class="language-plaintext highlighter-rouge">Selection</code>, što je zapravo roditelj interfejsa <code class="language-plaintext highlighter-rouge">Expression</code>, kao i <code class="language-plaintext highlighter-rouge">CompoundSelection</code> za slučaj kada je rezultat upita <code class="language-plaintext highlighter-rouge">Tuple</code> ili niz rezultata.</p>

<p>Do sada, mi smo prosleđivali koren upita metodu <code class="language-plaintext highlighter-rouge">select()</code>, čime smo indikovali da želimo da odgovarajući entitet bude rezultat upita. Moguće je proslediti i izraz koji predstavlja jednu vrednost, poput izdvajanja atributa iz entiteta ili bilo kog kompatibilnog skalarnog izraza. Naredni primer ilustruje ovaj pristup izdvajanjem atributa koji predstavlja ime entiteta <code class="language-plaintext highlighter-rouge">Student</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>      <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Stud</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">stud</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">&gt;</span><span class="n">get</span><span class="o">(</span><span class="s">"ime"</span><span class="o">));</span>
</code></pre></div></div>

<p>Ovakav upit će vratiti sva imena studenata, uključujući sve duplikate. O izdvajanju upita bez duplikata će biti reči kasnije.</p>

<p>Primetimo neobičnu sintaksu koju koristimo da bismo deklarisali da atribut <code class="language-plaintext highlighter-rouge">ime</code> predstavlja instancu tipa <code class="language-plaintext highlighter-rouge">String</code>. Tip izraza koji se prosleđuje metodu <code class="language-plaintext highlighter-rouge">select()</code> mora biti kompatibilan sa rezultujućim tipom koji se koristi za kreiranje <code class="language-plaintext highlighter-rouge">CriteriaQuery</code> objekta. Na primer, ako je <code class="language-plaintext highlighter-rouge">CriteriaQuery</code> objekat kreiran pozivom <code class="language-plaintext highlighter-rouge">createQuery(Ispit.class)</code> nad objektom interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code>, onda će biti greška ukoliko bismo pokušali da postavimo da se dobija izraz entiteta <code class="language-plaintext highlighter-rouge">Student</code> korišćenjem metoda <code class="language-plaintext highlighter-rouge">select()</code>. Kada poziv metoda poput <code class="language-plaintext highlighter-rouge">select()</code> koristi šablonsku tipiziranost da bi omogućio ograničenja kompatibilnosti, onda možemo prefiksovati tip imenu metoda kako bismo ga kvalifikovali u slučajevima kada tip ne može biti automatski zaključen. U ovom slučaju, moramo koristiti ovaj pristup s obzirom da je metod <code class="language-plaintext highlighter-rouge">select()</code> deklarisan kao:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">select</span><span class="o">(</span><span class="nc">Selection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">selection</span><span class="o">);</span>
</code></pre></div></div>

<p>Argument metoda <code class="language-plaintext highlighter-rouge">select()</code> mora biti tipa koji je kompatibilan rezultujućim tipom definicije upita. Metod <code class="language-plaintext highlighter-rouge">get()</code> vraća objekat <code class="language-plaintext highlighter-rouge">Path</code>, ali taj objekat je uvek tipa <code class="language-plaintext highlighter-rouge">Path&lt;Object&gt;</code> zato što kompilator ne može da zaključi odgovarajući tip samo na osnovu imena atributa. Zbog toga, da bismo deklarisali da je atribut <code class="language-plaintext highlighter-rouge">ime</code> u entitetu <code class="language-plaintext highlighter-rouge">Student</code> tipa <code class="language-plaintext highlighter-rouge">String</code>, moramo da preciziramo poziv metoda kao što smo videli.</p>

<p>This syntax has to be used whenever the <code class="language-plaintext highlighter-rouge">Path</code> is being passed as an argument for which the parameter has been strongly typed, such as the argument to the <code class="language-plaintext highlighter-rouge">select()</code> method and certain <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> expression methods. 
We have not had to use them so far in our examples because we have been using them in methods like <code class="language-plaintext highlighter-rouge">equal()</code>, where the parameter was declared to be of type <code class="language-plaintext highlighter-rouge">Expression&lt;?&gt;</code>. 
Because the type is wildcarded, it is valid to pass in an argument of type <code class="language-plaintext highlighter-rouge">Path&lt;Object&gt;</code>. 
Later in the chapter, we look at the strongly typed versions of the Criteria API methods that remove this requirement.</p>

<h3 id="1242-izdvajanje-više-izraza">12.4.2 Izdvajanje više izraza</h3>

<p>Kada definišemo <code class="language-plaintext highlighter-rouge">SELECT</code> klauzu koja sadrži izdvajanje više od jednog izraza, onda ćemo koristiti različite pristupe u zavisnosti od načina na koji je definicija upita kreirana:</p>

<ul>
  <li>
    <p>Ako je rezultujući tip <code class="language-plaintext highlighter-rouge">Tuple</code>, onda moramo metodu <code class="language-plaintext highlighter-rouge">select()</code> proslediti objekat <code class="language-plaintext highlighter-rouge">CompoundSelection&lt;Tuple&gt;</code>.</p>
  </li>
  <li>
    <p>Ako je rezultujući tip neperzistentna klasa koja će biti kreirana korišćenjem konstruktorskih izraza, tada argument mora biti objekat <code class="language-plaintext highlighter-rouge">CompoundSelection&lt;[T]&gt;</code>, gde je <code class="language-plaintext highlighter-rouge">[T]</code> tip te neperzistentne klase.</p>
  </li>
  <li>
    <p>Konačno, ako je rezultujući tip niz objekata, onda se metodu prosleđuje objekat <code class="language-plaintext highlighter-rouge">CompoundSelection&lt;Object[]&gt;</code>.</p>
  </li>
</ul>

<p>Ovi objekti se kreiraju pozivima metoda <code class="language-plaintext highlighter-rouge">tuple()</code>, <code class="language-plaintext highlighter-rouge">construct()</code> i <code class="language-plaintext highlighter-rouge">array()</code> nad objektom interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code>, redom. Neka je potrebno izdvojiti godine i oznake svih ispitnih rokova, što se izvodi narednim HQL upitom:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">ir</span><span class="p">.</span><span class="n">godina</span><span class="p">,</span>
        <span class="n">ir</span><span class="p">.</span><span class="n">oznaka</span>
<span class="k">FROM</span>    <span class="n">IspitniRok</span> <span class="n">ir</span>
</code></pre></div></div>

<p>Naredni primer demonstrira kako možemo imati višestruke izraze korišćenjem upita nad <code class="language-plaintext highlighter-rouge">Tuple</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Tuple</span><span class="o">&gt;</span> <span class="n">c</span>  <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createTupleQuery</span><span class="o">();</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">IspitniRok</span><span class="o">&gt;</span> <span class="n">ir</span>     <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">IspitniRok</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">tuple</span><span class="o">(</span><span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"godina"</span><span class="o">),</span> 
                  <span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"oznaka"</span><span class="o">)));</span>
</code></pre></div></div>

<p>Kao pogodnost, metod <code class="language-plaintext highlighter-rouge">multiselect()</code> iz interfejsa <code class="language-plaintext highlighter-rouge">CriteriaQuery</code> može se takođe koristiti za ispunjavanje istog zahteva. Metod <code class="language-plaintext highlighter-rouge">multiselect()</code> će kreirati odgovarajući tip argumenata za dati rezultujući tip upita, odnosno, zavisno od načina kreiranja upita.</p>

<p>Prva forma je za upite koje imaju <code class="language-plaintext highlighter-rouge">Object</code> ili <code class="language-plaintext highlighter-rouge">Object[]</code> kao njihov rezultujući tip. Metodu <code class="language-plaintext highlighter-rouge">multiselect()</code> se u ovom slučaju može proslediti lista izraza koje predstavljaju svaki od izraza:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">c</span>   <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">IspitniRok</span><span class="o">&gt;</span> <span class="n">ir</span>         <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">IspitniRok</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"godina"</span><span class="o">),</span> 
              <span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"oznaka"</span><span class="o">));</span>
</code></pre></div></div>

<p>Note that, if the query result type is declared as <code class="language-plaintext highlighter-rouge">Object</code> instead of <code class="language-plaintext highlighter-rouge">Object[]</code>, the behavior of <code class="language-plaintext highlighter-rouge">multiselect()</code> in this form changes slightly. The result is always an instance of <code class="language-plaintext highlighter-rouge">Object</code>, but if multiple arguments are passed into <code class="language-plaintext highlighter-rouge">multiselect()</code> then the result must be cast to <code class="language-plaintext highlighter-rouge">Object[]</code> in order to access any particular value. If only a single argument is passed into <code class="language-plaintext highlighter-rouge">multiselect()</code>, then no array is created and the result may be cast directly from <code class="language-plaintext highlighter-rouge">Object</code> to the desired type. In general, it is more convenient to be explicit about the query result type. If you want to work with an array of results, then declaring the query result type to be <code class="language-plaintext highlighter-rouge">Object[]</code> avoids casting later and makes the shape of the result more explicit if the query is invoked separately from the code that creates it.</p>

<p>Druga forma je slična prvoj formi, samo se odnosi na upite koji rezultuju tipom <code class="language-plaintext highlighter-rouge">Tuple</code>. Ponovo, metodu <code class="language-plaintext highlighter-rouge">multiselect()</code> se u ovom slučaju može proslediti lista izraza koje predstavljaju svaki od izraza:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Tuple</span><span class="o">&gt;</span> <span class="n">c</span>  <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createTupleQuery</span><span class="o">();</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">IspitniRok</span><span class="o">&gt;</span> <span class="n">ir</span>   <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">IspitniRok</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"godina"</span><span class="o">),</span> 
              <span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"oznaka"</span><span class="o">));</span>
</code></pre></div></div>

<p>Treća i konačna forma je za upite sa konstruktorskih izrazima čiji rezultat je neperzistentnog tipa. Metod <code class="language-plaintext highlighter-rouge">multiselect()</code> se ponovo poziva sa listom izraza, ali koristi tip upita da odredi i automatski kreira odgovarajući konstruktorski izraz, u ovom slučaju primarni ključ klase <code class="language-plaintext highlighter-rouge">IspitniRokId</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">IspitniRokId</span><span class="o">&gt;</span> <span class="n">c</span>   <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">IspitniRokId</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">IspitniRok</span><span class="o">&gt;</span> <span class="n">ir</span>             <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">IspitniRok</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"godina"</span><span class="o">),</span> 
              <span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"oznaka"</span><span class="o">));</span>
</code></pre></div></div>

<p>Ovo je ekvivalentno narednom kodu:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">IspitniRokId</span><span class="o">&gt;</span> <span class="n">c</span>   <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">IspitniRokId</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">IspitniRok</span><span class="o">&gt;</span> <span class="n">ir</span>             <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">IspitniRok</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">construct</span><span class="o">(</span><span class="nc">IspitniRokId</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">// Izdvoji primarni kljuc na osnovu kolona:</span>
         <span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"godina"</span><span class="o">),</span>                <span class="c1">// 1. godina</span>
         <span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"oznaka"</span><span class="o">)));</span>              <span class="c1">// 2. godina</span>
</code></pre></div></div>

<p>Međutim, iako je metod <code class="language-plaintext highlighter-rouge">multiselect()</code> izuzetno pogodan za upotrebu konstruktorskih izraza, postoje slučajevi kada je neophodno korišćenje metoda <code class="language-plaintext highlighter-rouge">construct()</code> iz interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code>. Na primer, ukoliko je potrebno da upit izračuna i naziv ispitnih rokova pored godine i oznake rokova. U tom slučaju, ispitni rokovi koji se konstruišu predstavljaju samo deo rezultata, tako da rezultujući tip upita mora biti tipa <code class="language-plaintext highlighter-rouge">Object[]</code> i onda on mora da sadrži konstruktorski izraz za konstruisanje instanci klase <code class="language-plaintext highlighter-rouge">IspitniRokId</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">c</span>   <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">IspitniRok</span><span class="o">&gt;</span> <span class="n">ir</span>         <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">IspitniRok</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"naziv"</span><span class="o">),</span> <span class="c1">// Izdvoji naziv roka</span>
              <span class="n">cb</span><span class="o">.</span><span class="na">construct</span><span class="o">(</span><span class="nc">IspitniRokId</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="c1">// Izdvoji primarni kljuc na osnovu kolona:</span>
                           <span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"godina"</span><span class="o">),</span>   <span class="c1">// 1. godina</span>
                           <span class="n">ir</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"oznaka"</span><span class="o">)));</span> <span class="c1">// 2. oznaka</span>
</code></pre></div></div>

<h3 id="1243-korišćenje-alijasa">12.4.3 Korišćenje alijasa</h3>

<p>Like HQL, aliases may also be set on expressions in the <code class="language-plaintext highlighter-rouge">SELECT</code> clause, which will then be included in the resulting SQL statement. They are of little use from a programming perspective as we construct the <code class="language-plaintext highlighter-rouge">ORDER BY</code> clause through the use of the <code class="language-plaintext highlighter-rouge">Selection</code> objects used to construct the <code class="language-plaintext highlighter-rouge">SELECT</code> clause.</p>

<p>Aliases are useful when the query has a result type of <code class="language-plaintext highlighter-rouge">Tuple</code>. The aliases will be available through the resulting <code class="language-plaintext highlighter-rouge">Tuple</code> objects. To set an alias, the <code class="language-plaintext highlighter-rouge">alias()</code> method of the <code class="language-plaintext highlighter-rouge">Selection</code> interface (parent to <code class="language-plaintext highlighter-rouge">Expression</code>) must be invoked. The following example demonstrates this approach:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Tuple</span><span class="o">&gt;</span> <span class="n">c</span>  <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createTupleQuery</span><span class="o">();</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>      <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">c</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"indeks"</span><span class="o">).</span><span class="na">alias</span><span class="o">(</span><span class="s">"indeks"</span><span class="o">),</span> 
              <span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mesto_rodjenja"</span><span class="o">).</span><span class="na">alias</span><span class="o">(</span><span class="s">"mesto"</span><span class="o">));</span>
</code></pre></div></div>

<p>This example actually demonstrates two facets of the <code class="language-plaintext highlighter-rouge">alias()</code> method. The first is that it returns itself, so it can be invoked as part of the call to <code class="language-plaintext highlighter-rouge">select()</code> or <code class="language-plaintext highlighter-rouge">multiselect()</code>. The second is, once again, that it returns itself, and is therefore mutating what should be an otherwise immutable object. The <code class="language-plaintext highlighter-rouge">alias()</code> method is an exception to the rule that only the query definition interfaces—<code class="language-plaintext highlighter-rouge">CriteriaQuery</code> and <code class="language-plaintext highlighter-rouge">Subquery</code>—contain mutating operations. Invoking <code class="language-plaintext highlighter-rouge">alias()</code> changes the original <code class="language-plaintext highlighter-rouge">Selection</code> object and returns it from the method invocation. It is invalid to set the alias of a <code class="language-plaintext highlighter-rouge">Selection</code> object more than once.</p>

<p>Using the alias when iterating over the query results is as simple as requesting the expression by name. Executing the previous query would allow it to be processed as follows:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TypedQuery</span><span class="o">&lt;</span><span class="nc">Tuple</span><span class="o">&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">Tuple</span> <span class="n">t</span> <span class="o">:</span> <span class="n">q</span><span class="o">.</span><span class="na">getResultList</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">Integer</span> <span class="n">indeks</span>  <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"indeks"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">mesto</span>    <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mesto"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="125-klauza-from">12.5 Klauza <code class="language-plaintext highlighter-rouge">FROM</code></h2>

<p>U sekciji 12.3.1, diskutovali smo o metodu <code class="language-plaintext highlighter-rouge">from()</code> iz interfejsa <code class="language-plaintext highlighter-rouge">AbstractQuery</code> kao i o ulogama korenova upita u formiranju definicije upita. Sada ćemo proširiti tu diskusiju i prikazati načine na koje se izrazi spajanja izražavaju u JPA Criteria API.</p>

<h3 id="1251-unutrašnja-i-spoljašnja-spajanja">12.5.1 Unutrašnja i spoljašnja spajanja</h3>

<p>Izrazi spajanja se kreiraju korišćenjem metoda <code class="language-plaintext highlighter-rouge">join()</code> iz interfejsa <code class="language-plaintext highlighter-rouge">From</code> koji predstavlja roditelj interfejsa <code class="language-plaintext highlighter-rouge">Root</code>, o kojem smo diskutovali ranije, kao i interfejsa <code class="language-plaintext highlighter-rouge">Join</code>, koji predstavlja tip objekata koji se vraćaju kreiranjem izraza spajanja. Ovo znači da proizvoljan koren upita može da se spaja, kao i da spajanja mogu da se ulančavaju. Metod <code class="language-plaintext highlighter-rouge">join()</code> zahteva izraz putanje kao argument i opciono, argument kojim se specifikuje tip spajanja: <code class="language-plaintext highlighter-rouge">JoinType.INNER</code> ili <code class="language-plaintext highlighter-rouge">JoinType.LEFT</code>, za unutrašnja ili spoljašnja spajanja, redom.</p>

<p>Kada se vrše spajanja unakrst kolekcijskih tipova (sa izuzetkom <code class="language-plaintext highlighter-rouge">Map</code>), spajanje će imati dva parametarska tipa: tip izvora i tip cilja. Ovim se održava sigurnost tipova sa obe strane spajanja i</p>

<p>Metod <code class="language-plaintext highlighter-rouge">join()</code> je aditivan, što znači da svaki poziv rezultuje novim spajanjem koji se kreira. Zbog toga, instanca tipa <code class="language-plaintext highlighter-rouge">Join</code> koja se vraća kao povratna vrednost metoda bi trebalo biti sačuvana kao lokalna promenljiva radi formiranja izraza putanja kasnije.</p>

<p>Naredni primer ilustruje spoljašnje spajanje od <code class="language-plaintext highlighter-rouge">Student</code> ka <code class="language-plaintext highlighter-rouge">Ispit</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>          <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">,</span><span class="nc">Ispit</span><span class="o">&gt;</span> <span class="n">ispit</span>   <span class="o">=</span> <span class="n">stud</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"indeks"</span><span class="o">,</span> <span class="nc">JoinType</span><span class="o">.</span><span class="na">LEFT</span><span class="o">);</span>
</code></pre></div></div>

<p>Da smo izostavili argument <code class="language-plaintext highlighter-rouge">JoinType.LEFT</code>, spajanje bi podrazumevano bilo unutrašnje. Poput HQL-a, višestruka spajanja se mogu asocirati za istu <code class="language-plaintext highlighter-rouge">From</code> instancu. Na primer, za navigaciju kroz <code class="language-plaintext highlighter-rouge">Ispit</code> i <code class="language-plaintext highlighter-rouge">StudijskiProgram</code>, potrebno je koristiti naredni kod, koji pretpostavlja unutrašnja spajanja:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>          <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">,</span><span class="nc">Ispit</span><span class="o">&gt;</span> <span class="n">ispit</span>   <span class="o">=</span> <span class="n">stud</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"indeks"</span><span class="o">);</span>
<span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">,</span><span class="nc">StudijskiProgram</span><span class="o">&gt;</span> <span class="n">studijskiProgram</span>     <span class="o">=</span> <span class="n">stud</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"studijskiProgram"</span><span class="o">);</span>
</code></pre></div></div>

<p>Spajanja se takođe mogu ulančavati u jednu naredbu. Rezultujuće spajanje će biti tipizirano tipom izvora i tipom cilja poslednjeg spajanja u naredbi:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Root</span><span class="o">&lt;</span><span class="nc">StudijskiProgram</span><span class="o">&gt;</span> <span class="n">studijskiProgram</span>             <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">StudijskiProgram</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">,</span><span class="nc">Ispit</span><span class="o">&gt;</span> <span class="n">ispiti</span>  <span class="o">=</span> <span class="n">studijskiProgram</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"studenti"</span><span class="o">).</span><span class="na">join</span><span class="o">(</span><span class="s">"ispiti"</span><span class="o">);</span>
</code></pre></div></div>

<p>Joins across collection relationships that use <code class="language-plaintext highlighter-rouge">Map</code> are a special case. HQL uses the <code class="language-plaintext highlighter-rouge">KEY</code> and <code class="language-plaintext highlighter-rouge">VALUE</code> keywords to extract the key or value of a <code class="language-plaintext highlighter-rouge">Map</code> element for use in other parts of the query. In the JPA Criteria API, these operators are handled by the <code class="language-plaintext highlighter-rouge">key()</code> and <code class="language-plaintext highlighter-rouge">value()</code> methods of the <code class="language-plaintext highlighter-rouge">MapJoin</code> interface. Consider the following example assuming a <code class="language-plaintext highlighter-rouge">Map</code> join across the phones relationship of the <code class="language-plaintext highlighter-rouge">Employee</code> entity:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> 
        <span class="k">KEY</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> 
        <span class="n">VALUE</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">FROM</span>    <span class="n">Employee</span> <span class="n">e</span> <span class="k">JOIN</span> 
        <span class="n">e</span><span class="p">.</span><span class="n">phones</span> <span class="n">p</span>
</code></pre></div></div>

<p>To create this query using the JPA Criteria API, we need to capture the result of the join as a <code class="language-plaintext highlighter-rouge">MapJoin</code>, in this case using the <code class="language-plaintext highlighter-rouge">joinMap()</code> method. The <code class="language-plaintext highlighter-rouge">MapJoin</code> object has three type parameters: the source type, key type, and value type. It can look a little more daunting, but makes it explicit what types are involved.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">c</span>                 <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">();</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">emp</span>                      <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">MapJoin</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">,</span><span class="nc">String</span><span class="o">,</span><span class="nc">Phone</span><span class="o">&gt;</span> <span class="n">phone</span>    <span class="o">=</span> <span class="n">emp</span><span class="o">.</span><span class="na">joinMap</span><span class="o">(</span><span class="s">"phones"</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span> 
              <span class="n">phone</span><span class="o">.</span><span class="na">key</span><span class="o">(),</span> 
              <span class="n">phone</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
</code></pre></div></div>

<p>We need to use the <code class="language-plaintext highlighter-rouge">joinMap()</code> method in this case because there is no way to overload the <code class="language-plaintext highlighter-rouge">join()</code> method to return a <code class="language-plaintext highlighter-rouge">Join</code> object or <code class="language-plaintext highlighter-rouge">MapJoin</code> object when all we are passing in is the name of the attribute. <code class="language-plaintext highlighter-rouge">Collection</code>, <code class="language-plaintext highlighter-rouge">Set</code>, and <code class="language-plaintext highlighter-rouge">List</code> relationships are likewise handled with the <code class="language-plaintext highlighter-rouge">joinCollection()</code>, <code class="language-plaintext highlighter-rouge">joinSet()</code>, and <code class="language-plaintext highlighter-rouge">joinList()</code> methods for those cases where a specific join interface must be used. The strongly typed version of
the <code class="language-plaintext highlighter-rouge">join()</code> method, which we demonstrate later, is able to handle all join types though the single <code class="language-plaintext highlighter-rouge">join()</code> call.</p>

<h2 id="126-klauza-where">12.6 Klauza <code class="language-plaintext highlighter-rouge">WHERE</code></h2>

<p>Kao što smo videli u nekim primerima, klauza <code class="language-plaintext highlighter-rouge">WHERE</code> u JPA Criteria API upitu se postavlja metodom <code class="language-plaintext highlighter-rouge">where()</code> iz interfejsa <code class="language-plaintext highlighter-rouge">AbstractQuery</code>. Metod <code class="language-plaintext highlighter-rouge">where()</code> ima dve varijante u zavisnosti od toga šta prihvata:</p>

<ul>
  <li>Nula ili više <code class="language-plaintext highlighter-rouge">Predicate</code> objekata</li>
  <li>Jedan argument tipa <code class="language-plaintext highlighter-rouge">Expression&lt;Boolean&gt;</code></li>
</ul>

<p>Svaki poziv metoda <code class="language-plaintext highlighter-rouge">where()</code> će poništiti sve druge <code class="language-plaintext highlighter-rouge">WHERE</code> klauze koje su postavljene prethodnim pozivima metoda <code class="language-plaintext highlighter-rouge">where()</code> i konstruisaće nov skup ograničenja na osnovu novoprosleđenih kriterijuma.</p>

<p>Definicija <code class="language-plaintext highlighter-rouge">WHERE</code> klauze je data u nastavku:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>where_clause ::= WHERE conditional_expression
</code></pre></div></div>

<p>Sada ćemo videti na koje načine je moguće konstruisati ograničenja koja se prosleđuju metodu <code class="language-plaintext highlighter-rouge">where()</code>.</p>

<h3 id="1261-konstrukcija-izraza">12.6.1 Konstrukcija izraza</h3>

<p>Ključ za konstruisanje izraza u okviru JPA Criteria API je interfejs <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code>. Ovaj interfejs sadrži metode za sve predikate, izraze i funkcije koje HQL podržava kao i druge karakteristike specifične za JPA Criteria API. Naredne tabele sumiraju preslikavanja između HQL operatora, izraza i funkcija u njihove ekvivalentne metode interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code>. Primetimo da u nekim slučajevima ne postoji direktna jednakost između HQL operatora i metoda, već je neophodno koristiti kombinaciju metoda iz <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> kako bismo ostvarili isti rezultat. U nekim drugim slučajevima, ekvivalentan metod za JPA Criteria API se nalazi u interfejsu koji nije <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code>.</p>

<p>HQL to CriteriaBuilder Predicate Mapping:</p>

<table>
  <thead>
    <tr>
      <th>HQL Operator</th>
      <th>CriteriaBuilder Method</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>AND</td>
      <td>and()</td>
    </tr>
    <tr>
      <td>OR</td>
      <td>or()</td>
    </tr>
    <tr>
      <td>NOT</td>
      <td>not()</td>
    </tr>
    <tr>
      <td>=</td>
      <td>equal()</td>
    </tr>
    <tr>
      <td>&lt;&gt;</td>
      <td>notEqual()</td>
    </tr>
    <tr>
      <td>&gt;</td>
      <td>greaterThan(),gt()</td>
    </tr>
    <tr>
      <td>&gt;=</td>
      <td>greaterThanOrEqualTo(),ge()</td>
    </tr>
    <tr>
      <td>&lt;</td>
      <td>lessThan(),lt()</td>
    </tr>
    <tr>
      <td>&lt;=</td>
      <td>lessThanOrEqualTo(),le()</td>
    </tr>
    <tr>
      <td>BETWEEN</td>
      <td>between()</td>
    </tr>
    <tr>
      <td>IS NULL</td>
      <td>isNull()</td>
    </tr>
    <tr>
      <td>IS NOT NULL</td>
      <td>isNotNull()</td>
    </tr>
    <tr>
      <td>EXISTS</td>
      <td>exists()</td>
    </tr>
    <tr>
      <td>NOT EXISTS</td>
      <td>not(exists())</td>
    </tr>
    <tr>
      <td>IS EMPTY</td>
      <td>isEmpty()</td>
    </tr>
    <tr>
      <td>IS NOT EMPTY</td>
      <td>isNotEmpty()</td>
    </tr>
    <tr>
      <td>MEMBER OF</td>
      <td>isMember()</td>
    </tr>
    <tr>
      <td>NOT MEMBER OF</td>
      <td>isNotMember()</td>
    </tr>
    <tr>
      <td>LIKE</td>
      <td>like()</td>
    </tr>
    <tr>
      <td>NOT LIKE</td>
      <td>notLike()</td>
    </tr>
    <tr>
      <td>IN</td>
      <td>in()</td>
    </tr>
    <tr>
      <td>NOT IN</td>
      <td>not(in())</td>
    </tr>
  </tbody>
</table>

<p>HQL to CriteriaBuilder Scalar Expression Mapping:</p>

<table>
  <thead>
    <tr>
      <th>HQL Expression</th>
      <th>CriteriaBuilder Method</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ALL</td>
      <td>all()</td>
    </tr>
    <tr>
      <td>ANY</td>
      <td>any()</td>
    </tr>
    <tr>
      <td>SOME</td>
      <td>some()</td>
    </tr>
    <tr>
      <td>-</td>
      <td>neg(),diff()</td>
    </tr>
    <tr>
      <td>+</td>
      <td>sum()</td>
    </tr>
    <tr>
      <td>*</td>
      <td>prod()</td>
    </tr>
    <tr>
      <td>/</td>
      <td>quot()</td>
    </tr>
    <tr>
      <td>COALESCE</td>
      <td>coalesce()</td>
    </tr>
    <tr>
      <td>NULLIF</td>
      <td>nullif()</td>
    </tr>
    <tr>
      <td>CASE</td>
      <td>selectCase()</td>
    </tr>
  </tbody>
</table>

<p>HQL to CriteriaBuilder Function Mapping:</p>

<table>
  <thead>
    <tr>
      <th>HQL Function</th>
      <th>CriteriaBuilder Method</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ABS</td>
      <td>abs()</td>
    </tr>
    <tr>
      <td>CONCAT</td>
      <td>concat()</td>
    </tr>
    <tr>
      <td>CURRENT_DATE</td>
      <td>currentDate()</td>
    </tr>
    <tr>
      <td>CURRENT_TIME</td>
      <td>currentTime()</td>
    </tr>
    <tr>
      <td>CURRENT_TIMESTAMP</td>
      <td>currentTimestamp()</td>
    </tr>
    <tr>
      <td>LENGTH</td>
      <td>length()</td>
    </tr>
    <tr>
      <td>LOCATE</td>
      <td>locate()</td>
    </tr>
    <tr>
      <td>LOWER</td>
      <td>lower()</td>
    </tr>
    <tr>
      <td>MOD</td>
      <td>mod()</td>
    </tr>
    <tr>
      <td>SIZE</td>
      <td>size()</td>
    </tr>
    <tr>
      <td>SQRT</td>
      <td>sqrt()</td>
    </tr>
    <tr>
      <td>SUBSTRING</td>
      <td>substring()</td>
    </tr>
    <tr>
      <td>UPPER</td>
      <td>upper()</td>
    </tr>
    <tr>
      <td>TRIM</td>
      <td>trim()</td>
    </tr>
  </tbody>
</table>

<p>HQL to CriteriaBuilder Aggregate Function Mapping:</p>

<table>
  <thead>
    <tr>
      <th>HQL Aggregate Function</th>
      <th>CriteriaBuilder Method</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>AVG</td>
      <td>avg()</td>
    </tr>
    <tr>
      <td>SUM</td>
      <td>sum(),sumAsLong(),sumAsDouble()</td>
    </tr>
    <tr>
      <td>MIN</td>
      <td>min(),least()</td>
    </tr>
    <tr>
      <td>MAX</td>
      <td>max(),greatest()</td>
    </tr>
    <tr>
      <td>COUNT</td>
      <td>count()</td>
    </tr>
    <tr>
      <td>COUNT DISTINCT</td>
      <td>countDistinct()</td>
    </tr>
  </tbody>
</table>

<p>Pored direktnog prevođenja HQL operatora, izraza i funkcija, postoje neke tehnike koje su specifične za JPA Criteria API koje je potrebno uzeti u obzir prilikom konstrukcije izraza. Sledeće sekcije detaljno razmatraju ove tehnike.</p>

<h3 id="1262-predikati">12.6.2 Predikati</h3>

<p>U narednom primeru, prosledili smo niz objekata <code class="language-plaintext highlighter-rouge">Predicate</code> metodu <code class="language-plaintext highlighter-rouge">and()</code>. Ovim se dobija ponašanje koje kombinuje sve izraze operatorom <code class="language-plaintext highlighter-rouge">AND</code>. Ekvivalentno ponašanje, samo za operatom <code class="language-plaintext highlighter-rouge">OR</code>, ostvaruje se metodom <code class="language-plaintext highlighter-rouge">or()</code>. Postoji prečica koja radi za <code class="language-plaintext highlighter-rouge">AND</code> operator, a to je da se svi izrazi proslede kao argumenti metodu <code class="language-plaintext highlighter-rouge">where()</code>. Ovaj pristup će implicitno kombinovati izraze korišćenjem semantike operatora <code class="language-plaintext highlighter-rouge">AND</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Predicate</span><span class="o">&gt;</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Predicate</span><span class="o">&gt;();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ParameterExpression</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"name"</span><span class="o">);</span>
    <span class="n">criteria</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span> <span class="n">p</span><span class="o">));</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">deptName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ParameterExpression</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"dept"</span><span class="o">);</span>
    <span class="n">criteria</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"dept"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span> <span class="n">p</span><span class="o">));</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"no criteria"</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">c</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">c</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">criteria</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">])));</span>
<span class="o">}</span>

<span class="nc">TypedQuery</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="n">q</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span> <span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">deptName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="n">q</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"dept"</span><span class="o">,</span> <span class="n">deptName</span><span class="o">);</span> <span class="o">}</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<p>The Criteria API also offers a different style of building <code class="language-plaintext highlighter-rouge">AND</code> and <code class="language-plaintext highlighter-rouge">OR</code> expressions for those who wish to build things incrementally rather than as a list. The <code class="language-plaintext highlighter-rouge">conjunction()</code> and <code class="language-plaintext highlighter-rouge">disjunction()</code> methods of the <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> interface create <code class="language-plaintext highlighter-rouge">Predicate</code> objects that always resolve to <code class="language-plaintext highlighter-rouge">true</code> and <code class="language-plaintext highlighter-rouge">false</code>, respectively. Once obtained, these primitive predicates can then be combined with other predicates to build up nested conditional expressions in a tree-like fashion. The following example rewrites the predication construction portion of the previous example using the <code class="language-plaintext highlighter-rouge">conjunction()</code> method. Note how each conditional statement is combined with its predecessor using an <code class="language-plaintext highlighter-rouge">and()</code> call.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Predicate</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">conjunction</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ParameterExpression</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span>
        <span class="n">cb</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"name"</span><span class="o">);</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">criteria</span><span class="o">,</span> <span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span> <span class="n">p</span><span class="o">));</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">deptName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ParameterExpression</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span>
        <span class="n">cb</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"dept"</span><span class="o">);</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">criteria</span><span class="o">,</span>
                      <span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"dept"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span> <span class="n">p</span><span class="o">));</span>
<span class="o">}</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<p>Što se tiče ostalih predikata, u tabelama za predikate iznad treba napomenuti da postoje dva skupa metoda koji su dostupni za relaciona poređenja. Na primer, postoje metodi <code class="language-plaintext highlighter-rouge">greaterThan()</code> i <code class="language-plaintext highlighter-rouge">gt()</code>. Metodi koji imaju naziv od dva karaktera su specifični za numeričke vrednosti i strogo su tipizirani da rade sa brojevima. Metodi koji pripadaju skupu sa dužim nazivom se mogu koristiti u svim ostalim slučajevima.</p>

<h3 id="1263-doslovne-vrednosti">12.6.3 Doslovne vrednosti</h3>

<p>Literal values may require special handling when expressed with the JPA Criteria API. In all the cases encountered so far, methods are overloaded to work with both <code class="language-plaintext highlighter-rouge">Expression</code> objects and Java literals. However, there may be some cases where only an <code class="language-plaintext highlighter-rouge">Expression</code> object is accepted (in cases where it is assumed you would never pass in a literal value or when any of a number of types would be acceptable). If you encounter this situation then, to use these expressions with Java literals, the literals must be wrapped using the <code class="language-plaintext highlighter-rouge">literal()</code> method.</p>

<p><code class="language-plaintext highlighter-rouge">NULL</code> doslovne vrednosti se kreiraju pozivom metoda <code class="language-plaintext highlighter-rouge">nullLiteral()</code>, koji prihvata tip klase kao parametar i proizvodi tipiziranu verziju vrednosti <code class="language-plaintext highlighter-rouge">NULL</code> za datu prosleđenu klasu. Ovo je neophodno radi proširivanja stroge tipiziranosti API-ja na <code class="language-plaintext highlighter-rouge">NULL</code> vrednosti.</p>

<h3 id="1264-parametri-parametarske-oznake">12.6.4 Parametri (parametarske oznake)</h3>

<p>Upravljanje parametrima u JPA Criteria API upitima se razlikuje od pristupa u HQL-u. Ako se prisetimo, u HQL-u upitima se parametri navode dvotačkom koju prati naziv parametra. U JPA Criteria API-u ovo ne funkcioniše. Umesto toga, moramo da eksplicitno kreiramo <code class="language-plaintext highlighter-rouge">ParameterExpression</code> korektnog tipa koji se može koristiti u uslovnim izrazima. Ovo se izvodi metodom <code class="language-plaintext highlighter-rouge">parameter()</code> interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code>. Ovaj metod zahteva tip klase (kako bi postavio tip objekta <code class="language-plaintext highlighter-rouge">ParameterExpression</code>) i opciono ime koje će koristiti u slučaju imenovanih parametara. Neka je potrebno izdvojiti podatke narednim upitom:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">s</span>
<span class="k">FROM</span>    <span class="n">Student</span> <span class="n">s</span>
<span class="k">WHERE</span>   <span class="n">s</span><span class="p">.</span><span class="n">studijskiProgram</span><span class="p">.</span><span class="n">naziv</span> <span class="o">=</span> <span class="p">:</span><span class="n">ns</span>
</code></pre></div></div>

<p>Naredni kod ilustruje korišćenje ovog metoda:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">c</span>    <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>          <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">stud</span><span class="o">);</span>

<span class="nc">ParameterExpression</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">nazivStudijskogPrograma</span> <span class="o">=</span>
    <span class="n">cb</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"ns"</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"studijskiProgram"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">"naziv"</span><span class="o">),</span> 
                 <span class="n">nazivStudijskogPrograma</span><span class="o">));</span>
</code></pre></div></div>

<p>Ako se parametar neće koristiti u drugim delovima upita, onda ga je moguće ugnezditi direktno u predikatskom izrazu da bismo učinili ceo upit konciznijim. Naredni kod ilustruje ovu tehniku:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">c</span>    <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>           <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">stud</span><span class="o">)</span>
 <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"studijskiProgram"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">"naziv"</span><span class="o">),</span>
                 <span class="n">cb</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"ns"</span><span class="o">)));</span>
</code></pre></div></div>

<p>Da bismo izvršili ovaj upit, očigledno, neophodno je da postavimo vrednost datog parametra. U prvom pristupu, možemo koristiti preopterećenje koje prihvata <code class="language-plaintext highlighter-rouge">ParameterExpression</code> objekat:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TypedQuery</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="n">nazivStudijskogPrograma</span><span class="o">,</span> <span class="s">"Informatika"</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</code></pre></div></div>

<p>U drugom pristupu, možemo koristiti preopterećenje koje prihvata <code class="language-plaintext highlighter-rouge">String</code> koji sadrži naziv imenovanog parametra:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TypedQuery</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"ns"</span><span class="o">,</span> <span class="s">"Informatika"</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</code></pre></div></div>

<h3 id="1265-podupiti">12.6.5 Podupiti</h3>

<p>The <code class="language-plaintext highlighter-rouge">AbstractQuery</code> interface provides the <code class="language-plaintext highlighter-rouge">subquery()</code> method for creation of subqueries. Subqueries may be correlated (meaning that they reference a root, path, or join from the parent query) or non-correlated. The JPA Criteria API supports both correlated and non-correlated subqueries, again using query roots to tie the various clauses and expressions together. The argument to <code class="language-plaintext highlighter-rouge">subquery()</code> is a class instance representing the result type of the subquery. The return value is an instance of <code class="language-plaintext highlighter-rouge">Subquery</code>, which is itself an extension of <code class="language-plaintext highlighter-rouge">AbstractQuery</code>. With the exception of restricted methods for constructing  clauses, the <code class="language-plaintext highlighter-rouge">Subquery</code> instance is a complete query definition like <code class="language-plaintext highlighter-rouge">CriteriaQuery</code> that may be used to create both simple and complex queries.</p>

<p>To demonstrate subquery usage, let’s look at a more significant example which uses subqueries to eliminate duplicates. The <code class="language-plaintext highlighter-rouge">Employee</code> entity has relationships with four other entities: single-valued relationships with <code class="language-plaintext highlighter-rouge">Department</code> and <code class="language-plaintext highlighter-rouge">Address</code>, and collection-valued relationships with <code class="language-plaintext highlighter-rouge">Phone</code> and <code class="language-plaintext highlighter-rouge">Project</code>. Whenever we join across a collection-valued relationship, we have the potential to return duplicate rows; therefore, we need to change the criteria expression for <code class="language-plaintext highlighter-rouge">Project</code> to use a subquery. The following code fragment shows the required code:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaBuilder</span> <span class="n">cb</span>          <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
<span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">c</span>   <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">emp</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">emp</span><span class="o">);</span>

<span class="c1">// ...</span>

<span class="k">if</span> <span class="o">(</span><span class="n">projectName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Subquery</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">sq</span>           <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">subquery</span><span class="o">(</span><span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">project</span>           <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Project</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">,</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">sqEmp</span>    <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"employees"</span><span class="o">);</span>

    <span class="n">sq</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">sqEmp</span><span class="o">)</span>
      <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span>
                      <span class="n">cb</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"project"</span><span class="o">)));</span>
    <span class="n">criteria</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">emp</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="n">sq</span><span class="o">));</span>
<span class="o">}</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<p>We introduced a new non-correlated subquery against <code class="language-plaintext highlighter-rouge">Project</code>. Because the subquery declares its own root and does not reference anything from the parent query, it runs independently and is therefore non-correlated. The equivalent HQL query with only <code class="language-plaintext highlighter-rouge">Project</code> criteria would be:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">e</span>
<span class="k">FROM</span>    <span class="n">Employee</span> <span class="n">e</span>
<span class="k">WHERE</span>   <span class="n">e</span> <span class="k">IN</span> <span class="p">(</span>
            <span class="k">SELECT</span>  <span class="n">emp</span>
            <span class="k">FROM</span>    <span class="n">Project</span> <span class="n">p</span> <span class="k">JOIN</span> 
                    <span class="n">p</span><span class="p">.</span><span class="n">employees</span> <span class="n">emp</span>
            <span class="k">WHERE</span>   <span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">project</span>
        <span class="p">)</span>
</code></pre></div></div>

<p>Whenever we write queries that use subqueries, there is often more than one way to achieve a particular result. For example, we could rewrite the previous example to use <code class="language-plaintext highlighter-rouge">EXISTS</code> instead of <code class="language-plaintext highlighter-rouge">IN</code> and shift the conditional expression into the <code class="language-plaintext highlighter-rouge">WHERE</code> clause of the subquery:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">projectName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Subquery</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">sq</span>            <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">subquery</span><span class="o">(</span><span class="nc">Project</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">project</span>           <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Project</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">,</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">sqEmp</span>    <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"employees"</span><span class="o">);</span>

    <span class="n">sq</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">project</span><span class="o">)</span>
      <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">sqEmp</span><span class="o">,</span> <span class="n">emp</span><span class="o">),</span>
             <span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span>
                      <span class="n">cb</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="s">"project"</span><span class="o">)));</span>
    <span class="n">criteria</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">sq</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>By referencing the <code class="language-plaintext highlighter-rouge">Employee</code> root from the parent query in the <code class="language-plaintext highlighter-rouge">WHERE</code> clause of the subquery, we now have a correlated subquery. This time the query takes the following form in HQL:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">e</span>
<span class="k">FROM</span>    <span class="n">Employee</span> <span class="n">e</span>
<span class="k">WHERE</span>   <span class="k">EXISTS</span> <span class="p">(</span>
            <span class="k">SELECT</span>  <span class="n">p</span>
            <span class="k">FROM</span>    <span class="n">Project</span> <span class="n">p</span> <span class="k">JOIN</span> 
                    <span class="n">p</span><span class="p">.</span><span class="n">employees</span> <span class="n">emp</span>
            <span class="k">WHERE</span>   <span class="n">emp</span> <span class="o">=</span> <span class="n">e</span> <span class="k">AND</span> 
                    <span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name</span>
        <span class="p">)</span>
</code></pre></div></div>

<p>We can still take this example further and reduce the search space for the subquery by moving the reference to the <code class="language-plaintext highlighter-rouge">Employee</code> root to the <code class="language-plaintext highlighter-rouge">FROM</code> clause of the subquery and joining directly to the list of projects specific to that employee. In HQL, we would write this as follows:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">e</span>
<span class="k">FROM</span>    <span class="n">Employee</span> <span class="n">e</span>
<span class="k">WHERE</span>   <span class="k">EXISTS</span> <span class="p">(</span>
            <span class="k">SELECT</span>  <span class="n">p</span>
            <span class="k">FROM</span>    <span class="n">e</span><span class="p">.</span><span class="n">projects</span> <span class="n">p</span>
            <span class="k">WHERE</span>   <span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name</span>
        <span class="p">)</span>
</code></pre></div></div>

<p>In order to re-create this query using the JPA Criteria API, we are confronted with a dilemma. We need to base the query on the <code class="language-plaintext highlighter-rouge">Root</code> object from the parent query but the <code class="language-plaintext highlighter-rouge">from()</code> method only accepts a persistent class type. The solution is the <code class="language-plaintext highlighter-rouge">correlate()</code> method from the <code class="language-plaintext highlighter-rouge">Subquery</code> interface. It performs a similar function to the <code class="language-plaintext highlighter-rouge">from()</code> method of the <code class="language-plaintext highlighter-rouge">AbstractQuery</code> interface, but does so with <code class="language-plaintext highlighter-rouge">Root</code> and <code class="language-plaintext highlighter-rouge">Join</code> objects from the parent query. The following example demonstrates how to use <code class="language-plaintext highlighter-rouge">correlate()</code> in this case:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">projectName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Subquery</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">sq</span>            <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">subquery</span><span class="o">(</span><span class="nc">Project</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">sqEmp</span>            <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="na">correlate</span><span class="o">(</span><span class="n">emp</span><span class="o">);</span>
    <span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">,</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">project</span>  <span class="o">=</span> <span class="n">sqEmp</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"projects"</span><span class="o">);</span>

    <span class="n">sq</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">project</span><span class="o">)</span>
      <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span>
             <span class="n">cb</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="s">"project"</span><span class="o">)));</span>
    <span class="n">criteria</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">sq</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Before we leave subqueries in the JPA Criteria API, there is one more corner case with correlated subqueries to explore: referencing a join expression from the parent query in the <code class="language-plaintext highlighter-rouge">FROM</code> clause of a subquery. Consider the following example that returns projects containing managers with direct reports earning an average salary higher than a userdefined threshold:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">p</span>
<span class="k">FROM</span>    <span class="n">Project</span> <span class="n">p</span> <span class="k">JOIN</span> 
        <span class="n">p</span><span class="p">.</span><span class="n">employees</span> <span class="n">e</span>
<span class="k">WHERE</span>   <span class="k">TYPE</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">DesignProject</span> <span class="k">AND</span>
        <span class="n">e</span><span class="p">.</span><span class="n">directs</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="n">EMPTY</span> <span class="k">AND</span>
        <span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">salary</span><span class="p">)</span>
         <span class="k">FROM</span>   <span class="n">e</span><span class="p">.</span><span class="n">directs</span> <span class="n">d</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">:</span><span class="n">value</span>
</code></pre></div></div>

<p>When creating the Criteria API query definition for this query, we must correlate the employees attribute of <code class="language-plaintext highlighter-rouge">Project</code> and then join it to the direct reports in order to calculate the average salary. This example also demonstrates the use of the <code class="language-plaintext highlighter-rouge">type()</code> method of the <code class="language-plaintext highlighter-rouge">Path</code> interface in order to do a polymorphic comparison of types:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">c</span>        <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Project</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">project</span>           <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Project</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">,</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">emp</span>      <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"employees"</span><span class="o">);</span>
<span class="nc">Subquery</span><span class="o">&lt;</span><span class="nc">Number</span><span class="o">&gt;</span> <span class="n">sq</span>             <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">subquery</span><span class="o">(</span><span class="nc">Number</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">,</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">sqEmp</span>    <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="na">correlate</span><span class="o">(</span><span class="n">emp</span><span class="o">);</span>
<span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">,</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">directs</span> <span class="o">=</span> <span class="n">sqEmp</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"directs"</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">project</span><span class="o">)</span>
  <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">type</span><span class="o">(),</span> <span class="nc">DesignProject</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
         <span class="n">cb</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">emp</span><span class="o">.&lt;</span><span class="nc">Collection</span><span class="o">&gt;</span><span class="n">get</span><span class="o">(</span><span class="s">"directs"</span><span class="o">)),</span>
         <span class="n">cb</span><span class="o">.</span><span class="na">ge</span><span class="o">(</span><span class="n">sq</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">avg</span><span class="o">(</span><span class="n">directs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"salary"</span><span class="o">))),</span>
               <span class="n">cb</span><span class="o">.</span><span class="na">parameter</span><span class="o">(</span><span class="nc">Number</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"value"</span><span class="o">)));</span>
</code></pre></div></div>

<h3 id="1266-izraz-in">12.6.6 Izraz <code class="language-plaintext highlighter-rouge">IN</code></h3>

<p>Za razliku od drugih operatora, operator <code class="language-plaintext highlighter-rouge">IN</code> zahteva specijalno upravljanje u JPA Criteria API. Metod <code class="language-plaintext highlighter-rouge">in()</code> interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> prihvata samo jedan argument-jednovrednosni izraz koji će biti testiran nad skupom vrednosti u <code class="language-plaintext highlighter-rouge">IN</code> izrazu. Da bismo postavili skup vrednosti, potrebno je da koristimo <code class="language-plaintext highlighter-rouge">CriteriaBuilder.In</code> objekat koji se dobija kao povratna vrednost metoda <code class="language-plaintext highlighter-rouge">in()</code>. Posmatrajmo naredni HQL upit:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">s</span>
<span class="k">FROM</span>    <span class="n">Student</span> <span class="n">s</span>
<span class="k">WHERE</span>   <span class="n">s</span><span class="p">.</span><span class="n">studijskiProgram</span><span class="p">.</span><span class="n">naziv</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'Informatika'</span><span class="p">,</span> <span class="s1">'Matematika'</span><span class="p">,</span> <span class="s1">'Astronomija'</span><span class="p">)</span>
</code></pre></div></div>

<p>Da bismo pretvorili ovaj upit u JPA Criteria API upit, potrebno je da pozovemo metod <code class="language-plaintext highlighter-rouge">value()</code> iz interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder.In</code> da bismo postavili skup vrednosti za nazive studijskih programa za koje smo zainteresovani, kao u narednom kodu:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">c</span>   <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>         <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">stud</span><span class="o">)</span>
 <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"studijskiProgram"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">"naziv"</span><span class="o">))</span>
          <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="s">"Informatika"</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">"Matematika"</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">"Astronomija"</span><span class="o">));</span>
</code></pre></div></div>

<p>Primetimo ulančane pozive metoda <code class="language-plaintext highlighter-rouge">value()</code> kako bismo postavili skup vrednosti za <code class="language-plaintext highlighter-rouge">IN</code> izraz. Argument metoda <code class="language-plaintext highlighter-rouge">in()</code> je izraz koji će biti upoređen sa vrednostima iz skupa vrednosti koje su postavljene metodom <code class="language-plaintext highlighter-rouge">value()</code>.</p>

<p>Specijalno, u slučajevima kada postoji veliki broj poziva <code class="language-plaintext highlighter-rouge">value()</code> metoda od kojih su sve vrednosti istog tipa, interfejsa <code class="language-plaintext highlighter-rouge">Expression</code> omogućava prečicu za kreiranje <code class="language-plaintext highlighter-rouge">IN</code> izraza. Metod <code class="language-plaintext highlighter-rouge">in()</code> iz ovog interfejsa dozvoljava jednu ili više vrednosti da budu postavljene jednim pozivom, što naredni kod ilustruje:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">c</span>   <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>         <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">stud</span><span class="o">)</span>
 <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"studijskiProgram"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">"naziv"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="s">"Informatika"</span><span class="o">,</span> <span class="s">"Matematika"</span><span class="o">,</span> <span class="s">"Astronomija"</span><span class="o">));</span>
</code></pre></div></div>

<p>U ovom pristupu, poziv metoda <code class="language-plaintext highlighter-rouge">in()</code> predstavlja ulančani sufiks nad izrazom umesto prefiksni, kao što je to bilo u prethodnom primeru. Primetimo razliku u tipovima argumenata između dve verzije metoda <code class="language-plaintext highlighter-rouge">in()</code> iz interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> i <code class="language-plaintext highlighter-rouge">Expression</code>. Verzija iz interfejsa <code class="language-plaintext highlighter-rouge">Expression</code> prihvata skup vrednosti, a ne izraz koji će biti upoređen. Sa druge strane, verzija iz interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> dozvoljava više tipizirani pristup. Odabir između ova dva pristupa je uglavnom stvar preference ili konvencije koju kompanija koristi.</p>

<p><code class="language-plaintext highlighter-rouge">IN</code> expressions that use subqueries are written using a similar approach. For a more complex example, in the previous chapter, we demonstrated a HQL query using an <code class="language-plaintext highlighter-rouge">IN</code> expression in which the department of an employee is tested against a list generated from a subquery. The example is reproduced here.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">e</span>
<span class="k">FROM</span>    <span class="n">Employee</span> <span class="n">e</span>
<span class="k">WHERE</span>   <span class="n">e</span><span class="p">.</span><span class="n">department</span> <span class="k">IN</span> <span class="p">(</span>
            <span class="k">SELECT</span>  <span class="k">DISTINCT</span> <span class="n">d</span>
            <span class="k">FROM</span>    <span class="n">Department</span> <span class="n">d</span> <span class="k">JOIN</span> 
                    <span class="n">d</span><span class="p">.</span><span class="n">employees</span> <span class="n">de</span> <span class="k">JOIN</span> 
                    <span class="n">de</span><span class="p">.</span><span class="n">project</span> <span class="n">p</span>
            <span class="k">WHERE</span>   <span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="k">LIKE</span> <span class="s1">'QA%'</span>
        <span class="p">)</span>
</code></pre></div></div>

<p>We can convert this example to the JPA Criteria API, as shown in the following code:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">c</span>       <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;</span> <span class="n">emp</span>              <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Subquery</span><span class="o">&lt;</span><span class="nc">Department</span><span class="o">&gt;</span> <span class="n">sq</span>         <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">subquery</span><span class="o">(</span><span class="nc">Department</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Department</span><span class="o">&gt;</span> <span class="n">dept</span>           <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Department</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">,</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">project</span>  <span class="o">=</span> <span class="n">dept</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"employees"</span><span class="o">).</span><span class="na">join</span><span class="o">(</span><span class="s">"projects"</span><span class="o">);</span>

<span class="n">sq</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">dept</span><span class="o">.&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span><span class="n">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">distinct</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
  <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">project</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">&gt;</span><span class="n">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span> 
                 <span class="s">"QA%"</span><span class="o">));</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">emp</span><span class="o">)</span>
 <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"dept"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">))</span>
          <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="n">sq</span><span class="o">));</span>
</code></pre></div></div>

<p>The subquery is created separately and then passed into the <code class="language-plaintext highlighter-rouge">value()</code> method as the expression to search for the <code class="language-plaintext highlighter-rouge">Department</code> entity. This example also demonstrates using an attribute expression as a value in the search list.</p>

<h3 id="1267-izraz-case">12.6.7 Izraz <code class="language-plaintext highlighter-rouge">CASE</code></h3>

<p>Like the <code class="language-plaintext highlighter-rouge">IN</code> expression, building <code class="language-plaintext highlighter-rouge">CASE</code> expressions with the Criteria API requires the use of a helper interface. We begin with the general form of the <code class="language-plaintext highlighter-rouge">CASE</code> expression, the most powerful but also the most complex.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="k">CASE</span> 
            <span class="k">WHEN</span> <span class="k">TYPE</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">DesignProject</span> <span class="k">THEN</span> <span class="s1">'Development'</span>
            <span class="k">WHEN</span> <span class="k">TYPE</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">QualityProject</span> <span class="k">THEN</span> <span class="s1">'QA'</span>
            <span class="k">ELSE</span> <span class="s1">'Non-Development'</span>
        <span class="k">END</span>
<span class="k">FROM</span>    <span class="n">Project</span> <span class="n">p</span>
<span class="k">WHERE</span>   <span class="n">p</span><span class="p">.</span><span class="n">employees</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="n">EMPTY</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">selectCase()</code> method of the <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> interface is used to create the <code class="language-plaintext highlighter-rouge">CASE</code> expression. For the general form, it takes no arguments and returns a <code class="language-plaintext highlighter-rouge">CriteriaBuilder.Case</code> object that we may use to add the conditional expressions to the <code class="language-plaintext highlighter-rouge">CASE</code> statement. The following example demonstrates this approach:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">c</span>   <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">project</span>       <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Project</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span>
              <span class="n">cb</span><span class="o">.</span><span class="na">selectCase</span><span class="o">()</span>
                <span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">type</span><span class="o">(),</span> <span class="nc">DesignProject</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                      <span class="s">"Development"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">type</span><span class="o">(),</span> <span class="nc">QualityProject</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                      <span class="s">"QA"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">otherwise</span><span class="o">(</span><span class="s">"Non-Development"</span><span class="o">))</span>
 <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">project</span><span class="o">.&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;&gt;</span><span class="n">get</span><span class="o">(</span><span class="s">"employees"</span><span class="o">)));</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">when()</code> and <code class="language-plaintext highlighter-rouge">otherwise()</code> methods correspond to the <code class="language-plaintext highlighter-rouge">WHEN</code> and <code class="language-plaintext highlighter-rouge">ELSE</code> keywords from HQL. Unfortunately, <code class="language-plaintext highlighter-rouge">else</code> is already a keyword in Java, so <code class="language-plaintext highlighter-rouge">otherwise</code> must be used as a substitute.</p>

<p>The next example simplifies the previous example down to the simple form of the <code class="language-plaintext highlighter-rouge">CASE</code> statement.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="k">CASE</span> <span class="k">TYPE</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">WHEN</span> <span class="n">DesignProject</span> <span class="k">THEN</span> <span class="s1">'Development'</span>
            <span class="k">WHEN</span> <span class="n">QualityProject</span> <span class="k">THEN</span> <span class="s1">'QA'</span>
            <span class="k">ELSE</span> <span class="s1">'Non-Development'</span>
        <span class="k">END</span>
<span class="k">FROM</span>    <span class="n">Project</span> <span class="n">p</span>
<span class="k">WHERE</span>   <span class="n">p</span><span class="p">.</span><span class="n">employees</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="n">EMPTY</span>
</code></pre></div></div>

<p>In this case, we pass the primary expression to be tested to the <code class="language-plaintext highlighter-rouge">selectCase()</code> method and use the <code class="language-plaintext highlighter-rouge">when()</code> and <code class="language-plaintext highlighter-rouge">otherwise()</code> methods of the <code class="language-plaintext highlighter-rouge">CriteriaBuilder.SimpleCase</code> interface. Rather than a predicate or boolean expression, these methods now accept single-valued expressions that are compared to the base expression of the <code class="language-plaintext highlighter-rouge">CASE</code> statement:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">c</span>   <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">project</span>       <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Project</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span>
              <span class="n">cb</span><span class="o">.</span><span class="na">selectCase</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">type</span><span class="o">())</span>
                <span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="nc">DesignProject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"Development"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="nc">QualityProject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"QA"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">otherwise</span><span class="o">(</span><span class="s">"Non-Development"</span><span class="o">))</span>
 <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">project</span><span class="o">.&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Employee</span><span class="o">&gt;&gt;(</span><span class="s">"employees"</span><span class="o">)));</span>
</code></pre></div></div>

<h3 id="1268-izraz-coalesce">12.6.8 Izraz <code class="language-plaintext highlighter-rouge">COALESCE</code></h3>

<p>The next example we cover in this subsection concerns the HQL <code class="language-plaintext highlighter-rouge">COALESCE</code> expression:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">COALESCE</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">FROM</span>    <span class="n">Department</span> <span class="n">d</span>
</code></pre></div></div>

<p>Building a <code class="language-plaintext highlighter-rouge">COALESCE</code> expression with the JPA Criteria API requires a helper interface like the other examples we have looked at in this section, but it is closer in form to the <code class="language-plaintext highlighter-rouge">IN</code> expression than to the <code class="language-plaintext highlighter-rouge">CASE</code> expressions. Here we invoke the <code class="language-plaintext highlighter-rouge">coalesce()</code> method without arguments to get back a <code class="language-plaintext highlighter-rouge">CriteriaBuilder.Coalesce</code> object that we then use the <code class="language-plaintext highlighter-rouge">value()</code> method of to add values to the <code class="language-plaintext highlighter-rouge">COALESCE</code> expression. The following example demonstrates this approach:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">c</span>     <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">();</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Department</span><span class="o">&gt;</span> <span class="n">dept</span>       <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Department</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">coalesce</span><span class="o">()</span>
           <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="n">dept</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">))</span>
           <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="n">dept</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">)));</span>
</code></pre></div></div>

<p>Convenience versions of the <code class="language-plaintext highlighter-rouge">coalesce()</code> method also exist for the case where only two expressions are being compared.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">c</span>     <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">();</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Department</span><span class="o">&gt;</span> <span class="n">dept</span>       <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Department</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">coalesce</span><span class="o">(</span><span class="n">dept</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span>
                     <span class="n">dept</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">)));</span>
</code></pre></div></div>

<p>A final note about case expressions is that they are another exception to the rule that the <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> methods are non-mutating. Each <code class="language-plaintext highlighter-rouge">when()</code> method causes another conditional expression to be added incrementally to the case expression, and each <code class="language-plaintext highlighter-rouge">value()</code> method adds an additional value to the coalesce list.</p>

<h3 id="1269-izrazi-sa-funkcijama">12.6.9 Izrazi sa funkcijama</h3>

<p>Not to be confused with the built-in functions of HQL, criteria function expressions are the JPA Criteria API equivalent of the <code class="language-plaintext highlighter-rouge">FUNCTION</code> keyword in HQL. They allow native SQL stored functions to be mixed with other JPA Criteria API expressions. They are intended for cases where a limited amount of native SQL is required to satisfy some requirement but you don’t want to convert the entire query to SQL.</p>

<p>Function expressions are created with the <code class="language-plaintext highlighter-rouge">function()</code> method of the <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code> interface. It requires as arguments the database function name, the expected return type, and a variable list of arguments, if any, that should be passed to the function. The return type is an <code class="language-plaintext highlighter-rouge">Expression</code>, so it can be used in many other places within the query. The following example invokes a database function to capitalize the first letter of each word in a department name:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">c</span>     <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Department</span><span class="o">&gt;</span> <span class="n">dept</span>       <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Department</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">function</span><span class="o">(</span><span class="s">"initcap"</span><span class="o">,</span> 
                     <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> 
                     <span class="n">dept</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">)));</span>
</code></pre></div></div>

<p>As always, developers interested in maximizing the portability of their applications should be careful in using function expressions. Unlike native SQL queries, which are clearly marked, function expressions are a small part of what otherwise looks like a normal portable JPA query that is actually tied to database-specific behavior.</p>

<h3 id="12610-klauza-order-by">12.6.10 Klauza <code class="language-plaintext highlighter-rouge">ORDER BY</code></h3>

<p>Metod <code class="language-plaintext highlighter-rouge">orderBy()</code> interfejsa <code class="language-plaintext highlighter-rouge">CriteriaQuery</code> postavlja uređenje u definiciji upita. Ovaj metoda prihvata jedan ili više <code class="language-plaintext highlighter-rouge">Order</code> objekata, koji se kreiraju pozivom metoda <code class="language-plaintext highlighter-rouge">asc()</code> ili <code class="language-plaintext highlighter-rouge">desc()</code> interfejsa <code class="language-plaintext highlighter-rouge">CriteriaBuilder</code>, za kreiranje rastućih ili opadajućih uređenja, redom. Naredni primer ilustruje metod <code class="language-plaintext highlighter-rouge">orderBy()</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Tuple</span><span class="o">&gt;</span> <span class="n">c</span>  <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Tuple</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>      <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">,</span><span class="nc">StudijskiProgram</span><span class="o">&gt;</span> <span class="n">studijskiProgram</span> <span class="o">=</span> <span class="n">stud</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"studijskiProgram"</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">studijskiProgram</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"naziv"</span><span class="o">),</span> 
              <span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"ime"</span><span class="o">),</span>
              <span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"prezime"</span><span class="o">));</span>
<span class="n">c</span><span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">desc</span><span class="o">(</span><span class="n">studijskiProgram</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"naziv"</span><span class="o">)),</span>
          <span class="n">cb</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"prezime"</span><span class="o">)));</span>
</code></pre></div></div>

<p>Argumenti metoda <code class="language-plaintext highlighter-rouge">asc()</code> i <code class="language-plaintext highlighter-rouge">desc()</code> moraju biti jednovrednosni izrazi, tipično formirani na osnovu atributa entiteta. Redosled u kojem se argumenti prosleđuju metodu <code class="language-plaintext highlighter-rouge">orderBy()</code> definišu generisani SQL. Ekvivalentan HQL upit za prethodni primer je:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>      <span class="n">sp</span><span class="p">.</span><span class="n">naziv</span>
            <span class="n">s</span><span class="p">.</span><span class="n">ime</span><span class="p">,</span>
            <span class="n">s</span><span class="p">.</span><span class="n">prezime</span>
<span class="k">FROM</span>        <span class="n">Student</span> <span class="n">s</span> <span class="k">JOIN</span> 
            <span class="n">s</span><span class="p">.</span><span class="n">studijskiProgram</span> <span class="n">sp</span>
<span class="k">ORDER</span> <span class="k">BY</span>    <span class="n">sp</span><span class="p">.</span><span class="n">naziv</span> <span class="k">DESC</span><span class="p">,</span> 
            <span class="n">s</span><span class="p">.</span><span class="n">prezime</span>
</code></pre></div></div>

<h3 id="12611-klauze-group-by-i-having">12.6.11 Klauze <code class="language-plaintext highlighter-rouge">GROUP BY</code> i <code class="language-plaintext highlighter-rouge">HAVING</code></h3>

<p>Metodu <code class="language-plaintext highlighter-rouge">groupBy()</code> i <code class="language-plaintext highlighter-rouge">having()</code> interfejsa <code class="language-plaintext highlighter-rouge">AbstractQuery</code> predstavlja JPA Criteria API ekvivalente klauzama <code class="language-plaintext highlighter-rouge">GROUP BY</code> i <code class="language-plaintext highlighter-rouge">HAVING</code> u HQL-u, redom. Oba metoda prihvataju jedan ili više izraza koji se koriste za grupisanje i filtriranje podataka.</p>

<p>Pogledajmo kako je <code class="language-plaintext highlighter-rouge">GROUP BY</code> klauza definisana:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>groupby_clause  ::= GROUP BY groupby_item {, groupby_item}*
groupby_item    ::= single_valued_path_expression | identification_variable
</code></pre></div></div>

<p>Pogledajmo kako je <code class="language-plaintext highlighter-rouge">HAVING</code> klauza definisana:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>having_clause   ::= HAVING conditional_expression
</code></pre></div></div>

<p>Do ovog trenutka u poglavlju, trebalo bi da čitaocu bude intuitivan način korišćenja ovih metoda. Pogledajmo naredni HQL upit:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>      <span class="n">s</span><span class="p">.</span><span class="n">indeks</span><span class="p">,</span> 
            <span class="k">COUNT</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="k">FROM</span>        <span class="n">Student</span> <span class="n">s</span> <span class="k">JOIN</span> 
            <span class="n">s</span><span class="p">.</span><span class="n">ispiti</span> <span class="n">i</span>
<span class="k">GROUP</span> <span class="k">BY</span>    <span class="n">s</span><span class="p">.</span><span class="n">indeks</span>
<span class="k">HAVING</span>      <span class="k">COUNT</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">BETWEEN</span> <span class="mi">20</span> <span class="k">AND</span> <span class="mi">30</span>
</code></pre></div></div>

<p>Da bismo rekreirali ovaj primer u JPA Criteria API, potrebno je da koristimo i agregatne funkcije i metode za grupisanje. Naredni primer demonstrira ovu konverziju:</p>

<!-- 
select      student0_.indeks as col_0_0_, 
            count(ispiti1_.id_predmeta) as col_1_0_ 
from        dosije student0_ inner join 
            ispit ispiti1_ on student0_.indeks=ispiti1_.indeks 
group by    student0_.indeks 
having      count(ispiti1_.id_predmeta) between 20 and 30 
-->

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Tuple</span><span class="o">&gt;</span> <span class="n">c</span>      <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createTupleQuery</span><span class="o">();</span>
<span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">stud</span>          <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">,</span><span class="nc">Ispit</span><span class="o">&gt;</span> <span class="n">ispit</span>   <span class="o">=</span> <span class="n">stud</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"ispiti"</span><span class="o">);</span>

<span class="n">c</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">stud</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"indeks"</span><span class="o">),</span> <span class="n">cb</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">ispit</span><span class="o">))</span>
 <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="n">stud</span><span class="o">)</span>
 <span class="o">.</span><span class="na">having</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">ispit</span><span class="o">),</span> 
                    <span class="n">cb</span><span class="o">.</span><span class="na">literal</span><span class="o">(</span><span class="k">new</span> <span class="nc">Long</span><span class="o">(</span><span class="mi">20</span><span class="o">)),</span> 
                    <span class="n">cb</span><span class="o">.</span><span class="na">literal</span><span class="o">(</span><span class="k">new</span> <span class="nc">Long</span><span class="o">(</span><span class="mi">30</span><span class="o">))));</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 12.1</strong>: Napisati Java aplikaciju koja korišćenjem biblioteke Hibernate i JPA Criteria API-ja izdvaja podatke o studentima bez duplikata čija imena ili prezimena počinju slovom <code class="language-plaintext highlighter-rouge">P</code> i koji su rođeni u Beogradu ili Kragujevcu. Rezultat urediti po mestu rođenja opadajuće, pa po imenu i prezimenu rastuće. Ispisati mesto stanovanja, indeks, ime i prezime za date studente.</p>
</div>

<p>Rešenje: Dajemo dva rešenja. Prvo od njih koristi pristup sa metodom <code class="language-plaintext highlighter-rouge">select()</code> u kojem se izdvajaju objekti klase <code class="language-plaintext highlighter-rouge">Student</code>. Drugo od njih koristi pristup sa metodom <code class="language-plaintext highlighter-rouge">multiselect()</code> da izdvoji samo informacije od značaja.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_12/src/zadatak_12_1/Main.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_12_1</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaQuery</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Order</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Predicate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Root</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.hibernate.Session</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hibernate.Transaction</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Pocetak rada\n"</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--------------------------------"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Izdvajanje podataka na 1. nacin:"</span><span class="o">);</span>
        <span class="n">readStudentiInfo</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--------------------------------"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Izdvajanje podataka na 2. nacin:"</span><span class="o">);</span>
        <span class="n">readStudentiInfoMultiselect</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Zavrsetak rada\n"</span><span class="o">);</span>
        <span class="nc">HibernateUtil</span><span class="o">.</span><span class="na">getSessionFactory</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">readStudentiInfo</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="nc">HibernateUtil</span><span class="o">.</span><span class="na">getSessionFactory</span><span class="o">().</span><span class="na">openSession</span><span class="o">();</span>
        <span class="nc">Transaction</span> <span class="no">TR</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        
        <span class="k">try</span> <span class="o">{</span>
            <span class="no">TR</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

            <span class="nc">CriteriaBuilder</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>

            <span class="c1">// Izdvojiti podatke o studentima</span>
            <span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">st</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">criteria</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">st</span><span class="o">);</span>
            <span class="c1">// Bez duplikata</span>
            <span class="n">criteria</span><span class="o">.</span><span class="na">distinct</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="c1">// Cije ime ili prezime pocinju na slovo 'P'</span>
            <span class="nc">Predicate</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"ime"</span><span class="o">),</span> <span class="s">"P%"</span><span class="o">),</span> 
                                 <span class="n">cb</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"prezime"</span><span class="o">),</span> <span class="s">"P%"</span><span class="o">));</span>
            <span class="c1">// Zive u Beogradu ili Kragujevcu</span>
            <span class="nc">Predicate</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">isNotNull</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mesto"</span><span class="o">));</span>
            <span class="nc">Predicate</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mesto"</span><span class="o">)).</span><span class="na">value</span><span class="o">(</span><span class="s">"Beograd"</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">"Kragujevac"</span><span class="o">);</span>
            <span class="n">criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="o">,</span> <span class="n">p3</span><span class="o">));</span>
            <span class="c1">// Rezultat urediti po mestu rodjenja opadajuce</span>
            <span class="nc">Order</span> <span class="n">o1</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">desc</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mesto"</span><span class="o">));</span>
            <span class="c1">// pa po imenu i prezimenu rastuce</span>
            <span class="nc">Order</span> <span class="n">o2</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"ime"</span><span class="o">));</span>
            <span class="nc">Order</span> <span class="n">o3</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"prezime"</span><span class="o">));</span>
            <span class="n">criteria</span><span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">o1</span><span class="o">,</span> <span class="n">o2</span><span class="o">,</span> <span class="n">o3</span><span class="o">);</span>

            <span class="c1">// Dobijanje podataka o studentima koji zadovoljavaju kriterijume</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">studenti</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">criteria</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Student</span> <span class="n">s</span> <span class="o">:</span> <span class="n">studenti</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
                        <span class="n">s</span><span class="o">.</span><span class="na">getMesto</span><span class="o">().</span><span class="na">trim</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span>
                        <span class="n">s</span><span class="o">.</span><span class="na">getIndeks</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> 
                        <span class="n">s</span><span class="o">.</span><span class="na">getIme</span><span class="o">().</span><span class="na">trim</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> 
                        <span class="n">s</span><span class="o">.</span><span class="na">getPrezime</span><span class="o">().</span><span class="na">trim</span><span class="o">()</span>
                <span class="o">);</span>
            <span class="o">}</span>

            <span class="no">TR</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Postoji problem sa ispisivanjem informacija o studentima! Ponistavanje transakcije!"</span><span class="o">);</span>
        
            <span class="k">if</span> <span class="o">(</span><span class="no">TR</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="no">TR</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">readStudentiInfoMultiselect</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="nc">HibernateUtil</span><span class="o">.</span><span class="na">getSessionFactory</span><span class="o">().</span><span class="na">openSession</span><span class="o">();</span>
        <span class="nc">Transaction</span> <span class="no">TR</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        
        <span class="k">try</span> <span class="o">{</span>
            <span class="no">TR</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

            <span class="nc">CriteriaBuilder</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>

            <span class="c1">// Za svakog studenta</span>
            <span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>
            <span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="n">st</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="c1">// Izdvojiti informacije o mestu rodjenja, imenu, prezimenu i indeksu</span>
            <span class="n">criteria</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mesto"</span><span class="o">),</span> <span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"ime"</span><span class="o">),</span> <span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"prezime"</span><span class="o">),</span> <span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"indeks"</span><span class="o">));</span>
            <span class="n">criteria</span><span class="o">.</span><span class="na">distinct</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            
            <span class="c1">// Cije ime ili prezime pocinju na slovo 'P'</span>
            <span class="nc">Predicate</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"ime"</span><span class="o">),</span> <span class="s">"P%"</span><span class="o">),</span> 
                                 <span class="n">cb</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"prezime"</span><span class="o">),</span> <span class="s">"P%"</span><span class="o">));</span>
            <span class="c1">// Zive u Beogradu ili Kragujevcu</span>
            <span class="nc">Predicate</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">isNotNull</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mesto"</span><span class="o">));</span>
            <span class="nc">Predicate</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mesto"</span><span class="o">)).</span><span class="na">value</span><span class="o">(</span><span class="s">"Beograd"</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">"Kragujevac"</span><span class="o">);</span>
            <span class="n">criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="o">,</span> <span class="n">p3</span><span class="o">));</span>
            <span class="c1">// Rezultat urediti po mestu rodjenja opadajuce</span>
            <span class="nc">Order</span> <span class="n">o1</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">desc</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"mesto"</span><span class="o">));</span>
            <span class="c1">// pa po imenu i prezimenu rastuce</span>
            <span class="nc">Order</span> <span class="n">o2</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"ime"</span><span class="o">));</span>
            <span class="nc">Order</span> <span class="n">o3</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"prezime"</span><span class="o">));</span>
            <span class="n">criteria</span><span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">o1</span><span class="o">,</span> <span class="n">o2</span><span class="o">,</span> <span class="n">o3</span><span class="o">);</span>

            <span class="c1">// Dobijanje podataka o studentima koji zadovoljavaju kriterijume</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">studenti</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">criteria</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">info</span> <span class="o">:</span> <span class="n">studenti</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
                        <span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">info</span><span class="o">[</span><span class="mi">0</span><span class="o">]).</span><span class="na">trim</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span>
                        <span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">info</span><span class="o">[</span><span class="mi">1</span><span class="o">]).</span><span class="na">trim</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span>
                        <span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">info</span><span class="o">[</span><span class="mi">2</span><span class="o">]).</span><span class="na">trim</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span>
                        <span class="o">((</span><span class="nc">Integer</span><span class="o">)</span><span class="n">info</span><span class="o">[</span><span class="mi">3</span><span class="o">])</span>
                <span class="o">);</span>
            <span class="o">}</span>

            <span class="no">TR</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Postoji problem sa ispisivanjem informacija o studentima! Ponistavanje transakcije!"</span><span class="o">);</span>
        
            <span class="k">if</span> <span class="o">(</span><span class="no">TR</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="no">TR</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 12.2</strong>: Napisati Java aplikaciju koja korišćenjem biblioteke Hibernate i JPA Criteria API-ja izdvaja nazive svih položenih predmeta za studenta čiji se indeks učitava sa standardnog ulaza. Ispisati prvo ime i prezime studenta, pa zatim spisak njegovih položenih ispita.</p>
</div>

<p>Rešenje: Dodajemo implementaciju u vidu klase <code class="language-plaintext highlighter-rouge">Predmet</code> za tabelu <code class="language-plaintext highlighter-rouge">PREDMET</code> kako bismo mogli da pristupimo nazivu predmeta. Potrebno je dopuniti i klasu <code class="language-plaintext highlighter-rouge">Ispit</code> radi ostvarivanja veze između ove dve klase. Konačno, dodajemo klasu <code class="language-plaintext highlighter-rouge">Predmet</code> u listu anotiranih klasa.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_12/src/zadatak_12_2/Predmet.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_12_2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.*</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span> <span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"DA.PREDMET"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Predmet</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">id</span><span class="o">;</span>
    
    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">naziv</span><span class="o">;</span>
    
    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span><span class="o">=</span><span class="s">"predmet"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Ispit</span><span class="o">&gt;</span> <span class="n">ispiti</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Ispit</span><span class="o">&gt;();</span>
    
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getNaziv</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">naziv</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNaziv</span><span class="o">(</span><span class="nc">String</span> <span class="n">naziv</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">naziv</span> <span class="o">=</span> <span class="n">naziv</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Ispit</span><span class="o">&gt;</span> <span class="nf">getIspiti</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ispiti</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setIspiti</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Ispit</span><span class="o">&gt;</span> <span class="n">ispiti</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ispiti</span> <span class="o">=</span> <span class="n">ispiti</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>
<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_12/src/zadatak_12_2/Ispit.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_12_2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.JoinColumn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.JoinColumns</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.ManyToOne</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.MapsId</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Table</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"DA.ISPIT"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Ispit</span> <span class="o">{</span>
    <span class="c1">// Primarni kljuc</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">IspitId</span> <span class="n">idIspita</span><span class="o">;</span>

    <span class="c1">// Ostale kolone</span>

    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">ocena</span><span class="o">;</span>

    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">status</span><span class="o">;</span>
    
    <span class="nd">@ManyToOne</span>
    <span class="nd">@MapsId</span><span class="o">(</span><span class="s">"indeks"</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"INDEKS"</span><span class="o">,</span> <span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"INDEKS"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Student</span> <span class="n">student</span><span class="o">;</span>

    <span class="nd">@MapsId</span><span class="o">(</span><span class="s">"idRoka"</span><span class="o">)</span>
    <span class="nd">@JoinColumns</span><span class="o">({</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"skgodina"</span><span class="o">,</span> <span class="n">referencedColumnName</span> <span class="o">=</span> <span class="s">"skgodina"</span><span class="o">),</span>
            <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"oznakaroka"</span><span class="o">,</span> <span class="n">referencedColumnName</span> <span class="o">=</span> <span class="s">"oznakaroka"</span><span class="o">)</span> <span class="o">})</span>
    <span class="nd">@ManyToOne</span>
    <span class="kd">private</span> <span class="nc">IspitniRok</span> <span class="n">ispitniRok</span><span class="o">;</span>
    
    <span class="nd">@ManyToOne</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"idPredmeta"</span><span class="o">,</span><span class="n">referencedColumnName</span><span class="o">=</span><span class="s">"id"</span><span class="o">,</span> <span class="n">insertable</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">updatable</span><span class="o">=</span><span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Predmet</span> <span class="n">predmet</span><span class="o">;</span>

    <span class="c1">// Get/set metodi</span>

    <span class="kd">public</span> <span class="nc">IspitId</span> <span class="nf">getIdIspita</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">idIspita</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setIdIspita</span><span class="o">(</span><span class="nc">IspitId</span> <span class="n">idIspita</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">idIspita</span> <span class="o">=</span> <span class="n">idIspita</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">getOcena</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ocena</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOcena</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">ocena</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ocena</span> <span class="o">=</span> <span class="n">ocena</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getStatus</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">status</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStatus</span><span class="o">(</span><span class="nc">String</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Student</span> <span class="nf">getStudent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">student</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStudent</span><span class="o">(</span><span class="nc">Student</span> <span class="n">student</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">student</span> <span class="o">=</span> <span class="n">student</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Predmet</span> <span class="nf">getPredmet</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">predmet</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPredmet</span><span class="o">(</span><span class="nc">Predmet</span> <span class="n">predmet</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">predmet</span> <span class="o">=</span> <span class="n">predmet</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>
<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_12/src/zadatak_12_2/HibernateUtil.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_12_2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.hibernate.SessionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hibernate.boot.MetadataSources</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hibernate.boot.registry.StandardServiceRegistry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hibernate.boot.registry.StandardServiceRegistryBuilder</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">HibernateUtil</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">SessionFactory</span> <span class="n">sessionFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">StandardServiceRegistry</span> <span class="n">registry</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StandardServiceRegistryBuilder</span><span class="o">().</span><span class="na">configure</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
            <span class="n">sessionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MetadataSources</span><span class="o">(</span><span class="n">registry</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addAnnotatedClass</span><span class="o">(</span><span class="nc">StudijskiProgram</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addAnnotatedClass</span><span class="o">(</span><span class="nc">IspitniRok</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addAnnotatedClass</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addAnnotatedClass</span><span class="o">(</span><span class="nc">Ispit</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addAnnotatedClass</span><span class="o">(</span><span class="nc">Predmet</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">buildMetadata</span><span class="o">().</span><span class="na">buildSessionFactory</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Session factory error"</span><span class="o">);</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="nc">SessionFactory</span> <span class="nf">getSessionFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sessionFactory</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_12/src/zadatak_12_2/Main.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_12_2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.CriteriaQuery</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Join</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.criteria.Root</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.hibernate.Session</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hibernate.Transaction</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Pocetak rada\n"</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">(</span><span class="nc">Scanner</span> <span class="n">ulaz</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Unesite indeks studenta: "</span><span class="o">);</span>
            <span class="nc">Integer</span> <span class="n">indeks</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>
            
            <span class="n">readPolozeniPredmetiCriteria</span><span class="o">(</span><span class="n">indeks</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Zavrsetak rada\n"</span><span class="o">);</span>
        <span class="nc">HibernateUtil</span><span class="o">.</span><span class="na">getSessionFactory</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">readPolozeniPredmetiCriteria</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">indeks</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---------------------------------"</span><span class="o">);</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="nc">HibernateUtil</span><span class="o">.</span><span class="na">getSessionFactory</span><span class="o">().</span><span class="na">openSession</span><span class="o">();</span>
        <span class="nc">Transaction</span> <span class="no">TR</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        
        <span class="k">try</span> <span class="o">{</span>
            <span class="no">TR</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
            
            <span class="nc">Student</span> <span class="n">trazeniStudent</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Student</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">indeks</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">ime</span> <span class="o">=</span> <span class="n">trazeniStudent</span><span class="o">.</span><span class="na">getIme</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">prezime</span> <span class="o">=</span> <span class="n">trazeniStudent</span><span class="o">.</span><span class="na">getPrezime</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Student: "</span> <span class="o">+</span> <span class="n">indeks</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">ime</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">prezime</span><span class="o">);</span>
            
            <span class="cm">/* Postavljanje kriterijuma tako da kriterijume ispunjavaju polozeni
             * ispiti studenta sa brojem indeksa indeks */</span>
            <span class="nc">CriteriaBuilder</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
            
            <span class="nc">CriteriaQuery</span><span class="o">&lt;</span><span class="nc">Ispit</span><span class="o">&gt;</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="nc">Ispit</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="nc">Root</span><span class="o">&lt;</span><span class="nc">Ispit</span><span class="o">&gt;</span> <span class="n">ispit</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="nc">Ispit</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            
            <span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Ispit</span><span class="o">,</span> <span class="nc">Student</span><span class="o">&gt;</span> <span class="n">student</span> <span class="o">=</span> <span class="n">ispit</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"student"</span><span class="o">);</span>
            <span class="nc">Join</span><span class="o">&lt;</span><span class="nc">Ispit</span><span class="o">,</span> <span class="nc">Predmet</span><span class="o">&gt;</span> <span class="n">predmet</span> <span class="o">=</span> <span class="n">ispit</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"predmet"</span><span class="o">);</span>
            
            <span class="n">criteria</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">ispit</span><span class="o">);</span>
            <span class="n">criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">and</span><span class="o">(</span>
                    <span class="n">cb</span><span class="o">.</span><span class="na">gt</span><span class="o">(</span><span class="n">ispit</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"ocena"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">Integer</span><span class="o">(</span><span class="mi">5</span><span class="o">)),</span> 
                    <span class="n">cb</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="n">ispit</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"status"</span><span class="o">),</span> <span class="s">"o"</span><span class="o">),</span> 
                    <span class="n">cb</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">student</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"indeks"</span><span class="o">),</span> <span class="n">indeks</span><span class="o">)</span>
                    <span class="o">)</span>
            <span class="o">);</span>
            <span class="n">criteria</span><span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">predmet</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"naziv"</span><span class="o">)));</span>
            
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Ispit</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">criteria</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
            <span class="n">results</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">.</span><span class="na">getPredmet</span><span class="o">().</span><span class="na">getNaziv</span><span class="o">())</span>
                <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">naziv</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Ispit: "</span> <span class="o">+</span> <span class="n">naziv</span><span class="o">));</span>
            
            <span class="no">TR</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>            
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Postoji problem sa ispisivanjem informacija o studentima! Ponistavanje transakcije!"</span><span class="o">);</span>
        
            <span class="k">if</span> <span class="o">(</span><span class="no">TR</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="no">TR</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h2 id="127-zadaci-za-vežbu">12.7 Zadaci za vežbu</h2>

<div class="ui stacked segment">
  <p><strong>Zadatak 12.3</strong>: Napisati Java aplikaciju koja korišćenjem biblioteke Hibernate i JPA Criteria API-ja izdvaja sve podatke o studentima koji su upisali fakultet godine koja se unosi sa standardnog ulaza.</p>
</div>

<div class="ui stacked segment">
  <p><strong>Zadatak 12.4</strong>: Napisati Java aplikaciju koja korišćenjem biblioteke Hibernate i JPA Criteria API-ja za svaki predmet izdvaja oznaku i naziv, a zatim i spisak uslovnih predmeta. Za svaki uslovni predmet izdvojiti oznaku, naziv i broj ESPB bodova.</p>
</div>

<div class="ui stacked segment">
  <p><strong>Zadatak 12.5</strong>: Napisati Java aplikaciju koja korišćenjem biblioteke Hibernate i JPA Criteria API-ja za studenta, čiji se indeks unosi sa standardnog ulaza, pravi izveštaj o položenim ispitima i uspehu po upisanim školskim godinama. Za svaku upisanu godinu ispisati naziv predmeta, datum polaganja i ocenu, a zatim prosečnu ocenu.</p>
</div>

        </div>
    </div>

    <script>
        $('#pageSticky').sticky({
            context: '#pageContent'
        });

        $('#pageSticky').click(function () {
            $('#sideMenu').sidebar('toggle');
        });
    </script>
</body>

</html>