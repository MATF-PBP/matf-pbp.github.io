<!DOCTYPE html>
<html lang="rs">
<head>
    <title>5. Implementiranje transakcija | Programiranje baza podataka</title>
    <meta charset="utf-8">

    <link rel="stylesheet" type="text/css" href="/resources/semantic/semantic.min.css">
    <script src="/resources/jquery/jquery-3.5.1.min.js"></script>
    <script src="/resources/semantic/semantic.min.js"></script>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <script src="https://semantic-ui.com/javascript/library/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
        $(document).ready(() => {
            $("table").addClass('ui celled table');
        });
    </script>
</head>

<body>
    <div class="ui sticky black big launch right attached fixed button" id="pageSticky">
        <i class="content icon"></i>
        <span class="text">Prikaži sadržaj</span>
    </div>

    <div class="ui sidebar vertical menu" id="sideMenu">
        <div class="item">
            <h3>Sadržaj</h3>
        </div>
        <a class="item" href="/vezbe/predgovor">Predgovor</a>
        <a class="item" href="/vezbe/poglavlja/1">1. Uvod u programiranje baza podataka</a>
        <a class="item" href="/vezbe/poglavlja/2">2. Osnovni koncepti programiranja C/SQL aplikacija</a>
        <a class="item" href="/vezbe/poglavlja/3">3. Programiranje korišćenjem kursora</a>
        <a class="item" href="/vezbe/poglavlja/4">4. Aplikacije sa dinamičkim SQL naredbama</a>
        <a class="item" href="/vezbe/poglavlja/5">5. Implementiranje transakcija</a>
        <a class="item" href="/vezbe/poglavlja/6">6. Aplikacije u višekorisničkom okruženju</a>
        <a class="item" href="/vezbe/poglavlja/7">7. Povezivanje aplikacija na više baza podataka</a>
        <a class="item" href="/vezbe/poglavlja/8">8. Osnovni koncepti programiranja Java/SQL aplikacija sa
            dinamičkim SQL naredbama (JDBC)</a>
        <a class="item" href="/vezbe/poglavlja/9">9. Napredne tehnike razvijanja Java/SQL aplikacija</a>
        <a class="item" href="/vezbe/poglavlja/10">10. Uvod u razvojno okruženje Hibernate</a>
        <a class="item" href="/vezbe/poglavlja/11">11. Napredna objektno-relaciona preslikavanja</a>
        <a class="item" href="/vezbe/poglavlja/12">12. Napredno kreiranje upita pomoću JPA Criteria API</a>
        <a class="item" href="/vezbe/poglavlja/13">13. Programiranje SQL rutina</a>
        <a class="item" href="/vezbe/poglavlja/14">14. Korisnički-definisane funkcije</a>
        <a class="item" href="/vezbe/poglavlja/15">15. Ugrađene procedure</a>
        <a class="item" href="/vezbe/poglavlja/16">16. Okidači</a>
    </div>

    <div class="ui justified container">
        <img class="ui centered small image" src="/resources/matf-srb.png">
        <header class="ui center aligned block header">
            <h1><a href="/">Programiranje baza podataka</a></h1>
        </header>

        <div class="ui divider"></div>

        <div id="pageContent">
            <h2>5. Implementiranje transakcija</h2>


<div class="ui warning message">
    <div class="header">
        Ova stranica je pod konstrukcijom!
    </div>
    Ako pronađete grešku ili propust, molimo Vas da nam skrenete pažnju otvaranjem primedbe na <a href="https://github.com/MATF-PBP/matf-pbp.github.io"><i class="github icon"></i>zvaničnom GitHub repozitorijumu</a>.
</div>


<p>Transakcije predstavljaju izuzetno važan alat za svakog programera koji koristi baze podataka u svojim aplikacijama. Svaka iole kompleksnija operacija nad podacima zahteva korišćenje transakcija da bi se takva operacija uspešno implementirala. Pritom, postoji veliki broj pitanja i potencijalnih problema koji se otvaraju prilikom korišćenja  transakcija. U ovoj sekciji ćemo se upoznati sa različitim naredbama za rad sa transakcijama u DB2 sistemu za upravljanje relacionim bazama podataka. Započnimo ovaj deo teksta narednom definicijom.</p>

<p><em>Transakcija</em> (engl. <em>transaction</em>) predstavlja logičku jedinicu posla pri radu sa podacima.</p>

<p>Transakcija predstavlja niz radnji koji ne narušava uslove integriteta. Sa stanovišta korisnika, izvršavanje transakcije je atomično. Po izvršenju kompletne transakcije stanje baze treba da bude konzistentno, tj. da su ispunjeni uslovi integriteta. Dakle, posmatrana kao jedinica posla, transakcija prevodi jedno konzistentno stanje baze u drugo takvo stanje baze, dok u međukoracima transakcije konzistentnost podataka može biti i narušena. Transakcija na taj način predstavlja i bezbedno sredstvo za interakciju korisnika sa bazom.</p>

<h2 id="51-operacije-potvrđivanja-i-poništavanja-izmena-u-bazi-podataka">5.1 Operacije potvrđivanja i poništavanja izmena u bazi podataka</h2>

<p>Pre nego što započnemo detaljnu diskusiju o implementaciji transakcija, obratićemo pažnju na jedan realan primer izvršavanja programa koji implementira prebacivanje novca sa jednog računa na drugi. Ovaj primer će nam služiti kao glavna motivacija zašto je potrebno da razumemo rad sa transakcijama. Pre nego što demonstriramo primer, dajmo narednu definiciju.</p>

<p><em>Atomična</em> (engl. <em>atomic</em>) operacija je ona operacija koju nije moguće podeliti na više manjih operacija (tj. u pitanju je nedeljiva operacija).</p>

<p>Premeštaj novca sa jednog računa na drugi se može implementirati narednim nizom atomičnih operacija (radi čuvanja prostora, iz narednog niza eliminišemo razne provere, kao što su provera da li korisnik može da prebaci novac između računa, provera da li ima dovoljno sredstava na prvom računu, itd.):</p>

<ol>
  <li>Dohvati red u tabeli koji predstavlja prvi račun.</li>
  <li>Umanji iznos u tom redu za traženu sumu.</li>
  <li>Dohvati red u tabeli koji predstavlja drugi račun.</li>
  <li>Uvećaj iznos u tom redu za traženu sumu.</li>
</ol>

<p>Pretpostavimo da SUBP operacije iz ovih koraka implementira na takav način da se neposredno nakon njihovog izvršavanja sve izmene trajno upisuju u bazu podataka. Naredna slika ilustruje jedno moguće izvršavanje programa koji implementira ove korake. U tom izvršavanju, program prvo naredbom <code class="language-plaintext highlighter-rouge">SELECT</code> dohvata red u tabeli koji predstavlja prvi račun (koji je na početku imao 100 000 jedinica valute). Zatim, u drugom koraku, naredbom <code class="language-plaintext highlighter-rouge">UPDATE</code> umanjuje iznos u tom redu za traženu sumu (10 000 jedinica valute). Iz nekog razloga (nestanak struje, prekid mrežne komunikacije, itd.), nakon 2. koraka, program prijavljuje grešku i operativni sistem ga prekida. Međutim, kao što je prikazano na slici, stanje baze je takvo da je prvom računu umanjen iznos i informacija o tome da novac nije uspešno prebačen na drugi račun se izgubila. Drugim rečima, baza se nalazi u <em>nekonzistentnom</em> stanju. Zbog toga, važno je zapamtiti da <strong>SUBP nikada ne implementira operacije izmena tako da njihovi efekti budu trajno upisani u bazu podataka neposredno nakon njihovog izvršavanja</strong>.</p>

<p><img src="/vezbe/poglavlja/5/Slike/CitanjePrePotvrdjivanja.png" alt="Nepravilna implementacija transakcija može dovesti do kršenja pravila u poslovnom domenu" class="ui centered large image" /></p>

<p>Sada je validno postaviti pitanje - u kom trenutku se informacije o izmenama zaista upisuju u bazu podataka? Db2 baza podataka definiše naredne dve operacije za rad sa izmenama u bazi podataka.</p>

<p><em>Potvrđivanje</em> (engl <em>commit</em>) predstavlja trajno upisivanje izmena u bazu podataka koje su do tada bile izvršene nad tom bazom podataka. Sve načinjene izmene se trajno pamte u bazi podataka i svi ostali procesi dobijaju mogućnost da vide načinjene izmene.</p>

<p><em>Poništavanje</em> (engl <em>rollback</em>) predstavlja vraćanje stanja baze podataka u ono u kojem se baza podataka našla pre izvršavanja izmena koje su do tada bile izvršene nad tom bazom podataka. Izvršavanjem ove naredbe možemo poništiti sve one akcije koje do trenutka poništavanja nisu prethodno bile potvrđene.</p>

<p>Da bismo dodatno razumeli koje su to izmene u bazi podataka koje se potvrđuju, odnosno, poništavaju ovim operacijama, potrebno je da definišemo pojam jedinice posla.</p>

<p><em>Jedinica posla</em> (engl. <em>unit of work</em>, skr. <em>UOW</em>) predstavlja nadoknadivu sekvencu operacija u okviru aplikacionog procesa.</p>

<p>Jedinica posla se inicijalizuje prilikom pokretanja aplikacionog procesa ili kada se prethodna jedinica posla završila posledicom operacije koja nije prekid aplikacionog procesa. Jedinica posla se završava operacijom potvrđivanja ili poništavanja izmena ili završetkom aplikacionog procesa. Operacije potvrđivanja i poništavanja izmena utiču samo da one promene u bazi podataka koje su izvršene tokom te jedinice posla koja se završava.</p>

<p>Inicijalizacija i završetak jedinice posla definišu tačke konzistentnosti u okviru aplikacionog procesa. Razmotrimo prethodni primer bankarske transakcije u kojoj se vrši premeštaj sredstava sa jednog računa na drugi račun. Kao što smo rekli, nakon drugog koraka (oduzimanja sredstava) podaci su nekonzistentni. Tek nakon izvršavanja četvrtog koraka (uvećavanje sredstava) konzistentnost je obnovljena, što je prikazano na narednoj slici:</p>

<p><img src="/vezbe/poglavlja/5/Slike/uow1.png" alt="&quot;Grafički prikaz jedne jedinice posla tokom vremena. Ova jedinica posla se uspešno izvršila i sve izmene koje predstavljaju deo te jedinice posla se uspešno potvrđuju u bazi podataka.&quot;" class="ui centered large image" /></p>

<p>Kada se oba koraka izvrše, može se iskoristiti operacija potvrđivanja izmena da bi se završila jedinica posla. Ako dođe do greške pre nego što se jedinica posla uspešno završi, SUBP će poništiti sve nepotvrđene izmene da bi vratio stanje baze podataka u konzistentno, što je prikazano na narednoj slici:</p>

<p><img src="/vezbe/poglavlja/5/Slike/uow2.png" alt="&quot;Grafički prikaz jedne jedinice posla tokom vremena. U ovoj jedinici posla je došlo do greške, čime je neophodno da se izmene koje su načinjene u bazi podataka ponište.&quot;" class="ui centered large image" /></p>

<p>Dakle, rešenje problema prenosa novca bismo implementirali narednim koracima:</p>

<ol>
  <li>(Implicitno) Započni novu jedinicu posla (bilo započinjanjem novog procesa, prethodnim izvršavanjem naredba potvrđivanja ili poništavanja, itd.).</li>
  <li>Dohvati red u tabeli koji predstavlja prvi račun.</li>
  <li>Umanji iznos u tom redu za traženu sumu.</li>
  <li>Dohvati red u tabeli koji predstavlja drugi račun.</li>
  <li>Uvećaj iznos u tom redu za traženu sumu.</li>
  <li>Potvrdi izmene u bazi podataka.</li>
</ol>

<p>Naravno, nakon svakog koraka je neophodno izvršiti proveru grešaka. U slučaju greške u bilo kom trenutku, program mora da izvrši poništavanje izmena, čime se stanje baze vraća u ono koje je bilo pre 1. koraka, dakle, u konzistentno stanje.</p>

<p>SQL jezik definiše dve naredbe koje odgovaraju opisanim operacijama:</p>

<ul>
  <li>
    <p>Naredba <code class="language-plaintext highlighter-rouge">COMMIT</code> implementira operaciju potvrđivanja izmena.</p>
  </li>
  <li>
    <p>Naredba <code class="language-plaintext highlighter-rouge">ROLLBACK</code> implementira operaciju poništavanja izmena.</p>
  </li>
</ul>

<p>O ovim naredbama i njihovim bočnim efektima ćemo detaljnije govoriti u sekcijama <a href="#54-potvrđivanje-izmena">o potvrđivanju izmena</a> i <a href="#55-poništavanje-izmena">o poništavanju izmena</a>. Međutim, diskusija koju smo izložili do sada je dovoljna za demonstraciju najosnovnijeg efekta ovih naredbi.</p>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.1</strong>: Napisati C/SQL program koji redom:</p>

  <ol>
    <li>Pronalazi i ispisuje najveći indeks iz tabele <code class="language-plaintext highlighter-rouge">ISPIT</code>.</li>
    <li>Briše studenta sa pronađenim indeksom iz tabele <code class="language-plaintext highlighter-rouge">ISPIT</code> i ispisuje poruku korisniku o uspešnosti brisanja.</li>
    <li>Ponovo pronalazi i ispisuje najveći indeks iz tabele <code class="language-plaintext highlighter-rouge">ISPIT</code>.</li>
    <li>Pita korisnika da li želi da potvrdi ili poništi izmene. U zavisnosti od korisnikovog odgovora, aplikacija potvrđuje ili poništava izmene uz ispisivanje poruke korisniku.</li>
    <li>Ponovo pronalazi i ispisuje najveći indeks iz tabele <code class="language-plaintext highlighter-rouge">ISPIT</code>.</li>
  </ol>
</div>

<p>Rešenje:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_5/zadatak_5_1.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">hIndex</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="c1">// U funkciju za obradu greske dodajemo naredbu ROLLBACK</span>
        <span class="c1">// da bismo ponistili eventualne izmene u bazi podataka</span>
        <span class="c1">// ukoliko zaista dodje do greske.</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">SELECT</span>  <span class="n">MAX</span><span class="p">(</span><span class="n">INDEKS</span><span class="p">)</span> 
        <span class="n">INTO</span>    <span class="o">:</span><span class="n">hIndex</span> 
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Select 1"</span><span class="p">);</span>
    
    <span class="c1">// Ako nema studenata u tabeli ISPIT, zavrsi program</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Tabela je prazna!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset - SQLCODE 100 - 1"</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// Inace, ispisi maksimalni index, pa ga obrisi iz tabele ISPIT</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Maksimalni index je %d.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hIndex</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DELETE</span>  <span class="n">FROM</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span> 
        <span class="n">WHERE</span>   <span class="n">INDEKS</span> <span class="o">=</span> <span class="o">:</span><span class="n">hIndex</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Delete"</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Uspesno je obrisan podatak"</span><span class="p">);</span>

    <span class="c1">// Ispisivanje najveceg index iz tabele ISPIT</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">SELECT</span>  <span class="n">MAX</span><span class="p">(</span><span class="n">INDEKS</span><span class="p">)</span> 
        <span class="n">INTO</span>    <span class="o">:</span><span class="n">hIndex</span> 
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Select 2"</span><span class="p">);</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Tabela je prazna!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Maximalni index je %d.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hIndex</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// Pitamo korisnika za dalju akciju</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Izaberite jednu od dve akcije:</span><span class="se">\n</span><span class="s">"</span>
        <span class="s">"1. Potvrdjivanje izmena</span><span class="se">\n</span><span class="s">"</span>
        <span class="s">"2. Ponistavanje izmena</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="kt">short</span> <span class="n">userResponse</span><span class="p">;</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%hd"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">userResponse</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">userResponse</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Potvrdjujemo izmene naredbom COMMIT</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Commit"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Ponistavamo izmene naredbom ROLLBACK</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Vasa akcija je izvrsena!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    
    <span class="c1">// Ispisujemo najveci index ponovo</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">SELECT</span>  <span class="n">MAX</span><span class="p">(</span><span class="n">INDEKS</span><span class="p">)</span> 
        <span class="n">INTO</span>    <span class="o">:</span><span class="n">hIndex</span> 
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Select 3"</span><span class="p">);</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Maximalni index je %d.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hIndex</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Tabela je prazna!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>   

    <span class="c1">// U slucaju uspesnog izvrsavanja programa,</span>
    <span class="c1">// potvrdjujemo sve akcije koje je nas program izvrsio</span>
    <span class="c1">// pre nego sto zatvorimo konekciju.</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Commit - kraj programa"</span><span class="p">);</span>
    
    <span class="c1">// Iako u ovom slucaju nismo imali nikakvu izmenu od poslednje COMMIT ili ROLLBACK naredbe do ovde, </span>
    <span class="c1">// potvrdjivanje izmena tik pred raskidanje konekcije se smatra dobrom praksom</span>
    <span class="c1">// tako da cemo ovo ponasanje usvojiti u svim nasim aplikacijama nadalje!</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Vrlo je bitno primetiti naredne dve stvari u kodu:</p>

<ul>
  <li>
    <p>U slučaju uspešnog izvršavanja programa, pre nego što zatvorimo konekciju sa bazom podataka, izvršavamo SQL naredbu <code class="language-plaintext highlighter-rouge">COMMIT</code> kako bismo potvrdili sve izmene koje je naša aplikacija eventualno izvršila nad bazom podataka.</p>
  </li>
  <li>
    <p>U slučaju da dođe do greške prilikom izvršavanja programa, pre nego što izađemo iz programa i prijavimo neuspeh, u funkciji <code class="language-plaintext highlighter-rouge">checkSQL</code> izvršavamo naredbu <code class="language-plaintext highlighter-rouge">ROLLBACK</code> kako bismo poništili sve izmene koje je naša aplikacija eventualno izvršila nad bazom podataka.</p>
  </li>
</ul>

<p>Ovo je dobra praksa i mi ćemo usvojiti ovaj način rada u našim C/SQL programima nadalje.</p>

<h2 id="52-složena-sql-naredba">5.2 Složena SQL naredba</h2>

<p>U ovoj sekciji ćemo diskutovati o načinima za izvršavanje više SQL naredbi kao jedne naredbe, tzv. složene SQL naredbe. Složene SQL naredbe predstavljaju osnovu rada sa transakcijama, o čemu će biti detaljnije reči u nastavku teksta.</p>

<p><em>Složena SQL naredba</em> (engl. <em>compound SQL</em>) predstavlja sekvencu SQL naredbi ograđenu odgovarajućim ključnim rečima kojim se definiše jedan blok izvršavanja.</p>

<p>Postoje tri tipa složenih SQL naredbi:</p>

<ol>
  <li>
    <p><em>Linijske</em> (engl. <em>inline</em>) - Složena SQL linijska naredba je složena SQL naredba koja je umetnuta linijski tokom faze izvršavanja u okviru druge SQL naredbe. Složene SQL linijske naredbe imaju svojstvo atomičnosti; ako izvršavanje bilo koje pojedinačne SQL naredbe podigne grešku, cela naredba se poništava.</p>
  </li>
  <li>
    <p><em>Ugnežđene</em> (engl. <em>embedded</em>) - Ovaj tip naredbi kombinuje jednu ili više SQL naredbi (odnosno, podnaredbi) u jedan izvršivi blok.</p>
  </li>
  <li>
    <p><em>Kompilirane</em> (engl. <em>compiled</em>) - Predstavlja sekvencu SQL naredbi koje se izvršavaju sa lokalnim opsegom za promenljive, uslove, kursore i pokazivače na slogove (engl. <em>handle</em>).</p>
  </li>
</ol>

<p>Mi ćemo u daljem tekstu razmatrati isključivo složene SQL ugnežđene naredbe, tako da podrazumevamo ovaj tip kada kažemo “složena SQL naredba”. Sintaksa ovih naredbi je data u nastavku:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span> <span class="n">COMPOUND</span> <span class="p">(</span><span class="k">ATOMIC</span><span class="o">|</span><span class="k">NOT</span> <span class="k">ATOMIC</span><span class="p">)</span> <span class="k">STATIC</span>
<span class="p">[</span><span class="n">STOP</span> <span class="k">AFTER</span> <span class="k">FIRST</span> <span class="o">&lt;</span><span class="n">MATICNA_PROMENLJIVA</span><span class="o">&gt;</span> <span class="n">STATEMENTS</span><span class="p">]</span>

<span class="o">&lt;</span><span class="n">SQL_NAREDBA</span><span class="o">&gt;</span><span class="p">;</span>
<span class="o">&lt;</span><span class="n">SQL_NAREDBA</span><span class="o">&gt;</span><span class="p">;</span>
<span class="c1">-- ...</span>
<span class="o">&lt;</span><span class="n">SQL_NAREDBA</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">END</span> <span class="n">COMPOUND</span>
</code></pre></div></div>

<p>U zavisnosti od odabranih vrednosti narednih opcija prilikom deklaracije složene SQL naredbe, ta naredba može imati različite varijante koji utiču na način izvršavanja:</p>

<ul>
  <li>
    <p>Atomičnost - tačno jedna od naredne dve opcije se navode</p>

    <ul>
      <li>
        <p>ATOMIC - Specifikuje da, ako bilo koja od podnaredbi u okviru složene SQL naredbe bude izvršena neuspešno, onda se sve izmene u bazi podataka koje su nastale efektom bilo koje druge podnaredbe, bilo one uspešne izvršene ili ne, poništavaju.</p>
      </li>
      <li>
        <p>NOT ATOMIC - Specifikuje da, bez obzira na neuspešno izvršavanje podnaredbi, složena SQL naredba neće poništiti izmene u bazi podataka koje su nastale efektom bilo koje druge podnaredbe.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Statičnost - navodi se naredna naredba</p>

    <ul>
      <li>STATIC - Specifikuje da će sve matične promenljive za sve podnaredbe zadržati njihove originalne vrednosti. Na primer, ukoliko se u SQL složenoj naredbi nađe naredba:</li>
    </ul>
  </li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="k">MIN</span><span class="p">(</span><span class="n">OCENA</span><span class="p">)</span> 
<span class="k">INTO</span>    <span class="p">:</span><span class="n">ocena</span> 
<span class="k">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span>
</code></pre></div></div>

<p>koja je praćena naredbom</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span>  <span class="k">FROM</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span> 
<span class="k">WHERE</span>   <span class="n">OCENA</span> <span class="o">=</span> <span class="p">:</span><span class="n">ocena</span>
</code></pre></div></div>

<p>onda će naredba <code class="language-plaintext highlighter-rouge">DELETE</code> koristiti vrednost matične promenljive <code class="language-plaintext highlighter-rouge">ocena</code> koju je ta promenljiva imala na početku bloka koji je definisan složenom SQL naredbom, a ne vrednost koju je naredba <code class="language-plaintext highlighter-rouge">SELECT INTO</code> upisala u tu matičnu promenljivu. Time je transakcija koja se ostvaruje tom SQL složenom naredbom, za koju bismo možda očekivali da bude korektna, zapravo neispravno implementirana, zato što se oslanja na međuvrednost koju matična promenljiva <code class="language-plaintext highlighter-rouge">ocena</code> dobija naredbom <code class="language-plaintext highlighter-rouge">SELECT INTO</code>. Dodatno, ako se vrednost iste promenljive postavlja od strane više SQL podnaredbi, onda će na kraju bloka ta promenljiva sadržati vrednost koju je postavila poslednja SQL podnaredba.</p>

<p>Napomenimo da u DB2 sistemu nestatičko ponašanje nije podržano. To znači da bi trebalo posmatrati kao da se podnaredbe izvršavaju nesekvencijalno i podnaredbe ne bi trebalo da imaju međuzavisnosti, kao u datom primeru.</p>

<ul>
  <li>Opcionom klauzom <code class="language-plaintext highlighter-rouge">STOP AFTER FIRST</code> specifikujemo da će se izvršiti samo određeni broj podnaredbi. Matična promenljiva <code class="language-plaintext highlighter-rouge">&lt;MATICNA_PROMENLJIVA&gt;</code> tipa <code class="language-plaintext highlighter-rouge">short</code> sadrži ceo broj <em>N</em> kojim se specifikuje koliko prvih <em>N</em> podnaredbi će biti izvršeno.</li>
</ul>

<p>Nakon opisanih opcija, potrebno je navesti nula ili više SQL naredbi <code class="language-plaintext highlighter-rouge">&lt;SQL_NAREDBA&gt;</code>. SQL naredbe koje je moguće navesti kao deo složenih SQL naredbi su sve izvršive naredbe, osim narednih 14 naredbi:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">CALL</code></li>
  <li><code class="language-plaintext highlighter-rouge">CLOSE</code></li>
  <li><code class="language-plaintext highlighter-rouge">CONNECT</code></li>
  <li>Složena SQL naredba</li>
  <li><code class="language-plaintext highlighter-rouge">DESCRIBE</code></li>
  <li><code class="language-plaintext highlighter-rouge">DISCONNECT</code></li>
  <li><code class="language-plaintext highlighter-rouge">EXECUTE IMMEDIATE</code></li>
  <li><code class="language-plaintext highlighter-rouge">FETCH</code></li>
  <li><code class="language-plaintext highlighter-rouge">OPEN</code></li>
  <li><code class="language-plaintext highlighter-rouge">PREPARE</code></li>
  <li><code class="language-plaintext highlighter-rouge">RELEASE (Connection)</code></li>
  <li><code class="language-plaintext highlighter-rouge">ROLLBACK</code></li>
  <li><code class="language-plaintext highlighter-rouge">SET CONNECTION</code></li>
  <li><code class="language-plaintext highlighter-rouge">SET variable</code></li>
</ol>

<p>Važe i neka dodatna pravila. Na primer, ukoliko se naredba <code class="language-plaintext highlighter-rouge">COMMIT</code> koristi kao jedna od podnaredbi, onda se ona mora naći kao poslednja podnaredba. Ukoliko je <code class="language-plaintext highlighter-rouge">COMMIT</code> nađe na ovoj poziciji, onda će ona biti izvršena, čak i u situaciji da klauza <code class="language-plaintext highlighter-rouge">STOP AFTER FIRST</code> indikuje da se neće sve podnaredbe u okviru složene SQL naredbe izvršiti. Na primer, pretpostavimo da je <code class="language-plaintext highlighter-rouge">COMMIT</code> poslednja podnaredba u okviru složene SQL naredbe koja ima 100 podnaredbi. Ukoliko se klauzom <code class="language-plaintext highlighter-rouge">STOP AFTER FIRST</code> specifikuje da se izvršava prvih 50 podnaredbi, onda će <code class="language-plaintext highlighter-rouge">COMMIT</code> podnaredba biti izvršena kao 51. podnaredba.</p>

<p>Neka dodatne napomene koje treba imati u vidu prilikom rada sa složenih SQL naredbama u DB2 sistemu su sledeće:</p>

<ul>
  <li>
    <p>Nije dozvoljeno ugnežđavati kod iz matičnog jezika unutar bloka koji definiše složena SQL naredba.</p>
  </li>
  <li>
    <p>Nije dozvoljeno ugnežđavati složene SQL naredbe u okviru drugih složenih SQL naredbi.</p>
  </li>
  <li>
    <p>Pripremljena <code class="language-plaintext highlighter-rouge">COMMIT</code> naredba nije dozvoljena u <code class="language-plaintext highlighter-rouge">ATOMIC</code> složenoj SQL naredbi.</p>
  </li>
  <li>
    <p>Jedna SQLCA struktura se postavlja za celu složenu SQL naredbu. Važe naredna pravila:</p>

    <ul>
      <li>
        <p>Vrednosti <code class="language-plaintext highlighter-rouge">SQLCODE</code> i <code class="language-plaintext highlighter-rouge">SQLSTATE</code> koje se postavljaju na kraju složene SQL naredbe su podrazumevano postavljene na osnovu poslednje podnaredbe koja se izvršila u okviru složene SQL naredbe, osim u slučaju opisanom narednom tačkom.</p>
      </li>
      <li>
        <p>Ako je sistem signalizirao upozorenje da “nije pronađen podatak” (<code class="language-plaintext highlighter-rouge">SQLSTATE 02000</code>, odnosno, <code class="language-plaintext highlighter-rouge">SQLCODE +100</code>), onda se tom upozorenju daje prednost u odnosu na ostala upozorenja da bi se naredbom <code class="language-plaintext highlighter-rouge">WHENEVER NOT FOUND</code> moglo dejstvovati. U ovoj situaciji se polja iz <code class="language-plaintext highlighter-rouge">SQLCA</code> strukture koja se eventualno vraćaju aplikaciji postavljaju na osnovu podnaredbe koja je okinula upozorenje da “nije pronađen podatak”. Ukoliko u okviru složene SQL naredbe postoji više podnaredbi koje okidaju ovo upozorenje, onda se polja iz SQLCA strukture postavljaju na osnovu poslednje od tih podnaredbi.</p>
      </li>
    </ul>
  </li>
</ul>

<p>Sada slede primeri korišćenja složenih SQL naredbi. Primetimo da smo, kao i u prethodnom zadatku, koristili naredbu <code class="language-plaintext highlighter-rouge">ROLLBACK</code> u definiciji funkcije <code class="language-plaintext highlighter-rouge">checkSQL</code> da poništimo izmene u bazi podataka u slučaju da dođe do greške, odnosno, naredbu <code class="language-plaintext highlighter-rouge">COMMIT</code> za potvrđivanje izmena pre raskidanja konekcije.</p>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.2</strong>: Napisati C/SQL program koji redom:</p>

  <ol>
    <li>Kreira novi ispitni rok u tekućoj godini čija je oznaka <code class="language-plaintext highlighter-rouge">'maj'</code> i naziv <code class="language-plaintext highlighter-rouge">'Maj GODINA'</code> u zavisnosti od tekuće godine (na primer, <code class="language-plaintext highlighter-rouge">'Maj 2021'</code>). Za početak prijavljivanja postaviti datum izvršavanja programa i postaviti da prijavljivanje traje 20 dana.</li>
    <li>Ažurira datum kraja prijavljivanja za prethodno uneti ispitni rok tako što smanjuje trajanje prijavljivanja za 10 dana.</li>
  </ol>

  <p>Obezbediti da se navedene operacije izvrše ili sve ili nijedna.</p>
</div>

<p>Rešenje:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_5/zadatak_5_2.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">BEGIN</span> <span class="n">COMPOUND</span> <span class="n">ATOMIC</span> <span class="n">STATIC</span>
            <span class="n">INSERT</span>  <span class="n">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="n">YEAR</span><span class="p">(</span><span class="n">CURRENT_DATE</span><span class="p">),</span> <span class="err">'</span><span class="n">maj</span><span class="err">'</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="err">'</span><span class="n">Maj</span> <span class="err">'</span><span class="p">,</span> <span class="n">YEAR</span><span class="p">(</span><span class="n">CURRENT_DATE</span><span class="p">)),</span> <span class="n">CURRENT_DATE</span><span class="p">,</span> <span class="n">CURRENT_DATE</span> <span class="o">+</span> <span class="mi">20</span> <span class="n">days</span><span class="p">);</span>
            
            <span class="n">UPDATE</span>  <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
            <span class="n">SET</span>     <span class="n">DATKRAJA</span> <span class="o">=</span> <span class="n">DATKRAJA</span> <span class="o">-</span> <span class="mi">10</span> <span class="n">days</span>
            <span class="n">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="n">YEAR</span><span class="p">(</span><span class="n">CURRENT_DATE</span><span class="p">)</span> <span class="n">AND</span>
                    <span class="n">OZNAKAROKA</span> <span class="o">=</span> <span class="err">'</span><span class="n">maj</span><span class="err">'</span><span class="p">;</span>
        <span class="n">END</span> <span class="n">COMPOUND</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Compound"</span><span class="p">);</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"Sve naredbe su uspesno izvrsene!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Commit"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="53-tačke-čuvanja-u-okviru-transakcija">5.3 Tačke čuvanja u okviru transakcija</h2>

<p>U prethodnim primerima smo videli da možemo da predstavimo transakcije kao složene SQL naredbe, a zatim da koristimo specifičnosti složenih SQL naredbi da bismo preciznije definisali ponašanje u zavisnosti od toga da li se pojavila greška tokom rada transakcije ili ne. Preciznije, videli smo kako je moguće poništiti efekat celog izvršavanja programa kao jedinice posla u slučaju pojave greške u nekoj od podnaredbi.</p>

<p>Vrlo često nam je neophodno da imamo precizniju kontrolu nad time šta se tačno poništava, na primer, ukoliko želimo da samo jedan deo transakcije bude poništen, umesto cele transakcije. Da bismo postigli takav efekat, potrebne su nam sofisticiranije metode upravljanja transakcijama. Jedan od takvih metoda podrazumeva korišćenje tačke čuvanja.</p>

<p><em>Tačka čuvanja</em> (engl. <em>savepoint</em>) predstavlja mehanizam za poništavanje precizno definisanog skupa izvršenih naredbi.</p>

<p>Ukoliko se desi neka greška prilikom izvršavanja transakcije, tačka čuvanja se može koristiti da poništi dejstvo naredbi od trenutka kada je tačka čuvanja započeta do trenutka kada je poništenje akcija zahtevano.</p>

<p>Samim tim, tačka čuvanja omogućava konstruisanje grupe od nekoliko SQL naredbi, grupisanih u jedan izvršivi blok, koji se može izvršavati, kao deo jedne transakcije. Ukoliko se neka od podnaredbi izvrši sa greškom, taj definisani blok će biti poništen.</p>

<h3 id="531-kreiranje-tačke-čuvanja">5.3.1 Kreiranje tačke čuvanja</h3>

<p>Kreiranje tačke čuvanja u izvornom kodu se može izvršiti pozivanjem naredbe <code class="language-plaintext highlighter-rouge">SAVEPOINT</code>, čija je sintaksa data sa:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SAVEPOINT</span> <span class="o">&lt;</span><span class="n">NAZIV_TACKE_CUVANJA</span><span class="o">&gt;</span> <span class="p">[</span><span class="k">UNIQUE</span><span class="p">]</span>
<span class="k">ON</span> <span class="k">ROLLBACK</span> <span class="n">RETAIN</span> <span class="n">CURSORS</span>
<span class="p">[</span><span class="k">ON</span> <span class="k">ROLLBACK</span> <span class="n">RETAIN</span> <span class="n">LOCKS</span><span class="p">]</span>
</code></pre></div></div>

<p>Ovom naredbom se kreira nova tačka čuvanja naziva <code class="language-plaintext highlighter-rouge">&lt;NAZIV_TACKE_CUVANJA&gt;</code>. Ukoliko specifikujemo opcionu klauzu <code class="language-plaintext highlighter-rouge">UNIQUE</code>, onda navodimo da aplikacija ne želi da iskoristi ovo ime tačke čuvanja dok je tačka čuvanja aktivna u okviru trenutnog nivoa čuvanja. DB2 sistem će prijaviti grešku ako pokušamo da kreiramo tačku čuvanja kao jedinstvenu ako već postoji tačka čuvanja sa istim imenom, kao i ako pokušamo da kreiramo tačku čuvanja sa imenom koje je prethodno bilo proglašeno za jedinstveno.</p>

<p>Obaveznom klauzom <code class="language-plaintext highlighter-rouge">ON ROLLBACK RETAIN CURSORS</code> se specifikuje ponašanje sistema tokom operacija poništavanja izmena do ove tačke čuvanja u odnosu na otvorene kursore nakon ove SAVEPOINT naredbe. Ovom klauzom se indikuje da, kada god je to moguće, kursori bivaju van uticaja operacije poništavanja do tačke čuvanja. Za više detalja o tome kako poništavanje izmena utiče na kursore, pogledati sekciju <a href="#55-poništavanje-izmena">o poništavanju izmena</a>.</p>

<p>Opcionom klauzom <code class="language-plaintext highlighter-rouge">ON ROLLBACK RETAIN LOCKS</code> se specifikuje ponašanje sistema tokom operacija poništavanja izmena do ove tačke čuvanja u odnosu na katance koje je aplikacija dobila nakon ove <code class="language-plaintext highlighter-rouge">SAVEPOINT</code> naredbe. Ukoliko je navedena, katanci koje je aplikacija dobila neće biti oslobođeni prilikom takve operacije poništavanja.</p>

<p>Neka dodatna pravila i napomene koje treba imati u vidu prilikom kreiranja tačaka čuvanja u DB2 sistemu su sledeće:</p>

<ul>
  <li>
    <p>Novi nivo čuvanja se kreira kada se naredni događaji okinu:</p>

    <ul>
      <li>
        <p>Nova jedinica posla je započela.</p>
      </li>
      <li>
        <p>Pozvana je procedura koja je definisana klauzom <code class="language-plaintext highlighter-rouge">NEW SAVEPOINT LEVEL</code>.</p>
      </li>
      <li>
        <p>Započeta je atomična složena SQL naredba.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Nivo čuvanja se završava kada događaj koji je inicirao njegovo kreiranje je završen ili uklonjen. Kada se nivo čuvanja završi, sve tačke čuvanja koje se nalaze na tom nivou se oslobađaju. Svi otvoreni kursori, DDL akcije ili modifikacije podataka su nasleđeni od strane roditeljskog nivoa čuvanja (odnosno, nivoa čuvanja u okviru kojeg se trenutni nivo čuvanja završio) i pod uticajem su bilo koje naredbe koja se tiče nivoa čuvanja i koja važi u okviru roditeljskog nivoa čuvanja.</p>
  </li>
</ul>

<h2 id="54-potvrđivanje-izmena">5.4 Potvrđivanje izmena</h2>

<p>Kao što smo videli, jedna od dve osnovne operacije za upravljanje izmenama koje je napravila jedna transakcija jeste <em>potvrđivanje izmena</em> (engl. <em>commit</em>), koja se izvršava naredbom <code class="language-plaintext highlighter-rouge">COMMIT</code>. Sintaksa ove naredbe je data u nastavku:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">COMMIT</span> <span class="p">[</span><span class="k">WORK</span><span class="p">]</span>
</code></pre></div></div>

<p>Iako naredba pohranjivanja izmena ima jednostavnu sintaksu, njeni efekti su mnogobrojni. Osnovna upotreba naredbe podrazumeva da se jedinica posla, u kojoj je <code class="language-plaintext highlighter-rouge">COMMIT</code> naredba izvršena, završava i nova jedinica posla se inicira. Sve izmene koje su izvršene nekom od narednih naredbi se potvrđuju u bazi podataka: <code class="language-plaintext highlighter-rouge">ALTER</code>, <code class="language-plaintext highlighter-rouge">COMMENT</code>, <code class="language-plaintext highlighter-rouge">CREATE</code>, <code class="language-plaintext highlighter-rouge">DROP</code>, <code class="language-plaintext highlighter-rouge">GRANT</code>, <code class="language-plaintext highlighter-rouge">LOCK TABLE</code>, <code class="language-plaintext highlighter-rouge">REVOKE</code>, <code class="language-plaintext highlighter-rouge">SET INTEGRITY</code>, <code class="language-plaintext highlighter-rouge">SET Variable</code>, kao i naredbe za izmenu podataka: <code class="language-plaintext highlighter-rouge">INSERT</code>, <code class="language-plaintext highlighter-rouge">DELETE</code>, <code class="language-plaintext highlighter-rouge">MERGE</code>, <code class="language-plaintext highlighter-rouge">UPDATE</code>, uključujući i one naredbe koje su  ugnežđene u upitima.</p>

<p>Svi katanci koje je jedinica posla dobila nakon njenog iniciranja se oslobađaju, osim neophodnih katanaca za otvorene kursore koji su deklarisani klauzom <code class="language-plaintext highlighter-rouge">WITH HOLD</code>. Svi otvoreni kursori koji nisu deklarisani klauzom <code class="language-plaintext highlighter-rouge">WITH HOLD</code> se zatvaraju. Otvoreni kursori koji jesu deklarisani klauzom <code class="language-plaintext highlighter-rouge">WITH HOLD</code> ostaju otvoreni, i takvi kursori se pozicioniraju ispred narednog logičkog reda rezultujuće tabele (drugim rečima, naredba <code class="language-plaintext highlighter-rouge">FETCH</code> se mora izvršiti pre nego što se izvrši pozicionirana naredba <code class="language-plaintext highlighter-rouge">UPDATE</code> ili <code class="language-plaintext highlighter-rouge">DELETE</code>).</p>

<p>Sve tačke čuvanja postavljene u okviru transakcije se oslobađaju.</p>

<p>Neka dodatna pravila i napomene koje treba imati u vidu prilikom poništavanja izmena u DB2 sistemu su sledeće:</p>

<ul>
  <li>Snažno se preporučuje da svaki aplikacioni proces eksplicitno završi svoju jedinicu posla pre nego li se završi. Ako se aplikacioni program završi bez <code class="language-plaintext highlighter-rouge">COMMIT</code> ili <code class="language-plaintext highlighter-rouge">ROLLBACK</code> naredbe, onda će SUBP sam pokušati da izvrši operaciju pohranjivanja ili poništavanja u zavisnosti od okruženja aplikacije. Iako su SUBP sistemi napredni, ipak se ne bi trebalo osloniti na njih da rade posao programera.</li>
</ul>

<h2 id="55-poništavanje-izmena">5.5 Poništavanje izmena</h2>

<p>Ukoliko želimo da poništimo izmene koje je napravila jedna transakcija, možemo koristiti SQL naredbu <code class="language-plaintext highlighter-rouge">ROLLBACK</code>. Sintaksa ove naredbe je data u nastavku:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ROLLBACK</span> <span class="p">[</span><span class="k">WORK</span><span class="p">]</span>
<span class="p">[</span><span class="k">TO</span> <span class="n">SAVEPOINT</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">IME_TACKE_CUVANJA</span><span class="o">&gt;</span><span class="p">]]</span>
</code></pre></div></div>

<p>Efekat ove naredbe je da se prekida jedinica posla u kojoj je izvršena naredba <code class="language-plaintext highlighter-rouge">ROLLBACK</code> i nova jedinica posla se inicijalizuje. Sve promene koje su se ostvarile u bazi podataka tokom jedinice posla su poništene. U zavisnosti od odabranih vrednosti narednih opcija prilikom deklaracije naredbe <code class="language-plaintext highlighter-rouge">ROLLBACK</code>, ta naredba može imati različite varijante koje utiču na način izvršavanja:</p>

<ul>
  <li>Navođenjem opcione klauze <code class="language-plaintext highlighter-rouge">TO SAVEPOINT</code>, poništavanje se izvršava parcijalno, odnosno, do poslednje tačke čuvanja. Ukoliko nijedna tačka čuvanja nije aktivna na trenutnom nivou čuvanja, podiže se greška (<code class="language-plaintext highlighter-rouge">SQLSTATE 3B502</code>). Nakon uspešnog poništavanja, navedena tačka čuvanja <code class="language-plaintext highlighter-rouge">&lt;IME_TACKE_CUVANJA&gt;</code> nastavlja da postoji, ali svaka ugnežđena tačka čuvanja se oslobađa i nadalje ne postoji. Ugnežđene tačke čuvanja, ako postoje, smatraju se za poništene i oslobođene kao deo poništavanja do navedene tačke čuvanja. Ukoliko <code class="language-plaintext highlighter-rouge">&lt;IME_TACKE_CUVANJA&gt;</code> nije navedeno, onda se poništavanje vrši do poslednje postavljene tačke čuvanja na tekućem nivou čuvanja.
<br />
<br />
Ako se klauza <code class="language-plaintext highlighter-rouge">TO SAVEPOINT</code> ne postavi, onda naredba <code class="language-plaintext highlighter-rouge">ROLLBACK</code> poništava čitavu transakciju. Dodatno, sve tačke čuvanja u okviru te transakcije se oslobađaju. Ukoliko se navede <code class="language-plaintext highlighter-rouge">&lt;IME_TACKE_CUVANJA&gt;</code>, onda će se poništavanje izvršiti do te imenovane tačke čuvanja. Nakon uspešne operacije poništavanja, navedena imenovana tačka čuvanja nastavlja da postoji. Ukoliko ne postoji imenovana tačka čuvanja sa datim nazivom, podiže se greška (<code class="language-plaintext highlighter-rouge">SQLSTATE 3B001</code>).</li>
</ul>

<p>Neka dodatna pravila i napomene koje treba imati u vidu prilikom poništavanja izmena u DB2 sistemu su sledeće:</p>

<ul>
  <li>
    <p>Svi katanci koji se čuvaju se oslobađaju prilikom izvršavanja naredbe <code class="language-plaintext highlighter-rouge">ROLLBACK</code> za tu jedinicu posla. Svi otvoreni kursori se zatvaraju.</p>
  </li>
  <li>
    <p>Izvršavanje naredbe <code class="language-plaintext highlighter-rouge">ROLLBACK</code> neće uticati na naredbu <code class="language-plaintext highlighter-rouge">RELEASE</code>.</p>
  </li>
  <li>
    <p>Ukoliko se izvršavanje program ne završi normalno, onda je jedinica posla implicitno poništena.</p>
  </li>
  <li>
    <p>Uticaj na kursore koji rezultuje iz naredbe <code class="language-plaintext highlighter-rouge">ROLLBACK TO SAVEPOINT</code> zavisi od naredbi u okviru tačke čuvanja:</p>

    <ul>
      <li>
        <p>Ako tačka čuvanja sadrži DDL za koji je kursor zavisan, kursor se označava za nevalidan. Pokušaji da se takav kursor koristi rezultuju podizanjem greške (<code class="language-plaintext highlighter-rouge">SQLSTATE 57007</code>).</p>
      </li>
      <li>
        <p>Inače:</p>

        <ul>
          <li>
            <p>Ako je kursor referenciran u tački čuvanja, kursor ostaje otvoren i biva pozicioniran ispred narednog logičkog reda rezultujuće tabele. U tom slučaju je potrebno  izvršiti naredbu <code class="language-plaintext highlighter-rouge">FETCH</code> pre nego što se izvrši pozicionirajuća naredba <code class="language-plaintext highlighter-rouge">UPDATE</code> ili <code class="language-plaintext highlighter-rouge">DELETE</code>.</p>
          </li>
          <li>
            <p>Inače, kursor ne potpada pod uticaj naredbe <code class="language-plaintext highlighter-rouge">ROLLBACK TO SAVEPOINT</code> (ostaje otvoren i pozicioniran).</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Naredba <code class="language-plaintext highlighter-rouge">ROLLBACK TO SAVEPOINT</code> će obrisati sve privremeno kreirane ili deklarisane privremene tabele u okviru tačke čuvanja.</p>
  </li>
  <li>
    <p>Svi katanci su sadržani nakon <code class="language-plaintext highlighter-rouge">ROLLBACK TO SAVEPOINT</code> naredbe.</p>
  </li>
</ul>

<p>Naredni primeri ilustruju napredno implementiranje transakcija korišćenjem naredbi <code class="language-plaintext highlighter-rouge">COMMIT</code> i <code class="language-plaintext highlighter-rouge">ROLLBACK</code>.</p>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.3</strong>: Napisati C/SQL program kojim se za svaki ispitni rok, za koji postoji makar jedno polaganje, prvo ispisuju informacije o nazivu i godini roka, a zatim se korisnik pita da li želi da obriše sva polaganja za taj ispitni rok. Ukoliko želi, aplikacija izvršava brisanje i prikazuje poruku korisniku. Obrada jednog ispitnog roka predstavlja jednu transakciju.</p>
</div>

<p>Rešenje:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_5/zadatak_5_3.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">hSchoolYear</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hFinalsName</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span>
     <span class="n">hFinalsLabel</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="c1">// Primetimo da smo morali da navedemo klauzu WITH HOLD ovde</span>
    <span class="c1">// zato sto vrsimo potvrdjivanje izmena tokom obrade kursora.</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cFinals</span> <span class="n">CURSOR</span> <span class="n">WITH</span> <span class="n">HOLD</span> <span class="n">FOR</span> 
        <span class="n">SELECT</span>  <span class="n">NAZIV</span><span class="p">,</span>
                <span class="n">SKGODINA</span><span class="p">,</span>
                <span class="n">OZNAKAROKA</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span> <span class="n">IR</span>
        <span class="n">WHERE</span>   <span class="n">EXISTS</span> <span class="p">(</span>
                    <span class="n">SELECT</span>  <span class="o">*</span>
                    <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span> <span class="n">I</span>
                    <span class="n">WHERE</span>   <span class="n">I</span><span class="p">.</span><span class="n">SKGODINA</span> <span class="o">=</span> <span class="n">IR</span><span class="p">.</span><span class="n">SKGODINA</span> <span class="n">AND</span>
                            <span class="n">I</span><span class="p">.</span><span class="n">OZNAKAROKA</span> <span class="o">=</span> <span class="n">IR</span><span class="p">.</span><span class="n">OZNAKAROKA</span>
                <span class="p">);</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cFinals</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open"</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">cFinals</span> 
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">hFinalsName</span><span class="p">,</span>
                    <span class="o">:</span><span class="n">hSchoolYear</span><span class="p">,</span>
                    <span class="o">:</span><span class="n">hFinalsLabel</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch"</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Obradjujem ispitni rok %s u %hd. godini</span><span class="se">\n</span><span class="s">"</span>
            <span class="s">"Da li zelite da obrisete polaganja u ovom ispitnom roku? [d/n] "</span><span class="p">,</span> <span class="n">hFinalsName</span><span class="p">,</span> <span class="n">hSchoolYear</span><span class="p">);</span>
            
        <span class="kt">char</span> <span class="n">userResponse</span><span class="p">;</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">userResponse</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span> <span class="c1">// Za citanje novog reda</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">userResponse</span> <span class="o">==</span> <span class="sc">'n'</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Preskacem obradu za ovaj ispitni rok</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
            
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span>
            <span class="n">DELETE</span>  <span class="n">FROM</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span>
            <span class="n">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="o">:</span><span class="n">hSchoolYear</span> <span class="n">AND</span>
                    <span class="n">OZNAKAROKA</span> <span class="o">=</span> <span class="o">:</span><span class="n">hFinalsLabel</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Delete"</span><span class="p">);</span>
        
        <span class="c1">// Da nismo naveli klauzu WITH HOLD pri deklaraciji kursora, </span>
        <span class="c1">// onda bi naredni poziv naredbe COMMIT zatvorio kursor,</span>
        <span class="c1">// pa bi poziv FETCH naredbe u narednoj iteraciji petlje prijavio gresku </span>
        <span class="c1">// (jer dohvatamo podatak nad zatvorenim kursorom).</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Commit"</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"Podaci su uspesno obrisani</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cFinals</span><span class="p">;</span>    
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
 

</code></pre></div></div>

<p>Za naredni program je potrebno kreirati tabelu <code class="language-plaintext highlighter-rouge">OBRADJENIPREDMETI</code> sa narednom strukturom:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">OBRADJENIPREDMETI</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">OBRADJENIPREDMETI</span> <span class="p">(</span>
    <span class="n">IDPREDMETA</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">IDPREDMETA</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">IDPREDMETA</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span>
<span class="p">);</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.4</strong>: Napisati C/SQL program koji za svaki predmet koji se ne nalazi u tabeli <code class="language-plaintext highlighter-rouge">OBRADJENIPREDMETI</code> izlistava njegov naziv i ESPB. Korisniku se nudi opcija da poveća broj bodova za 1. Obrada 5 uzastopnih predmeta predstavlja jednu transakciju. Nakon svakog 5. predmeta pitati korisnika da li želi da nastavi sa daljim izmenama. Ukoliko ne želi, program se prekida. U suprotnom, nastaviti sa daljom obradom predmeta.</p>
</div>

<p>Rešenje:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_5/zadatak_5_4.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">hCourseId</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">hCourseESPB</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hCourseName</span><span class="p">[</span><span class="mi">201</span><span class="p">];</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cUnprocessedCourses</span> <span class="n">CURSOR</span> <span class="n">WITH</span> <span class="n">HOLD</span> <span class="n">FOR</span> 
        <span class="n">SELECT</span>  <span class="n">ID</span><span class="p">,</span>
                <span class="n">RTRIM</span><span class="p">(</span><span class="n">NAZIV</span><span class="p">),</span>
                <span class="n">ESPB</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span>
        <span class="n">WHERE</span>   <span class="n">ID</span> <span class="n">NOT</span> <span class="n">IN</span> <span class="p">(</span>
                    <span class="n">SELECT</span>  <span class="n">IDPREDMETA</span>
                    <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">OBRADJENIPREDMETI</span>
                <span class="p">)</span>
        <span class="n">FOR</span>     <span class="n">UPDATE</span> <span class="n">OF</span> <span class="n">ESPB</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cUnprocessedCourses</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open"</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="n">broj_obradjenih</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">cUnprocessedCourses</span> 
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">hCourseId</span><span class="p">,</span>
                    <span class="o">:</span><span class="n">hCourseName</span><span class="p">,</span>
                    <span class="o">:</span><span class="n">hCourseESPB</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch"</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Predmet %s ima broj bodova: %hd.</span><span class="se">\n</span><span class="s">"</span>
            <span class="s">"Da li zelite da povecate broj bodova za 1? [d/n] "</span><span class="p">,</span> <span class="n">hCourseName</span><span class="p">,</span> <span class="n">hCourseESPB</span><span class="p">);</span>
            
        <span class="kt">char</span> <span class="n">userResponse</span><span class="p">;</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">userResponse</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span> <span class="c1">// Za citanje novog reda</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">userResponse</span> <span class="o">==</span> <span class="sc">'d'</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">UPDATE</span>  <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span>
                <span class="n">SET</span>     <span class="n">ESPB</span> <span class="o">=</span> <span class="n">ESPB</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">WHERE</span>   <span class="n">CURRENT</span> <span class="n">OF</span> <span class="n">cUnprocessedCourses</span><span class="p">;</span>
            <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Update"</span><span class="p">);</span>            
            
            <span class="n">printf</span><span class="p">(</span><span class="s">"Podaci su uspesno azurirani</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="c1">// Ubelezavamo u BP da smo obradili tekuci predmet</span>
        <span class="n">EXEC</span> <span class="n">SQL</span>
            <span class="n">INSERT</span>  <span class="n">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">OBRADJENIPREDMETI</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="o">:</span><span class="n">hCourseId</span><span class="p">);</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Insert into"</span><span class="p">);</span>
        
        <span class="c1">// Uvecavamo broj obradjenih predmeta        </span>
        <span class="o">++</span><span class="n">broj_obradjenih</span><span class="p">;</span>
        
        <span class="c1">// Proveravamo da li je kraj jedne transakcije</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">broj_obradjenih</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
            <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Commit"</span><span class="p">);</span>
            
            <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">TRANSAKCIJA JE IZVRSENA</span><span class="se">\n</span><span class="s">"</span>
                <span class="s">"Da li zelite da nastavite obradu? [d/n] "</span><span class="p">);</span>
            <span class="kt">char</span> <span class="n">userResponse</span><span class="p">;</span>
            <span class="n">scanf</span><span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">userResponse</span><span class="p">);</span>
            
            <span class="n">getchar</span><span class="p">();</span> <span class="c1">// Za citanje novog reda</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">userResponse</span> <span class="o">==</span> <span class="sc">'n'</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">broj_obradjenih</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cUnprocessedCourses</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Naredni zadatak ilustruje jednostavan rad sa tačkama čuvanja u okviru transakcija.</p>

<p>Za naredni program je potrebno izvršiti naredne SQL naredbe:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span>  <span class="k">FROM</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
<span class="k">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="mi">2021</span><span class="p">;</span>

<span class="k">DELETE</span>  <span class="k">FROM</span> <span class="n">DA</span><span class="p">.</span><span class="n">SKOLSKAGODINA</span>
<span class="k">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="mi">2021</span><span class="p">;</span>

<span class="k">INSERT</span>  <span class="k">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">SKOLSKAGODINA</span>
<span class="k">VALUES</span>  <span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="s1">'01/01/2021'</span><span class="p">,</span> <span class="s1">'12/31/2021'</span><span class="p">);</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.5</strong>: Napisati C/SQL program koji zahteva od korisnika da unese broj obaveznih ispitnih rokova u 2021. godini. Program zatim unosi za svaki mesec, počevši od januara 2021. godine, po jedan ispitni rok, pa ispisuje sve ispitne rokove. Program zatim pita korisnika da li želi da poništi unos ispitnih rokova koji nisu obavezni. Ukoliko korisnik odgovori potvrdno, poništiti unos neobaveznih ispitnih rokova. U suprotnom, potvrditi sve izmene. Ispisati sve ispitne rokove ponovo.</p>
</div>

<p>Rešenje:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_5/zadatak_5_5.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="c1">// U ovom primeru ilustrujemo kako je moguce smestiti jedan red iz tabele u C strukturu.</span>
<span class="c1">// S obzirom da ova struktura predstavlja jedan ceo red u tabeli DA.ISPITNIROK,</span>
<span class="c1">// neophodno je da redosled polja u strukturi odgovara redosledu kolona u tabeli</span>
<span class="c1">// (iako imena polja i kolona ne moraju da budu identicna).</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">final</span> <span class="p">{</span>
    <span class="n">sqlint32</span> <span class="n">schoolYear</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">finalsLabel</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">finalsName</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">finalsStartDate</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">finalsEndDate</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="p">}</span> <span class="n">hFinal</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Funkcija za pripremanje niza struktura</span>
<span class="c1">// koje sadrze podatke o ispitnim rokovima.</span>
<span class="kt">void</span> <span class="nf">prepareFinalsArray</span><span class="p">(</span><span class="k">struct</span> <span class="n">final</span> <span class="n">finalsArr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">n</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="c1">// Pripremamo niz ispitnih rokova.</span>
    <span class="c1">// Naredni niz ce cuvati generisane ispitne rokove za tekucu godinu.</span>
    <span class="k">struct</span> <span class="n">final</span> <span class="n">finalsArr</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">finalsArr</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">final</span><span class="p">);</span>
    <span class="n">prepareFinalsArray</span><span class="p">(</span><span class="n">finalsArr</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
    
    <span class="c1">// S obzirom da se podaci o jednom ispitnom roku smestaju u strukturu struct final,</span>
    <span class="c1">// potrebno je da redosled kolona u projekciji odgovara redosledu polja u strukturi.</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cFinals</span> <span class="n">CURSOR</span> <span class="n">WITH</span> <span class="n">HOLD</span> <span class="n">FOR</span>
        <span class="n">SELECT</span>  <span class="n">SKGODINA</span><span class="p">,</span>
                <span class="n">OZNAKAROKA</span><span class="p">,</span>
                <span class="n">NAZIV</span><span class="p">,</span>
                <span class="n">DATPOCETKA</span><span class="p">,</span>
                <span class="n">DATKRAJA</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare"</span><span class="p">);</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"Unesite obavezan broj ispitnih rokova: "</span><span class="p">);</span>
    <span class="kt">short</span> <span class="n">numOfFinals</span><span class="p">;</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%hd"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numOfFinals</span><span class="p">);</span>
    <span class="n">getchar</span><span class="p">();</span> <span class="c1">// novi red</span>

    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numOfFinals</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Pripremamo maticnu promenljivu tako sto kopiramo vrednosti iz jedne-po-jedne strukture u nizu</span>
        <span class="n">hFinal</span><span class="p">.</span><span class="n">schoolYear</span> <span class="o">=</span> <span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">schoolYear</span><span class="p">;</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsLabel</span><span class="p">,</span> <span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsLabel</span><span class="p">);</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsName</span><span class="p">,</span> <span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsName</span><span class="p">);</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsStartDate</span><span class="p">,</span> <span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsStartDate</span><span class="p">);</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsEndDate</span><span class="p">,</span> <span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsEndDate</span><span class="p">);</span>
            
        <span class="c1">// Maticna promenljiva tipa struct final se moze koristiti kao i bilo koja druga maticna promenljiva.</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">INSERT</span>  <span class="n">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="o">:</span><span class="n">hFinal</span><span class="p">);</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Unosenje obaveznih ispitnih rokova"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Kreiranje tacke cuvanja</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SAVEPOINT</span> <span class="n">tacka_cuvanja</span> <span class="n">ON</span> <span class="n">ROLLBACK</span> <span class="n">RETAIN</span> <span class="n">CURSORS</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Savepoint"</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">hFinal</span><span class="p">.</span><span class="n">schoolYear</span> <span class="o">=</span> <span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">schoolYear</span><span class="p">;</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsLabel</span><span class="p">,</span> <span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsLabel</span><span class="p">);</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsName</span><span class="p">,</span> <span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsName</span><span class="p">);</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsStartDate</span><span class="p">,</span> <span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsStartDate</span><span class="p">);</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsEndDate</span><span class="p">,</span> <span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsEndDate</span><span class="p">);</span>
        
        <span class="c1">// Maticna promenljiva tipa struct final se moze koristiti i na drugi nacin:</span>
        <span class="c1">// navodjenjem polja te strukture direktno.</span>
        <span class="c1">// INSERT naredba ispod je ekvivalentna INSERT naredbi iznad.</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">INSERT</span>  <span class="n">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="o">:</span><span class="n">hFinal</span><span class="p">.</span><span class="n">schoolYear</span><span class="p">,</span> <span class="o">:</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsLabel</span><span class="p">,</span> <span class="o">:</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsName</span><span class="p">,</span> <span class="o">:</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsStartDate</span><span class="p">,</span> <span class="o">:</span><span class="n">hFinal</span><span class="p">.</span><span class="n">finalsEndDate</span><span class="p">);</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Unosenje ostalih ispitnih rokova"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"----------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cFinals</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open"</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="c1">// Prva verzija koriscenja strukture, ovoga puta u FETCH naredbi.</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">cFinals</span> 
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">hFinal</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch"</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"%5.5d  %7.7s  %18.18s  %10.10s  %10.10s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> 
               <span class="n">hFinal</span><span class="p">.</span><span class="n">schoolYear</span><span class="p">,</span> <span class="n">hFinal</span><span class="p">.</span><span class="n">finalsLabel</span><span class="p">,</span> <span class="n">hFinal</span><span class="p">.</span><span class="n">finalsName</span><span class="p">,</span> <span class="n">hFinal</span><span class="p">.</span><span class="n">finalsStartDate</span><span class="p">,</span> <span class="n">hFinal</span><span class="p">.</span><span class="n">finalsEndDate</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cFinals</span><span class="p">;</span>    
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close"</span><span class="p">);</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"----------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Da li zelite da ponistite unos neobaveznih ispitnih rokova? </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="kt">char</span> <span class="n">userResponse</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userResponse</span> <span class="o">==</span> <span class="sc">'d'</span> <span class="o">||</span> <span class="n">userResponse</span> <span class="o">==</span> <span class="sc">'D'</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Ponistavanje izmena samo do prethodno kreirane tacke cuvanja</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span> <span class="n">TO</span> <span class="n">SAVEPOINT</span> <span class="n">tacka_cuvanja</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Commit"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"----------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cFinals</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open"</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="c1">// Druga verzija koriscenja strukture, ovoga puta u FETCH naredbi.</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">cFinals</span> 
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">hFinal</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch"</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"%5.5d  %7.7s  %18.18s  %10.10s  %10.10s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> 
               <span class="n">hFinal</span><span class="p">.</span><span class="n">schoolYear</span><span class="p">,</span> <span class="n">hFinal</span><span class="p">.</span><span class="n">finalsLabel</span><span class="p">,</span> <span class="n">hFinal</span><span class="p">.</span><span class="n">finalsName</span><span class="p">,</span> <span class="n">hFinal</span><span class="p">.</span><span class="n">finalsStartDate</span><span class="p">,</span> <span class="n">hFinal</span><span class="p">.</span><span class="n">finalsEndDate</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cFinals</span><span class="p">;</span>    
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close"</span><span class="p">);</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"----------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">prepareFinalsArray</span><span class="p">(</span><span class="k">struct</span> <span class="n">final</span> <span class="n">finalsArr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">monthNames</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"Januar"</span><span class="p">,</span> <span class="s">"Februar"</span><span class="p">,</span> <span class="s">"Mart"</span><span class="p">,</span> <span class="s">"April"</span><span class="p">,</span> <span class="s">"Maj"</span><span class="p">,</span> <span class="s">"Jun"</span><span class="p">,</span> <span class="s">"Jul"</span><span class="p">,</span> <span class="s">"Avgust"</span><span class="p">,</span> <span class="s">"Septembar"</span><span class="p">,</span> <span class="s">"Oktobar"</span><span class="p">,</span> <span class="s">"Novembar"</span><span class="p">,</span> <span class="s">"Decembar"</span><span class="p">};</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">schoolYear</span> <span class="o">=</span> <span class="mi">2021</span><span class="p">;</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsLabel</span><span class="p">,</span> <span class="s">"%.3s 21"</span><span class="p">,</span> <span class="n">monthNames</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsName</span><span class="p">,</span> <span class="s">"%s 2021"</span><span class="p">,</span> <span class="n">monthNames</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsStartDate</span><span class="p">,</span> <span class="s">"%2.2d/01/2021"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">finalsArr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">finalsEndDate</span><span class="p">,</span> <span class="s">"%2.2d/10/2021"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Naredni zadaci ilustruju kompleksniju upotrebu tačaka čuvanja u okviru transakcija.</p>

<p>Za naredni program je potrebno izvršiti naredne SQL naredbe:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span>    <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">STATISTIKAPOLAGANJA</span><span class="p">;</span>

<span class="k">CREATE</span>  <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">STATISTIKAPOLAGANJA</span> <span class="p">(</span>
    <span class="n">SKGODINA</span>    <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">OZNAKAROKA</span>  <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">IDPREDMETA</span>  <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">USPESNOST</span>   <span class="nb">DOUBLE</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">SKGODINA</span><span class="p">,</span> <span class="n">OZNAKAROKA</span><span class="p">,</span> <span class="n">IDPREDMETA</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">SKGODINA</span><span class="p">,</span> <span class="n">OZNAKAROKA</span><span class="p">)</span> 
                <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">IDPREDMETA</span><span class="p">)</span>
                <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span>
<span class="p">);</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.6</strong>: Napisati C/SQL program koji izračunava statistiku polaganja predmeta po ispitnim rokovima i te podatke upisuje u tabelu <code class="language-plaintext highlighter-rouge">STATISTIKAPOLAGANJA</code>. Program prvo ispisuje procenat položenih ispita u odnosu na ukupan broj polaganih ispita za predmete po ispitnim rokovima, ali samo za one predmete u ispitnom rokovima koji nemaju statistiku, pa zatim beleži izračunatu statistiku. Nakon unosa polaganja, pitati korisnika da li želi da poništi zabeleženu statistiku, ali omogućiti da se sačuva informacija o tome da je statistika zabeležena (tj. da kolona <code class="language-plaintext highlighter-rouge">USPESNOST</code> bude <code class="language-plaintext highlighter-rouge">NULL</code>). Cela obrada jednog predmeta u jednom ispitnom roku predstavlja jednu transakciju.</p>
</div>

<p>Rešenje:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_5/zadatak_5_6.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">hSchoolYear</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hFinalsLabel</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
<span class="n">sqlint32</span> <span class="n">hCourseId</span><span class="p">;</span>
<span class="kt">double</span> <span class="n">hSuccessPercentage</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>  <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cExamStatistics</span> <span class="n">CURSOR</span> <span class="n">WITH</span> <span class="n">HOLD</span> <span class="n">FOR</span>
        <span class="n">SELECT</span>      <span class="n">SKGODINA</span><span class="p">,</span>
                    <span class="n">OZNAKAROKA</span><span class="p">,</span>
                    <span class="n">IDPREDMETA</span><span class="p">,</span>
                    <span class="n">SUM</span><span class="p">(</span>
                        <span class="n">CASE</span> 
                            <span class="n">WHEN</span> <span class="n">OCENA</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="n">AND</span> <span class="n">STATUS</span><span class="o">=</span><span class="sc">'o'</span> <span class="n">THEN</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> 
                            <span class="n">ELSE</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span> 
                        <span class="n">END</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span> <span class="n">AS</span> <span class="n">USPESNOST</span>
        <span class="n">FROM</span>        <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span> <span class="n">I</span>
        <span class="n">WHERE</span>       <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="p">(</span>
                        <span class="n">SELECT</span>  <span class="o">*</span>
                        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">STATISTIKAPOLAGANJA</span> <span class="n">SP</span>
                        <span class="n">WHERE</span>   <span class="n">SP</span><span class="p">.</span><span class="n">SKGODINA</span> <span class="o">=</span> <span class="n">I</span><span class="p">.</span><span class="n">SKGODINA</span> <span class="n">AND</span>
                                <span class="n">SP</span><span class="p">.</span><span class="n">OZNAKAROKA</span> <span class="o">=</span> <span class="n">I</span><span class="p">.</span><span class="n">OZNAKAROKA</span> <span class="n">AND</span>
                                <span class="n">SP</span><span class="p">.</span><span class="n">IDPREDMETA</span> <span class="o">=</span> <span class="n">I</span><span class="p">.</span><span class="n">IDPREDMETA</span>
                    <span class="p">)</span>
        <span class="n">GROUP</span> <span class="n">BY</span>    <span class="n">SKGODINA</span><span class="p">,</span>
                    <span class="n">OZNAKAROKA</span><span class="p">,</span>
                    <span class="n">IDPREDMETA</span>
        <span class="n">ORDER</span> <span class="n">BY</span>    <span class="n">IDPREDMETA</span> <span class="n">ASC</span><span class="p">,</span>
                    <span class="n">SKGODINA</span> <span class="n">ASC</span><span class="p">,</span>
                    <span class="n">OZNAKAROKA</span> <span class="n">DESC</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare cExamStatistics"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cExamStatistics</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open cExamStatistics"</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">cExamStatistics</span>
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">hSchoolYear</span><span class="p">,</span>
                    <span class="o">:</span><span class="n">hFinalsLabel</span><span class="p">,</span>
                    <span class="o">:</span><span class="n">hCourseId</span><span class="p">,</span>
                    <span class="o">:</span><span class="n">hSuccessPercentage</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch cExamStatistics"</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span>
            <span class="n">INSERT</span>  <span class="n">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">STATISTIKAPOLAGANJA</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="o">:</span><span class="n">hSchoolYear</span><span class="p">,</span> <span class="o">:</span><span class="n">hFinalsLabel</span><span class="p">,</span> <span class="o">:</span><span class="n">hCourseId</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Insert"</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SAVEPOINT</span> <span class="n">tacka_cuvanja</span> <span class="n">ON</span> <span class="n">ROLLBACK</span> <span class="n">RETAIN</span> <span class="n">CURSORS</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Savepoint"</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">UPDATE</span>  <span class="n">DA</span><span class="p">.</span><span class="n">STATISTIKAPOLAGANJA</span>
            <span class="n">SET</span>     <span class="n">USPESNOST</span> <span class="o">=</span> <span class="o">:</span><span class="n">hSuccessPercentage</span>
            <span class="n">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="o">:</span><span class="n">hSchoolYear</span> <span class="n">AND</span>
                    <span class="n">OZNAKAROKA</span> <span class="o">=</span> <span class="o">:</span><span class="n">hFinalsLabel</span> <span class="n">AND</span>
                    <span class="n">IDPREDMETA</span> <span class="o">=</span> <span class="o">:</span><span class="n">hCourseId</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Update"</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Uneta je statistika: %5.2lf%% hSuccessPercentagei za predmet %d u roku %s %hd.</span><span class="se">\n</span><span class="s">"</span>
            <span class="s">"Da li zelite da ponistite unos statistike? [d/n] "</span><span class="p">,</span> <span class="n">hSuccessPercentage</span><span class="p">,</span> <span class="n">hCourseId</span><span class="p">,</span> <span class="n">hFinalsLabel</span><span class="p">,</span> <span class="n">hSchoolYear</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">userResponse</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
        <span class="n">getchar</span><span class="p">();</span> <span class="c1">// novi red</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">userResponse</span> <span class="o">==</span> <span class="sc">'d'</span> <span class="o">||</span> <span class="n">userResponse</span> <span class="o">==</span> <span class="sc">'D'</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">EXEC</span> <span class="n">SQL</span>
                <span class="n">ROLLBACK</span> <span class="n">TO</span> <span class="n">SAVEPOINT</span> <span class="n">tacka_cuvanja</span><span class="p">;</span>
            <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback to savepoint"</span><span class="p">);</span>
            
            <span class="n">printf</span><span class="p">(</span><span class="s">"Statistika o polaganju nije sacuvana, ali je zabelezeno da je izracunata!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Commit"</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cExamStatistics</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close cExamStatistics"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Commit"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Za naredni program je potrebno izvršiti naredne SQL naredbe:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">OBRADJENAPOLAGANJA</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">OBRADJENAPOLAGANJA</span> <span class="p">(</span>
    <span class="n">INDEKS</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">GODINA</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">INDEKS</span><span class="p">,</span> <span class="n">GODINA</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">INDEKS</span><span class="p">)</span>
        <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">DOSIJE</span>
<span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">OBRADJENAPOLAGANJA</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">20180050</span><span class="p">,</span> <span class="mi">2018</span><span class="p">);</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.7</strong>: Napisati C/SQL program kojim se omogućuje da radnik u studentskoj službi poništava studentske ispite. Obrada jednog studenta u jednoj godini roka, koja je opisana u nastavku, mora da predstavlja zasebnu transakciju. Transakcija se sastoji od narednih koraka:</p>

  <ol>
    <li>Aplikacija zahteva od korisnika da unese indeks studenta.</li>
    <li>Aplikacija na osnovu unetog indeksa ispisuje godine rokova u kojima student ima neke položene ispite, ali samo ukoliko već nije prethodno ta godina roka obrađena za tog studenta (ova informacija se čuva u tabeli <code class="language-plaintext highlighter-rouge">OBRADJENAPOLAGANJA</code>).</li>
    <li>Korisnik bira jednu od ispisanih godina.</li>
    <li>Aplikacija pronalazi sve položene ispite za datog studenta u odabranoj godini studija. Za svaki ispit, aplikacija ispisuje naziv položenog predmeta i ocenu koju je student ostvario. Takođe, aplikacija pita korisnika da li želi da poništi tekući ispit čije su informacije ispisane. Ukoliko korisnik odgovori potvrdno, aplikacija poništava tekući ispit. U svakom slučaju, aplikacija prelazi na naredni ispit sve do ispisivanja svih ispita.</li>
    <li>Kada se svi ispiti obrade, aplikacija pita korisnika da potvrdi sve izmene u tekućoj transakciji. Ukoliko korisnik odgovori odrično, onda je potrebno poništiti sve izmene koje se tiču poništavanja ispita iz koraka 4. Međutim, potrebno je omogućiti da, u svakom slučaju, tekuća godina roka za dati indeks bude obrađena (tj. trajno zapamćena u tabeli <code class="language-plaintext highlighter-rouge">OBRADJENAPOLAGANJA</code>).</li>
  </ol>

  <p>Na kraju svake transakcije, aplikacija pita korisnika da li želi da završi sa radom. Ukoliko korisnik odgovori potvrdno, aplikacija se završava. U suprotnom, započinje se nova transakcija sa prethodno opisanim koracima.</p>
</div>

<p>Rešenje: Da bismo lakše modulirali naše rešenje, implementirajmo naredne funkcije:</p>

<ol>
  <li>
    <p>Funkcija <code class="language-plaintext highlighter-rouge">void deklarisi_kursor_za_godine(sqlint32 indeks)</code> vrši deklaraciju čitajućeg kursora sa nazivom <code class="language-plaintext highlighter-rouge">c_godine</code> koji pronalazi godine onih ispitnih rokova u kojem student, čiji je indeks jednak vrednosti parametra <code class="language-plaintext highlighter-rouge">indeks</code> (koja predstavlja matičnu promenljivu koja je globalno deklarisana), ima položene ispite.</p>
  </li>
  <li>
    <p>Funkcija <code class="language-plaintext highlighter-rouge">unsigned godine_polozenih_ispita()</code> ispisuje sve godine iz kursora <code class="language-plaintext highlighter-rouge">c_godine</code>. Funkcija takođe i vraća broj pronađenih godina.</p>
  </li>
  <li>
    <p>Funkcija <code class="language-plaintext highlighter-rouge">void deklarisi_kursor_za_polaganja(sqlint32 indeks, short godina)</code> vrši deklaraciju ažurirajućeg kursora sa nazivom <code class="language-plaintext highlighter-rouge">c_polozeni</code> kojim se može ažurirati vrednost kolone <code class="language-plaintext highlighter-rouge">STATUS_PRIJAVE</code> u tabeli <code class="language-plaintext highlighter-rouge">ISPIT</code> i koji pronalazi naziv predmeta i ocenu za sve položene ispite za studenta sa indeksom <code class="language-plaintext highlighter-rouge">indeks</code> u godini roka <code class="language-plaintext highlighter-rouge">godina</code> (oba parametra predstavljaju matične promenljive). Ovaj kursor mora biti deklarisan klauzom <code class="language-plaintext highlighter-rouge">WITH HOLD</code> zato što se koristi kao deo transakcije.</p>
  </li>
  <li>
    <p>Funkcija <code class="language-plaintext highlighter-rouge">void polaganja_za_studenta_u_godini(sqlint32 indeks, short godina)</code> implementira neophodne operacije koje čine deo transakcije za jednog studenta. Funkcija redom:</p>
  </li>
</ol>

<ul>
  <li>Unosi informacije (<code class="language-plaintext highlighter-rouge">INSERT</code>) o indeksu i godini roka u tabelu <code class="language-plaintext highlighter-rouge">OBRADJENAPOLAGANJA</code>.</li>
  <li>Kreira tačku čuvanja, kako bismo mogli da eventualno poništimo sve izmene, osim unosa u tabelu iz prethodne tačke.</li>
  <li>Prolazi kroz kursor <code class="language-plaintext highlighter-rouge">c_polozeni</code>. Za svaki red ispisuje informacije iz kursora i ukoliko korisnik potvrdi poništavanje ispita, izvršava odgovarajuće ažuriranje (<code class="language-plaintext highlighter-rouge">UPDATE</code>).</li>
  <li>Postavlja pitanje korisniku da li želi da potvrdi izmene. Ukoliko je odgovor negativan, funkcija poništava sve izmene, ali ne i izmenu koja je učinjena u prvoj tački (tj. naredbu <code class="language-plaintext highlighter-rouge">INSERT</code> iznad), pošto bez obzira na poništavanje ažuriranja, želimo da informacija o obrađivanju bude trajno upisana.</li>
</ul>

<p>Funkcija <code class="language-plaintext highlighter-rouge">int main()</code> je sada poprilično jednostavna. Nakon povezivanja na bazu podataka i deklarisanja kursora (pozivom funkcija pod 1 i 3 iznad), započinje se iterativni proces koji predstavlja jednu transakciju. Svaka transakcija se sastoji od opisanih operacija iz teksta zadatka, tako što se pozivaju odgovarajuće funkcije (pod 2 i 4 iznad). Naravno, da bi svaka iteracija predstavljala jednu transakciju, potrebno je da se na kraju iteracije izvrši naredba <code class="language-plaintext highlighter-rouge">COMMIT</code>.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_5/zadatak_5_7.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">hIndex</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">hSchoolYear</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hCourseName</span><span class="p">[</span><span class="mi">201</span><span class="p">];</span>
<span class="kt">short</span> <span class="n">hGrade</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">declareSchoolYearsCursor</span><span class="p">(</span><span class="n">sqlint32</span> <span class="n">hIndex</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">declareExamsCursor</span><span class="p">(</span><span class="n">sqlint32</span> <span class="n">hIndex</span><span class="p">,</span> <span class="kt">short</span> <span class="n">hSchoolYear</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="nf">iterOverSchoolYearsCursor</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">iterOverExamsCursor</span><span class="p">(</span><span class="n">sqlint32</span> <span class="n">hIndex</span><span class="p">,</span> <span class="kt">short</span> <span class="n">hSchoolYear</span><span class="p">);</span>

<span class="kt">char</span> <span class="n">userResponse</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="n">declareSchoolYearsCursor</span><span class="p">(</span><span class="n">hIndex</span><span class="p">);</span>
    <span class="n">declareExamsCursor</span><span class="p">(</span><span class="n">hIndex</span><span class="p">,</span> <span class="n">hSchoolYear</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">----------POCETAK TRANSAKCIJE----------</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"Unesite indeks studenta: "</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hIndex</span><span class="p">);</span>
        
        <span class="kt">unsigned</span> <span class="n">numOfSchoolYears</span> <span class="o">=</span> <span class="n">iterOverSchoolYearsCursor</span><span class="p">();</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">numOfSchoolYears</span> <span class="o">==</span> <span class="mi">0u</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span>
                <span class="s">"Za datog studenta ne postoji obradjena godina "</span>
                <span class="s">"u kojoj su polagali neke ispite</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"Unesite jednu od ponudjenih godina polaganja: "</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%hd"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hSchoolYear</span><span class="p">);</span>
        
        <span class="n">iterOverExamsCursor</span><span class="p">(</span><span class="n">hIndex</span><span class="p">,</span> <span class="n">hSchoolYear</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Commit transakcije"</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">----------KRAJ TRANSAKCIJE----------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Da li zelite da nastavite dalje? [da/ne] "</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">userResponse</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">userResponse</span><span class="p">,</span> <span class="s">"da"</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Commit"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">declareSchoolYearsCursor</span><span class="p">(</span><span class="n">sqlint32</span> <span class="n">hIndex</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cSchoolYears</span> <span class="n">CURSOR</span> <span class="n">FOR</span>
        <span class="n">SELECT</span>  <span class="n">DISTINCT</span> 
                <span class="n">SKGODINA</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span> <span class="n">I</span>
        <span class="n">WHERE</span>   <span class="n">INDEKS</span> <span class="o">=</span> <span class="o">:</span><span class="n">hIndex</span> <span class="n">AND</span>
                <span class="n">OCENA</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="n">AND</span>
                <span class="n">STATUS</span> <span class="o">=</span> <span class="sc">'o'</span> <span class="n">AND</span>
                <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="p">(</span>
                    <span class="n">SELECT</span>  <span class="o">*</span>
                    <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">OBRADJENAPOLAGANJA</span>
                    <span class="n">WHERE</span>   <span class="n">INDEKS</span> <span class="o">=</span> <span class="o">:</span><span class="n">hIndex</span> <span class="n">AND</span>
                            <span class="n">GODINA</span> <span class="o">=</span> <span class="n">I</span><span class="p">.</span><span class="n">SKGODINA</span>
                <span class="p">)</span>
        <span class="n">FOR</span>     <span class="n">READ</span> <span class="n">ONLY</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare cSchoolYears"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">declareExamsCursor</span><span class="p">(</span><span class="n">sqlint32</span> <span class="n">hIndex</span><span class="p">,</span> <span class="kt">short</span> <span class="n">hSchoolYear</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cExams</span> <span class="n">CURSOR</span> <span class="n">WITH</span> <span class="n">HOLD</span> <span class="n">FOR</span>
        <span class="n">SELECT</span>  <span class="p">(</span>
                    <span class="n">SELECT</span>  <span class="n">TRIM</span><span class="p">(</span><span class="n">P</span><span class="p">.</span><span class="n">NAZIV</span><span class="p">)</span>
                    <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span> <span class="n">P</span>
                    <span class="n">WHERE</span>   <span class="n">I</span><span class="p">.</span><span class="n">IDPREDMETA</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">ID</span>
                <span class="p">)</span> <span class="n">AS</span> <span class="n">NAZIV_PREDMETA</span><span class="p">,</span>
                <span class="n">I</span><span class="p">.</span><span class="n">OCENA</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span> <span class="n">I</span>
        <span class="n">WHERE</span>   <span class="n">I</span><span class="p">.</span><span class="n">INDEKS</span> <span class="o">=</span> <span class="o">:</span><span class="n">hIndex</span> <span class="n">AND</span>
                <span class="n">I</span><span class="p">.</span><span class="n">SKGODINA</span> <span class="o">=</span> <span class="o">:</span><span class="n">hSchoolYear</span> <span class="n">AND</span>
                <span class="n">OCENA</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="n">AND</span>
                <span class="n">STATUS</span> <span class="o">=</span> <span class="sc">'o'</span>
        <span class="n">FOR</span>     <span class="n">UPDATE</span> <span class="n">OF</span> <span class="n">STATUS</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare cExams"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="nf">iterOverSchoolYearsCursor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">numOfSchoolYears</span> <span class="o">=</span> <span class="mi">0u</span><span class="p">;</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cSchoolYears</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open cSchoolYears"</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">cSchoolYears</span>
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">hSchoolYear</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch cSchoolYears"</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">%hd</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hSchoolYear</span><span class="p">);</span>
        <span class="o">++</span><span class="n">numOfSchoolYears</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cSchoolYears</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close cSchoolYears"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="n">numOfSchoolYears</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iterOverExamsCursor</span><span class="p">(</span><span class="n">sqlint32</span> <span class="n">hIndex</span><span class="p">,</span> <span class="kt">short</span> <span class="n">hSchoolYear</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">INSERT</span>  <span class="n">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">OBRADJENAPOLAGANJA</span>
        <span class="n">VALUES</span>  <span class="p">(</span><span class="o">:</span><span class="n">hIndex</span><span class="p">,</span> <span class="o">:</span><span class="n">hSchoolYear</span><span class="p">);</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Insert into"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span>
        <span class="n">SAVEPOINT</span> <span class="n">s_obradjeni</span> <span class="n">ON</span> <span class="n">ROLLBACK</span> <span class="n">RETAIN</span> <span class="n">CURSORS</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Savepoint"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cExams</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open cExams"</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">cExams</span>
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">hCourseName</span><span class="p">,</span>
                    <span class="o">:</span><span class="n">hGrade</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch cExams"</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"%s, %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hCourseName</span><span class="p">,</span> <span class="n">hGrade</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Da li zelite da ponistite ispit? [da/ne] "</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">userResponse</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">userResponse</span><span class="p">,</span> <span class="s">"da"</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span>
            <span class="n">UPDATE</span>  <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span>
            <span class="n">SET</span>     <span class="n">STATUS</span> <span class="o">=</span> <span class="sc">'x'</span>
            <span class="n">WHERE</span>   <span class="n">CURRENT</span> <span class="n">OF</span> <span class="n">cExams</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Update"</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cExams</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close cExams"</span><span class="p">);</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"Da li zelite da potvrdite sve izmene za tekuceg studenta? [da/ne] "</span><span class="p">);</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">userResponse</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">userResponse</span><span class="p">,</span> <span class="s">"da"</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span> <span class="n">TO</span> <span class="n">SAVEPOINT</span> <span class="n">s_obradjeni</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback to savepoint"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h2 id="56-zadaci-za-vežbu">5.6 Zadaci za vežbu</h2>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.8</strong>: Napisati C/SQL program koji redom:</p>

  <ol>
    <li>Kreira novi ispitni rok u 2020. godini čija je oznaka <code class="language-plaintext highlighter-rouge">'apr'</code> i naziv <code class="language-plaintext highlighter-rouge">'April 2021'</code>. Za početak prijavljivanja postaviti današnji datum i postaviti da prijavljivanje traje 15 dana.</li>
    <li>Ažurira datum kraja prijavljivanja za prethodno uneti ispitni rok tako što smanjuje trajanje prijavljivanja za 5 dana.</li>
  </ol>

  <p>Obezbediti da se navedene operacije izvrše zasebno.</p>
</div>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.9</strong>: Napisati C/SQL program koji koji pronalazi indekse i nazive predmeta za sva polaganja koja su bila neuspešna. Sortirati podatke po indeksu rastuće. Obezbediti da aplikacija briše podatke o najviše 10 studenata. Jednu transakciju čine brisanja za sve pronađene studente. Prilikom obrade podataka, ispisati informacije o indeksu studenta, a zatim prikazati nazive predmeta za obrisana polaganja tog studenta. Nakon brisanja podataka o jednom studentu, upitati korisnika da li želi da poništi izmene za tog studenta (voditi računa da brisanja za sve prethodne studente ostanu nepromenjena).</p>
</div>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.10</strong>: Napisati C/SQL program koji za svaki predmet koji je obavezan na smeru čiji je identifikator 103, pita korisnika da li želi da poveća broj bodova za 1. Ukoliko je odgovor korisnika ‘da’, izvršava se odgovarajuća naredba. Obrada jednog predmeta treba da predstavlja jednu transakciju.</p>
</div>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.11</strong>: Napisati C/SQL program koji za svaki predmet koji je obavezan na smeru čiji je identifikator 101 pronalazi i ispisuje uslovne predmete, a zatim pita korisnika da li želi da poveća ukloni uslovnosti za tekući predmet. Ukoliko je odgovor korisnika ‘da’, aplikacija izvršava brisanje i prikazuje korisniku poruku. Obrada jednog predmeta treba da predstavlja jednu transakciju.</p>
</div>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.12</strong>: Napisati C/SQL program koji omogućava studentu prijavu na praksu i redom:\n
\n</p>
  <ol>
    <li>Ispisuje spisak identifikatora i naziva predmeta za koje može da se prijavi student sa brojem indeksa koji se unosi sa standardnog ulaza. Studentu se nude samo predmeti koje je položio sa ocenom većom od prosečne ocene sa položenih ispita iz tog predmeta i oni koji se ne nalaze u tabeli <code class="language-plaintext highlighter-rouge">PRAKSA2020</code> za odabranog studenta. \n</li>
    <li>Omogućava odabir jednog predmeta unosom odgovarajućeg identifikatora sa spiska ili unos 0 za kraj. Odabrani predmet se unosu u tabelu <code class="language-plaintext highlighter-rouge">PRAKSA2020</code> ukoliko ispunjava uslove. Posle svakog odabranog predmeta, program nudi studentu izmenjeni spisak predmeta na kom se ne nalaze već odabrani predmeti i postupak se ponavlja. \n</li>
    <li>Ispisuje izveštaj koji za svaki prijavljeni predmet sadrži naziv predmeta, broj do tada prijavljenih studenata za praksu iz tog predmeta, prosečnu prolaznost iz tog predmeta. Izveštaj urediti opadajuće po prolaznosti. Prolaznost se računa kao količnik broja položenih ispita sa ocenom većom od 5 nevezano za status prijave i broj izlazaka na ispit (broj unosa u tabeli <code class="language-plaintext highlighter-rouge">ISPIT</code> sa statusom prijave različitim od <code class="language-plaintext highlighter-rouge">n</code>). \n</li>
  </ol>

  <p>Obrada jedne prijave na praksu treba da predstavlja jednu transakciju.</p>
</div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">PRAKSA2020</span> <span class="p">(</span>
    <span class="n">INDEKS</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">IDPREDMETA</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">INDEKS</span><span class="p">,</span> <span class="n">IDPREDMETA</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">INDEKS</span><span class="p">)</span>
        <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">DOSIJE</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">IDPREDMETA</span><span class="p">)</span>
        <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.13</strong>: Napisati C/SQL program koji omogućava korisniku da unese nove ispitne rokove u 2020. godini za svaki mesec od aprila do oktobra, sa odgovarajućim oznakama i nazivima. Za svaki ispitni rok postaviti da je datum početka prijavljivanja današnji datum pomeren za odgovarajući broj meseci, kao i da prijavljivanje traje 20 dana.</p>

  <p>Omogućiti da korisnik unese broj ispitnih rokova koji želi da kreira. Minimalni broj ispitnih rokova je 0, a maksimalni broj je 6. U zavisnosti od unetog broja, kreirati odgovarajući broj ispitnih rokova.</p>

  <p>Obezbediti da se navedene operacije izvrše zasebno.</p>
</div>

<div class="ui stacked segment">
  <p><strong>Zadatak 5.14</strong>: Napisati C/SQL program koji omogućava korisniku da obriše informacije o studentima koji su upisani u godini koja se unosi sa standardnog ulaza. Za svakog studenta, program pita korisnika da li želi da obriše informacije. Ako korisnik potvrdi, obrisati podatke iz tabela <code class="language-plaintext highlighter-rouge">ISPIT</code>, <code class="language-plaintext highlighter-rouge">UPISANKURS</code>, <code class="language-plaintext highlighter-rouge">UPISGODINE</code>, <code class="language-plaintext highlighter-rouge">PRIZNATIISPIT</code>, <code class="language-plaintext highlighter-rouge">DOSIJEEXT</code> i <code class="language-plaintext highlighter-rouge">DOSIJE</code> (tim redosledom) za tekućeg studenta i ispisati poruku o uspešnosti brisanja za svaku tabelu ponaosob. Nakon toga, aplikacija pita korisnika da li želi da izvrši potvrđivanje ili poništavanje dotadašnjih izmena. Korisnik može da bira jednu od tri opcije:</p>

  <ol>
    <li>Izvršavanje potvrđivanja</li>
    <li>Izvršavanje poništavanja</li>
    <li>Bez akcije</li>
  </ol>

  <p>U slučaju akcija 1. i 2. potrebno je izvršiti odgovarajuću SQL naredbu i prikazati poruku korisniku o uspešnosti akcije. Takođe ispisati i informaciju o tome za koliko studenata je izvršeno potvrđivanje/poništavanje, na primer: <code class="language-plaintext highlighter-rouge">'TRANSAKCIJA JE ZAVRSENA: POTVRDILI STE BRISANJE 7 STUDENATA'</code> ili <code class="language-plaintext highlighter-rouge">'TRANSAKCIJA JE ZAVRSENA: PONIŠTILI STE BRISANJE 7 STUDENATA'</code> (ukoliko je pre tekuće akcije korisnik 7 puta odabrao 3. akciju).</p>

  <p>U slučaju akcije 3. potrebno je samo uvećati broj studenata koji je obrisan u tekućoj jedinici posla. Naravno, prilikom izvršavanja akcije 1. ili 2. ovaj broj se mora postaviti na 0.</p>
</div>

        </div>
    </div>

    <script>
        $('#pageSticky').sticky({
            context: '#pageContent'
        });

        $('#pageSticky').click(function () {
            $('#sideMenu').sidebar('toggle');
        });
    </script>
</body>

</html>