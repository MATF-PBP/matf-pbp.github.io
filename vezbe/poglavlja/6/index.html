<!DOCTYPE html>
<html lang="rs">
<head>
    <title>6. Aplikacije u višekorisničkom okruženju | Programiranje baza podataka</title>
    <meta charset="utf-8">

    <link rel="stylesheet" type="text/css" href="/resources/semantic/semantic.min.css">
    <script src="/resources/jquery/jquery-3.5.1.min.js"></script>
    <script src="/resources/semantic/semantic.min.js"></script>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <script src="https://semantic-ui.com/javascript/library/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
        $(document).ready(() => {
            $("table").addClass('ui celled table');
        });
    </script>
</head>

<body>
    <div class="ui sticky black big launch right attached fixed button" id="pageSticky">
        <i class="content icon"></i>
        <span class="text">Prikaži sadržaj</span>
    </div>

    <div class="ui sidebar vertical menu" id="sideMenu">
        <div class="item">
            <h3>Sadržaj</h3>
        </div>
        <a class="item" href="/vezbe/predgovor">Predgovor</a>
        <a class="item" href="/vezbe/poglavlja/1">1. Uvod u programiranje baza podataka</a>
        <a class="item" href="/vezbe/poglavlja/2">2. Osnovni koncepti programiranja C/SQL aplikacija</a>
        <a class="item" href="/vezbe/poglavlja/3">3. Programiranje korišćenjem kursora</a>
        <a class="item" href="/vezbe/poglavlja/4">4. Aplikacije sa dinamičkim SQL naredbama</a>
        <a class="item" href="/vezbe/poglavlja/5">5. Implementiranje transakcija</a>
        <a class="item" href="/vezbe/poglavlja/6">6. Aplikacije u višekorisničkom okruženju</a>
        <a class="item" href="/vezbe/poglavlja/7">7. Povezivanje aplikacija na više baza podataka</a>
        <a class="item" href="/vezbe/poglavlja/8">8. Osnovni koncepti programiranja Java/SQL aplikacija sa
            dinamičkim SQL naredbama (JDBC)</a>
        <a class="item" href="/vezbe/poglavlja/9">9. Napredne tehnike razvijanja Java/SQL aplikacija</a>
        <a class="item" href="/vezbe/poglavlja/10">10. Uvod u razvojno okruženje Hibernate</a>
        <a class="item" href="/vezbe/poglavlja/11">11. Napredna objektno-relaciona preslikavanja</a>
        <a class="item" href="/vezbe/poglavlja/12">12. Napredno kreiranje upita pomoću JPA Criteria API</a>
        <a class="item" href="/vezbe/poglavlja/13">13. Programiranje SQL rutina</a>
        <a class="item" href="/vezbe/poglavlja/14">14. Korisnički-definisane funkcije</a>
        <a class="item" href="/vezbe/poglavlja/15">15. Ugrađene procedure</a>
        <a class="item" href="/vezbe/poglavlja/16">16. Okidači</a>
    </div>

    <div class="ui justified container">
        <img class="ui centered small image" src="/resources/matf-srb.png">
        <header class="ui center aligned block header">
            <h1><a href="/">Programiranje baza podataka</a></h1>
        </header>

        <div class="ui divider"></div>

        <div id="pageContent">
            <h2>6. Aplikacije u višekorisničkom okruženju</h2>


<div class="ui warning message">
    <div class="header">
        Ova stranica je pod konstrukcijom!
    </div>
    Ako pronađete grešku ili propust, molimo Vas da nam skrenete pažnju otvaranjem primedbe na <a href="https://github.com/MATF-PBP/matf-pbp.github.io"><i class="github icon"></i>zvaničnom GitHub repozitorijumu</a>.
</div>


<p>Ovo poglavlje je posvećeno dizajnu aplikacija koje koriste baze podataka, a za koje se očekuje da će biti izvršavane u višekorisničkom okruženju. Ovo podrazumeva da je potrebno uvesti dodatne mere u slučaju da više aplikacija želi da pristupi nekom objektu u bazi podataka (na primer, određenom redu ili tabeli).</p>

<h2 id="61-aplikacioni-proces-i-konkurentnost">6.1 Aplikacioni proces i konkurentnost</h2>

<p>Svi SQL-aplikativni programi se izvršavaju kao deo <em>aplikacionih procesa</em> ili <em>agenata</em>. Aplikacioni proces podrazumeva izvršavanje jednog ili više programa, i predstavlja jedinicu kojoj SUBP alocira resurse i katance. Različiti aplikacioni procesi mogu da povlače sa sobom izvršavanje različitih programa ili različita izvršavanja istog programa.</p>

<p>U višekorisničkom okruženju, osnovna pretpostavka je da više od jednog aplikacionog procesa može da zahteva pristup istim podacima u isto vreme. U tu svrhu, da bi se obezbedio integritet podataka, potrebno je implementirati i koristiti mehanizam poznat pod nazivom zaključavanje.</p>

<p><em>Zaključavanje</em> (engl. <em>locking</em>) predstavlja mehanizam zasnovan na katancima koji se koristi za održavanje integriteta podataka pod uslovima višekorisničkog okruženja.</p>

<p>Korišćenjem zaključavanja se može sprečiti da, na primer, dva aplikaciona procesa izvrše ažuriranje istog reda u isto vreme.</p>

<p>SUBP upravlja katancima da bi onemogućio da nepotvrđene izmene napravljene od strane jednog aplikacionog procesa budu vidljive od bilo kog drugog procesa. U trenutku kada se neki proces završi, tada se svi katanci koje je proces dobio od strane RSUBP, i držao ih, oslobađaju. Ipak, aplikacioni proces može da eksplicitno zahteva da se neki katanac oslobodi ranije. Ovo je omogućeno korišćenjem operacije potvrđivanja izmena, koja oslobađa katance koji su dobijeni tokom jedinice posla i koja, takođe, potvrđuje sve izmene koje su obavljene tokom te jedinice posla.</p>

<p>Direktni pozivi DB2 funkcija i ugnežđeni SQL omogućavaju režim konekcije koji se naziva <em>konkurentne transakcije</em> (engl. <em>concurrent transactions</em>) kojim se omogućavaju višestruke konekcije ka bazama podataka, pri čemu svaka od njih predstavlja nezavisnu transakciju.</p>

<p>Aplikacija može da ima više konkurentnih konekcija ka istoj bazi podataka.</p>

<h2 id="62-katanci">6.2 Katanci</h2>

<p>Kao što smo rekli, katanci predstavljaju osnovni alat za uspostavljanje mehanizma zaključavanja. Svaki katanac ima odgovarajuće karakteristike:</p>

<ul>
  <li>
    <p><em>Režim</em> (engl. <em>mode</em>) definiše tip pristupa koji je dozvoljen procesu koji drži ključ, kao i tip pristupa koji je dozvoljen konkurentnim procesima. Ponekad se režim katanca naziva i <em>stanje</em> (engl. <em>state</em>) katanca.</p>
  </li>
  <li>
    <p><em>Objekat</em> (engl. <em>database object</em>) definiše resurs nad kojim se primenjuje operacija zaključavanja. Jedini tip objekta koji se može programerski zaključati jeste tabela (za više informacija, videti sekciju <a href="#64-programersko-zaključavanje-tabela">6.4</a>). SUBP ima pravo da postavi katanac na druge objekte u bazi podataka, kao što su: redovi, prostori tabela, blokovi, particije podataka, i dr.</p>
  </li>
  <li>
    <p><em>Trajanje</em> (engl. <em>lock count</em>) definiše dužinu vremena tokom kojeg je katanac bio držan od strane procesa. Trajanje katanca se određuje nivoom izolovanosti pod kojim se naredba pokreće (za više informacija o nivoima izolovanosti, videti sekciju <a href="#63-nivoi-izolovanosti">6.3</a>).</p>
  </li>
</ul>

<p>DB2 sistem nudi podršku za različite režime katanaca. Mi ćemo prikazati samo najosnovnije, poređane rastuće po restrikciji koju obezbeđuju:</p>

<ul>
  <li>
    <p><em>IN</em> (engl. <em>intent none</em>) definiše da vlasnik katanca može da čita sve podatke u tabeli, uključujući i nepotvrđene podatke, ali ne može da ih menja. Druge konkurentne aplikacije mogu da čitaju ili da ažuriraju tabelu. Ne postavljaju se nikakvi katanci na redovima.</p>
  </li>
  <li>
    <p><em>IS</em> (engl. <em>intent share</em>) definiše da vlasnik katanca može da čita proizvoljan podatak u tabeli ako se <em>S</em> katanac može dobiti na redovima ili stranicama od interesa.</p>
  </li>
  <li>
    <p><em>IX</em> (engl. <em>intent exclusive</em>) definiše da vlasnik katanca može da čita ili menja proizvoljni podatak u tabeli ako važe naredna dva uslova:</p>

    <ul>
      <li>
        <p><em>X</em> katanac se može dobiti na redovima ili stranicama koje želimo da menjamo.</p>
      </li>
      <li>
        <p><em>S</em> ili <em>U</em> katanac se može dobiti na redovima koje želimo da čitamo.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><em>SIX</em> (engl. <em>share with intent exclusive</em>) definiše da vlasnik katanca može da čita sve podatke iz tabele i da menja redove ako može da dobije <em>X</em> katanac na tim redovima. Za čitanje se ne dobijaju katanci na redovima. Druge konkurentne aplikacije mogu da čitaju iz tabele. <em>SIX</em> katanac se dobija ako aplikacija ima <em>IX</em> katanac na tabeli i onda se zahteva <em>S</em> katanac ili obratno.</p>
  </li>
  <li>
    <p><em>S</em> (engl. <em>share</em>) definiše da vlasnik katanca moze da čita proizvoljan podatak u tabeli i neće dobiti katance na redovima ili stranicama.</p>
  </li>
  <li>
    <p><em>U</em> (engl. <em>update</em>) definiše da vlasnik katanca može da čita proizvoljan podatak u tabeli i može da menja podatke ako se na tabeli može dobiti <em>X</em> katanac. Pritom se ne dobijaju nikakvi katanci na redovima ili stranicama.</p>
  </li>
  <li>
    <p><em>X</em> (engl. <em>exclusive</em>) definiše da vlasnik katanca može da čita i da menja proizvoljan podatak iz tabele. Pritom se ne dobijaju nikakvi katanci na redovima ili stranicama.</p>
  </li>
  <li>
    <p><em>Z</em> (engl. <em>super exclusive</em>) katanac se zahteva na tabeli u posebnim prilikama, kao što su recimo menjanje strukture tabele ili njeno brisanje. Nijedna druga aplikacija (ni ona sa nivoom izolovanosti “nepotvrđeno čitanje”, videti sekciju <a href="#53-nivoi-izolovanosti">6.3</a>) ne može da čita niti da ažurira podatke u tabeli.</p>
  </li>
</ul>

<p>Očigledno, primenom različitih vrsta katanaca, može doći do sukoba u smislu da li SUBP treba da dodeli katanac nekom aplikacionom procesu kada postoji drugi aplikacioni proces koji već drži katanac nad istim objektom. Samo u slučaju kada su katanci <em>kompatibilni</em> će SUBP dodeliti drugi katanac.</p>

<p>U slučaju da katanci nisu kompatibilni, nije moguće dodeliti traženi katanac aplikacionom procesu. Tada taj proces mora da pređe u stanje čekanja dok proces ne oslobodi nekompatibilni katanac koji drži, kao i dok se svi ostali nekompatibilni katanci ne oslobode. U nekim slučajevima može doći do <em>isteka vremena</em> (engl. <em>timeout</em>) dok zatražilac čeka na katanac. O tome će nešto detaljnije biti reči u nastavku, a za sada ćemo prikazati kompatibilnosti između katanaca u narednoj tabeli. Oznaka <em>N</em> znači da nad resursom nema katanca, odnosno, da aplikacioni proces ne traži katanac.</p>

<p><img src="/vezbe/poglavlja/6/Slike/tabela-kompatibilnosti-katanaca.png" alt="&quot;Tabela kompatibilnosti katanaca.&quot;" class="ui centered large image" /></p>

<h3 id="621-konverzija-i-ekskalacija-katanaca">6.2.1 Konverzija i ekskalacija katanaca</h3>

<p>Konverzija katanca se ostvaruje u situacijama kada aplikacioni proces pristupa objektu nad kojim već drži katanac, a taj pristup zahteva restriktivniji katanac od onog koji se već drži. Proces nad objektom može da drži najviše jedan katanac u nekom trenutku, ali može da traži različite katance nad istim objektom indirektno kroz izvršavanje naredbi.</p>

<p>Promena režima katanca koji se već drži se naziva <em>konverzija katanca</em> (engl. <em>lock conversion</em>).</p>

<p>Neki režimi katanaca se primenjuju samo za tabele, neki samo za redove, blokove ili particije podataka. Za redove ili blokove, konverzija se uglavnom izvršava ukoliko se traži katanac <em>X</em>, a već se drži katanac <em>S</em> ili <em>U</em>.</p>

<p>Katanci <em>IX</em> i <em>S</em> imaju specijalan odnos — nijedan od ova dva katanca se smatra restriktivnijim u odnosu na drugi. Ukoliko aplikacioni proces drži jedan od ova dva katanca i zahteva drugi, onda će se izvršiti konverzija u katanac <em>SIX</em>. Sve ostale konverzije se vrše po narednom principu: <strong>Ukoliko je katanac koji se zahteva restriktivniji u odnosu na katanac koji se drži, onda se katanac koji se drži konvertuje u katanac koji se zahteva.</strong></p>

<p>Naravno, da bi se uspešno izvršila konverzija katanca, nad objektom nad kojim se zahteva novi katanac ne sme postojati neki drugi katanac koji je nekompatibilan sa njim.</p>

<p>Da bi se uslužio što veci broj aplikacija, menadžer baza podataka omogucava funkciju <em>ekskalacije katanaca</em>. Ovaj proces objedinjuje proces dobijanja katanca na tabeli i oslobađanja katanaca na redovima. Željeni efekat  je da se smanje ukupni zahtevi skladištenja za katance od strane menadžera baza podataka. Ovo ́ce omoguciti drugim aplikacijama da dobiju željene katance. Dva konfiguraciona parametra baze podataka imaju direktan uticaj na proces ekskalacije katanaca:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">locklist</code>: to je prostor u globalnoj memoriji baze podataka koji se koristi za skladištenje katanaca,</li>
  <li><code class="language-plaintext highlighter-rouge">maxlocks</code>: to je procenat ukupne liste katanaca koji je dozvoljeno da drži jedna aplikacija.</li>
</ul>

<p>Oba parametra su konfigurabilna.</p>

<p>Ekskalacija katanaca se dešava u dva slučaja:</p>

<ul>
  <li>Aplikacija zahteva katanac koji bi proizveo da ona prevaziđe procenat ukupne veličine liste katanaca, koji je definisan parametrom <code class="language-plaintext highlighter-rouge">maxlocks</code>. U ovoj situaciji menadžer baze podataka ́ce pokušati da oslobodi memorijski prostor dobijanjem jednog katanca na tabelu, a oslobađanjem katanaca na redove te tabele.</li>
  <li>Aplikacija ne može da dobije katanac jer je lista katanaca puna. Menadžer baze podataka ́ce pokušati da oslobodi memorijski prostor tako što ́ce dobiti katanac na tabelu, a osloboditi katance na redove te tabele. Primetimo da aplikacija koja pokrece ekskalaciju katanaca može, ali i ne mora da drži značajan broj katanaca.</li>
</ul>

<p>Ekskalacija katanaca može da ne uspe. Ako se desi greška, aplikacija koja je pokrenula ekskalaciju dobiće vrednost <code class="language-plaintext highlighter-rouge">SQLCODE</code> -912. Ovaj kod bi trebaloda bude obrađen programski od strane aplikacije.</p>

<h3 id="622-istek-vremena-i-mrtva-petlja">6.2.2 Istek vremena i mrtva petlja</h3>

<p>Već smo napomenuli da, ukoliko aplikacija zahteva katanac nad objektom koji je nekompatibilan sa katancem koji već postoji nad istim objektom, ona ulazi u fazu čekanja dok se taj katanac ne oslobodi. Neka, na primer, jedna transakcija čeka na katanac koji drži neka korisnička aplikacija. Ukoliko korisnik koji koristi tu aplikaciju napusti aplikaciju bez da dozvoli potvrđivanje izmena, onda se katanac ne oslobađa nad tim objektom i transakcija može da čeka beskonačno dugo.</p>

<p>SUBP ima poseban mehanizam kojim se može sprečiti da aplikacija beskonačno dugo čeka na oslobađanje katanca i koji se naziva <em>detekcija isteka vremena</em> (engl. <em>lock timeout detection</em>). Ovaj mehanizam se oslanja na korišćenje <code class="language-plaintext highlighter-rouge">locktimeout</code> parametra podešavanja baze podataka i predstavlja najduže vreme koje transakcija može da čeka na oslobađanje katanca. Podrazumevana vrednost ovog parametra je <code class="language-plaintext highlighter-rouge">-1</code>, što znači da je detekcija isteka vremena onemogućena. U nastavku ćemo videti kako možemo postaviti vrednost ovog parametra, kao i koje je ponašanje SUBP u slučaju da dođe do isteka vremena, međutim, prvo ćemo diskutovati o situaciji do koje može doći u slučaju da aplikacije mogu da čekaju beskonačno dugo na oslobađanje katanca.</p>

<p>Pretpostavimo da postoje dve aplikacije A i B koje rade konkurentno i da je mehanizam detekcije isteka vremena onemogućen u SUBP. Aplikacija A se sastoji od dve operacije: prva operacija želi da ažurira red 1 u tabeli 1, a druga operacija želi da ažurira red 2 u tabeli 2. Aplikacija B se takođe sastoji od dve operacije: prva operacija želi da ažurira red 2 u tabeli 2, a druga operacija želi da ažurira red 1 u tabeli 1. Pretpostavimo takođe da se operacije dešavaju u (približno) isto vreme. Redosled izvršavanja ovih operacija i dobijanja katanaca je sledeći (što je ilustrovano i na narednoj slici):</p>

<ul>
  <li>U trenutku T1:
    <ul>
      <li>Aplikacija A dobija katanac X nad redom 1 u tabeli 1.</li>
      <li>Aplikacija B dobija katanac X nad redom 2 u tabeli 2.</li>
    </ul>
  </li>
  <li>U trenutku T2:
    <ul>
      <li>Aplikacija A pokušava da dobije katanac X nad redom 2 u tabeli 2. Taj katanac je nekompatibilan sa postojećim katancem X koji drži aplikacija B. Aplikacija A prelazi u stanje čekanja.</li>
      <li>Aplikacija B pokušava da dobije katanac X nad redom 1 u tabeli 1. Taj katanac je nekompatibilan sa postojećim katancem X koji drži aplikacija A. Aplikacija B prelazi u stanje čekanja.</li>
    </ul>
  </li>
  <li>U trenutku TN (N &gt; 2):
    <ul>
      <li>Aplikacija A je u stanju čekanja.</li>
      <li>Aplikacija B je u stanju čekanja.</li>
    </ul>
  </li>
</ul>

<p><img src="/vezbe/poglavlja/6/Slike/mrtva-petlja.png" alt="&quot;Ilustracija pojave mrtve petlje prilikom izvršavanja dva aplikaciona procesa.&quot;" class="ui centered large image" /></p>

<p>Očigledno, počevši od trenutka T3, obe aplikacije će čekati jedna na drugu beskonačno dugo i neće se “nikad” završiti. Ova pojava se naziva mrtva petlja.</p>

<p><em>Mrtva petlja</em> (engl. <em>deadlock</em>) predstavlja pojavu kada dve aplikacije (ili više njih) zaključaju podatak koji je neophodan jedan drugoj, što rezultuje u situaciji da se obe aplikacije blokiraju i nijedna ne može da nastavi sa daljim izvršavanjem.</p>

<p>Zbog toga što aplikacije neće “volonterski” osloboditi katance koje drže nad podacima, da bi se prevazišla mrtva petlja, mora se pristupiti procesu prepoznavanja mrtve petlje. Mehanizam prepoznavanja mrtve petlje nadgleda informacije o agentima koji čekaju na katance i pokreće se na interval specifikovan kroz parametar <code class="language-plaintext highlighter-rouge">dlchktime</code> podešavanja baze podataka.</p>

<p>Ukoliko mehanizam pronađe mrtvu petlju, onda se nasumično bira jedan od procesa u mrtvoj petlji koji se naziva <em>žrtva</em> (engl. <em>victim process</em>), čije će izmene biti poništene. Aplikacija koja pripada procesu žrtvi se podiže i prosleđuje joj se odgovarajući kod koji je ona dužna da obradi. <strong>SUBP automatski poništava nepotvrđene izmene od strane odabrane aplikacije.</strong> Kada je operacija poništavanja završena, katanci koji su pripadali procesu žrtvi se oslobađaju, kursori se zatvaraju i ostali procesi u mrtvoj petlji mogu da nastave dalje sa radom.</p>

<p>Postoje dve vrste grešaka koje SUBP može prijaviti aplikaciji u slučaju da dođe do isteka vremena, odnosno, ako je aplikacija izabrana za žrtvu prilikom prepoznavanja mrtve petlje:</p>

<ul>
  <li>Greška -911
    <ul>
      <li>Značenje: Tekuća transakcija se poništava usled mrtve petlje ili isteka vremena.</li>
      <li>Uz ovu poruku se prilaže i kod koji preciznije označava razlog zbog kojeg se došlo do greske. Ovih kodova ima više, a mi ćemo prikazati dva najznačajnija:
        <ul>
          <li>2: Transakcija je poništena usled mrtve petlje.</li>
          <li>68: Transakcija je poništena usled isteka vremena za katanac.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>Pokretanjem komande <code class="language-plaintext highlighter-rouge">db2 ? sql911</code> u terminalu je moguće dobiti više informacija o grešci.</p>

<ul>
  <li>Greška -913
    <ul>
      <li>Značenje: Došlo je do neuspeha pri izvršavanju distribuirane transakcije zbog mrtve petlje ili isteka vremena.</li>
      <li>I uz ovu poruku se prilaže kod koji preciznije označava razlog zbog kojeg se došlo do greske. Ovih kodova ima više, a mi ćemo prikazati dva najznačajnija:
        <ul>
          <li>2: Grana transakcije je neuspešna usled mrtve petlje.</li>
          <li>68: Grana transakcije je neuspešna usled isteka vremena za katanac.</li>
          <li>80: Naredba je neuspešna usled isteka vremena.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>Pokretanjem komande <code class="language-plaintext highlighter-rouge">db2 ? sql913</code> u terminalu je moguće dobiti više informacija o grešci.</p>

<p>Još jedan mogući način da se izborimo sa mrtvom petljom jeste da specifikujemo najduži vremenski period koji aplikacija može da čeka na dobijanje katanca. Specijalni registar <code class="language-plaintext highlighter-rouge">CURRENT LOCK TIMEOUT</code>, koji je tipa <code class="language-plaintext highlighter-rouge">INTEGER</code>, sadrži broj sekundi pre nego što SUBP vrati grešku koja indikuje da katanac ne može biti dodeljen aplikacionom procesu.</p>

<p>Validne vrednosti za ovaj registar su u opsegu <code class="language-plaintext highlighter-rouge">[-1, 32767]</code>. Dodatno, specijalnom registru se može postaviti vrednost <code class="language-plaintext highlighter-rouge">NULL</code>. Vrednost <code class="language-plaintext highlighter-rouge">-1</code> označava da SUBP neće prijavljivati istek vremena, već da aplikacija mora da čeka na zahtevani katanac dok se nekompatibilni katanac ne oslobodi ili dok se ne detektuje mrtva petlja. Vrednost <code class="language-plaintext highlighter-rouge">0</code> označava da aplikacija neće čekati na katanac, već ukoliko ne može da dobije katanac kada ga zatraži, odmah će dobiti grešku. Vrednost <code class="language-plaintext highlighter-rouge">NULL</code> označava da će SUBP koristiti vrednost koja je postavljena u parametru <code class="language-plaintext highlighter-rouge">locktimeout</code> o kojem je bilo reči ranije.</p>

<p>Ukoliko želimo da pročitamo vrednost ovog specijalnog registra, nakon konekcije na bazu podataka potrebno je izvršiti narednu komandu u terminalu:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 values CURRENT LOCK TIMEOUT
</code></pre></div></div>

<p>SQL naredba <code class="language-plaintext highlighter-rouge">SET CURRENT LOCK TIMEOUT</code> služi za promenu vrednosti specijalnog registra <code class="language-plaintext highlighter-rouge">CURRENT LOCK TIMEOUT</code>. Izvršavanje ove naredbe nije pod uticajem kontrole transakcije u programu. Zbog toga, ukoliko ovu naredbu koristimo u našim aplikacijama, dobra je praksa vratiti vrednost na podrazumevanu pre završavanja programa. Sintaksa ove naredbe je data u nastavku:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="p">[</span><span class="k">CURRENT</span><span class="p">]</span> <span class="k">LOCK</span> <span class="n">TIMEOUT</span> <span class="p">[</span><span class="o">=</span><span class="p">]</span>
<span class="p">(</span><span class="n">WAIT</span><span class="o">|</span><span class="k">NOT</span> <span class="n">WAIT</span><span class="o">|</span><span class="k">NULL</span><span class="o">|</span><span class="p">[</span><span class="n">WAIT</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">CELOBROJNA_KONSTANTA</span><span class="o">&gt;|&lt;</span><span class="n">MATI</span><span class="err">Č</span><span class="n">NA_PROMENLJIVA</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div></div>

<p>Ovoj naredbi je moguće specifikovati naredne vrednosti:</p>

<ul>
  <li>
    <p>Klauzom <code class="language-plaintext highlighter-rouge">WAIT</code> specifikuje se vrednost <code class="language-plaintext highlighter-rouge">-1</code>, što znači da SUBP mora da čeka dok se katanac ne oslobodi ili se ne detektuje mrtva petlja.</p>
  </li>
  <li>
    <p>Klauzom <code class="language-plaintext highlighter-rouge">NOT WAIT</code> specifikuje se vrednost <code class="language-plaintext highlighter-rouge">0</code>, što znači da SUBP ne čeka na katance koji se ne mogu dodeliti aplikacijama, već odmah prijavljuje grešku.</p>
  </li>
  <li>
    <p>Vrednošću <code class="language-plaintext highlighter-rouge">NULL</code> specifikuje se da vrednost u registru <code class="language-plaintext highlighter-rouge">CURRENT LOCK TIMEOUT</code> nije postavljena, čime se efektivno koristi vrednost parametra <code class="language-plaintext highlighter-rouge">locktimeout</code> podešavanja baze podataka. Vrednost koja se vraća za ovaj specijalni registar se menja pri promeni vrednosti parametra <code class="language-plaintext highlighter-rouge">locktimeout</code>.</p>
  </li>
  <li>
    <p>Klauzom <code class="language-plaintext highlighter-rouge">[WAIT] &lt;CELOBROJNA_KONSTANTA&gt;</code> specifikuje se celobrojna vrednost iz intervala <code class="language-plaintext highlighter-rouge">[-1, 32767]</code>. Ako data vrednost pripada intervalu <code class="language-plaintext highlighter-rouge">[1, 32767]</code>, onda će SUBP čekati toliko sekundi pre nego što aplikaciji prosledi grešku. Vrednosti <code class="language-plaintext highlighter-rouge">-1</code> i <code class="language-plaintext highlighter-rouge">0</code> odgovaraju specifikovanju prethodno opisanih klauza <code class="language-plaintext highlighter-rouge">WAIT</code> i <code class="language-plaintext highlighter-rouge">NO WAIT</code>, redom.</p>
  </li>
  <li>
    <p>Navođenjem <code class="language-plaintext highlighter-rouge">&lt;MATIČNA PROMENLJIVA&gt;</code> specifikuje se celobrojna vrednost iz intervala <code class="language-plaintext highlighter-rouge">[-1, 32767]</code> koja se čita iz vrednosti date matične promenljive. Ako data vrednost pripada intervalu <code class="language-plaintext highlighter-rouge">[1, 32767]</code>, onda će SUBP čekati toliko sekundi pre nego što aplikaciji prosledi grešku. Vrednosti <code class="language-plaintext highlighter-rouge">-1</code> i <code class="language-plaintext highlighter-rouge">0</code> odgovaraju specifikovanju prethodno opisanih klauza <code class="language-plaintext highlighter-rouge">WAIT</code> i <code class="language-plaintext highlighter-rouge">NO WAIT</code>, redom.</p>
  </li>
</ul>

<div class="ui stacked segment">
  <p><strong>Zadatak 6.1</strong>: Napisati C/SQL program koji za svaki studijski program pita korisnika da li želi da promeni obim ESPB bodova na tom studijskom programu. Ukoliko korisnik odgovori potvrdno, aplikacija zahteva od korisnika da unese novi broj bodova nakon čega se vrši izmena podataka.</p>

  <p>Napisati program tako da može da radi u višekorisničkom okruženju. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.</p>

  <p>Pokrenuti dve instance aplikacije. Uveriti se da dok jedna aplikacija obrađuje tekući studijski program, druga aplikacija ne može da dobije katanac nad odgovarajućim slogom.</p>
</div>

<p>Rešenje: Nakon izvršavanja svake SQL naredbe koja može da zahteva zaključavanje nekog sloga u tabeli, potrebno je izvršiti proveru da li aplikacija može da dobije odgovarajući katanac. Provera se sastoji u ispitivanju vrednosti makroa <code class="language-plaintext highlighter-rouge">SQLCODE</code> i to pre poziva funkcije za obradu greške, kako se proces ne bi završio pre obrade katanaca. Sama obrada čekanja je u ovom slučaju vrlo jednostavna - potrebno je ispisati poruku korisniku da je isteklo vreme za čekanje trenutnog katanca i nastaviti dalje sa izvršavanjem (poništiti eventualne izmene i ponovo otvoriti kursor koji se obrađuje).</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_1.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hStudyProgramName</span><span class="p">[</span><span class="mi">201</span><span class="p">];</span>
<span class="kt">short</span> <span class="n">hStudyProgramESPB</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="c1">// Definisemo funkciju koja ce vrsiti obradu cekanja u slucaju da dodje do problema u visekorisnickom okruzenju.</span>
<span class="c1">// Primetimo da je definicija funkcije odvojena od njene deklaracije,</span>
<span class="c1">// zato sto se u definiciji ove funkcije koristi (otvara) kursor `cStudyPrograms`.</span>
<span class="c1">// Ako bismo stavili definiciju ove funkcije ispred `main` funkcije,</span>
<span class="c1">// onda bi Db2 pretprocesor izdao upozorenje da se kursor koristi (otvara) pre deklaracije.</span>
<span class="c1">// Funkcija vraca 1 ukoliko je doslo do problema, a 0 inace.</span>
<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">();</span>

<span class="c1">// Funkcija za obradu SQL gresaka</span>
<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="c1">// Postavljanje isteka vremena na 5 sekundi</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set current lock timeout 5"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cStudyPrograms</span> <span class="n">CURSOR</span> <span class="n">WITH</span> <span class="n">HOLD</span> <span class="n">FOR</span> 
        <span class="n">SELECT</span>  <span class="n">TRIM</span><span class="p">(</span><span class="n">NAZIV</span><span class="p">),</span> 
                <span class="n">OBIMESPB</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">STUDIJSKIPROGRAM</span>
        <span class="n">FOR</span>     <span class="n">UPDATE</span> <span class="n">OF</span> <span class="n">OBIMESPB</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare cStudyPrograms"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cStudyPrograms</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open cStudyPrograms"</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="c1">// Naredba FETCH dohvata jedan red iz rezultata upita.</span>
        <span class="c1">// Bilo da li se informacije koriste za citanje ili za eventualnu izmenu,</span>
        <span class="c1">// SUBP mora da dodeli aplikaciji odgovarajuci katanac.</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">cStudyPrograms</span> 
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">hStudyProgramName</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">hStudyProgramESPB</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch cStudyPrograms"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Nema vise studijskih programa za obradjivanje!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
            
        <span class="n">printf</span><span class="p">(</span><span class="s">"%s (%hd)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hStudyProgramName</span><span class="p">,</span> <span class="n">hStudyProgramESPB</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Da li zelite da promenite bodove za ovaj studijski program? [d/n] "</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">userResponse</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
        <span class="n">getchar</span><span class="p">();</span>  <span class="c1">// novi red</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">userResponse</span> <span class="o">!=</span> <span class="sc">'d'</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"Unesite broj bodova: "</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%hd"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hStudyProgramESPB</span><span class="p">);</span>

        <span class="c1">// Izvrsavanje naredbe UPDATE uvek trazi katanac za azuriranje podataka</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">UPDATE</span>  <span class="n">DA</span><span class="p">.</span><span class="n">STUDIJSKIPROGRAM</span>
            <span class="n">SET</span>     <span class="n">OBIMESPB</span> <span class="o">=</span> <span class="o">:</span><span class="n">hStudyProgramESPB</span>
            <span class="n">WHERE</span>   <span class="n">CURRENT</span> <span class="n">OF</span> <span class="n">cStudyPrograms</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Update"</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Bodovi su azurirani!</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cStudyPrograms</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close cStudyPrograms"</span><span class="p">);</span>

    <span class="c1">// Vracamo istek vremena na podrazumevanu vrednost</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set current lock timeout null"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">SQLCODE</span> <span class="o">&amp;&amp;</span> <span class="n">SQLCODE</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Objekat je zakljucan od strane druge transakcije. "</span>
            <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cStudyPrograms</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open cStudyPrograms - waitForLock"</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<h2 id="63-obrada-transakcija-u-višekorisničkom-okruženju">6.3 Obrada transakcija u višekorisničkom okruženju</h2>

<p>Problem sa pristupom obrade grešaka u prethodnom zadatku je taj što se pod transakcijom smatra izvršavanje celog programa, te ako bilo gde u obradi dođe do problema dobijanja katanaca, sve izmene koje su do tada načinjene se poništavaju. Umesto toga, pouzdanija tehnika jeste definisati da jedna transakcija obuhvata obradu jednog podatka. U prethodnom primeru, to bi značilo da jedna transakcija obuhvata izmenu tačno jednog studijskog programa, a ne svih studijskih programa. Dodatno, često je poželjno da aplikacija pamti koji podaci su već obrađeni, kako ih ne bi obrađivala dva puta. Ovo je važno pamtiti zbog toga što otvaranjem kursora u obradi čekanja, kursor se pozicionira na početak rezultujuće tabele, a ne tamo gde je obrada stala. (Alternativno, možemo pamtiti broj obrađenih redova u neku matičnu promenljivu <code class="language-plaintext highlighter-rouge">row_count</code>, pa zatim koristiti klauzu <code class="language-plaintext highlighter-rouge">OFFSET :row_count ROWS</code> u <code class="language-plaintext highlighter-rouge">SELECT</code> naredbi.)</p>

<p>Naredni zadatak ilustruje obradu transakcija u višekorisničkom okruženju korišćenjem znanja iz ovog poglavlja.</p>

<div class="ui stacked segment">
  <p><strong>Zadatak 6.2</strong>: Napisati C/SQL program koji za svaki predmet omogućava korisniku da poveća broj ESPB za 1. Nakon svakog ažuriranja, proveriti da li je odgovarajuci red u tabeli izmenjen ponovnim dohvatanjem informacija.</p>

  <p>Napisati program tako da može da radi u višekorisničkom okruženju. Obrada jednog predmeta predstavlja jednu transakciju. Postaviti istek vremena za zahtevanje katanaca na 10 sekundi.</p>
</div>

<p>Rešenje: S obzirom da se ovoga puta obrada katanaca vrši kao deo zasebne transakcije, onda je potrebno da poništavamo izmene ukoliko dođe do isteka vremena za dobijanje katanaca. Zbog toga, funkciji za obradu čekanja dodajemo naredbu <code class="language-plaintext highlighter-rouge">ROLLBACK</code>. Dodatno, kako će ta naredba zatvoriti sve otvorene kursore u transakciji (pa čak i one deklarisane klauzom <code class="language-plaintext highlighter-rouge">WITH HOLD</code>), potrebno je otvoriti kursor koji se koristio pre nego što se pređe u narednu iteraciju petlje koja obrađuje taj kursor.</p>

<p>Takođe, primetimo da aplikacija čuva niz obrađenih predmeta tokom svog rada. Prilikom obrađivanja narednog predmeta, aplikacija prvo proverava funkcijom <code class="language-plaintext highlighter-rouge">int isCourseProcessed(sqlint32 id)</code> i ukoliko jeste, aplikacija ga preskače i prelazi na naredni predmet. U suprotnom, vrši se obrada i funkcijom <code class="language-plaintext highlighter-rouge">void setCourseAsProcessed(sqlint32 id)</code> se predmet označava da je obrađen za naredne provere.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_2.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">hCourseId</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hCourseLabel</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> 
     <span class="n">hCourseName</span><span class="p">[</span><span class="mi">151</span><span class="p">];</span>
<span class="kt">short</span> <span class="n">hCourseESPB</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="c1">// Niz identifikatora predmeta obradjenih od strane ovog programa.</span>
<span class="c1">// Ovde koristimo staticki niz radi ilustracije, ali broj predmeta nije poznat unapred, naravno,</span>
<span class="c1">// pa bi korektnije resenje koristilo dinamicki inicijalizovan niz.</span>
<span class="n">sqlint32</span> <span class="n">processedCoursesArr</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
<span class="kt">size_t</span> <span class="n">processedCoursesArrSize</span> <span class="o">=</span> <span class="mi">0u</span><span class="p">;</span>

<span class="c1">// Pomocne funkcije sa rad sa nizom identifikatora predmeta</span>
<span class="kt">int</span> <span class="nf">isCourseProcessed</span><span class="p">(</span><span class="n">sqlint32</span> <span class="n">id</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">setCourseAsProcessed</span><span class="p">(</span><span class="n">sqlint32</span> <span class="n">id</span><span class="p">);</span>

<span class="c1">// Pomocne funkcije za obradu gresaka i cekanja na katance</span>
<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">();</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set current lock timeout 5"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cCourses</span> <span class="n">CURSOR</span> <span class="n">WITH</span> <span class="n">HOLD</span> <span class="n">FOR</span> 
        <span class="n">SELECT</span>  <span class="n">ID</span><span class="p">,</span> 
                <span class="n">TRIM</span><span class="p">(</span><span class="n">OZNAKA</span><span class="p">),</span> 
                <span class="n">TRIM</span><span class="p">(</span><span class="n">NAZIV</span><span class="p">),</span> 
                <span class="n">ESPB</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span>
        <span class="n">FOR</span>     <span class="n">UPDATE</span> <span class="n">OF</span> <span class="n">ESPB</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare cCourses"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cCourses</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open cCourses"</span><span class="p">);</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"PREDMETI</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">cCourses</span> 
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">hCourseId</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">hCourseLabel</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">hCourseName</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">hCourseESPB</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch cCourses"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Nema vise predmeta za obradjivanje!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Provera da li je predmet vec obradjen </span>
        <span class="c1">// od strane ove instance aplikacije</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isCourseProcessed</span><span class="p">(</span><span class="n">hCourseId</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">---------------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%5.5d %-10.10s %-40.40s %5.5d"</span><span class="p">,</span> <span class="n">hCourseId</span><span class="p">,</span> <span class="n">hCourseLabel</span><span class="p">,</span> <span class="n">hCourseName</span><span class="p">,</span> <span class="n">hCourseESPB</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">---------------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Da li zelite da uvecate broj ESPB za ovaj predmet za 1? [d/n] "</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">userResponse</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
        <span class="n">getchar</span><span class="p">();</span>  <span class="c1">// novi red</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">userResponse</span> <span class="o">==</span> <span class="sc">'d'</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Azuriranje podataka zahteva katanac za menjanje podataka</span>
            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">UPDATE</span>  <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span>
                <span class="n">SET</span>     <span class="n">ESPB</span> <span class="o">=</span> <span class="n">ESPB</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">WHERE</span>   <span class="n">CURRENT</span> <span class="n">OF</span> <span class="n">cCourses</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Update"</span><span class="p">);</span>

            <span class="c1">// Slicno kao i FETCH, naredba SELECT INTO zahteva katanac za citanje</span>
            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">SELECT</span>  <span class="n">ESPB</span>
                <span class="n">INTO</span>    <span class="o">:</span><span class="n">hCourseESPB</span>
                <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span>
                <span class="n">WHERE</span>   <span class="n">ID</span> <span class="o">=</span> <span class="o">:</span><span class="n">hCourseId</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Select into"</span><span class="p">);</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">"Broj ESPB je sada %hd</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hCourseESPB</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Evidentiramo izmene u nizu namenjenim za to.</span>
        <span class="n">setCourseAsProcessed</span><span class="p">(</span><span class="n">hCourseId</span><span class="p">);</span>
        
        <span class="c1">// Potvrdjivanje izmena u tekucoj transakciji</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Commit"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cCourses</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close cCourses"</span><span class="p">);</span>

    <span class="c1">// Vracamo istek vremena na podrazumevanu vrednost</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set current lock timeout null"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">SQLCODE</span> <span class="o">&amp;&amp;</span> <span class="n">SQLCODE</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Objekat je zakljucan od strane druge transakcije. "</span>
            <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cCourses</span><span class="p">;</span>    
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open cCourses - obrada cekanja"</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">isCourseProcessed</span><span class="p">(</span><span class="n">sqlint32</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">processedCoursesArrSize</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">processedCoursesArr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setCourseAsProcessed</span><span class="p">(</span><span class="n">sqlint32</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">processedCoursesArr</span><span class="p">[</span><span class="n">processedCoursesArrSize</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="64-nivoi-izolovanosti">6.4 Nivoi izolovanosti</h2>

<p>U najosnovnijem slučaju, svaka transakcija je u potpunosti izolovana od svih drugih transakcija. Međutim, videli smo da ovakva, potpuna izolovanost, može brzo dovesti do problema poput mrtve petlje u konkurentnom sistemu izvršavanja. Zbog toga, da bi se povećala konkurentnost između aplikacionih procesa, DB2 SUBP definiše različite nivoe izolovanosti na kojima aplikacija može da se izvršava.</p>

<p><em>Nivo izolovanosti</em> (engl. <em>isolation level</em>) koji se pridružuje aplikacionom procesu određuje stepen zaključavanja ili izolacije u kojem su podaci kojima taj proces pristupa, u odnosu na druge konkurentne procese.</p>

<p>Drugim rečima, nivo izolovanosti jednog aplikacionog procesa P specifikuje sledeće:</p>

<ul>
  <li>Stepen u kojem su redovi koji se čitaju ili ažuriraju od strane procesa P dostupni drugim konkurentnim aplikacionim procesima.</li>
  <li>Stepen u kojem ažuriranja od strane drugih konkurentnih aplikacionih procesa mogu da utiču na izvršavanje procesa P.</li>
</ul>

<p>DB2 definiše naredna četiri nivoa izolacije:</p>

<ul>
  <li>Ponovljeno čitanje</li>
  <li>Stabilno čitanje</li>
  <li>Stabilni kursor</li>
  <li>Nepotvrđeno čitanje</li>
</ul>

<h3 id="641-ponovljeno-čitanje">6.4.1 Ponovljeno čitanje</h3>

<p>U nivou izolacije <em>ponovljeno čitanje</em> (engl. <em>repeatable read</em>, skr. <em>RR</em>) nijedan podatak koji je pročitan od strane procesa P ne sme se menjati od strane drugih procesa sve do završetka obrade od strane procesa P (čime se obezbeđuje saglasnost podataka u slučaju ponovljenog čitanja, te otuda i naziv nivoa izolacije). Sa druge strane, nijedan red promenjen od strane drugog procesa ne može se čitati od strane procesa P dok se promene u okviru tog procesa na okončaju.</p>

<p>Osim već pomenutih ekskluzivnih katanaca, proces na RR nivou izolovanosti dobija bar deljive katance na svim podacima kojima pristupa, pri čemu se zaključavanje vrši tako da je proces u potpunosti izolovan od strane ostalih procesa.</p>

<h3 id="642-stabilno-čitanje">6.4.2 Stabilno čitanje</h3>

<p>U nivou izolacije <em>stabilno čitanje</em> (engl. <em>read stability</em>, skr. <em>RS</em>) nijedan podatak koji je pročitan od strane procesa P ne sme se menjati od strane drugih procesa sve do završetka obrade od strane procesa P. Sa druge strane, nijedan red promenjen od strane drugog procesa ne može se čitati dok se promene u okviru tog procesa ne okončaju.</p>

<p>Međutim, za razliku od RR, na ovom nivou izolacije proces koji izvršava isti upit više puta, može dobiti neke nove redove u odgovorima u slučaju da drugi proces unese nove redove koji zadovoljavaju dati upit i potvrdi te izmene. Ovo predstavlja tzv. <em>problem fantomskih redova</em> (engl. <em>fantom rows problem</em>).</p>

<p>Osim ekskluzivnih katanaca, proces na RS nivou izolovanosti dobija bar deljive katance na svim podacima koji su prihvaćeni. Na primer, neka se u procesu P izvršava naredni upit:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="o">*</span>
<span class="k">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">STUDIJSKIPROGRAM</span>
<span class="k">WHERE</span>   <span class="n">IDNIVOA</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></div>

<p>U slučaju RR nivoa izolovanosti izvršavanje ovog upita izazvaće zaključavanje svih redova tabele <code class="language-plaintext highlighter-rouge">STUDIJSKIPROGRAM</code>, a u slučaju RS nivoa izolovanosti zaključavanje se vrši samo nad onim redovima koji ispunjavaju uslov restrikcije <code class="language-plaintext highlighter-rouge">IDNIVOA = 1</code>. Zbog toga, ako neki drugi proces unese novi red koji zadovoljava datu restrikciju, u slučaju RR nivoa izolovanosti to neće biti moguće, dok će ponovo izvršavanje upita u slučaju RS nivoa izolovanosti proizvesti prikazivanje i tih novih redova.</p>

<h3 id="643-stabilni-kursor">6.4.3 Stabilni kursor</h3>

<p>U nivou izolacije <em>stabilni kursor</em> (engl. <em>cursor stability</em>, skr. <em>CS</em>) nijedan proces ne može da menja podatke iz reda dok je ažurirajući kursor pozicioniran nad tim redom. Dakle, ovaj nivo izolovanosti obezbeđuje da konkurentni procesi ne mogu menjati samo trenutno aktivne redove otvorenih kursora posmatranog procesa P. Redovi koji su ranije pročitani mogu biti menjani. Takodje, nijedan red promenjen od strane drugog procesa ne može se čitati dok se promene u okviru tog procesa na okončaju.</p>

<p>Takođe, ovaj nivo izolovanosti zaključava sve redove kojima transakcija pristupa dok je kursor pozicioniran na tim redovima. Ako transakcija koristi podatke iz reda za čitanje, onda se ovaj katanac drži sve dok se ne dohvati naredni red u kursoru ili dok se transakcija ne završi. Međutim, ako je izmena izvršena nad nekim redom, onda se nad tim redom drži katanac sve do kraja transakcije.</p>

<p>Očito, i u ovom nivou izolacije moguć je problem fantomskih redova. Međutim, postoji još jedan problem koji se može javiti. Neka prvo proces A pročita red, pa zatim pređe na druge redove. Neka zatim proces B pročita i izmeni isti red i potvrdi svoje izmene. Ukoliko proces A ponovo pročita isti red, videće drugačije vrednosti u odnosu na prethodno čitanje. Ovaj problem se naziva <em>problem neponovljivih čitanja</em> (engl. <em>non-repeatable reads problem</em>).</p>

<p>Bez obzira na razne ekskluzivne katance, ovaj nivo obezbeđuje bar deljive katance na aktivnim redovima svih kursora.</p>

<h3 id="644-nepotvrđeno-čitanje">6.4.4 Nepotvrđeno čitanje</h3>

<p>I nivou izolacije <em>nepotvrđeno čitanje</em> (engl. <em>uncommitted read</em>, skr. <em>UR</em>) proces P može da pristupi nepotvrđenim izmenama od strane drugih procesa. Dodatno, nivo izolacije UR ne sprečava drugim procesima da pristupe redu koji čita proces P, osim ukoliko taj drugi proces ne pokušava da izmeni strukturu tabele ili da je obriše.</p>

<p>Za naredbe <code class="language-plaintext highlighter-rouge">SELECT INTO</code> ili <code class="language-plaintext highlighter-rouge">FETCH</code> nad kursorom koji služi samo za čitanje, ili podupite naredbi <code class="language-plaintext highlighter-rouge">INSERT</code> ili <code class="language-plaintext highlighter-rouge">UPDATE</code>, ili upite koji kao rezultat imaju skalarnu vrednost, ovaj nivo izolacije omogućava da:</p>

<ul>
  <li>
    <p>Bilo koji red pročitan tokom jedinice obrade bude promenjen od strane drugih procesa.</p>
  </li>
  <li>
    <p>Proces može čitati podatke izmenjene od strane drugih korisnika, čak i pre nego što su te izmene potvrđene (ne traži se deljeni katanac za čitanje).</p>
  </li>
  <li>
    <p>Za ostale operacije važe pravila nivoa izolovanosti CS.</p>
  </li>
</ul>

<p>Pored problema fantomskih redova i problema neponovljivih čitanja, postoji još jedan problem koji se može javiti u ovom nivou izolacije. Ako prvo proces A izmeni neku vrednost, zatim proces B pročita tu vrednost pre nego što je potvrđena, a zatim proces A poništi svoje izmene, onda proces B može raditi nad nekorektnim podacima. Ovaj problem se naziva <em>problem pristupa nepotvrđenim podacima</em> (engl. <em>access to uncommitted data problem</em>).</p>

<h3 id="645-programersko-podešavanje-nivoa-izolovanosti">6.4.5 Programersko podešavanje nivoa izolovanosti</h3>

<p>Moguće je specifikovati koji se nivo izolovanosti koristi i on je u efektu tokom trajanja jedinice posla. Postoji nekoliko načina za podešavanje nivoa izolovanosti:</p>

<ul>
  <li>Navođenje na nivou jedne naredbe je moguće izvršiti korišćenjem klauze <code class="language-plaintext highlighter-rouge">WITH</code><sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>, čija je sintaksa data u nastavku:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="p">(</span>
    <span class="n">RR</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">KLAUZA_ZAKLJU</span><span class="err">Č</span><span class="n">AVANJA</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">|</span>
    <span class="n">RS</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">KLAUZA_ZAKLJU</span><span class="err">Č</span><span class="n">AVANJA</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">|</span>
    <span class="n">CS</span> <span class="o">|</span>
    <span class="n">UR</span>
<span class="p">)</span>
</code></pre></div></div>

<p>gde je <code class="language-plaintext highlighter-rouge">&lt;KLAUZA_ZAKLJUČAVANJA&gt;</code> klauza kojom se specifikuje tip katanca koji aplikacija zahteva od SUBP, a čija je sintaksa:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="k">AND</span> <span class="n">KEEP</span> <span class="p">(</span><span class="k">SHARE</span><span class="o">|</span><span class="k">UPDATE</span><span class="o">|</span><span class="k">EXCLUSIVE</span><span class="p">)</span> <span class="n">LOCKS</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">WITH</code> klauza se može koristiti u narednim naredbama: <code class="language-plaintext highlighter-rouge">DECLARE CURSOR</code>, pretražujuća <code class="language-plaintext highlighter-rouge">UPDATE</code> naredba, <code class="language-plaintext highlighter-rouge">INSERT</code>, <code class="language-plaintext highlighter-rouge">SELECT</code>, <code class="language-plaintext highlighter-rouge">SELECT INTO</code> i pretražujuća <code class="language-plaintext highlighter-rouge">DELETE</code> naredba.</p>

<ul>
  <li>Podešavanjem specijalnog registra <code class="language-plaintext highlighter-rouge">CURRENT ISOLATION</code>, čiji je tip <code class="language-plaintext highlighter-rouge">CHAR(2)</code>, a koji sadrži informaciju o nivou izolacije za svaku dinamičku SQL naredbu koja se izvršava u tekućoj sesiji. Moguće vrednosti su: prazna niska, <code class="language-plaintext highlighter-rouge">'RR'</code>, <code class="language-plaintext highlighter-rouge">'RS'</code>, <code class="language-plaintext highlighter-rouge">'CS'</code> i <code class="language-plaintext highlighter-rouge">'UR'</code>. Promena ove vrednosti se može izvršiti naredbom <code class="language-plaintext highlighter-rouge">SET CURRENT ISOLATION</code>, čija je sintaksa:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="p">[</span><span class="k">CURRENT</span><span class="p">]</span> <span class="k">ISOLATION</span> <span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="p">(</span><span class="n">UR</span><span class="o">|</span><span class="n">CS</span><span class="o">|</span><span class="n">RR</span><span class="o">|</span><span class="n">RS</span><span class="o">|</span><span class="k">RESET</span><span class="p">)</span>
</code></pre></div></div>

<p>Navođenjem vrednosti <code class="language-plaintext highlighter-rouge">RESET</code> će vrednost registra biti postavljena na praznu nisku, što znači da se neće koristiti ta vrednost za registar.</p>

<ul>
  <li>Navođenjem vrednosti za nivo izolacije kao atribut paketa, čime se efektivno koristi ta vrednost za aplikacije koje koriste taj paket. Ovo se može uraditi navođenjem <code class="language-plaintext highlighter-rouge">ISOLATION</code> opcije prilikom izvršavanja naredbi <code class="language-plaintext highlighter-rouge">PRECOMPILE</code> ili <code class="language-plaintext highlighter-rouge">BIND</code>. Ova opcija ima narednu sintaksu:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ISOLATION</span> <span class="p">(</span><span class="n">CS</span><span class="o">|</span><span class="n">RR</span><span class="o">|</span><span class="n">RS</span><span class="o">|</span><span class="n">UR</span><span class="p">)</span>
</code></pre></div></div>

<p>Ukoliko se ne specifikuje nivo izolacije, DB2 će podrazumevano koristiti nivo CS.</p>

<p>Naredni primeri ilustruju različite efekte iste aplikacije pri različitim nivoima izolovanosti. Primetimo da smo u narednim primerima koristili klauzu <code class="language-plaintext highlighter-rouge">WITH</code> za postavljanje nivoa izolovanosti.</p>

<div class="ui stacked segment">
  <p><strong>Zadatak 6.3</strong>: Napisati:</p>

  <ul>
    <li>C/SQL program <code class="language-plaintext highlighter-rouge">repeatableRead</code> koji dva puta ispisuje informacije o godini, oznaci, nazivu i periodu prijavljivanja za svaki ispitni rok u 2021. godini. Omogućiti da se prilikom oba ispisivanja dobijaju iste informacije.</li>
    <li>C/SQL program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code> koji unosi novi ispitni rok za mesec mart u 2021. godini. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.</li>
  </ul>
</div>

<p>Rešenje: Za potrebe prevođenja i pripremanja podataka u bazi, napravljena je <code class="language-plaintext highlighter-rouge">Makefile</code> datoteka čiji je sadržaj:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_3/Makefile</code></strong>:</p>
<div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Za prevodjenje programa pozvati: make
# Za pripremu baze pozvati: make db
# Za ciscenje artefakta pozvati: make clean
</span>
<span class="nl">repeatableRead</span><span class="o">:</span> <span class="nf">repeatableRead.sqc insertIspitniRok</span>
	./prevodjenje repeatableRead stud2020 student abcdef

<span class="nl">insertIspitniRok</span><span class="o">:</span> <span class="nf">insertIspitniRok.sqc</span>
	./prevodjenje insertIspitniRok stud2020 student abcdef

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">clean db</span>

<span class="nl">clean</span><span class="o">:</span>
	<span class="nb">rm</span> <span class="nt">-f</span> <span class="k">*</span>.bnd
	<span class="nb">rm</span> <span class="nt">-f</span> <span class="k">*</span>.o
	<span class="nb">rm</span> <span class="nt">-f</span> <span class="k">*</span>.c
	<span class="nb">rm</span> <span class="nt">-f</span> repeatableRead
	<span class="nb">rm</span> <span class="nt">-f</span> insertIspitniRok

<span class="nl">db</span><span class="o">:</span>
	db2 <span class="nt">-tf</span> pripremaBaze.sql <span class="o">||</span> <span class="nb">true</span>

</code></pre></div></div>

<p>Prevođenje programa se vrši pozivom alata <code class="language-plaintext highlighter-rouge">make</code>, a moguće je i očistiti artefakte prevođenja pozivom <code class="language-plaintext highlighter-rouge">make clean</code>. Pre ilustracije rada programa <code class="language-plaintext highlighter-rouge">repeatableRead</code>, potrebno je pozvati <code class="language-plaintext highlighter-rouge">make db</code> koji će pripremiti informacije o ispitnim rokovima u bazu podataka na osnovu skripta <code class="language-plaintext highlighter-rouge">pripremaBaze.sql</code> čiji je sadržaj:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_3/pripremaBaze.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CONNECT</span> <span class="k">TO</span> <span class="n">STUD2020</span> <span class="k">USER</span> <span class="n">student</span> <span class="k">USING</span> <span class="n">abcdef</span><span class="p">;</span>

<span class="k">DELETE</span>  <span class="k">FROM</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
<span class="k">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="mi">2021</span><span class="p">;</span>

<span class="k">DELETE</span>  <span class="k">FROM</span> <span class="n">DA</span><span class="p">.</span><span class="n">SKOLSKAGODINA</span>
<span class="k">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="mi">2021</span><span class="p">;</span>

<span class="k">INSERT</span>  <span class="k">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">SKOLSKAGODINA</span>
<span class="k">VALUES</span>  <span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="s1">'09/01/2021'</span><span class="p">,</span> <span class="s1">'09/01/2022'</span><span class="p">);</span>

<span class="k">INSERT</span>  <span class="k">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span> 
<span class="k">VALUES</span>  <span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="s1">'Jan21'</span><span class="p">,</span> <span class="s1">'Januar 2021'</span><span class="p">,</span> <span class="s1">'01/01/2022'</span><span class="p">,</span> <span class="s1">'01/11/2022'</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="s1">'Feb21'</span><span class="p">,</span> <span class="s1">'Februar 2021'</span><span class="p">,</span> <span class="s1">'02/01/2022'</span><span class="p">,</span> <span class="s1">'02/11/2022'</span><span class="p">);</span>

<span class="k">CONNECT</span> <span class="k">RESET</span><span class="p">;</span>

</code></pre></div></div>

<p>Pokrenuti program <code class="language-plaintext highlighter-rouge">repeatableRead</code> i započeti prvo ispisivanje. U toku prvog ispisivanja ili nakon njega, pokrenuti program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code>, pa nastaviti sa daljim ispisivanjem ispitnih rokova u programu <code class="language-plaintext highlighter-rouge">repeatableRead</code>. Uveriti se da program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code> ne može da izvrši unos sve dok program <code class="language-plaintext highlighter-rouge">repeatableRead</code> ne završi sa svim ispisivanjima i, takođe, da oba ispisivanja u tom programu imaju iste vrednosti.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_3/repeatableRead.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">hSchoolYear</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hFinalsLabel</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> 
     <span class="n">hFinalsName</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span>
     <span class="n">hFinalsStartDate</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
     <span class="n">hFinalsEndDate</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cFinals</span> <span class="n">CURSOR</span> <span class="n">FOR</span>
        <span class="n">SELECT</span>  <span class="n">SKGODINA</span><span class="p">,</span> 
                <span class="n">OZNAKAROKA</span><span class="p">,</span> 
                <span class="n">NAZIV</span><span class="p">,</span>
                <span class="n">DATPOCETKA</span><span class="p">,</span>
                <span class="n">DATKRAJA</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
        <span class="n">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="mi">2021</span>
        <span class="n">FOR</span>     <span class="n">READ</span> <span class="n">ONLY</span>
        <span class="n">WITH</span>    <span class="n">RR</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare cursor"</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Citanje rezultata %d. put. Pritisnite ENTER za pocetak.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cFinals</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open"</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">---------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">FETCH</span>   <span class="n">cFinals</span>
                <span class="n">INTO</span>    <span class="o">:</span><span class="n">hSchoolYear</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">hFinalsLabel</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">hFinalsName</span><span class="p">,</span>
                        <span class="o">:</span><span class="n">hFinalsStartDate</span><span class="p">,</span>
                        <span class="o">:</span><span class="n">hFinalsEndDate</span><span class="p">;</span>
            <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch"</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">"%4.4d %-10.10s %-20.20s %-10.10s %-10.10s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hSchoolYear</span><span class="p">,</span> <span class="n">hFinalsLabel</span><span class="p">,</span> <span class="n">hFinalsName</span><span class="p">,</span> <span class="n">hFinalsStartDate</span><span class="p">,</span> <span class="n">hFinalsEndDate</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">---------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cFinals</span><span class="p">;</span>    
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_3/insertIspitniRok.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code_hint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">SQLCODE</span> <span class="o">&amp;&amp;</span> <span class="n">SQLCODE</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[%s] Objekat je zakljucan od strane druge transakcije. "</span>
            <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">code_hint</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">INSERT</span>  <span class="n">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="err">'</span><span class="n">Mar21</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">Mart</span> <span class="mi">2021</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="mo">03</span><span class="o">/</span><span class="mo">01</span><span class="o">/</span><span class="mi">2022</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="mo">03</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2022</span><span class="err">'</span><span class="p">);</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">(</span><span class="s">"INSERT"</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Insert"</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 6.4</strong>: Napisati:</p>

  <ul>
    <li>C/SQL program <code class="language-plaintext highlighter-rouge">readStability</code> koji dva puta ispisuje informacije o godini, oznaci, nazivu i periodu prijavljivanja za svaki ispitni rok u 2021. godini. Dozvoljeno je da se prilikom drugog ispisivanja pojave novi redovi, ali ne i da budu vidljive izmene pročitanih redova.</li>
    <li>C/SQL program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code> koji unosi novi ispitni rok za mesec mart u 2021. godini. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.</li>
    <li>C/SQL program <code class="language-plaintext highlighter-rouge">updateIspitniRok</code> koji za svaki ispitni rok u 2021. godini produžava period prijavljivanja za 3 dana. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.</li>
  </ul>
</div>

<p>Rešenje: Kao i u prethodnom zadatku, napravljena je <code class="language-plaintext highlighter-rouge">Makefile</code> koja služi za pozivanje alata <code class="language-plaintext highlighter-rouge">make</code> na već opisan način.</p>

<p>Pokrenuti program <code class="language-plaintext highlighter-rouge">readStability</code> i započeti prvo ispisivanje. U toku ispisivanja ili nakon njega, pokrenuti program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code>, pa nastaviti sa daljim ispisivanjem ispitnih rokova. Uveriti se da program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code> može da izvrši unos novog ispitnog roka tokom rada programa <code class="language-plaintext highlighter-rouge">readStability</code> i da se novi rok vidi prilikom drugog ispisivanja. Zatim, ponovo pokrenuti program <code class="language-plaintext highlighter-rouge">readStability</code> (nakon ponovnog pripremanja baze podataka pozivom <code class="language-plaintext highlighter-rouge">make db</code>), pa u toku prvog ispisivanja ili nakon njega, pokrenuti program <code class="language-plaintext highlighter-rouge">updateIspitniRok</code>. Uveriti se da program <code class="language-plaintext highlighter-rouge">updateIspitniRok</code> ne može da promeni informacije o ispitnim rokovima dok program <code class="language-plaintext highlighter-rouge">readStability</code> radi.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_4/readStability.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">hSchoolYear</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hFinalsLabel</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> 
     <span class="n">hFinalsName</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span>
     <span class="n">hFinalsStartDate</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
     <span class="n">hFinalsEndDate</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cFinals</span> <span class="n">CURSOR</span> <span class="n">FOR</span>
        <span class="n">SELECT</span>  <span class="n">SKGODINA</span><span class="p">,</span> 
                <span class="n">OZNAKAROKA</span><span class="p">,</span> 
                <span class="n">NAZIV</span><span class="p">,</span>
                <span class="n">DATPOCETKA</span><span class="p">,</span>
                <span class="n">DATKRAJA</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
        <span class="n">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="mi">2021</span>
        <span class="n">FOR</span>     <span class="n">READ</span> <span class="n">ONLY</span>
        <span class="n">WITH</span>    <span class="n">RS</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare cursor"</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Citanje rezultata %d. put. Pritisnite ENTER za pocetak.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cFinals</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open"</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">---------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">FETCH</span>   <span class="n">cFinals</span>
                <span class="n">INTO</span>    <span class="o">:</span><span class="n">hSchoolYear</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">hFinalsLabel</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">hFinalsName</span><span class="p">,</span>
                        <span class="o">:</span><span class="n">hFinalsStartDate</span><span class="p">,</span>
                        <span class="o">:</span><span class="n">hFinalsEndDate</span><span class="p">;</span>
            <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch"</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">"%4.4d %-10.10s %-20.20s %-10.10s %-10.10s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hSchoolYear</span><span class="p">,</span> <span class="n">hFinalsLabel</span><span class="p">,</span> <span class="n">hFinalsName</span><span class="p">,</span> <span class="n">hFinalsStartDate</span><span class="p">,</span> <span class="n">hFinalsEndDate</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">---------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cFinals</span><span class="p">;</span>    
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_4/insertIspitniRok.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code_hint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">SQLCODE</span> <span class="o">&amp;&amp;</span> <span class="n">SQLCODE</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[%s] Objekat je zakljucan od strane druge transakcije. "</span>
            <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">code_hint</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">INSERT</span>  <span class="n">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="err">'</span><span class="n">Mar21</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">Mart</span> <span class="mi">2021</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="mo">03</span><span class="o">/</span><span class="mo">01</span><span class="o">/</span><span class="mi">2022</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="mo">03</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2022</span><span class="err">'</span><span class="p">);</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">(</span><span class="s">"INSERT"</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Insert"</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_4/updateIspitniRok.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code_hint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">SQLCODE</span> <span class="o">&amp;&amp;</span> <span class="n">SQLCODE</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[%s] Objekat je zakljucan od strane druge transakcije. "</span>
            <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">code_hint</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">UPDATE</span>  <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
            <span class="n">SET</span>     <span class="n">DATKRAJA</span> <span class="o">=</span> <span class="n">DATKRAJA</span> <span class="o">+</span> <span class="mi">3</span> <span class="n">DAYS</span>
            <span class="n">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="mi">2021</span><span class="p">;</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">(</span><span class="s">"UPDATE"</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Insert"</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 6.5</strong>: Napisati:</p>

  <ul>
    <li>C/SQL program <code class="language-plaintext highlighter-rouge">cursorStability</code> koji dva puta ispisuje informacije o godini, oznaci, nazivu i periodu prijavljivanja za svaki ispitni rok u 2021. godini. Dozvoljeno je da se prilikom drugog ispisivanja pojave novi redovi i da budu vidljive izmene pročitanih redova, ali ne i nepotvrđene izmene.</li>
    <li>C/SQL program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code> koji unosi novi ispitni rok za mesec mart u 2021. godini. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.</li>
    <li>C/SQL program <code class="language-plaintext highlighter-rouge">updateIspitniRok</code> koji za svaki ispitni rok u 2021. godini produžava period prijavljivanja za 3 dana. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.</li>
  </ul>
</div>

<p>Rešenje: Kao i u prethodnom zadatku, napravljena je <code class="language-plaintext highlighter-rouge">Makefile</code> koja služi za pozivanje alata <code class="language-plaintext highlighter-rouge">make</code> na već opisan način.</p>

<p>Pokrenuti program <code class="language-plaintext highlighter-rouge">cursorStability</code> i započeti prvo ispisivanje. U toku ispisivanja ili nakon njega, pokrenuti program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code>, pa nastaviti sa daljim ispisivanjem ispitnih rokova. Uveriti se da program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code> može da izvrši unos novog ispitnog roka tokom rada programa <code class="language-plaintext highlighter-rouge">readStability</code> i da se novi rok vidi prilikom drugog ispisivanja. Zatim, ponovo pokrenuti program <code class="language-plaintext highlighter-rouge">readStability</code> (nakon ponovnog pripremanja baze podataka pozivom <code class="language-plaintext highlighter-rouge">make db</code>), pa u toku prvog ispisivanja ili nakon njega, pokrenuti program <code class="language-plaintext highlighter-rouge">updateIspitniRok</code>. Uveriti se da program <code class="language-plaintext highlighter-rouge">updateIspitniRok</code> ovoga puta može da promeni informacije o ispitnim rokovima, čak i dok program <code class="language-plaintext highlighter-rouge">cursorStability</code> radi, kao i da će ovoga puta program <code class="language-plaintext highlighter-rouge">cursorStability</code> videti te izmene prilikom drugog ispisivanja, što nije bio slučaj za nivo izolovanosti RS ili strožijim od njega.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_5/cursorStability.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">hSchoolYear</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hFinalsLabel</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> 
     <span class="n">hFinalsName</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span>
     <span class="n">hFinalsStartDate</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
     <span class="n">hFinalsEndDate</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cFinals</span> <span class="n">CURSOR</span> <span class="n">FOR</span>
        <span class="n">SELECT</span>  <span class="n">SKGODINA</span><span class="p">,</span> 
                <span class="n">OZNAKAROKA</span><span class="p">,</span> 
                <span class="n">NAZIV</span><span class="p">,</span>
                <span class="n">DATPOCETKA</span><span class="p">,</span>
                <span class="n">DATKRAJA</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
        <span class="n">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="mi">2021</span>
        <span class="n">FOR</span>     <span class="n">READ</span> <span class="n">ONLY</span>
        <span class="n">WITH</span>    <span class="n">CS</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare cursor"</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Citanje rezultata %d. put. Pritisnite ENTER za pocetak.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cFinals</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open"</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">---------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">FETCH</span>   <span class="n">cFinals</span>
                <span class="n">INTO</span>    <span class="o">:</span><span class="n">hSchoolYear</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">hFinalsLabel</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">hFinalsName</span><span class="p">,</span>
                        <span class="o">:</span><span class="n">hFinalsStartDate</span><span class="p">,</span>
                        <span class="o">:</span><span class="n">hFinalsEndDate</span><span class="p">;</span>
            <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch"</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">"%4.4d %-10.10s %-20.20s %-10.10s %-10.10s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hSchoolYear</span><span class="p">,</span> <span class="n">hFinalsLabel</span><span class="p">,</span> <span class="n">hFinalsName</span><span class="p">,</span> <span class="n">hFinalsStartDate</span><span class="p">,</span> <span class="n">hFinalsEndDate</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">---------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cFinals</span><span class="p">;</span>    
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_5/insertIspitniRok.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code_hint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">SQLCODE</span> <span class="o">&amp;&amp;</span> <span class="n">SQLCODE</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[%s] Objekat je zakljucan od strane druge transakcije. "</span>
            <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">code_hint</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">INSERT</span>  <span class="n">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="err">'</span><span class="n">Mar21</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">Mart</span> <span class="mi">2021</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="mo">03</span><span class="o">/</span><span class="mo">01</span><span class="o">/</span><span class="mi">2022</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="mo">03</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2022</span><span class="err">'</span><span class="p">);</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">(</span><span class="s">"INSERT"</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Insert"</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_5/updateIspitniRok.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code_hint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">SQLCODE</span> <span class="o">&amp;&amp;</span> <span class="n">SQLCODE</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[%s] Objekat je zakljucan od strane druge transakcije. "</span>
            <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">code_hint</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">UPDATE</span>  <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
            <span class="n">SET</span>     <span class="n">DATKRAJA</span> <span class="o">=</span> <span class="n">DATKRAJA</span> <span class="o">+</span> <span class="mi">3</span> <span class="n">DAYS</span>
            <span class="n">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="mi">2021</span><span class="p">;</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">(</span><span class="s">"UPDATE"</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Insert"</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 6.6</strong>: Napisati:</p>

  <ul>
    <li>C/SQL program <code class="language-plaintext highlighter-rouge">uncommittedRead</code> koji dva puta ispisuje informacije o godini, oznaci, nazivu i periodu prijavljivanja za svaki ispitni rok u 2021. godini. Dozvoljeno je da se prilikom drugog ispisivanja pojave novi redovi, da budu vidljive izmene pročitanih redova, bilo one potvrđene ili ne.</li>
    <li>C/SQL program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code> koji unosi novi ispitni rok za mesec mart u 2021. godini. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi. Zahtevati od korisnika eksplicitno potvrđivanje izmena nakon unosa.</li>
    <li>C/SQL program <code class="language-plaintext highlighter-rouge">updateIspitniRok</code> koji za svaki ispitni rok u 2021. godini produžava period prijavljivanja za 3 dana. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi. Zahtevati od korisnika eksplicitno potvrđivanje izmena nakon ažuriranja.</li>
  </ul>
</div>

<p>Rešenje: Kao i u prethodnom zadatku, napravljena je <code class="language-plaintext highlighter-rouge">Makefile</code> koja služi za pozivanje alata <code class="language-plaintext highlighter-rouge">make</code> na već opisan način.</p>

<p>Pokrenuti program <code class="language-plaintext highlighter-rouge">uncommittedRead</code> i započeti prvo ispisivanje. U toku ispisivanja ili nakon njega, pokrenuti program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code>, ali ne potvrditi izmene još uvek. Zatim, nastaviti sa daljim ispisivanjem ispitnih rokova u programu <code class="language-plaintext highlighter-rouge">uncommittedRead</code>. Uveriti se da program <code class="language-plaintext highlighter-rouge">insertIspitniRok</code> može da izvrši unos novog ispitnog roka tokom rada programa <code class="language-plaintext highlighter-rouge">uncommittedRead</code> i da se novi rok vidi prilikom drugog ispisivanja, bez obzira što izmene u programu <code class="language-plaintext highlighter-rouge">insertIspitniRok</code> nisu potvrđene. Zatim, ponovo pokrenuti program <code class="language-plaintext highlighter-rouge">readStability</code> (nakon ponovnog pripremanja baze podataka pozivom <code class="language-plaintext highlighter-rouge">make db</code>) i uraditi isti postupak sa programom <code class="language-plaintext highlighter-rouge">updateIspitniRok</code> umesto <code class="language-plaintext highlighter-rouge">insertIspitniRok</code>. Uveriti se će i ovoga puta program <code class="language-plaintext highlighter-rouge">uncommittedRead</code> videti nepotvrđene izmene od strane programa <code class="language-plaintext highlighter-rouge">updateIspitniRok</code>, slično kao i u slučaju programa <code class="language-plaintext highlighter-rouge">insertIspitniRok</code>. Ovo je ponašanje koje se neće javiti u slučaju nivoa izolovanosti CS ili strožijim od njega.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_6/uncommittedRead.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">hSchoolYear</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hFinalsLabel</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> 
     <span class="n">hFinalsName</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span>
     <span class="n">hFinalsStartDate</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
     <span class="n">hFinalsEndDate</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cFinals</span> <span class="n">CURSOR</span> <span class="n">FOR</span>
        <span class="n">SELECT</span>  <span class="n">SKGODINA</span><span class="p">,</span> 
                <span class="n">OZNAKAROKA</span><span class="p">,</span> 
                <span class="n">NAZIV</span><span class="p">,</span>
                <span class="n">DATPOCETKA</span><span class="p">,</span>
                <span class="n">DATKRAJA</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
        <span class="n">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="mi">2021</span>
        <span class="n">FOR</span>     <span class="n">READ</span> <span class="n">ONLY</span>
        <span class="n">WITH</span>    <span class="n">UR</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare cursor"</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Citanje rezultata %d. put. Pritisnite ENTER za pocetak.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cFinals</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open"</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">---------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">FETCH</span>   <span class="n">cFinals</span>
                <span class="n">INTO</span>    <span class="o">:</span><span class="n">hSchoolYear</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">hFinalsLabel</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">hFinalsName</span><span class="p">,</span>
                        <span class="o">:</span><span class="n">hFinalsStartDate</span><span class="p">,</span>
                        <span class="o">:</span><span class="n">hFinalsEndDate</span><span class="p">;</span>
            <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch"</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">"%4.4d %-10.10s %-20.20s %-10.10s %-10.10s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hSchoolYear</span><span class="p">,</span> <span class="n">hFinalsLabel</span><span class="p">,</span> <span class="n">hFinalsName</span><span class="p">,</span> <span class="n">hFinalsStartDate</span><span class="p">,</span> <span class="n">hFinalsEndDate</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">---------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cFinals</span><span class="p">;</span>    
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_6/insertIspitniRok.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code_hint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">SQLCODE</span> <span class="o">&amp;&amp;</span> <span class="n">SQLCODE</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[%s] Objekat je zakljucan od strane druge transakcije. "</span>
            <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">code_hint</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">INSERT</span>  <span class="n">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="err">'</span><span class="n">Mar21</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">Mart</span> <span class="mi">2021</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="mo">03</span><span class="o">/</span><span class="mo">01</span><span class="o">/</span><span class="mi">2022</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="mo">03</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2022</span><span class="err">'</span><span class="p">);</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">(</span><span class="s">"INSERT"</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Insert"</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Pritisnuti enter za potvrdjivanje izmena: "</span><span class="p">);</span>
    <span class="n">getchar</span><span class="p">();</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_6/updateIspitniRok.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code_hint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">SQLCODE</span> <span class="o">&amp;&amp;</span> <span class="n">SQLCODE</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[%s] Objekat je zakljucan od strane druge transakcije. "</span>
            <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">code_hint</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">UPDATE</span>  <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span>
            <span class="n">SET</span>     <span class="n">DATKRAJA</span> <span class="o">=</span> <span class="n">DATKRAJA</span> <span class="o">+</span> <span class="mi">3</span> <span class="n">DAYS</span>
            <span class="n">WHERE</span>   <span class="n">SKGODINA</span> <span class="o">=</span> <span class="mi">2021</span><span class="p">;</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">(</span><span class="s">"UPDATE"</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Insert"</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Pritisnuti enter za potvrdjivanje izmena: "</span><span class="p">);</span>
    <span class="n">getchar</span><span class="p">();</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Sledi još jedan zadatak koji ilustruje koncept konkurentnih transakcija u višekorisničkom okruženju. Za potrebe ovog zadatka je neophodno izvršiti naredne SQL naredbe:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">DRZAVA</span> <span class="p">(</span>
    <span class="n">IDDRZAVE</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">NAZIV</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">EKSKURZIJA</span> <span class="p">(</span>
    <span class="n">INDEKS</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">IDDRZAVE</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">TRENUTAKPRIJAVE</span> <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">INDEKS</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">INDEKS</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">DOSIJE</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">IDDRZAVE</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">DRZAVA</span>
<span class="p">);</span>

<span class="k">INSERT</span>  <span class="k">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">DRZAVA</span>
<span class="k">VALUES</span>  <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'Spanija'</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'Italija'</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'Grcka'</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'Nemacka'</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">'Rusija'</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">'Francuska'</span><span class="p">);</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 6.7</strong>: Napisati C/SQL program koji od korisnika zahteva da unese identifikator studijskog programa sa osnovnih studija. Program na osnovu unetog podatka pronalazi naredne informacije o studentima sa datog studijskog programa: (1) broj indeksa, (2) ime, (3) prezime, (4) broj položenih ispita tog studenta, (5) broj položenih ESPB bodova, ali samo ukoliko student ima položeno bar 12 predmeta, ima skupljeno bar 120 bodova i ako se studentov indeks već ne nalazi u tabeli <code class="language-plaintext highlighter-rouge">EKSKURZIJA</code>.</p>

  <p>Za svakog pronađenog studenta, korisnik unosi ceo broj koji predstavlja jedan od identifikatora država iz tabele <code class="language-plaintext highlighter-rouge">DRZAVA</code> ili 0 (pretpostaviti da je ispravan unos). Ukoliko korisnik unese identifikator, aplikacija unosi informacije u tabelu <code class="language-plaintext highlighter-rouge">EKSKURZIJA</code>, a ukoliko unese 0, prelazi se na sledećeg studenta. Nakon svaka 3 uneta glasa, ponuditi korisniku mogućnost da prekine sa daljom obradom i napusti program, unošenjem odgovora <code class="language-plaintext highlighter-rouge">'da'</code>.</p>

  <p>Napomene: Obrada jednog studenta predstavlja jednu transakciju. Proveravati greške koje se javljaju prilikom izvršavanja aplikacije u višekorisničkom okruženju. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi. Voditi računa da aplikacija ne sme da vidi bilo kakve vrste izmena od strane drugih aplikacija.</p>
</div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_7.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">hStudyProgramId</span><span class="p">;</span>

<span class="n">sqlint32</span> <span class="n">hIndex</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hName</span><span class="p">[</span><span class="mi">26</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">hSurname</span><span class="p">[</span><span class="mi">26</span><span class="p">];</span>
<span class="n">sqlint32</span> <span class="n">hNumOfPassedExams</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">hSumESPB</span><span class="p">;</span>

<span class="n">sqlint32</span> <span class="n">hCountryId</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code_hint</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"CONNECT TO"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"CURRENT LOCK TIMEOUT 5"</span><span class="p">);</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"Unesite identifikator studijskog programa sa osnovnih studija: "</span><span class="p">);</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hStudyProgramId</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">DECLARE</span> <span class="n">cStudents</span> <span class="n">CURSOR</span> <span class="n">WITH</span> <span class="n">HOLD</span> <span class="n">FOR</span> 
        <span class="n">SELECT</span>      <span class="n">D</span><span class="p">.</span><span class="n">INDEKS</span><span class="p">,</span>
                    <span class="n">RTRIM</span><span class="p">(</span><span class="n">D</span><span class="p">.</span><span class="n">IME</span><span class="p">),</span>
                    <span class="n">RTRIM</span><span class="p">(</span><span class="n">D</span><span class="p">.</span><span class="n">PREZIME</span><span class="p">),</span>
                    <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">AS</span> <span class="n">BROJ_POLOZENIH</span><span class="p">,</span>
                    <span class="n">SUM</span><span class="p">(</span><span class="n">P</span><span class="p">.</span><span class="n">ESPB</span><span class="p">)</span> <span class="n">AS</span> <span class="n">BROJ_ESPB</span>
        <span class="n">FROM</span>        <span class="n">DA</span><span class="p">.</span><span class="n">DOSIJE</span> <span class="n">D</span> <span class="n">JOIN</span>
                    <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span> <span class="n">I</span> <span class="n">ON</span> <span class="n">D</span><span class="p">.</span><span class="n">INDEKS</span> <span class="o">=</span> <span class="n">I</span><span class="p">.</span><span class="n">INDEKS</span> <span class="n">JOIN</span>
                    <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span> <span class="n">P</span> <span class="n">ON</span> <span class="n">I</span><span class="p">.</span><span class="n">IDPREDMETA</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">ID</span>
        <span class="n">WHERE</span>       <span class="n">D</span><span class="p">.</span><span class="n">IDPROGRAMA</span> <span class="o">=</span> <span class="o">:</span><span class="n">hStudyProgramId</span> <span class="n">AND</span>
                    <span class="n">I</span><span class="p">.</span><span class="n">OCENA</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="n">AND</span>
                    <span class="n">I</span><span class="p">.</span><span class="n">STATUS</span> <span class="o">=</span> <span class="sc">'o'</span> <span class="n">AND</span>
                    <span class="n">D</span><span class="p">.</span><span class="n">INDEKS</span> <span class="n">NOT</span> <span class="n">IN</span> <span class="p">(</span>
                        <span class="n">SELECT</span>  <span class="n">INDEKS</span>
                        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">EKSKURZIJA</span>
                    <span class="p">)</span>
        <span class="n">GROUP</span> <span class="n">BY</span>    <span class="n">D</span><span class="p">.</span><span class="n">INDEKS</span><span class="p">,</span>
                    <span class="n">D</span><span class="p">.</span><span class="n">IME</span><span class="p">,</span>
                    <span class="n">D</span><span class="p">.</span><span class="n">PREZIME</span>
        <span class="n">HAVING</span>      <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="n">AND</span>
                    <span class="n">SUM</span><span class="p">(</span><span class="n">P</span><span class="p">.</span><span class="n">ESPB</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">120</span>
        <span class="n">FOR</span>         <span class="n">READ</span> <span class="n">ONLY</span>
        <span class="n">WITH</span>        <span class="n">RR</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"DECLARE"</span><span class="p">);</span>
        
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cStudents</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"OPEN"</span><span class="p">);</span>
    
    <span class="kt">unsigned</span> <span class="n">numOfStudents</span> <span class="o">=</span> <span class="mi">0u</span><span class="p">;</span>
    
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">FETCH</span> <span class="n">cStudents</span> <span class="n">INTO</span>
            <span class="o">:</span><span class="n">hIndex</span><span class="p">,</span>
            <span class="o">:</span><span class="n">hName</span><span class="p">,</span>
            <span class="o">:</span><span class="n">hSurname</span><span class="p">,</span>
            <span class="o">:</span><span class="n">hNumOfPassedExams</span><span class="p">,</span>
            <span class="o">:</span><span class="n">hSumESPB</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">(</span><span class="s">"FETCH"</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"FETCH"</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">----------------------------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Anketiram studenta: %-10.10s %-15.15s (%d) - broj polozenih ispita = %5.5d, broj polozenih espb = %5.5d"</span><span class="p">,</span> 
               <span class="n">hName</span><span class="p">,</span> <span class="n">hSurname</span><span class="p">,</span> <span class="n">hIndex</span><span class="p">,</span> <span class="n">hNumOfPassedExams</span><span class="p">,</span> <span class="n">hSumESPB</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">----------------------------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Unesite identifikator drzave ili 0: "</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hCountryId</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hCountryId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"Unosim Vas glas za drzavu sa identifikatorom %d...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hCountryId</span><span class="p">);</span>
        
        
        <span class="n">EXEC</span> <span class="n">SQL</span>
            <span class="n">INSERT</span>  <span class="n">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">EKSKURZIJA</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="o">:</span><span class="n">hIndex</span><span class="p">,</span> <span class="o">:</span><span class="n">hCountryId</span><span class="p">,</span> <span class="n">CURRENT_DATE</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">(</span><span class="s">"INSERT INTO"</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="c1">// Ako je neka druga aplikacija vec unela red za datog studenta...</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">803</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">checkSQL</span><span class="p">(</span><span class="s">"INSERT INTO"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// ...onda cemo pitati korisnika da li zeli da radi azuriranje glasa.</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Postoji glas za tekuceg studenta. Da li zelite da azurirate glas? [d/n] "</span><span class="p">);</span>
            <span class="kt">char</span> <span class="n">odgovor</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
            <span class="n">getchar</span><span class="p">();</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">odgovor</span> <span class="o">==</span> <span class="sc">'n'</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">UPDATE</span>  <span class="n">DA</span><span class="p">.</span><span class="n">EKSKURZIJA</span>
                <span class="n">SET</span>     <span class="n">IDDRZAVE</span> <span class="o">=</span> <span class="o">:</span><span class="n">hCountryId</span>
                <span class="n">WHERE</span>   <span class="n">INDEKS</span> <span class="o">=</span> <span class="o">:</span><span class="n">hIndex</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">waitForLock</span><span class="p">(</span><span class="s">"UPDATE"</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">checkSQL</span><span class="p">(</span><span class="s">"UPDATE"</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"Vas glas je uspesno zabelezen!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"COMMIT"</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">********** END TRANSACTION **********</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
        <span class="o">++</span><span class="n">numOfStudents</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">numOfStudents</span> <span class="o">%</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Da li zelite da zavrsite anketiranje? [da/ne] "</span><span class="p">);</span>
            <span class="kt">char</span> <span class="n">userResponse</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
            <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">userResponse</span><span class="p">);</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">userResponse</span><span class="p">,</span> <span class="s">"da"</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Zavrsavam program!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cStudents</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"CLOSE"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"CURRENT LOCK TIMEOUT NULL"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"COMMIT - kraj programa"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"CONNECT RESET"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">waitForLock</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code_hint</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">SQLCODE</span> <span class="o">&amp;&amp;</span> <span class="n">SQLCODE</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[%s] Objekat je zakljucan od strane druge transakcije. "</span>
            <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">code_hint</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cStudents</span><span class="p">;</span>    
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open predmeti - obrada cekanja"</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<h2 id="65-programersko-zaključavanje-tabela">6.5 Programersko zaključavanje tabela</h2>

<p>Programeri mogu sami da zatraže katance od SUBP ukoliko smatraju da im je to neophodno, ali sa ograničenjem da je na ovaj način jedino moguće zaključati tabelu, a ne redove, blokove, i druge objekte. SQL naredba <code class="language-plaintext highlighter-rouge">LOCK TABLE</code> onemogućava konkurentnoj aplikaciji da koristi ili menja tabelu, u zavinosti od režima u kojem se tabela zaključava. Ovako dobijeni katanac se oslobađa kada se završi jedinica posla u kojem je naredba <code class="language-plaintext highlighter-rouge">LOCK TABLE</code> izvršena, bilo operacijom potvrđivanja izmena ili njenim završavanjem.</p>

<p>Korisnik koji izvršava naredbu <code class="language-plaintext highlighter-rouge">LOCK TABLE</code> mora da ima barem jednu od narednih privilegija da bi je uspešno izvršio:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">SELECT</code> privilegiju nad tabelom koja se zaključava.</li>
  <li><code class="language-plaintext highlighter-rouge">CONTROL</code> privilegiju nad tabelom koja se zaključava.</li>
  <li><code class="language-plaintext highlighter-rouge">DATAACCESS</code> privilegiju.</li>
</ul>

<p>Sintaksa ove naredbe je data u nastavku:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">LOCK</span> <span class="k">TABLE</span> <span class="o">&lt;</span><span class="n">IME_TABELE</span><span class="o">&gt;</span> <span class="k">IN</span> <span class="p">[</span><span class="k">SHARE</span><span class="o">|</span><span class="k">EXCLUSIVE</span><span class="p">]</span> <span class="k">MODE</span>
</code></pre></div></div>

<p>Ovom naredbom se traži odgovarajući katanac nad tabelom <code class="language-plaintext highlighter-rouge">&lt;IME_TABELE&gt;</code>. U zavisnosti od odabranih vrednosti narednih opcija prilikom deklaracije složene SQL naredbe, ta naredba može imati različite varijante koji utiču na način izvršavanja:</p>

<ul>
  <li>
    <p>Klauza <code class="language-plaintext highlighter-rouge">SHARE</code> onemogućava konkurentnoj aplikaciji da izvrši bilo koju operaciju osim čitanja podataka iz tabele.</p>
  </li>
  <li>
    <p>Kluza <code class="language-plaintext highlighter-rouge">EXCLUSIVE</code> onemogućava konkurentnoj aplikaciji da izvrši bilo koju operaciju nad tabelom. Napomenimo da ovaj režim ne onemogućava da aplikacioni procesi izvršavaju naredbe čitanja podataka iz tabele ukoliko oni rade na nivou izolacije nepotvrđeno čitanje (UR).</p>
  </li>
</ul>

<div class="ui stacked segment">
  <p><strong>Zadatak 6.6</strong>: Napisati C/SQL program <code class="language-plaintext highlighter-rouge">shareMode</code> koji ispisuje identifikator, oznaku, naziv i broj ESPB bodova za svaki studijski program u bazi podataka. Omogućiti da ostale aplikacije ne mogu da menjaju ove podatke tokom ispisivanja podataka.</p>

  <p>Napisati C/SQL program <code class="language-plaintext highlighter-rouge">exclusiveMode</code> koji ispisuje identifikator, oznaku, naziv, broj semestara i broj ESPB bodova za svaki studijski program u bazi podataka. Omogućiti da ostale aplikacije ne mogu da menjaju ove podatke tokom ispisivanja podataka, kao ni da ih čitaju.</p>
</div>

<p>Rešenje: Isprobati sve kombinacije redosleda izvršavanja programa <code class="language-plaintext highlighter-rouge">exclusiveMode</code> i <code class="language-plaintext highlighter-rouge">shareMode</code> i uveriti se da jedino kombinacija <code class="language-plaintext highlighter-rouge">(shareMode, shareMode)</code> može raditi konkurentno. Primetimo da u ovom zadatku nismo koristili obradu čekanja na katance niti smo postavili vreme za istek katanaca, što znači da će jedna aplikacija čekati sve dok druga ne završi sa radom.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_8/shareMode.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">hCourseId</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hCourseLabel</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">hCourseName</span><span class="p">[</span><span class="mi">201</span><span class="p">];</span>
<span class="kt">short</span> <span class="n">hCourseESPB</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="c1">// Zakljucavamo tabelu PREDMET u deljenom rezimu</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">LOCK</span> <span class="n">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span> <span class="n">IN</span> <span class="n">SHARE</span> <span class="n">MODE</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Lock table"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cCourses</span> <span class="n">CURSOR</span> <span class="n">FOR</span> 
        <span class="n">SELECT</span>  <span class="n">ID</span><span class="p">,</span> 
                <span class="n">OZNAKA</span><span class="p">,</span> 
                <span class="n">NAZIV</span><span class="p">,</span> 
                <span class="n">ESPB</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare cursor"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cCourses</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open cursor"</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">cCourses</span>
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">hCourseId</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">hCourseLabel</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">hCourseName</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">hCourseESPB</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch cursor"</span><span class="p">);</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"%4.4d %-10.10s %-30.30s %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hCourseId</span><span class="p">,</span> <span class="n">hCourseLabel</span><span class="p">,</span> <span class="n">hCourseName</span><span class="p">,</span> <span class="n">hCourseESPB</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Pritisnite ENTER za dalje citanje</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cCourses</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close cursor"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_6/zadatak_6_8/exclusiveMode.sqc</code></strong>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">hCourseId</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">hCourseLabel</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">hCourseName</span><span class="p">[</span><span class="mi">201</span><span class="p">];</span>
<span class="kt">short</span> <span class="n">hCourseESPB</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">checkSQL</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Greska %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">stud2020</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="c1">// Zakljucavamo tabelu PREDMET u privatnom rezimu</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">LOCK</span> <span class="n">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span> <span class="n">IN</span> <span class="n">EXCLUSIVE</span> <span class="n">MODE</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Lock table"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">cCourses</span> <span class="n">CURSOR</span> <span class="n">FOR</span> 
        <span class="n">SELECT</span>  <span class="n">ID</span><span class="p">,</span> 
                <span class="n">OZNAKA</span><span class="p">,</span> 
                <span class="n">NAZIV</span><span class="p">,</span> 
                <span class="n">ESPB</span>
        <span class="n">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Declare cursor"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">cCourses</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Open cursor"</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">cCourses</span>
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">hCourseId</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">hCourseLabel</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">hCourseName</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">hCourseESPB</span><span class="p">;</span>
        <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Fetch cursor"</span><span class="p">);</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"%4.4d %-10.10s %-30.30s %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hCourseId</span><span class="p">,</span> <span class="n">hCourseLabel</span><span class="p">,</span> <span class="n">hCourseName</span><span class="p">,</span> <span class="n">hCourseESPB</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Pritisnite ENTER za dalje citanje</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">cCourses</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Close cursor"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">checkSQL</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<h2 id="66-zadaci-za-vežbu">6.6 Zadaci za vežbu</h2>

<div class="ui stacked segment">
  <p><strong>Zadatak 6.9</strong>: Napisati C/SQL program koji za sve ispitne rokove pronalazi informacije o polaganjima za svaki položeni predmet u tom ispitnom roku i te podatke unosi u tabelu <code class="language-plaintext highlighter-rouge">ISPITNIROKOVIPOLAGANJA</code>. Nakon jednog unosa podataka ispisati unete podatke odvojene zapetom. Nakon svih unosa podataka, potrebno je odgovarajućom SQL naredbom izračunati broj unetih redova u tabeli <code class="language-plaintext highlighter-rouge">ISPITNIROKOVIPOLAGANJA</code> i ispisati rezultat na standardni izlaz. Napisati program tako da može da radi u višekorisničkom okruženju. Unos podataka za jedan ispitni rok i jedno polaganje predstavlja jednu transakciju. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.</p>
</div>

<p>Napraviti tabelu <code class="language-plaintext highlighter-rouge">ISPITNIROKOVIPOLAGANJA</code> koja sadrži kolone sa podacima o:</p>
<ul>
  <li>godini roka</li>
  <li>oznaci roka</li>
  <li>identifikatoru predmeta</li>
  <li>oceni</li>
  <li>broju položenih ispita na tom predmetu sa tom ocenom</li>
  <li>nazivu roka</li>
  <li>nazivu predmeta</li>
</ul>

<p>Definisati primarni ključ na osnovu prvih 5 kolona i strane ključeve ka odgovarajućim tabelama.</p>

<div class="ui stacked segment">
  <p><strong>Zadatak 6.10</strong>: Napisati C/SQL program koji za sve studente pronalazi informacije o studijskom programu na kojem studiraju i te podatke unosi u tabelu <code class="language-plaintext highlighter-rouge">STUDIJSKIPROGRAMPSTUDENTI</code>. Nakon jednog unosa podataka ispisati unete podatke odvojene zapetom. Nakon svih unosa podataka, potrebno je odgovarajućom SQL naredbom izračunati broj unetih redova u tabeli <code class="language-plaintext highlighter-rouge">STUDIJSKIPROGRAMPSTUDENTI</code> i ispisati rezultat na standardni izlaz. Napisati program tako da može da radi u višekorisničkom okruženju. Unos podataka za jednog studenta i jedan studijski program predstavlja jednu transakciju. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.</p>
</div>

<p>Napraviti tabelu <code class="language-plaintext highlighter-rouge">STUDIJSKIPROGRAMPSTUDENTI</code> koja sadrži kolone sa podacima o:</p>
<ul>
  <li>indeksu studenta</li>
  <li>nazivu studijskog programa</li>
  <li>imenu i prezimenu studenta</li>
  <li>zvanju</li>
  <li>broju bodova koji je potrebno ostvariti na studijskom programu</li>
  <li>broju bodova koje je student trenutno ostvario</li>
  <li>napomeni: vrednost ove kolone je niska <code class="language-plaintext highlighter-rouge">'Polozeni su svi predmeti'</code> ukoliko je student ostvario sve potrebne poene, a prazna niska u suprotnom</li>
</ul>

<p>Definisati primarni ključ na osnovu prve 2 kolone i strane ključeve ka odgovarajućim tabelama.</p>

<div class="ui stacked segment">
  <p><strong>Zadatak 6.11</strong>: Napisati C/SQL program koji redom omogućava naredne funkcionalnosti:</p>

  <ol>
    <li>Student započinje prijavljivanje na praksu navođenjem broja indeksa, nakon čega mu se nudi spisak numerisanih naziva predmeta za koje se može prijaviti da radi praksu. Za prijavljivanje studentu se nude samo predmeti koje je položio sa ocenom većom od prosečne ocene sa položenih ispita iz tog predmeta.</li>
    <li>Zatim student (potencijalno više puta) upisuje identifikator predmeta iz koga želi da radi praksu, ili 0 za kraj. Posle svakog izabranog predmeta studentu se nudi izmenjen spisak predmeta u kome se ne nalaze
već izabrani predmeti. Odabrani predmet se unosi u tabelu <code class="language-plaintext highlighter-rouge">PRAKSA</code>.</li>
    <li>Na kraju se ispisuje izveštaj koji za svaki prijavljeni predmet sadrži: naziv predmeta, broj do tada prijavljenih studenata za praksu iz tog predmeta; prosečnu prolaznost (ukupnu) u poslednjih 5 godina. Izveštaj urediti u opadajućem redosledu po prolaznosti. Prolaznost računati kao količnik broja položenih ispita sa ocenom većom od 5 nevezano od statusa prijave i broja izlazaka na ispit (broja unosa u tabelu ispit sa statusom prijave različitim od ‘n’).</li>
  </ol>

  <p>Svako prijavljivanje predstavlja nezavisnu transakciju. Napisati program tako da radi ispravno u višekorisničkom okruženju. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.</p>
</div>

<p>Potrebno je u bazi vstud kreirati naredbu koja pravi tabelu <code class="language-plaintext highlighter-rouge">PRAKSA</code> koja ima kolone:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">INDEKS</code> - indeks studenta;</li>
  <li><code class="language-plaintext highlighter-rouge">IDPREDMETA</code> - identifikator predmeta koji student prijavljuje.</li>
</ul>

<p>Definisati primarni ključ u tabeli <code class="language-plaintext highlighter-rouge">PRAKSA</code> i strane ključeve nad tabelama <code class="language-plaintext highlighter-rouge">DOSIJE</code> i <code class="language-plaintext highlighter-rouge">PREDMET</code>. U ovoj tabeli se čuvaju podaci o prijavljenim praksama. Jedan student može potencijalno prijaviti više različitih predmeta, a i isti predmet može prijaviti više različitih studenata.</p>

<hr />
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Obratiti pažnju da se ne radi o <code class="language-plaintext highlighter-rouge">WITH</code> klauzi za kreiranje privremenih tabela u <code class="language-plaintext highlighter-rouge">SELECT</code> naredbi, već da se ova <code class="language-plaintext highlighter-rouge">WITH</code> klauza nekad naziva i <code class="language-plaintext highlighter-rouge">isolation-clause</code>. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

        </div>
    </div>

    <script>
        $('#pageSticky').sticky({
            context: '#pageContent'
        });

        $('#pageSticky').click(function () {
            $('#sideMenu').sidebar('toggle');
        });
    </script>
</body>

</html>