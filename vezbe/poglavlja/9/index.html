<!DOCTYPE html>
<html lang="rs">
<head>
    <title>9. Napredne tehnike razvijanja Java/SQL aplikacija | Programiranje baza podataka</title>
    <meta charset="utf-8">

    <link rel="stylesheet" type="text/css" href="/resources/semantic/semantic.min.css">
    <script src="/resources/jquery/jquery-3.5.1.min.js"></script>
    <script src="/resources/semantic/semantic.min.js"></script>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <script src="https://semantic-ui.com/javascript/library/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
        $(document).ready(() => {
            $("table").addClass('ui celled table');
        });
    </script>
</head>

<body>
    <div class="ui sticky black big launch right attached fixed button" id="pageSticky">
        <i class="content icon"></i>
        <span class="text">Prikaži sadržaj</span>
    </div>

    <div class="ui sidebar vertical menu" id="sideMenu">
        <div class="item">
            <h3>Sadržaj</h3>
        </div>
        <a class="item" href="/vezbe/predgovor">Predgovor</a>
        <a class="item" href="/vezbe/poglavlja/1">1. Uvod u programiranje baza podataka</a>
        <a class="item" href="/vezbe/poglavlja/2">2. Osnovni koncepti programiranja C/SQL aplikacija</a>
        <a class="item" href="/vezbe/poglavlja/3">3. Programiranje korišćenjem kursora</a>
        <a class="item" href="/vezbe/poglavlja/4">4. Aplikacije sa dinamičkim SQL naredbama</a>
        <a class="item" href="/vezbe/poglavlja/5">5. Implementiranje transakcija</a>
        <a class="item" href="/vezbe/poglavlja/6">6. Aplikacije u višekorisničkom okruženju</a>
        <a class="item" href="/vezbe/poglavlja/7">7. Povezivanje aplikacija na više baza podataka</a>
        <a class="item" href="/vezbe/poglavlja/8">8. Osnovni koncepti programiranja Java/SQL aplikacija sa
            dinamičkim SQL naredbama (JDBC)</a>
        <a class="item" href="/vezbe/poglavlja/9">9. Napredne tehnike razvijanja Java/SQL aplikacija</a>
        <a class="item" href="/vezbe/poglavlja/10">10. Uvod u razvojno okruženje Hibernate</a>
        <a class="item" href="/vezbe/poglavlja/11">11. Napredna objektno-relaciona preslikavanja</a>
        <a class="item" href="/vezbe/poglavlja/12">12. Napredno kreiranje upita pomoću JPA Criteria API</a>
        <a class="item" href="/vezbe/poglavlja/13">13. Programiranje SQL rutina</a>
        <a class="item" href="/vezbe/poglavlja/14">14. Korisnički-definisane funkcije</a>
        <a class="item" href="/vezbe/poglavlja/15">15. Ugrađene procedure</a>
        <a class="item" href="/vezbe/poglavlja/16">16. Okidači</a>
    </div>

    <div class="ui justified container">
        <img class="ui centered small image" src="/resources/matf-srb.png">
        <header class="ui center aligned block header">
            <h1><a href="/">Programiranje baza podataka</a></h1>
        </header>

        <div class="ui divider"></div>

        <div id="pageContent">
            <h2>9. Napredne tehnike razvijanja Java/SQL aplikacija</h2>


<div class="ui warning message">
    <div class="header">
        Ova stranica je pod konstrukcijom!
    </div>
    Ako pronađete grešku ili propust, molimo Vas da nam skrenete pažnju otvaranjem primedbe na <a href="https://github.com/MATF-PBP/matf-pbp.github.io"><i class="github icon"></i>zvaničnom GitHub repozitorijumu</a>.
</div>


<p>U ovom poglavlju ćemo demonstrirati rad sa transakcijama, rad u konkurentnom okruženju,
kao i povezivanje na više baza podataka u JDBC aplikacijama.</p>

<h2 id="91-transakcioni-rad">9.1 Transakcioni rad</h2>

<p>JDBC podržava naredne koncepte za upravljanje transakcijama:</p>

<ul>
  <li>Režim automatskog potvrđivanja izmena</li>
  <li>Podešavanje nivoa izolovanosti transakcija</li>
  <li>Tačke čuvanja</li>
</ul>

<h3 id="911-režim-automatskog-potvrđivanja-izmena">9.1.1 Režim automatskog potvrđivanja izmena</h3>

<p>Prilikom povezivanja na bazu podataka, JDBC drajver podrazumevano postavlja svojstvo
objekta interfejsa <code class="language-plaintext highlighter-rouge">Connection</code> automatskog potvrđivanja izmena na <code class="language-plaintext highlighter-rouge">true</code>. Ako je
konekcija podešena u režimu automatskog potvrđivanja izmena, onda će svaka
SQL naredba koja se izvrši nad bazom podataka biti u isto vreme i potvrđena (u
slučaju uspešnog izvršenja te naredbe) ili poništena (u slučaju 
neuspešnog izvršenja te naredbe).</p>

<p>Ovo ponašanje nam često nije poželjno, s obzirom da je neophodno da sami
definišemo koje sve SQL naredbe predstavljaju deo transakcija u aplikacijama. Zbog
toga, potrebno je isključiti režim automatskog potvrđivanja izmena. Ovo se
izvršava pozivom metoda <code class="language-plaintext highlighter-rouge">Connection.setAutoCommit(boolean autoCommit)</code> i 
prosle\d jivanjem vrednosti <code class="language-plaintext highlighter-rouge">false</code>, nakon što se konekcija ka bazi podataka uspešno
uspostavi.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Dohvatanje konekcije</span>
<span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">dbURL</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>

<span class="c1">// Isključivanje režima automatskog potvrđivanja izmena</span>
<span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</code></pre></div></div>

<p>Ako se metod <code class="language-plaintext highlighter-rouge">setAutoCommit</code> poziva da bi se promenio režim automatskog potvrđivanja 
izmena u toku izvršavanja neke transakcije, ta transakcija će biti potvrđena u tom
trenutku. Zbog toga što ovakvo ponašanje može dovesti do neočekivanih ponašanja
u odnosu na poslovnu logiku aplikacije, obično se režim automatskog potvrđivanja 
izmena postavlja odmah nakon povezivanja na bazu podataka, kao u primeru koda iznad.</p>

<h4 id="potvrđivanje-i-poništavanje-izmena-u-transakcijama">Potvrđivanje i poništavanje izmena u transakcijama</h4>

<p>Jednog kada je režim automatskog potvrđivanja izmena isključen, na raspolaganju
su nam metodi <code class="language-plaintext highlighter-rouge">Connection.commit()</code> i <code class="language-plaintext highlighter-rouge">Connection.rollback()</code> kojima se upravlja dužina
trajanja i uspešnost transakcija.</p>

<p>Uobičajeni kod u JDBC aplikacijama koji izvršava transakciju nad bazom podataka je
dat u nastavku:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="o">(</span>
    <span class="c1">// Get a connection</span>
    <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">dbURL</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
<span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Set the auto-commit off</span>
    <span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

    <span class="c1">// Perform database transaction activities here</span>
    
    <span class="c1">// Successful scenario:</span>
    <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"An error occured: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Rolling back the transaction"</span><span class="o">);</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// Unsuccessful scenario:</span>
        <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 9.1</strong>: Napisati Java program u kojem se SQL naredbe izvršavaju dinamički koji redom:</p>

  <ol>
    <li>Pronalazi i ispisuje najveći indeks iz tabele <code class="language-plaintext highlighter-rouge">ISPIT</code>.</li>
    <li>Briše studenta sa pronađenim indeksom iz tabele <code class="language-plaintext highlighter-rouge">ISPIT</code> i ispisuje poruku korisniku o uspešnosti brisanja.</li>
    <li>Ponovo pronalazi i ispisuje najveći indeks iz tabele <code class="language-plaintext highlighter-rouge">ISPIT</code>.</li>
    <li>Pita korisnika da li želi da potvrdi ili poništi izmene. U zavisnosti od korisnikovog odgovora, aplikacija potvrđuje ili poništava izmene uz ispisivanje poruke korisniku.</li>
    <li>Ponovo pronalazi i ispisuje najveći indeks iz tabele <code class="language-plaintext highlighter-rouge">ISPIT</code>.</li>
  </ol>
</div>

<p>Rešenje:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_1/Main.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_9_1</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.ibm.db2.jcc.DB2Driver"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"jdbc:db2://localhost:50000/stud2020"</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="s">"student"</span><span class="o">,</span> <span class="s">"abcdef"</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// Iskljucujemo automatsko potvrdjivanje izmena</span>
            <span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="c1">// Moramo da imamo unutrasnji try-catch blok,</span>
            <span class="c1">// kako bismo pozvali metode commit() ili rollback()</span>
            <span class="c1">// tik pred zatvaranje konekcije</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Integer</span> <span class="n">indeks</span> <span class="o">=</span> <span class="n">pronadjiNajveciIndeks</span><span class="o">(</span><span class="n">con</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"1. Najveci indeks u tabeli ISPIT je "</span> <span class="o">+</span> <span class="n">indeks</span><span class="o">);</span>
                <span class="n">obrisiIspite</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">indeks</span><span class="o">);</span>
                <span class="n">indeks</span> <span class="o">=</span> <span class="n">pronadjiNajveciIndeks</span><span class="o">(</span><span class="n">con</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"3. Najveci indeks u tabeli ISPIT je "</span> <span class="o">+</span> <span class="n">indeks</span><span class="o">);</span>
                <span class="n">potvrdiIliPonistiIzmene</span><span class="o">(</span><span class="n">con</span><span class="o">);</span>
                <span class="n">indeks</span> <span class="o">=</span> <span class="n">pronadjiNajveciIndeks</span><span class="o">(</span><span class="n">con</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"5. Najveci indeks u tabeli ISPIT je "</span> <span class="o">+</span> <span class="n">indeks</span><span class="o">);</span>
                
                <span class="c1">// S obzirom da je sve proslo kako treba ako se doslo do ove tacke,</span>
                <span class="c1">// potvrdjujemo izmene pre raskidanje konekcije</span>
                <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Ako je bilo gde u kodu u try bloku doslo do gresaka,</span>
                <span class="c1">// ovim se osiguravamo da ce rollback() metod biti pozvan</span>
                <span class="c1">// pre automatskog zatvaranja konekcije nakon napustanja try-with-resources bloka</span>
                <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SQLCODE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span> <span class="s">"SQLSTATE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getSQLState</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span>
                    <span class="o">+</span> <span class="s">"PORUKA: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Doslo je do neke greske: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Integer</span> <span class="nf">pronadjiNajveciIndeks</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> 
            <span class="s">"SELECT  MAX(INDEKS)"</span> <span class="o">+</span>
            <span class="s">"FROM    DA.ISPIT"</span><span class="o">;</span>
        <span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
        <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        
        <span class="nc">Integer</span> <span class="n">indeks</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">boolean</span> <span class="n">imaRezultata</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">imaRezultata</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">indeks</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">"Nema ispita u bazi"</span><span class="o">);</span>
        <span class="o">}</span>
        
        <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        
        <span class="k">return</span> <span class="n">indeks</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">obrisiIspite</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">indeks</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> 
            <span class="s">"DELETE  FROM DA.ISPIT "</span> <span class="o">+</span>
            <span class="s">"WHERE   INDEKS = ?"</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">stmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">indeks</span><span class="o">);</span>
        
        <span class="n">stmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
        
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"2. Obrisani su ispiti za studenta sa indeksom "</span> <span class="o">+</span> <span class="n">indeks</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">potvrdiIliPonistiIzmene</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"4. Da li zelite da potvrdite izmene [y] ili da ponistite izmene [n]?"</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">Scanner</span> <span class="n">ulaz</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">odgovor</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"y"</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// Potvrdjivanje izmena</span>
                <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Izmene su potvrdjene!"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// Ponistavanje izmena</span>
                <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Izmene su ponistene!"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="912-nivoi-izolacije-transakcija">9.1.2 Nivoi izolacije transakcija</h3>

<p>ANSI SQL-92 standard definiše četiri nivoa izolacije transakcija u terminima
konzistentnosti podataka. Svaki nivo izolacije definiše koje vrste nekonzistentnosti
podataka jesu ili nisu dozvoljene. Ovi nivoi su:</p>

<ul>
  <li>Read uncommitted</li>
  <li>Read committed</li>
  <li>Repeatable read</li>
  <li>Serializable</li>
</ul>

<p>JDBC standard definiše naredne četiri statičke konstante interfejsa <code class="language-plaintext highlighter-rouge">Connection</code> 
koji odgovaraju nivoima izolacije ANSI SQL-92 standarda, redom:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">TRANSACTION_READ_UNCOMMITTED</code></li>
  <li><code class="language-plaintext highlighter-rouge">TRANSACTION_READ_COMMITTED</code></li>
  <li><code class="language-plaintext highlighter-rouge">TRANSACTION_REPEATABLE_READ</code></li>
  <li><code class="language-plaintext highlighter-rouge">TRANSACTION_SERIALIZABLE</code></li>
</ul>

<p>Postavljanje nivoa izolacije transakcija za bazu podataka se može izvršiti pozivom metoda <code class="language-plaintext highlighter-rouge">Connection.setTransactionIsolation(int level)</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Get a Connection object</span>
<span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">dbURL</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>

<span class="c1">// Set the transaction isolation level to read committed</span>
<span class="n">con</span><span class="o">.</span><span class="na">setTransactionIsolation</span><span class="o">(</span><span class="nc">Connection</span><span class="o">.</span><span class="na">TRANSACTION_READ_COMMITTED</span><span class="o">);</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 9.2</strong>: Napisati Java program u kojem se SQL naredbe izvršavaju dinamički koji iz tabele <code class="language-plaintext highlighter-rouge">UKUPNIBODOVI</code> (videti ispod) izdvaja 10 najuspešnijih studenata. Za svakog studenta ispisati podatke iz te tabele i upitati korisnika da li želi da dodeli tom studentu počasnih 10 ESPB. Ukoliko želi, izvršiti odgovarajuću izmenu. Nakon svih izmena, ispisati izveštaj rada u kojem se vide izmene. Sve izmene i prikaz izveštaja implementirati kao jednu transakciju. Omogućiti da nijedan drugi korisnik ne može da vidi izmene tokom rada ovog programa.</p>
</div>

<p>Rešenje: Pre početka izvršavanja, izvršiti naredni skript nad bazom podataka <code class="language-plaintext highlighter-rouge">STUD2020</code> koji će pripremiti podatke:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_2/priprema_baze.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">UKUPNIBODOVI</span> <span class="p">(</span>
    <span class="n">INDEKS</span>  <span class="nb">INTEGER</span>     <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">IME</span>     <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">PREZIME</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">ESPB</span>    <span class="nb">INTEGER</span>     <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">INDEKS</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">INDEKS</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">DOSIJE</span>    
<span class="p">);</span>

<span class="k">INSERT</span>      <span class="k">INTO</span> <span class="n">DA</span><span class="p">.</span><span class="n">UKUPNIBODOVI</span>
<span class="k">SELECT</span>      <span class="n">D</span><span class="p">.</span><span class="n">INDEKS</span><span class="p">,</span> 
            <span class="n">IME</span><span class="p">,</span> 
            <span class="n">PREZIME</span><span class="p">,</span> 
            <span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> 
                <span class="k">WHEN</span> <span class="n">OCENA</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">AND</span> <span class="n">STATUS</span> <span class="o">=</span> <span class="s1">'o'</span> <span class="k">THEN</span> <span class="n">P</span><span class="p">.</span><span class="n">ESPB</span> 
                <span class="k">ELSE</span> <span class="mi">0</span> 
                <span class="k">END</span><span class="p">)</span> <span class="n">UKUPNO_BODOVA</span>
<span class="k">FROM</span>        <span class="n">DA</span><span class="p">.</span><span class="n">DOSIJE</span> <span class="n">D</span> <span class="k">JOIN</span>
            <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span> <span class="n">I</span> <span class="k">ON</span> <span class="n">D</span><span class="p">.</span><span class="n">INDEKS</span> <span class="o">=</span> <span class="n">I</span><span class="p">.</span><span class="n">INDEKS</span> <span class="k">JOIN</span>
            <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span> <span class="n">P</span> <span class="k">ON</span> <span class="n">I</span><span class="p">.</span><span class="n">IDPREDMETA</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">ID</span>
<span class="k">GROUP</span> <span class="k">BY</span>    <span class="n">D</span><span class="p">.</span><span class="n">INDEKS</span><span class="p">,</span> <span class="n">IME</span><span class="p">,</span> <span class="n">PREZIME</span>
<span class="k">ORDER</span> <span class="k">BY</span>    <span class="n">UKUPNO_BODOVA</span> <span class="k">DESC</span><span class="p">;</span>

</code></pre></div></div>

<p>S obzirom da ćemo menjati odgovarajuću tabelu, naredbu <code class="language-plaintext highlighter-rouge">stmt</code> koja se koristi za kreiranje kursora koji prolazi tabelom moramo kreirati opcijom <code class="language-plaintext highlighter-rouge">ResultSet.CONCUR_UPDATABLE</code>. Međutim, da bismo sprečili sve ostale programe da vide izmene, potrebno je da postavimo najstrožiji nivo izolacije, tj. da pozovemo metod <code class="language-plaintext highlighter-rouge">setIsolationLevel()</code> sa argumentom <code class="language-plaintext highlighter-rouge">Connection.TRANSACTION_SERIALIZABLE</code>.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_2/Main.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_9_2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.DriverManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Statement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.ibm.db2.jcc.DB2Driver"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"jdbc:db2://localhost:50000/stud2020"</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="s">"student"</span><span class="o">,</span> <span class="s">"abcdef"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">con</span><span class="o">.</span><span class="na">setTransactionIsolation</span><span class="o">(</span><span class="nc">Connection</span><span class="o">.</span><span class="na">TRANSACTION_SERIALIZABLE</span><span class="o">);</span>

            <span class="k">try</span> <span class="o">(</span><span class="nc">Scanner</span> <span class="n">ulaz</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">izdvoji10NajuspesnijihStudenata</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">ulaz</span><span class="o">);</span>
                <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SQLCODE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span> <span class="s">"SQLSTATE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getSQLState</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span>
                    <span class="o">+</span> <span class="s">"PORUKA: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Doslo je do neke greske: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">izdvoji10NajuspesnijihStudenata</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Scanner</span> <span class="n">ulaz</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">(</span><span class="nc">ResultSet</span><span class="o">.</span><span class="na">TYPE_SCROLL_SENSITIVE</span><span class="o">,</span> <span class="nc">ResultSet</span><span class="o">.</span><span class="na">CONCUR_UPDATABLE</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> 
                <span class="s">"SELECT  * "</span> <span class="o">+</span> 
                <span class="s">"FROM    DA.UKUPNIBODOVI "</span> <span class="o">+</span>
                <span class="s">"FETCH   FIRST 10 ROWS ONLY"</span><span class="o">;</span>
        <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Obradjujem 10 najuspesnijih studenata: \n"</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">indeks</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">ime</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="na">trim</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">prezime</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="na">trim</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">espb</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">". "</span> <span class="o">+</span> <span class="n">ime</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">prezime</span> <span class="o">+</span> <span class="s">"("</span> <span class="o">+</span> <span class="n">indeks</span> <span class="o">+</span> <span class="s">") ima osvojenih "</span> <span class="o">+</span> <span class="n">espb</span> <span class="o">+</span> <span class="s">" ESPB."</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Da li zelite da dodelite 10 pocasnih bodova? [d/n]"</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">odgovor</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"d"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">kursor</span><span class="o">.</span><span class="na">updateInt</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="n">espb</span> <span class="o">+</span> <span class="mi">10</span><span class="o">);</span>
                <span class="n">kursor</span><span class="o">.</span><span class="na">updateRow</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Uspesno ste dodeliti pocasne poene!"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
            <span class="o">++</span><span class="n">i</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Unesite \"I\", pa zatim ENTER za prikaz izvestaja:"</span><span class="o">);</span>
        <span class="n">ulaz</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
        
        <span class="n">kursor</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">indeks</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">ime</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">prezime</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">bodovi</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">". "</span> <span class="o">+</span> <span class="n">ime</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">prezime</span> <span class="o">+</span> <span class="s">"("</span> <span class="o">+</span> <span class="n">indeks</span> <span class="o">+</span> <span class="s">") ima osvojenih "</span> <span class="o">+</span> <span class="n">bodovi</span> <span class="o">+</span> <span class="s">" ESPB."</span><span class="o">);</span>
            <span class="o">++</span><span class="n">i</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        
        <span class="c1">// Zavrsavam transakciju</span>
        <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
        
        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="913-tačke-čuvanja-u-transakciji">9.1.3 Tačke čuvanja u transakciji</h3>

<p>Kao što znamo, transakcija u bazi podataka se sadrži od jedne ili više izmena u 
okviru jedne jedinice posla. Poništavanje transakcije podrazumevano poništava sve
izmene definisane u toj jedinici posla.</p>

<p>Tačka čuvanja predstavlja marker koji određuje tačku u transakciji do koje se
mogu poništiti izmene. Drugim rečima, poništavanje transakcije do neke tačke
čuvanja će poništiti samo one izmene koje su nastale nakon te tačke čuvanja
(a one koje su nastale pre tačke čuvanja će ostati neponištene).</p>

<p>U JDBC aplikacijama, tačke čuvanja se reprezentuju objektima interfejsa <code class="language-plaintext highlighter-rouge">Savepoint</code>.
Kako bi se markirala tačka u tekućoj transakciji, potrebno je pozvati metod
<code class="language-plaintext highlighter-rouge">Connection.setSavepoint()</code>. Ovaj metod kreira novu, neimenovanu tačku čuvanja u
tekućoj transakciji i vraća objekat interfejsa <code class="language-plaintext highlighter-rouge">Statement</code> koji je reprezentuje.
Ovaj objekat se koristi za upravljanje tačkom čuvanja nadalje. Naredni primer
ilustruje kreiranje nekoliko tačaka čuvanja u okviru transakcije:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">dbURL</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
<span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

<span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>

<span class="n">stmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="s">"insert into person values ('John', 'Doe')"</span><span class="o">);</span>
<span class="nc">Savepoint</span> <span class="n">sp1</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">setSavepoint</span><span class="o">();</span> <span class="c1">// 1</span>

<span class="n">stmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="s">"insert into person values ('Jane', 'Doe')"</span><span class="o">);</span>
<span class="nc">Savepoint</span> <span class="n">sp2</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">setSavepoint</span><span class="o">();</span> <span class="c1">// 2</span>

<span class="n">stmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="s">"insert into person values ('Another', 'Unknown')"</span><span class="o">);</span>
<span class="nc">Savepoint</span> <span class="n">sp3</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">setSavepoint</span><span class="o">();</span> <span class="c1">// 3</span>
</code></pre></div></div>

<p>Nakon kreiranja poslednje tačke čuvanja, korisnik ima opciju da poništi izmene
do bilo koje od tačaka čuvanja <code class="language-plaintext highlighter-rouge">spX</code>. Da bi se ova akcija ostvarila, potrebno je
pozvati metod <code class="language-plaintext highlighter-rouge">Connection.rollback(Savepoint savepoint)</code> čiji argument definiše
tačku čuvanja do koje se vrši poništavanje transakcije. Na primer, ako bismo
želeli da poništimo sve izmene nakon tačke čuvanja 1, iskoristili bismo poziv:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Rolls back inserts 2 and 3</span>
<span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">sp1</span><span class="o">);</span>
</code></pre></div></div>

<p>Važno je napomenuti da jednom kad smo poništili izmene do neke tačke čuvanja, 
(recimo, <code class="language-plaintext highlighter-rouge">sp1</code>), sve tačke čuvanja koje su kreirane nakon ove tačke čuvanja
(<code class="language-plaintext highlighter-rouge">sp2</code> i <code class="language-plaintext highlighter-rouge">sp3</code>) biće oslobođene i ne bi trebalo referisati na njih nadalje. Pokušaj
da se oslobodi već oslobođena tačka čuvanja rezultuje ispaljivanjem izuzetka 
<code class="language-plaintext highlighter-rouge">SQLException</code>. Na primer, naredni kod će ispaliti izuzetak <code class="language-plaintext highlighter-rouge">SQLException</code> (pod 
pretpostavkom da prethodno nisu oslobođene tačke čuvanja <code class="language-plaintext highlighter-rouge">sp1</code> i <code class="language-plaintext highlighter-rouge">sp2</code>):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">sp2</span><span class="o">);</span> <span class="c1">// Will release sp3</span>
<span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">sp3</span><span class="o">);</span> <span class="c1">// Will throw an exception: sp3 is already released.</span>
</code></pre></div></div>

<p>Primetimo da prilikom poništavanja transakcije do neke tačke čuvanja,
sama tačka čuvanja do koje se izvršilo poništavanje neće biti oslobođena.
Na primer, u primeru koda iznad, tačka čuvanja <code class="language-plaintext highlighter-rouge">sp2</code> je ostala aktivna i korisnik
može ponovo poništiti izmene do nje.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">sp2</span><span class="o">);</span> <span class="c1">// OK</span>
<span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">sp2</span><span class="o">);</span> <span class="c1">// OK</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 9.3</strong>: Napisati Java program u kojem se SQL naredbe izvršavaju dinamički koji pronalazi indekse i nazive predmeta za sva polaganja koja su bila neuspešna. Sortirati podatke po indeksu rastuće. Obezbediti da aplikacija briše podatke o najviše 10 studenata. Jednu transakciju čine brisanja za sve pronađene studente. Prilikom obrade podataka, ispisati informacije o indeksu studenta, a zatim prikazati nazive predmeta za obrisana polaganja tog studenta. Nakon brisanja podataka o jednom studentu, upitati korisnika da li želi da poništi izmene za tog studenta (voditi računa da brisanja za sve prethodne studente ostanu nepromenjena).</p>
</div>

<p>Rešenje: Ono što je potrebno uraditi jeste, pre brisanja slogova za jednog studenta, postaviti tačku čuvanja. Nakon što se detektuje da se dohvatio slog za narednog studenta, aplikacija treba da pita korisnika da li želi da poništi izmene od postavljene tačke čuvanja. Tako se obezbeđujemo da samo obrisani redovi za tekućeg studenta budu poništeni, a ne i za sve prethodne.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_3/Main.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_9_3</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.ibm.db2.jcc.DB2Driver"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"jdbc:db2://localhost:50000/stud2020"</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="s">"student"</span><span class="o">,</span> <span class="s">"abcdef"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

            <span class="k">try</span> <span class="o">(</span><span class="nc">Scanner</span> <span class="n">ulaz</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">obrisiNeuspesnaPolaganja</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">ulaz</span><span class="o">);</span>
                <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SQLCODE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span> <span class="s">"SQLSTATE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getSQLState</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span>
                    <span class="o">+</span> <span class="s">"PORUKA: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Doslo je do neke greske: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">obrisiNeuspesnaPolaganja</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Scanner</span> <span class="n">ulaz</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// Koristimo TYPE_SCROLL_SENSITIVE jer upit sadrzi ORDER BY klauzu.</span>
        <span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">(</span><span class="nc">ResultSet</span><span class="o">.</span><span class="na">TYPE_SCROLL_SENSITIVE</span><span class="o">,</span> <span class="nc">ResultSet</span><span class="o">.</span><span class="na">CONCUR_UPDATABLE</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">ucitajSqlIzDatoteke</span><span class="o">();</span>
        <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>

        <span class="nc">Savepoint</span> <span class="n">s</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">prethodniIndeks</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">brojStudenta</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">indeks</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">naziv</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="na">trim</span><span class="o">();</span>
            
            <span class="c1">// Ako smo procitali podatke za novog studenta</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">indeks</span> <span class="o">!=</span> <span class="n">prethodniIndeks</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Nemamo sta da uradimo ako obradjujemo prvog studenta</span>
                <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">brojStudenta</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// Ako smo vec obradili barem jednog studenta,</span>
                    <span class="c1">// onda treba da pitamo korisnika da li zeli da ponisti brisanja za prethodnog studenta</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Da li zelite da ponistite brisanja? [da/ne] "</span><span class="o">);</span>
                    <span class="nc">String</span> <span class="n">odgovor</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"da"</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">con</span><span class="o">.</span><span class="na">releaseSavepoint</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                
                <span class="c1">// Ako je redni broj 10, izlazimo iz petlje</span>
                <span class="k">if</span> <span class="o">(</span><span class="mi">10</span> <span class="o">==</span> <span class="n">brojStudenta</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="c1">// Inace, pre nego sto predjemo na menjanje podataka za novog studenta,</span>
                <span class="c1">// moramo da postavimo novu tacku cuvanja i </span>
                <span class="c1">// azuriramo informacije o prethodnom indeksu i rednom broju</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">setSavepoint</span><span class="o">();</span>
                <span class="n">prethodniIndeks</span> <span class="o">=</span> <span class="n">indeks</span><span class="o">;</span>
                <span class="o">++</span><span class="n">brojStudenta</span><span class="o">;</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Brisem nepolozena polaganja za "</span> <span class="o">+</span> <span class="n">brojStudenta</span> <span class="o">+</span> <span class="s">". studenta: "</span> <span class="o">+</span> <span class="n">indeks</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"    %s\n"</span><span class="o">,</span> <span class="n">naziv</span><span class="o">);</span>
            <span class="n">kursor</span><span class="o">.</span><span class="na">deleteRow</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>        
        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">ucitajSqlIzDatoteke</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">StringBuilder</span> <span class="n">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">lines</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.dir"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"/bin/zadatak_9_3/upit.sql"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">linija</span> <span class="o">-&gt;</span> <span class="n">sql</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">linija</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_3/upit.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>      <span class="n">INDEKS</span><span class="p">,</span>
            <span class="p">(</span><span class="k">SELECT</span> <span class="n">NAZIV</span> <span class="k">FROM</span> <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span> <span class="k">WHERE</span> <span class="n">ID</span> <span class="o">=</span> <span class="n">I</span><span class="p">.</span><span class="n">IDPREDMETA</span><span class="p">)</span> 
<span class="k">FROM</span>        <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span> <span class="n">I</span>
<span class="k">WHERE</span>       <span class="n">OCENA</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">AND</span>
            <span class="n">STATUS</span> <span class="o">=</span> <span class="s1">'o'</span> 
<span class="k">ORDER</span> <span class="k">BY</span>    <span class="n">INDEKS</span>
</code></pre></div></div>

<h2 id="92-rad-u-višekorisničkom-okruženju">9.2 Rad u višekorisničkom okruženju</h2>

<p>U poglavlju 5 smo govorili detaljno o problemima konkurentnog rada sa bazom podataka.
Aplikacije pisane u programskom jeziku Java, bilo one SQLJ ili JDBC, takođe “boluju” od
istih problema kao i aplikacije koje smo pisali u programskom jeziku C. Zbog toga ćemo
imati na umu sve napomene koje smo tada uveli, sa određenim napomenama koje slede u
daljem tekstu.</p>

<p>S obzirom da se u programskom jeziku Java greške prijavljuju kroz objekte klase <code class="language-plaintext highlighter-rouge">SQLException</code>, 
proveru da li je došlo do nekog problema konkurentnog okruženja možemo izvršiti proverom
koda greške, pozivom metoda <code class="language-plaintext highlighter-rouge">getErrorCode()</code> nad objektom klase <code class="language-plaintext highlighter-rouge">SQLException</code> koji
smo uhvatili. Zašto nam je ova informacija važna? Prisetimo se da, ukoliko dođe do nekog
problema konkurentnog okruženja, DB2 SUBP šalje grešku -911 ili -913. Dodatno, u slučaju da 
aplikacija zahteva ekskalaciju katanaca, ali menadžer baze podataka ne uspe da izvrši tu
operaciju, onda će aplikaciji biti prijavljena greška -912. U tom slučaju,
potrebno je izvršiti obradu isteka vremena ili pojave mrtve petlje, i poništiti eventualne
izmene. Evo jednog primera:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// U main funkciji:</span>

<span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT ..."</span><span class="o">;</span>
<span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">(</span>
    <span class="nc">ResultSet</span><span class="o">.</span><span class="na">TYPE_FORWARD_ONLY</span><span class="o">,</span>
    <span class="nc">ResultSet</span><span class="o">.</span><span class="na">CONCUR_UPDATABLE</span><span class="o">,</span>
    <span class="nc">ResultSet</span><span class="o">.</span><span class="na">HOLD_CURSORS_OVER_COMMIT</span>
<span class="o">);</span>
<span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">otvoriKursor</span><span class="o">(</span><span class="n">stmt</span><span class="o">,</span> <span class="n">sql</span><span class="o">);</span>

<span class="c1">// Petlja koja prolazi kroz kursor</span>
<span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// Kod koji moze da dovede do problema</span>
        <span class="c1">// u visekorisnickom okruzenju</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Ako je doslo do izuzetka zbog katanaca...</span>
        <span class="k">if</span> <span class="o">(-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ... onda ih je potrebno obraditi</span>
            <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">kursor</span> <span class="o">=</span> <span class="n">obradiCekanje</span><span class="o">(</span><span class="s">"FETCH, UPDATE, ..."</span><span class="o">,</span> <span class="n">con</span><span class="o">,</span> <span class="n">stmt</span><span class="o">,</span> <span class="n">sql</span><span class="o">);</span>
            <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// Inace, neka druga greska je u pitanju,</span>
        <span class="c1">// pa ju je potrebno proslediti kodu za obradu greske</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// *********************************************************</span>
<span class="c1">// Izvan main funkcije:</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="nc">ResultSet</span> <span class="nf">otvoriKursor</span><span class="o">(</span><span class="nc">Statement</span> <span class="n">stmt</span><span class="o">,</span> <span class="nc">String</span> <span class="n">sql</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
    <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">kursor</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="nc">ResultSet</span> <span class="nf">obradiCekanje</span><span class="o">(</span><span class="nc">String</span> <span class="n">codeHint</span><span class="o">,</span> <span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Statement</span> <span class="n">stmt</span><span class="o">,</span> <span class="nc">String</span> <span class="n">sql</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] Objekat je zakljucan od strane druge transakcije!\n"</span> <span class="o">+</span>
        <span class="s">"Molimo sacekajte!\n"</span><span class="o">,</span> <span class="n">codeHint</span><span class="o">);</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="nf">otvoriKursor</span><span class="o">(</span><span class="n">stmt</span><span class="o">,</span> <span class="n">sql</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Naredni primeri ilustruju konstrukciju JDBC aplikacija koje koriste transakcioni rad u
višekorisničkom okruženju.</p>

<div class="ui stacked segment">
  <p><strong>Zadatak 9.4</strong>: Napisati Java program u kojem se SQL naredbe izvršavaju dinamički koji za svaki predmet koji je obavezan na studijskom programu čiji je identifikator 103, pita korisnika da li želi da poveća broj ESPB bodova za 1. Ukoliko je odgovor korisnika ”da”, izvršava se odgovarajuća naredba. Zadatak uraditi tako da aplikacija radi u višekorisničkom okruženju. Obrada jednog predmeta treba da predstavlja jednu transakciju. Postaviti istek vremena na 5 sekundi. Omogućiti da drugi korisnici mogu da pristupaju predmetima koje ovaj program trenutno obrađuje.</p>
</div>

<p>Rešenje: Da bismo implementirali date zahteve, potrebno je da pamtimo koje smo predmete obrađivali. Zato ćemo kreirati promenljivu <code class="language-plaintext highlighter-rouge">obradjeniPredmeti</code> tipa <code class="language-plaintext highlighter-rouge">ArrayList&lt;Integer&gt;</code> koja će čuvati informaciju o identifikatorima predmeta koje smo obradili. Zbog toga što se primarni ključ tabele <code class="language-plaintext highlighter-rouge">PREDMET</code> sastoji samo od jedne kolone tipa <code class="language-plaintext highlighter-rouge">INTEGER</code>, to je šablonski parametar kolekcije <code class="language-plaintext highlighter-rouge">ArrayList</code> tipa <code class="language-plaintext highlighter-rouge">Integer</code>. U slučaju složenih primarnih ključeva, neophodno je da kreiramo klasu koja sadrži atribute koji odgovaraju kolonama složenog primarnog ključa (videti <a href="#94-zadaci-za-vežbu">zadatke za vežbu</a>). Dodatno, potrebno je da postavimo nivo izolovanosti stabilno čitanje, kako bismo omogućili da drugi programi mogu da čitaju slogove koji se ne ažuriraju od strane naše aplikacije.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_4/Main.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_9_4</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.ibm.db2.jcc.DB2Driver"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"jdbc:db2://localhost:50000/stud2020"</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="s">"student"</span><span class="o">,</span> <span class="s">"abcdef"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">con</span><span class="o">.</span><span class="na">setTransactionIsolation</span><span class="o">(</span><span class="nc">Connection</span><span class="o">.</span><span class="na">TRANSACTION_REPEATABLE_READ</span><span class="o">);</span>

            <span class="c1">// Postavljanje isteka vremena za katance.</span>
            <span class="nc">Statement</span> <span class="n">lockStmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
            <span class="n">lockStmt</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"SET CURRENT LOCK TIMEOUT 5"</span><span class="o">);</span>
            
            <span class="k">try</span> <span class="o">{</span>                
                <span class="n">obradiPredmete</span><span class="o">(</span><span class="n">con</span><span class="o">);</span>
                
                <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="c1">// Vracanje podrazumevane vrednosti za istek vremena</span>
                <span class="n">lockStmt</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"SET CURRENT LOCK TIMEOUT NULL"</span><span class="o">);</span>
                <span class="n">lockStmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SQLCODE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span> <span class="s">"SQLSTATE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getSQLState</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span>
                    <span class="o">+</span> <span class="s">"PORUKA: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Doslo je do neke greske: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">obradiPredmete</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">Scanner</span> <span class="n">ulaz</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">obradjeniPredmeti</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">ucitajSql</span><span class="o">();</span>
                
            <span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">(</span>
                <span class="nc">ResultSet</span><span class="o">.</span><span class="na">TYPE_FORWARD_ONLY</span><span class="o">,</span> 
                <span class="nc">ResultSet</span><span class="o">.</span><span class="na">CONCUR_UPDATABLE</span><span class="o">,</span>
                <span class="c1">// Kursor deklarisemo sa opcijom HOLD_CURSORS_OVER_COMMIT</span>
                <span class="c1">// da bi ostao otvoren prilikom izvrsavanja COMMIT naredbe.</span>
                <span class="nc">ResultSet</span><span class="o">.</span><span class="na">HOLD_CURSORS_OVER_COMMIT</span><span class="o">);</span>
            
            <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">otvoriKursor</span><span class="o">(</span><span class="n">stmt</span><span class="o">,</span> <span class="n">sql</span><span class="o">);</span>
            
            <span class="c1">// Citanje reda moze dovesti do problema zbog S ili U katanaca,</span>
            <span class="c1">// te moramo poziv metoda next() obraditi zasebno,</span>
            <span class="c1">// pa zato ide unutar petlje za obradu.</span>
            <span class="kt">boolean</span> <span class="n">imaRedova</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// S ili U katanac</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">imaRedova</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// Obrada katanaca</span>
                    <span class="k">if</span> <span class="o">(-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                        <span class="n">kursor</span> <span class="o">=</span> <span class="n">obradiCekanje</span><span class="o">(</span><span class="s">"FETCH"</span><span class="o">,</span> <span class="n">con</span><span class="o">,</span> <span class="n">stmt</span><span class="o">,</span> <span class="n">sql</span><span class="o">);</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
                <span class="o">}</span>
                
                <span class="c1">// Izlaz iz beskonacne petlje</span>
                <span class="c1">// ukoliko vise nema redova u kursoru</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">imaRedova</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                
                <span class="c1">// Inace, dohvatamo podatke</span>
                <span class="kt">int</span> <span class="n">idPredmeta</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">naziv</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
                <span class="kt">short</span> <span class="n">espb</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getShort</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
                
                <span class="c1">// Preskacemo one predmete koje smo vec obradili</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">obradjeniPredmeti</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">idPredmeta</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
                
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"\nPredmet %s ima %d bodova\n"</span><span class="o">,</span> <span class="n">naziv</span><span class="o">.</span><span class="na">trim</span><span class="o">(),</span> <span class="n">espb</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Da li zelite da uvecate broj bodova za 1? [da/ne]"</span><span class="o">);</span>
                
                <span class="nc">String</span> <span class="n">odgovor</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"da"</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// X katanac</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="c1">// Ovde koristimo metode updateXXX i updateRow za azuriranje podataka.</span>
                        <span class="c1">// Za vezbu uraditi zadatak pozicionirajucom UPDATE naredbom.</span>
                        <span class="n">kursor</span><span class="o">.</span><span class="na">updateShort</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="o">(</span><span class="n">espb</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
                        <span class="n">kursor</span><span class="o">.</span><span class="na">updateRow</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                            <span class="n">kursor</span> <span class="o">=</span> <span class="n">obradiCekanje</span><span class="o">(</span><span class="s">"UPDATE"</span><span class="o">,</span> <span class="n">con</span><span class="o">,</span> <span class="n">stmt</span><span class="o">,</span> <span class="n">sql</span><span class="o">);</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
                    <span class="o">}</span>
                    
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Uspesno su azurirani bodovi za tekuci predmet!"</span><span class="o">);</span>
                <span class="o">}</span>
                
                <span class="c1">// Evidentiranje obrade tekuceg predmeta</span>
                <span class="n">obradjeniPredmeti</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">idPredmeta</span><span class="o">);</span>
                
                <span class="c1">// Zavrsavamo jednu transakciju</span>
                <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
                
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Da li zelite da zavrsite sa obradom? [da/ne]"</span><span class="o">);</span>
                <span class="n">odgovor</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                
                <span class="k">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"da"</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            
            <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ResultSet</span> <span class="nf">otvoriKursor</span><span class="o">(</span><span class="nc">Statement</span> <span class="n">stmt</span><span class="o">,</span> <span class="nc">String</span> <span class="n">sql</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">kursor</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ResultSet</span> <span class="nf">obradiCekanje</span><span class="o">(</span><span class="nc">String</span> <span class="n">codeHint</span><span class="o">,</span> <span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Statement</span> <span class="n">stmt</span><span class="o">,</span> <span class="nc">String</span> <span class="n">sql</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] Objekat je zakljucan od strane druge transakcije!\n"</span> <span class="o">+</span>
                <span class="s">"Molimo sacekajte!\n"</span><span class="o">,</span> <span class="n">codeHint</span><span class="o">);</span>
        
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        
        <span class="k">return</span> <span class="nf">otvoriKursor</span><span class="o">(</span><span class="n">stmt</span><span class="o">,</span> <span class="n">sql</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">ucitajSql</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">StringBuilder</span> <span class="n">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">lines</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.dir"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"/bin/zadatak_9_4/upit.sql"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">linija</span> <span class="o">-&gt;</span> <span class="n">sql</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">linija</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_4/upit.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">ID</span><span class="p">,</span>  
       <span class="n">NAZIV</span><span class="p">,</span>  
       <span class="n">ESPB</span> 
<span class="k">FROM</span>   <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span> 
<span class="k">WHERE</span>  <span class="n">ID</span> <span class="k">IN</span> <span class="p">(</span> 
           <span class="k">SELECT</span>  <span class="n">IDPREDMETA</span> 
           <span class="k">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">PREDMETPROGRAMA</span> 
           <span class="k">WHERE</span>   <span class="n">IDPROGRAMA</span> <span class="o">=</span> <span class="mi">103</span> <span class="k">AND</span> 
                      <span class="n">VRSTA</span> <span class="o">=</span> <span class="s1">'obavezan'</span>
       <span class="p">);</span>
</code></pre></div></div>

<h2 id="93-povezivanje-na-više-baza-podataka">9.3 Povezivanje na više baza podataka</h2>

<p>Upravljanje podacima nad više baza podataka u JDBC aplikacijama je značajno jednostavnije
nego u C aplikacijama sa ugnežđenim SQL-om.</p>

<p>U JDBC aplikacijama možemo imati proizvoljan broj objekata interfejsa <code class="language-plaintext highlighter-rouge">Connection</code> i svaki
od njih predstavlja i ostvaruje konekciju ka jednoj bazi podataka. Pretpostavimo da
imamo dve konekcije ka bazama podataka <code class="language-plaintext highlighter-rouge">X</code> i <code class="language-plaintext highlighter-rouge">Y</code> ostvarene kroz objekte <code class="language-plaintext highlighter-rouge">conX</code> i <code class="language-plaintext highlighter-rouge">conY</code> interfejsa
<code class="language-plaintext highlighter-rouge">Connection</code>.</p>

<p>Ukoliko je potrebno da izvršimo naredbu nad bazom podataka <code class="language-plaintext highlighter-rouge">X</code>, onda je potrebno da kreiramo
objekat naredbe (bilo kroz klasu <code class="language-plaintext highlighter-rouge">Statement</code> ili <code class="language-plaintext highlighter-rouge">PreparedStatement</code>) koristeći objekat
<code class="language-plaintext highlighter-rouge">conX</code>. Za izvršavanje naredbe nad drugom bazom podataka <code class="language-plaintext highlighter-rouge">Y</code>, koristićemo objekat <code class="language-plaintext highlighter-rouge">conY</code>
za kreiranje objekta naredbe.</p>

<p>Naredni primer ilustruje korišćenje dve baze podataka: <code class="language-plaintext highlighter-rouge">VSTUD</code> i <code class="language-plaintext highlighter-rouge">MSTUD</code>.</p>

<div class="ui stacked segment">
  <p><strong>Zadatak 9.5</strong>: Napisati Java program u kojem se SQL naredbe izvršavaju dinamički koji omogućava konekciju na 2 baze (vstud i mstud). Program redom:</p>

  <ol>
    <li>Zahteva od korisnika da unese broj bodova <code class="language-plaintext highlighter-rouge">B</code>.</li>
    <li>Iz baze mstud izdvaja indeks, ime i prezime studenata koji su položili sve predmete koji nose više od <code class="language-plaintext highlighter-rouge">B</code> bodova.</li>
    <li>Zatim, zahteva od korisnika da unese ocenu <code class="language-plaintext highlighter-rouge">O</code> (ceo broj od 6 do 10).</li>
    <li>Iz baze vstud izlistava indeks, naziv, ocenu, godinu i oznaku ispitnog roka za sve studente koji nikada nisu dobili ocenu manju nego što je ocena <code class="language-plaintext highlighter-rouge">O</code>.</li>
    <li>Nakon ispisivanja tih podataka, u bazi mstud, iz tabele ispit briše sva polaganja za studenta sa najmanjim brojem indeksa <code class="language-plaintext highlighter-rouge">I</code> iz dosije, i vraća <code class="language-plaintext highlighter-rouge">I</code>.</li>
    <li>Na kraju, u bazi vstud, u tabeli <code class="language-plaintext highlighter-rouge">PREDMET</code> za sve predmete koje je položio student sa brojem indeksa <code class="language-plaintext highlighter-rouge">I</code>, uvećava broj bodova za jedan (osim ako je broj bodova veći od 10, tada ostavlja nepromenjeno stanje).</li>
  </ol>
</div>

<p>Rešenje: Datoteka <code class="language-plaintext highlighter-rouge">Main.java</code> implementira navedene funkcionalnosti, dok prateće <code class="language-plaintext highlighter-rouge">*.sql</code> datoteke sadrže SQL naredbe koje se koriste u rešenju.</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_5/Main.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_9_5</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.DriverManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.PreparedStatement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Statement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.ibm.db2.jcc.DB2Driver"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">urlVstud</span> <span class="o">=</span> <span class="s">"jdbc:db2://localhost:50000/stud2020"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">urlMstud</span> <span class="o">=</span> <span class="s">"jdbc:db2://localhost:50001/mstud"</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">(</span>
            <span class="nc">Connection</span> <span class="n">conVstud</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">urlVstud</span><span class="o">,</span> <span class="s">"student"</span><span class="o">,</span> <span class="s">"abcdef"</span><span class="o">);</span>
            <span class="nc">Connection</span> <span class="n">conMstud</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">urlMstud</span><span class="o">,</span> <span class="s">"student"</span><span class="o">,</span> <span class="s">"abcdef"</span><span class="o">);</span>
        <span class="o">)</span> <span class="o">{</span>
            <span class="n">conVstud</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">conMstud</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

            <span class="k">try</span> <span class="o">(</span><span class="nc">Scanner</span> <span class="n">ulaz</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// Program redom:</span>
                <span class="c1">// Zahteva od korisnika da unese broj bodova B.</span>

                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Unesite broj bodova B:"</span><span class="o">);</span>
                <span class="kt">short</span> <span class="n">brojBodova</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">nextShort</span><span class="o">();</span>

                <span class="c1">// Iz baze MSTUD izdvaja indeks, ime i prezime studenata</span>
                <span class="c1">// koji su polozili sve predmete koji nose vise od B bodova.</span>

                <span class="n">izlistajStudenteMstud</span><span class="o">(</span><span class="n">conMstud</span><span class="o">,</span> <span class="n">brojBodova</span><span class="o">);</span>

                <span class="c1">// Zatim, zahteva od korisnika da unese ocenu O (ceo broj od 6</span>
                <span class="c1">// do 10).</span>

                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Unesite ocenu O:"</span><span class="o">);</span>
                <span class="kt">short</span> <span class="n">ocena</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">nextShort</span><span class="o">();</span>

                <span class="c1">// Iz baze VSTUD izlistava indeks, naziv, ocenu, godinu i oznaku</span>
                <span class="c1">// ispitnog roka</span>
                <span class="c1">// za sve studente koji nikada nisu dobili ocenu manju nego sto</span>
                <span class="c1">// je ocena O.</span>

                <span class="n">izlistajPolaganjaVstud</span><span class="o">(</span><span class="n">conVstud</span><span class="o">,</span> <span class="n">ocena</span><span class="o">);</span>

                <span class="c1">// Nakon ispisivanja tih podataka, u bazi MSTUD, iz tabele ISPIT</span>
                <span class="c1">// brise sva polaganja za studenta sa maksimalnim brojem indeksa</span>
                <span class="c1">// I</span>
                <span class="c1">// iz DOSIJE, i vraca I.</span>

                <span class="kt">int</span> <span class="n">indeks</span> <span class="o">=</span> <span class="n">obrisiPolaganjaIVratiIndeksMstud</span><span class="o">(</span><span class="n">conMstud</span><span class="o">);</span>

                <span class="c1">// Na kraju, u bazi VSTUD, u tabeli PREDMET</span>
                <span class="c1">// za sve predmete koje je polozio student sa brojem indeksa I,</span>
                <span class="c1">// uvecava broj bodova za jedan (osim ako je broj bodova veci od</span>
                <span class="c1">// 10,</span>
                <span class="c1">// tada ostavlja nepromenjeno stanje).</span>

                <span class="n">uvecajBodoveZaPredmeteVstud</span><span class="o">(</span><span class="n">conVstud</span><span class="o">,</span> <span class="n">indeks</span><span class="o">);</span>
                
                <span class="c1">// Potvrdjivanje izmena mora da se vrsi nad obe baze!</span>
                <span class="n">conVstud</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
                <span class="n">conMstud</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Ponistavanje izmena mora da se vrsi nad obe baze!</span>
                <span class="n">conVstud</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                <span class="n">conMstud</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> 
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SQLCODE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span> <span class="s">"SQLSTATE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getSQLState</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span>
                    <span class="o">+</span> <span class="s">"PORUKA: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Doslo je do neke greske: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">izlistajStudenteMstud</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="kt">short</span> <span class="n">brojBodova</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">ucitajSqlIzDatoteke</span><span class="o">(</span><span class="s">"izlistajStudenteMstud.sql"</span><span class="o">);</span>
        <span class="nc">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>

        <span class="n">stmt</span><span class="o">.</span><span class="na">setShort</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">brojBodova</span><span class="o">);</span>
        <span class="nc">ResultSet</span> <span class="n">rez</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n\nStudenti koji su polozili sve predmete od "</span> <span class="o">+</span> <span class="n">brojBodova</span> <span class="o">+</span> <span class="s">" bodova\n"</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">rez</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Indeks: "</span> <span class="o">+</span> <span class="n">rez</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="s">"Ime: "</span> <span class="o">+</span> <span class="n">rez</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span> <span class="o">+</span> <span class="s">", "</span>
                    <span class="o">+</span> <span class="s">"Prezime: "</span> <span class="o">+</span> <span class="n">rez</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span> <span class="o">+</span> <span class="s">", "</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">rez</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">izlistajPolaganjaVstud</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="kt">short</span> <span class="n">ocena</span><span class="o">)</span> 
            <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">ucitajSqlIzDatoteke</span><span class="o">(</span><span class="s">"izlistajPolaganjaVstud.sql"</span><span class="o">);</span>
        <span class="nc">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>

        <span class="n">stmt</span><span class="o">.</span><span class="na">setShort</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">ocena</span><span class="o">);</span>
        <span class="nc">ResultSet</span> <span class="n">rez</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Polozeni ispiti studenata koji nemaju ocenu manju od "</span> <span class="o">+</span> <span class="n">ocena</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">rez</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Indeks: "</span> <span class="o">+</span> <span class="n">rez</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="s">"Naziv: "</span> <span class="o">+</span> <span class="n">rez</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span> <span class="o">+</span> <span class="s">", "</span>
                    <span class="o">+</span> <span class="s">"Ocena: "</span> <span class="o">+</span> <span class="n">rez</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="s">"Godina roka: "</span> <span class="o">+</span> <span class="n">rez</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="s">"Oznaka roka: "</span>
                    <span class="o">+</span> <span class="n">rez</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="na">trim</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="n">rez</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">obrisiPolaganjaIVratiIndeksMstud</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">)</span> 
            <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">indeks</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
        <span class="nc">ResultSet</span> <span class="n">rez</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span>
                <span class="s">"SELECT  MIN(INDEKS) "</span> <span class="o">+</span> 
                <span class="s">"FROM    DOSIJE"</span><span class="o">);</span>

        <span class="kt">boolean</span> <span class="n">dohvacenIndeks</span> <span class="o">=</span> <span class="n">rez</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">dohvacenIndeks</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">"Ne postoji nijedan indeks u bazi podataka"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">indeks</span> <span class="o">=</span> <span class="n">rez</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">rez</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="kt">int</span> <span class="n">brojObrisanih</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span>
                <span class="s">"DELETE  FROM ISPIT "</span> <span class="o">+</span> 
                <span class="s">"WHERE   INDEKS = (SELECT MIN(INDEKS) FROM DOSIJE)"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Broj obrisanih redova: "</span> <span class="o">+</span> <span class="n">brojObrisanih</span><span class="o">);</span>

        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">indeks</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">uvecajBodoveZaPredmeteVstud</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="kt">int</span> <span class="n">indeks</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">ucitajSqlIzDatoteke</span><span class="o">(</span><span class="s">"uvecajBodoveZaPredmeteVstud.sql"</span><span class="o">);</span>
        <span class="nc">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">stmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">indeks</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">brojAzuriranih</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Broj azuriranih redova: "</span> <span class="o">+</span> <span class="n">brojAzuriranih</span><span class="o">);</span>

        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">ucitajSqlIzDatoteke</span><span class="o">(</span><span class="nc">String</span> <span class="n">nazivDatoteke</span><span class="o">)</span> 
            <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">StringBuilder</span> <span class="n">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">lines</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.dir"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"/bin/zadatak_9_5/"</span> <span class="o">+</span> <span class="n">nazivDatoteke</span><span class="o">))</span>
            <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">linija</span> <span class="o">-&gt;</span> <span class="n">sql</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">linija</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_5/izlistajStudenteMstud.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">INDEKS</span><span class="p">,</span>
        <span class="n">IME</span><span class="p">,</span>
        <span class="n">PREZIME</span>  
<span class="k">FROM</span>    <span class="n">DOSIJE</span> <span class="n">D</span>  
<span class="k">WHERE</span>   <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="p">(</span>  
            <span class="k">SELECT</span>  <span class="o">*</span>  
            <span class="k">FROM</span>    <span class="n">PREDMET</span> <span class="n">P</span>  
            <span class="k">WHERE</span>   <span class="n">BODOVI</span> <span class="o">=</span> <span class="o">?</span> <span class="k">AND</span> 
                    <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="p">(</span>  
                        <span class="k">SELECT</span>  <span class="o">*</span>  
                        <span class="k">FROM</span>    <span class="n">ISPIT</span> <span class="n">I</span>  
                        <span class="k">WHERE</span>   <span class="n">I</span><span class="p">.</span><span class="n">INDEKS</span> <span class="o">=</span> <span class="n">D</span><span class="p">.</span><span class="n">INDEKS</span> <span class="k">AND</span> 
                                <span class="n">I</span><span class="p">.</span><span class="n">ID_PREDMETA</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">ID_PREDMETA</span> <span class="k">AND</span> 
                                <span class="n">I</span><span class="p">.</span><span class="n">OCENA</span> <span class="o">&gt;</span> <span class="mi">5</span>  
                    <span class="p">)</span>  
        <span class="p">)</span>
</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_5/izlistajPolaganjaVstud.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">INDEKS</span><span class="p">,</span> 
        <span class="n">P</span><span class="p">.</span><span class="n">NAZIV</span><span class="p">,</span> 
        <span class="n">OCENA</span><span class="p">,</span> 
        <span class="n">GODINA_ROKA</span><span class="p">,</span> 
        <span class="n">OZNAKA_ROKA</span>  
<span class="k">FROM</span>    <span class="n">ISPIT</span> <span class="n">I</span> <span class="k">JOIN</span> 
        <span class="n">PREDMET</span> <span class="n">P</span> <span class="k">ON</span> <span class="n">I</span><span class="p">.</span><span class="n">ID_PREDMETA</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">ID_PREDMETA</span>  
<span class="k">WHERE</span>   <span class="n">OCENA</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">AND</span> 
        <span class="n">STATUS_PRIJAVE</span> <span class="o">=</span> <span class="s1">'O'</span> <span class="k">AND</span> 
        <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="p">(</span>  
            <span class="k">SELECT</span>  <span class="o">*</span>  
            <span class="k">FROM</span>    <span class="n">ISPIT</span> <span class="n">I2</span>  
            <span class="k">WHERE</span>   <span class="n">I</span><span class="p">.</span><span class="n">INDEKS</span> <span class="o">=</span> <span class="n">I2</span><span class="p">.</span><span class="n">INDEKS</span> <span class="k">AND</span>  
                    <span class="n">OCENA</span> <span class="o">&lt;</span> <span class="o">?</span>  
        <span class="p">)</span>
</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_5/uvecajBodoveZaPredmeteVstud.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">UPDATE</span>  <span class="n">PREDMET</span> <span class="n">P</span>
<span class="k">SET</span>     <span class="n">BODOVI</span> <span class="o">=</span> <span class="n">BODOVI</span> <span class="o">+</span> <span class="mi">1</span> 
<span class="k">WHERE</span>   <span class="n">BODOVI</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">AND</span> 
        <span class="k">EXISTS</span> <span class="p">(</span>
            <span class="k">SELECT</span>  <span class="o">*</span>
            <span class="k">FROM</span>    <span class="n">ISPIT</span> <span class="n">I</span> 
            <span class="k">WHERE</span>   <span class="n">I</span><span class="p">.</span><span class="n">ID_PREDMETA</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">ID_PREDMETA</span> <span class="k">AND</span> 
                    <span class="n">OCENA</span> <span class="o">&gt;</span> <span class="mi">5</span>
                    <span class="k">AND</span> <span class="n">INDEKS</span> <span class="o">=</span> <span class="o">?</span>
        <span class="p">)</span>
</code></pre></div></div>

<h2 id="94-objektno-orijentisani-pristup-kreiranju-jdbc-aplikacija">9.4 Objektno-orijentisani pristup kreiranju JDBC aplikacija</h2>

<p>Do sada smo naše JDBC aplikacije pisali u proceduralnom stilu - metod <code class="language-plaintext highlighter-rouge">main()</code> nam je služio kao alat koji je izvršavao sve potrebne aktivnosti, kao što su: povezivanje na bazu podataka, kreiranje objekata naredbi, izvršavanje naredbi, procesiranje podataka, oslobađanje resursa i diskonekcija sa baze podataka.</p>

<p>Ovaj pristup nije problematičan prilikom kreiranja jednostavnih aplikacija kao što su to bile aplikacije koje smo videli do sada. Međutim, što se složenost aplikacije povećava, ovakav pristup postaje izuzetno naporan za održavanje - što je i jedna od najvećih mana proceduralne paradigme programiranja. Neke od rešenja ovih problema ćemo prikazati kroz naredni zadatak.</p>

<div class="ui stacked segment">
  <p><strong>Zadatak 9.6</strong>: Napisati Java program u kojem se SQL naredbe izvršavaju dinamički koji izdvaja studente po studijskim programima. Za svaki studijski program ispisati naziv obim u ESPB i zvanje, a zatim spisak studenata (indeks, ime i prezime) koji su upisali taj program. Zadatak uraditi korišćenjem objektno-orijentisanog pristupa dizajnu.</p>
</div>

<p>Rešenje: Jednan od osnovnih koncepata objektno-orijentisane paradigme je da jedna klasa treba da implementira jednu jezgrovitu funkcionalnost.</p>

<p>Za početak, možemo napisati po jednu klasu za svaku tabelu koja će se koristiti. U ovom slučaju to su tabele <code class="language-plaintext highlighter-rouge">STUDIJSKIPROGRAM</code> i <code class="language-plaintext highlighter-rouge">DOSIJE</code>, a odgovarajuće klase nazvaćemo <code class="language-plaintext highlighter-rouge">StudijskiProgram</code> i <code class="language-plaintext highlighter-rouge">Student</code>. Svaka klasa treba da sadrži polja koja odgovaraju nekoj od kolona tabele. Jedan objekat klase predstavlja jedan slog odgovarajuće tabele.</p>

<p>Potrebna nam je i klasa, na primer <code class="language-plaintext highlighter-rouge">Database</code>, koja implementira osnovne operacije za rad sa bazom. Zatim, ove funkcionalnosti možemo iskoristiti u implementaciji za rad sa bazom <code class="language-plaintext highlighter-rouge">STUD2020</code> tako što ćemo napisati posebnu klasu za ovu bazu, na primer <code class="language-plaintext highlighter-rouge">Stud2020</code>,  koja će naslediti klasu <code class="language-plaintext highlighter-rouge">Database</code>. U ovoj klasi implementiramo zahteve kao metode klase. Time dobijamo naredne klase:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_6/Database.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_9_6</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>

<span class="cm">/**
 * Database is the abstract base class for all database contexts which allow an
 * application to perform basic operations on a database, using the JDBC API.
 * 
 * In order to use this class, for each database, there needs to exists an
 * inherited class from this class. The inherited class needs to set the
 * following protected members in its constructor method: &lt;code&gt;dbName&lt;/code&gt;,
 * &lt;code&gt;url&lt;/code&gt;, &lt;code&gt;username&lt;/code&gt;, &lt;code&gt;password&lt;/code&gt;.
 */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Database</span> <span class="kd">implements</span> <span class="nc">AutoCloseable</span> <span class="o">{</span>
    <span class="cm">/**
     * The object which is used for keeping the resources used in a connection
     * to a database.
     */</span>
    <span class="kd">protected</span> <span class="nc">Connection</span> <span class="n">con</span><span class="o">;</span>

    <span class="cm">/**
     * The name of the database used for printing purposes.
     */</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="n">dbName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="cm">/**
     * The Type 4 JDBC URL used for connecting to a database.
     */</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="cm">/**
     * The user which is being used for connecting to a database and executing
     * the statements.
     */</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="cm">/**
     * The password for the specified user.
     */</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="cm">/**
     * The helper function for getting the name of a database.
     * 
     * @return the name of a database
     */</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dbName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * The helper function for getting the URL of a database.
     * 
     * @return the URL of a database
     */</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">getUrl</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">url</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * The helper function for getting the username of a database.
     * 
     * @return the username of a database
     */</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * The helper function for getting the password of a database user.
     * 
     * @return the password of a database user
     */</span>
    <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">getPassword</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Connects to a database using the information stored in the following
     * protected members: &lt;code&gt;url&lt;/code&gt;, &lt;code&gt;username&lt;/code&gt;,
     * &lt;code&gt;password&lt;/code&gt;. These members must be set in the constructor
     * method of inherited classes.
     * 
     * @throws SQLException
     *             If an SQL error occured while connecting to a database
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">con</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Povezivanje na "</span> <span class="o">+</span> <span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"..."</span><span class="o">);</span>
            <span class="n">con</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">getUrl</span><span class="o">(),</span> <span class="n">getUsername</span><span class="o">(),</span> <span class="n">getPassword</span><span class="o">());</span>
            <span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Uspesno je ostvarena konekcija!"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Disconnects from a previously connected database. Does nothing if the
     * connection does not exists.
     * 
     * @param successful
     *            whether to commit or rollback potential changes made to the
     *            database
     * @throws SQLException
     *             If an SQL error occured while disconnecting from a database
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">disconnect</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">successful</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">con</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">successful</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">commit</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">rollback</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">con</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Diskonektovano sa "</span> <span class="o">+</span> <span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"!"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Commits the potential changes made to the database. Ignores any SQL
     * errors that might occur.
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">con</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Sve izmene su pohranjene u bazi podataka "</span> <span class="o">+</span> <span class="n">getName</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Rolls back the potential changes made to the database. Ignores any SQL
     * errors that might occur.
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rollback</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">con</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Sve izmene su ponistene u bazi podataka "</span> <span class="o">+</span> <span class="n">getName</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Reads the SQL statement from the file located at the given pathname
     * &lt;code&gt;filename&lt;/code&gt;.
     * 
     * @param filename
     * @return
     * @throws IOException
     */</span>
    <span class="kd">protected</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">readSQLFromFile</span><span class="o">(</span><span class="nc">String</span> <span class="n">filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">StringBuilder</span> <span class="n">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">lines</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">filename</span><span class="o">)).</span><span class="na">forEach</span><span class="o">(</span><span class="n">linija</span> <span class="o">-&gt;</span> <span class="n">sql</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">linija</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Closes the connection.
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">con</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_6/Stud2020.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_9_6</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stud2020</span> <span class="kd">extends</span> <span class="nc">Database</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Stud2020</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="n">dbName</span> <span class="o">=</span> <span class="s">"STUD2020"</span><span class="o">;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"jdbc:db2://localhost:50000/stud2020"</span><span class="o">;</span>
        <span class="n">username</span> <span class="o">=</span> <span class="s">"student"</span><span class="o">;</span>
        <span class="n">password</span> <span class="o">=</span> <span class="s">"abcdef"</span><span class="o">;</span>
        <span class="n">connect</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">izlistajStudentePoStudijskimProgramima</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">readSQLFromFile</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.dir"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"/bin/zadatak_9_6/studijskiProgrami.sql"</span><span class="o">);</span>
        <span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
        <span class="nc">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">StudijskiProgram</span> <span class="n">sp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StudijskiProgram</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span> <span class="n">rs</span><span class="o">.</span><span class="na">getShort</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">4</span><span class="o">));</span>
            
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n"</span> <span class="o">+</span> <span class="n">sp</span><span class="o">);</span>
            
            <span class="n">izlistajStudenteStudijskogPrograma</span><span class="o">(</span><span class="n">sp</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">izlistajStudenteStudijskogPrograma</span><span class="o">(</span><span class="kt">int</span> <span class="n">idPrograma</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">readSQLFromFile</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.dir"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"/bin/zadatak_9_6/studentiStudijskogPrograma.sql"</span><span class="o">);</span>
        <span class="nc">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">stmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">idPrograma</span><span class="o">);</span>
        <span class="nc">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
        
        <span class="k">while</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Student</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\t"</span> <span class="o">+</span> <span class="n">student</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_6/StudijskiProgram.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_9_6</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudijskiProgram</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">naziv</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">short</span> <span class="n">obimespb</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="nc">String</span> <span class="n">zvanje</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">StudijskiProgram</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">naziv</span><span class="o">,</span> <span class="kt">short</span> <span class="n">obimespb</span><span class="o">,</span> <span class="nc">String</span> <span class="n">zvanje</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">naziv</span> <span class="o">=</span> <span class="n">naziv</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">obimespb</span> <span class="o">=</span> <span class="n">obimespb</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">zvanje</span> <span class="o">=</span> <span class="n">zvanje</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getNaziv</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">naziv</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNaziv</span><span class="o">(</span><span class="nc">String</span> <span class="n">naziv</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">naziv</span> <span class="o">=</span> <span class="n">naziv</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">short</span> <span class="nf">getObimespb</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">obimespb</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setObimespb</span><span class="o">(</span><span class="kt">short</span> <span class="n">obimespb</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">obimespb</span> <span class="o">=</span> <span class="n">obimespb</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getZvanje</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">zvanje</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setZvanje</span><span class="o">(</span><span class="nc">String</span> <span class="n">zvanje</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">zvanje</span> <span class="o">=</span> <span class="n">zvanje</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Naziv: "</span> <span class="o">+</span> <span class="n">naziv</span> <span class="o">+</span> <span class="s">", obim: "</span> <span class="o">+</span> <span class="n">obimespb</span> <span class="o">+</span> <span class="s">", zvanje: "</span> <span class="o">+</span> <span class="n">zvanje</span><span class="o">;</span>
    <span class="o">}</span>
    
<span class="o">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_6/Student.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_9_6</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">indeks</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">ime</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">prezime</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">Student</span><span class="o">(</span><span class="kt">int</span> <span class="n">indeks</span><span class="o">,</span> <span class="nc">String</span> <span class="n">ime</span><span class="o">,</span> <span class="nc">String</span> <span class="n">prezime</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">indeks</span> <span class="o">=</span> <span class="n">indeks</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ime</span> <span class="o">=</span> <span class="n">ime</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">prezime</span> <span class="o">=</span> <span class="n">prezime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getIndeks</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">indeks</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setIndeks</span><span class="o">(</span><span class="kt">int</span> <span class="n">indeks</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">indeks</span> <span class="o">=</span> <span class="n">indeks</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getIme</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setIme</span><span class="o">(</span><span class="nc">String</span> <span class="n">ime</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ime</span> <span class="o">=</span> <span class="n">ime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getPrezime</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">prezime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPrezime</span><span class="o">(</span><span class="nc">String</span> <span class="n">prezime</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">prezime</span> <span class="o">=</span> <span class="n">prezime</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">indeks</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">ime</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">prezime</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_6/Main.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_9_6</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.ibm.db2.jcc.DB2Driver"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="k">try</span> <span class="o">(</span><span class="nc">Stud2020</span> <span class="n">stud2020</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Stud2020</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">stud2020</span><span class="o">.</span><span class="na">izlistajStudentePoStudijskimProgramima</span><span class="o">();</span>
            <span class="n">stud2020</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SQLCODE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span> <span class="s">"SQLSTATE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getSQLState</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span>
                    <span class="o">+</span> <span class="s">"PORUKA: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Doslo je do neke greske: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="o">}</span>


    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>Naredne SQL datoteke sadrže odgovarajuće naredbe:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_6/studijskiProgrami.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">ID</span><span class="p">,</span>
        <span class="n">NAZIV</span><span class="p">,</span>
        <span class="n">OBIMESPB</span><span class="p">,</span>
        <span class="n">ZVANJE</span>
<span class="k">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">STUDIJSKIPROGRAM</span><span class="p">;</span>
       
</code></pre></div></div>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_6/studentiStudijskogPrograma.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="n">INDEKS</span><span class="p">,</span>
        <span class="n">IME</span><span class="p">,</span>
        <span class="n">PREZIME</span>
<span class="k">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">DOSIJE</span>
<span class="k">WHERE</span>   <span class="n">IDPROGRAMA</span> <span class="o">=</span> <span class="o">?</span>
</code></pre></div></div>

<h2 id="95-zadaci-za-vežbu">9.5 Zadaci za vežbu</h2>

<div class="ui stacked segment">
  <p><strong>Zadatak 9.7</strong>: Napisati Java program u kojem se SQL naredbe izvršavaju dinamički koji ima mogućnost da upravlja podacima o statistikama upisanih kurseva. Kreirati klasu <code class="language-plaintext highlighter-rouge">Main.java</code>. U toj klasi implementirati naredne metode nad datim bazama podataka. Nije dozvoljeno menjati potpise metoda; jedino je moguće dodavati izuzetke koje oni ispaljuju. Nije dozvoljeno implementirati opisane operacije van tela metoda (ali je moguće koristiti pomoćne metode):</p>

  <p>(a) Napisati metod <code class="language-plaintext highlighter-rouge">private static ArrayList&lt;Predmet&gt; aPronadjiSvePredmete(Connection con, String upitZaNaziv) throws SQLException</code> koji pronalazi identifikatore i nazive svih predmeta čiji naziv predmeta počinje niskom <code class="language-plaintext highlighter-rouge">upitZaNaziv</code>. Implementirati klasu <code class="language-plaintext highlighter-rouge">Predmet</code> koja ima dva polja koja predstavljaju identifikator i naziv predmeta. Metod vraća listu instanci ove klase.</p>

  <p>(b) Napisati metod <code class="language-plaintext highlighter-rouge">private static ArrayList&lt;Predmet&gt; bIzdvojiPredmeteKojiIspunjavajuUslov(Connection con, ArrayList&lt;Predmet&gt; predmeti) throws SQLException</code> koji od date liste predmeta <code class="language-plaintext highlighter-rouge">predmeti</code> izdvaja samo one predmete koji zadovoljavaju naredna dva uslova:</p>
  <ul>
    <li>Predmet mora da ima studente koji su ga upisali.</li>
    <li>Predmet mora da se ne nalazi u tabeli <code class="language-plaintext highlighter-rouge">STATISTIKAUPISANIHKURSEVA</code>.
Dopustiti da aplikacija može da vidi nepotvrđene izmene drugih aplikacija prilikom provere datih uslova.</li>
  </ul>

  <p>(c) Napisati metod <code class="language-plaintext highlighter-rouge">private static void cObradiPredmete(Connection con, ArrayList&lt;Predmet&gt; predmeti) throws SQLException</code> koji izdvaja naredne informacije: (1) identifikator predmeta, (2) školsku godinu, (3) broj studenata koji su upisali taj predmet u toj godini, (4) broj polaganja tog predmeta u toj godini, ali samo za one predmete koji zadovoljavaju uslove iz metoda pod (b). Ove informacije je potrebno ispisati na standardni izlaz, a zatim uneti u tabelu <code class="language-plaintext highlighter-rouge">STATISTIKAUPISANIHKURSEVA</code> metodom pod (d). Samo u ovom metodu proveravati greške koje se javljaju prilikom izvršavanja aplikacije u višekorisničkom okruženju. Postaviti istek vremena na 5 sekundi. Obrada jednog predmeta (ispis + unos) mora da predstavlja jednu transakciju. Omogućiti da nijedna druga aplikacija ne sme čitati ili menjati podatke tokom obrade predmeta u ovom metodu.</p>

  <p>(d) Napisati metod <code class="language-plaintext highlighter-rouge">private static void dUnesiNovuStatistiku(Connection con, int idPredmeta, short godina, Integer brojStudenata, Integer brojPolaganja) throws SQLException</code> koji unosi novi slog u tabelu <code class="language-plaintext highlighter-rouge">STATISTIKAUPISANIHKURSEVA</code> na osnovu argumenata koji mu se prosleđuju. Za kolonu <code class="language-plaintext highlighter-rouge">PONISTENI</code> postaviti vrednost <code class="language-plaintext highlighter-rouge">0</code>.</p>

  <p>(e) Napisati metod <code class="language-plaintext highlighter-rouge">private static void ePonistiStatistike(Connection con, short godina, Scanner ulaz) throws SQLException</code> koji ponistava sve statistike (tj. postavlja kolonu <code class="language-plaintext highlighter-rouge">PONISTENI</code> na vrednost <code class="language-plaintext highlighter-rouge">1</code>) iz tabele <code class="language-plaintext highlighter-rouge">STATISTIKAUPISANIHKURSEVA</code> za one statistike iz godine koja se prosleđuje kao argument metoda. Poništavanje svih statistika za datu godinu predstavlja jednu transakciju. Međutim, potrebno je omogućiti da se nakon izmene jednog sloga korisnik pita da potvrdi izmene. Ukoliko ipak želi da odustane od izmene tekuće statistike, omogućiti poništavanje samo poslednje izmenjene statistike.</p>

  <p>(f) Napisati metod <code class="language-plaintext highlighter-rouge">private static void fObrisiStatistike(Connection con) throws SQLException</code> koji briše sve poništene statistike iz tabele <code class="language-plaintext highlighter-rouge">STATISTIKAUPISANIHKURSEVA</code>. Za svaki slog je neophodno ispisati na standardni izlaz identifikator predmeta za slog koji se briše, a zatim se izvršava brisanje tog sloga. Brisanje svih poništenih statistika predstavlja jednu transakciju.</p>

  <p>(g) Napisati metod <code class="language-plaintext highlighter-rouge">private static void gPrikaziStatistike(Connection con) throws SQLException</code> koji ispisuje informacije iz tabele <code class="language-plaintext highlighter-rouge">STATISTIKAUPISANIHKURSEVA</code>. Sortirati ispis po identifikatoru predmeta rastuće.</p>

  <p>Aplikacija omogućava korisniku da odabere jednu od narednih 5 opcija. Svaki put kada se opcija završi (osim u slučaju opcije 5), aplikacija ponovo zahteva od korisnika da unese jednu od narednih opcija:</p>
  <ol>
    <li><code class="language-plaintext highlighter-rouge">unos</code>: Aplikacija zahteva od korisnika da unese upit za naziv predmeta. Nakon unosa, aplikacija metodom pod (a) pronalazi sve kandidate. Zatim ispisuje sve predmete metodom pod (b). Nakon toga, vrši se obrada metodom pod (c).</li>
    <li><code class="language-plaintext highlighter-rouge">ponistavanje</code>: Aplikacija zahteva od korisnika da unese godinu studija. Zatim se metodom pod (e) vrši poništavanje statistika.</li>
    <li><code class="language-plaintext highlighter-rouge">brisanje</code>: Aplikacija izvršava metod pod (f).</li>
    <li><code class="language-plaintext highlighter-rouge">prikazivanje</code>: Aplikacija izvršava metod pod (g).</li>
    <li><code class="language-plaintext highlighter-rouge">dalje</code>: Aplikacija zahteva od korisnika da unese ocenu i poziva metod pod (h). Nakon toga, aplikacija se završava.</li>
  </ol>
</div>

<p>Rešenje: Pre pokretanja programa, potrebno je pripremiti bazu <code class="language-plaintext highlighter-rouge">STUD2020</code> izvršavanjem narednog skripta nad tom BP:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_7/pripremaBaze.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">STATISTIKAUPISANIHKURSEVA</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">STATISTIKAUPISANIHKURSEVA</span> <span class="p">(</span>
    <span class="n">IDPREDMETA</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">SKGODINA</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">BROJSTUDENATA</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">BROJPOLAGANJA</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">PONISTENI</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">IDPREDMETA</span><span class="p">,</span> <span class="n">SKGODINA</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">FK_PREDMET</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">IDPREDMETA</span><span class="p">)</span>
        <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span> <span class="p">(</span><span class="n">ID</span><span class="p">)</span>
        <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
<span class="p">);</span>
</code></pre></div></div>

<p>Implementacija rešenja se nalazi u narednim datotekama:</p>

<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_7/Main.java</code></strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">zadatak_9_7</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.ibm.db2.jcc.DB2Driver"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Predmet</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="n">idPredmeta</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="n">naziv</span><span class="o">;</span>
        
        <span class="kd">public</span> <span class="nf">Predmet</span><span class="o">(</span><span class="kt">int</span> <span class="n">idPredmeta</span><span class="o">,</span> <span class="nc">String</span> <span class="n">naziv</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">idPredmeta</span> <span class="o">=</span> <span class="n">idPredmeta</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">naziv</span> <span class="o">=</span> <span class="n">naziv</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"jdbc:db2://localhost:50000/stud2020"</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">(</span>
            <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="s">"student"</span><span class="o">,</span> <span class="s">"abcdef"</span><span class="o">);</span>
        <span class="o">)</span> <span class="o">{</span>
            <span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

            <span class="k">try</span> <span class="o">(</span><span class="nc">Scanner</span> <span class="n">ulaz</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Odaberite jednu od narednih opcija: "</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  1. unos"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  2. ponistavanje"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  3. brisanje"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  4. prikazivanje"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  5. dalje"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Vas unos: "</span><span class="o">);</span>
                    <span class="nc">String</span> <span class="n">odgovor</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"----------------------------------------"</span><span class="o">);</span>
                    
                    <span class="k">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"unos"</span><span class="o">))</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Unesite naziv predmeta: "</span><span class="o">);</span>
                        <span class="nc">String</span> <span class="n">naziv</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                        
                        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Predmet</span><span class="o">&gt;</span> <span class="n">predmeti</span> <span class="o">=</span> <span class="n">aPronadjiSvePredmete</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">naziv</span><span class="o">);</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Pronadjeni predmeti su: "</span><span class="o">);</span>
                        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Predmet</span><span class="o">&gt;</span> <span class="n">odabraniPredmeti</span> <span class="o">=</span> <span class="n">bIzdvojiPredmeteKojiIspunjavajuUslov</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">predmeti</span><span class="o">);</span>
                        <span class="n">cObradiPredmete</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">odabraniPredmeti</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"ponistavanje"</span><span class="o">))</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Unesite godinu studija: "</span><span class="o">);</span>
                        <span class="kt">short</span> <span class="n">godina</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">nextShort</span><span class="o">();</span>
                        <span class="n">ulaz</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span> <span class="c1">// '\n'</span>
                        <span class="n">ePonistiStatistike</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">godina</span><span class="o">,</span> <span class="n">ulaz</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"brisanje"</span><span class="o">))</span> <span class="o">{</span>                        
                        <span class="n">fObrisiStatistike</span><span class="o">(</span><span class="n">con</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"prikazivanje"</span><span class="o">))</span> <span class="o">{</span>                        
                        <span class="n">gPrikaziStatistike</span><span class="o">(</span><span class="n">con</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"dalje"</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">"Odabrali ste nepostojecu opciju: "</span> <span class="o">+</span> <span class="n">odgovor</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                
                <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> 
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SQLCODE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span> <span class="s">"SQLSTATE: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getSQLState</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span>
                    <span class="o">+</span> <span class="s">"PORUKA: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Doslo je do neke greske: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Predmet</span><span class="o">&gt;</span> <span class="nf">aPronadjiSvePredmete</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">String</span> <span class="n">upitZaNaziv</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Predmet</span><span class="o">&gt;</span> <span class="n">predmeti</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT ID, TRIM(NAZIV) FROM DA.PREDMET WHERE NAZIV LIKE ?"</span><span class="o">;</span>
        
        <span class="nc">PreparedStatement</span> <span class="n">pStmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">upitZaNaziv</span> <span class="o">+=</span> <span class="s">"%"</span><span class="o">;</span>
        <span class="n">pStmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">upitZaNaziv</span><span class="o">);</span>
        <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">pStmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
        
        <span class="k">while</span> <span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">idPredmeta</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">naziv</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
            <span class="n">predmeti</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Predmet</span><span class="o">(</span><span class="n">idPredmeta</span><span class="o">,</span> <span class="n">naziv</span><span class="o">));</span>
        <span class="o">}</span>
        
        <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">pStmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        
        <span class="k">return</span> <span class="n">predmeti</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Predmet</span><span class="o">&gt;</span> <span class="nf">bIzdvojiPredmeteKojiIspunjavajuUslov</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span>
            <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Predmet</span><span class="o">&gt;</span> <span class="n">predmeti</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Predmet</span><span class="o">&gt;</span> <span class="n">izdvojeniPredmeti</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">ucitajSqlIzDatoteke</span><span class="o">(</span><span class="s">"izdvajanjePredmetaSaUslovom.sql"</span><span class="o">);</span>
        <span class="nc">PreparedStatement</span> <span class="n">pStmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        
        <span class="k">for</span> <span class="o">(</span><span class="nc">Predmet</span> <span class="n">predmet</span> <span class="o">:</span> <span class="n">predmeti</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pStmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">predmet</span><span class="o">.</span><span class="na">idPredmeta</span><span class="o">);</span>
            <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">pStmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
            
            <span class="kt">boolean</span> <span class="n">imaRedova</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">imaRedova</span> <span class="o">||</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  Za predmet "</span> <span class="o">+</span> <span class="n">predmet</span><span class="o">.</span><span class="na">naziv</span> <span class="o">+</span> <span class="s">" sa identifikatorom "</span> <span class="o">+</span> <span class="n">predmet</span><span class="o">.</span><span class="na">idPredmeta</span> <span class="o">+</span> <span class="s">" nema studenata koji su ga upisali"</span><span class="o">);</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            
            <span class="kt">int</span> <span class="n">brojUpisanih</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  Predmet "</span> <span class="o">+</span> <span class="n">predmet</span><span class="o">.</span><span class="na">naziv</span> <span class="o">+</span> <span class="s">" sa identifikatorom "</span> <span class="o">+</span> <span class="n">predmet</span><span class="o">.</span><span class="na">idPredmeta</span> <span class="o">+</span> <span class="s">" je upisalo "</span> <span class="o">+</span> <span class="n">brojUpisanih</span> <span class="o">+</span> <span class="s">" student/studenata"</span><span class="o">);</span>
            <span class="n">izdvojeniPredmeti</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">predmet</span><span class="o">);</span>
            
            <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
        
        <span class="n">pStmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        
        <span class="k">return</span> <span class="n">izdvojeniPredmeti</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">cObradiPredmete</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Predmet</span><span class="o">&gt;</span> <span class="n">predmeti</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">ucitajSqlIzDatoteke</span><span class="o">(</span><span class="s">"statistika.sql"</span><span class="o">);</span>
        <span class="nc">PreparedStatement</span> <span class="n">pStmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        
        <span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
        <span class="n">stmt</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"SET CURRENT LOCK TIMEOUT 5"</span><span class="o">);</span>
        
        <span class="k">for</span> <span class="o">(</span><span class="nc">Predmet</span> <span class="n">predmet</span> <span class="o">:</span> <span class="n">predmeti</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pStmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">predmet</span><span class="o">.</span><span class="na">idPredmeta</span><span class="o">);</span>
            <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">pStmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
            
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// BEGIN visekorisnicko</span>
                    <span class="kt">boolean</span> <span class="n">imaRedova</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">imaRedova</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    
                    <span class="kt">int</span> <span class="n">idPredmeta</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="kt">short</span> <span class="n">godina</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getShort</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span> 
                    <span class="kt">int</span> <span class="n">brojStudenata</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
                    <span class="kt">boolean</span> <span class="n">brojStNull</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">wasNull</span><span class="o">();</span>
                    <span class="kt">int</span> <span class="n">brojPolaganja</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
                    <span class="kt">boolean</span> <span class="n">brojPolNull</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">wasNull</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  Unosim informacije: "</span> <span class="o">+</span> <span class="n">idPredmeta</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">godina</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">brojStudenata</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">brojPolaganja</span><span class="o">);</span>
                    
                    <span class="n">dUnesiNovuStatistiku</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">idPredmeta</span><span class="o">,</span> <span class="n">godina</span><span class="o">,</span> <span class="n">brojStNull</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">brojStudenata</span><span class="o">,</span> <span class="n">brojPolNull</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">brojPolaganja</span><span class="o">);</span>
                    
                    <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
                    <span class="c1">// END visekorisnicko</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(-</span><span class="mi">913</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">911</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                        <span class="n">kursor</span> <span class="o">=</span> <span class="n">obradiCekanje</span><span class="o">(</span><span class="n">con</span><span class="o">,</span> <span class="n">stmt</span><span class="o">,</span> <span class="n">sql</span><span class="o">);</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="c1">// Vrati podrazumevanu vrednost za istek vremena, oslobodi resurse </span>
                    <span class="c1">// i prosledi izuzetak main() metodi za obradu</span>
                    <span class="n">stmt</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"SET CURRENT LOCK TIMEOUT NULL"</span><span class="o">);</span>
                    
                    <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                    <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                    <span class="n">pStmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                    
                    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            
            <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
        
        <span class="n">stmt</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"SET CURRENT LOCK TIMEOUT NULL"</span><span class="o">);</span>
        
        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">pStmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">dUnesiNovuStatistiku</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="kt">int</span> <span class="n">idPredmeta</span><span class="o">,</span> <span class="kt">short</span> <span class="n">godina</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">brojStudenata</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">brojPolaganja</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"INSERT INTO DA.STATISTIKAUPISANIHKURSEVA VALUES (?, ?, ?, ?, 0)"</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">pStmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        
        <span class="n">pStmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">idPredmeta</span><span class="o">);</span>
        <span class="n">pStmt</span><span class="o">.</span><span class="na">setShort</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">godina</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">brojStudenata</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pStmt</span><span class="o">.</span><span class="na">setNull</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">Types</span><span class="o">.</span><span class="na">INTEGER</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">pStmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">brojStudenata</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">brojPolaganja</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pStmt</span><span class="o">.</span><span class="na">setNull</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">Types</span><span class="o">.</span><span class="na">INTEGER</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">pStmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="n">brojPolaganja</span><span class="o">);</span>
        <span class="o">}</span>
        
        <span class="n">pStmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
        <span class="n">pStmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">ePonistiStatistike</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="kt">short</span> <span class="n">godina</span><span class="o">,</span> <span class="nc">Scanner</span> <span class="n">ulaz</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT * FROM DA.STATISTIKAUPISANIHKURSEVA WHERE SKGODINA = ?"</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">pStmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="nc">ResultSet</span><span class="o">.</span><span class="na">TYPE_FORWARD_ONLY</span><span class="o">,</span> <span class="nc">ResultSet</span><span class="o">.</span><span class="na">CONCUR_UPDATABLE</span><span class="o">);</span>
        <span class="n">pStmt</span><span class="o">.</span><span class="na">setShort</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">godina</span><span class="o">);</span>
        <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">pStmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
        
        <span class="k">while</span> <span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Savepoint</span> <span class="n">s</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">setSavepoint</span><span class="o">();</span>
            
            <span class="kt">int</span> <span class="n">idPredmeta</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="n">kursor</span><span class="o">.</span><span class="na">updateShort</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span><span class="mi">1</span><span class="o">);</span>
            <span class="n">kursor</span><span class="o">.</span><span class="na">updateRow</span><span class="o">();</span>
            
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  Da li ste sigurni da zelite da ponistite podatke o predmetu sa identifikatorom "</span> <span class="o">+</span> <span class="n">idPredmeta</span> <span class="o">+</span> <span class="s">" u odabranoj godini "</span> <span class="o">+</span> <span class="n">godina</span> <span class="o">+</span> <span class="s">"? [da/ne]"</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">odgovor</span> <span class="o">=</span> <span class="n">ulaz</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"ne"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">odgovor</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"da"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">con</span><span class="o">.</span><span class="na">releaseSavepoint</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">"Uneli ste neispravan odgovor: "</span> <span class="o">+</span> <span class="n">odgovor</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">pStmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        
        <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">fObrisiStatistike</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT * FROM DA.STATISTIKAUPISANIHKURSEVA WHERE PONISTENI = 0"</span><span class="o">;</span>
        <span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">(</span><span class="nc">ResultSet</span><span class="o">.</span><span class="na">TYPE_FORWARD_ONLY</span><span class="o">,</span> <span class="nc">ResultSet</span><span class="o">.</span><span class="na">CONCUR_UPDATABLE</span><span class="o">);</span>
        <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        
        <span class="k">while</span> <span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">idPredmeta</span> <span class="o">=</span> <span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  Brisem podatke o predmetu sa identifikatorom "</span> <span class="o">+</span> <span class="n">idPredmeta</span> <span class="o">+</span> <span class="s">" u odabranoj godini"</span><span class="o">);</span>
            <span class="n">kursor</span><span class="o">.</span><span class="na">deleteRow</span><span class="o">();</span>
        <span class="o">}</span>
        
        <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        
        <span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">gPrikaziStatistike</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT * FROM DA.STATISTIKAUPISANIHKURSEVA ORDER BY IDPREDMETA"</span><span class="o">;</span>
        <span class="nc">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
        <span class="nc">ResultSet</span> <span class="n">kursor</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"+--------------------------------------------------------------------+"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"| ID PREDMETA | GODINA | BROJ STUDENATA | BROJ POLAGANJA | PONISTENO |"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"|-------------+--------+----------------+----------------+-----------|"</span><span class="o">);</span>
        
        <span class="k">while</span> <span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">idPredmeta</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
            <span class="nc">String</span> <span class="n">godina</span> <span class="o">=</span> <span class="nc">Short</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">getShort</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span> 
            <span class="nc">String</span> <span class="n">brojStudenata</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
            <span class="k">if</span><span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">wasNull</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">brojStudenata</span> <span class="o">=</span> <span class="s">"NULL          "</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">String</span> <span class="n">brojPolaganja</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">4</span><span class="o">));</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">wasNull</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">brojPolaganja</span> <span class="o">=</span> <span class="s">"NULL          "</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">String</span> <span class="n">ponisteni</span> <span class="o">=</span> <span class="s">"FALSE    "</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">kursor</span><span class="o">.</span><span class="na">getShort</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ponisteni</span> <span class="o">=</span> <span class="s">"TRUE     "</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"| %s%s | %s   | %s%s | %s%s | %s |\n"</span><span class="o">,</span>
                    <span class="n">idPredmeta</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="mi">11</span> <span class="o">-</span> <span class="n">idPredmeta</span><span class="o">.</span><span class="na">length</span><span class="o">()]).</span><span class="na">replace</span><span class="o">(</span><span class="s">"\0"</span><span class="o">,</span> <span class="s">" "</span><span class="o">),</span> 
                    <span class="n">godina</span><span class="o">,</span> <span class="n">brojStudenata</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="mi">14</span> <span class="o">-</span> <span class="n">brojStudenata</span><span class="o">.</span><span class="na">length</span><span class="o">()]).</span><span class="na">replace</span><span class="o">(</span><span class="s">"\0"</span><span class="o">,</span> <span class="s">" "</span><span class="o">),</span>
                    <span class="n">brojPolaganja</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="mi">14</span> <span class="o">-</span> <span class="n">brojPolaganja</span><span class="o">.</span><span class="na">length</span><span class="o">()]).</span><span class="na">replace</span><span class="o">(</span><span class="s">"\0"</span><span class="o">,</span> <span class="s">" "</span><span class="o">),</span>
                    <span class="n">ponisteni</span><span class="o">);</span>
        <span class="o">}</span>
        
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"|-------------+--------+----------------+----------------+-----------|"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"+--------------------------------------------------------------------+"</span><span class="o">);</span>
        
        <span class="n">kursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">ucitajSqlIzDatoteke</span><span class="o">(</span><span class="nc">String</span> <span class="n">nazivDatoteke</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">StringBuilder</span> <span class="n">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">lines</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.dir"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"/bin/zadatak_9_7/"</span> <span class="o">+</span> <span class="n">nazivDatoteke</span><span class="o">))</span>
            <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">linija</span> <span class="o">-&gt;</span> <span class="n">sql</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">linija</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ResultSet</span> <span class="nf">obradiCekanje</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="nc">Statement</span> <span class="n">stmt</span><span class="o">,</span> <span class="nc">String</span> <span class="n">sql</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Objekat je zakljucan od strane druge transakcije! Molimo sacekajte..."</span><span class="o">);</span>
        
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
        
        <span class="k">return</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>
<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_7/izdvajanjePredmetaSaUslovom.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span>    <span class="n">DA</span><span class="p">.</span><span class="n">UPISANKURS</span> <span class="n">UK</span> <span class="k">JOIN</span>
        <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span> <span class="n">P</span> <span class="k">ON</span> <span class="n">P</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">UK</span><span class="p">.</span><span class="n">IDPREDMETA</span> 
<span class="k">WHERE</span>   <span class="n">P</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="o">?</span> <span class="k">AND</span>
        <span class="n">P</span><span class="p">.</span><span class="n">ID</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">IDPREDMETA</span> <span class="k">FROM</span> <span class="n">DA</span><span class="p">.</span><span class="n">STATISTIKAUPISANIHKURSEVA</span><span class="p">)</span> 
<span class="k">WITH</span>    <span class="n">UR</span>
</code></pre></div></div>
<p><strong>Datoteka: <code class="language-plaintext highlighter-rouge">vezbe/primeri/poglavlje_9/src/zadatak_9_7/statistika.sql</code></strong>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">BROJPOLAGANJAPREDMETA</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>      <span class="n">IDPREDMETA</span><span class="p">,</span>
                <span class="n">SKGODINA</span><span class="p">,</span>
                <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">BROJPOLAGANJA</span>
    <span class="k">FROM</span>        <span class="n">DA</span><span class="p">.</span><span class="n">ISPIT</span>
    <span class="k">GROUP</span> <span class="k">BY</span>    <span class="n">IDPREDMETA</span><span class="p">,</span>
                <span class="n">SKGODINA</span>
<span class="p">)</span>
<span class="k">SELECT</span>      <span class="n">UK</span><span class="p">.</span><span class="n">IDPREDMETA</span><span class="p">,</span>
            <span class="n">UK</span><span class="p">.</span><span class="n">SKGODINA</span><span class="p">,</span>
            <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">BROJUPISANIH</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="k">SELECT</span>  <span class="n">BROJPOLAGANJA</span> 
                <span class="k">FROM</span>    <span class="n">BROJPOLAGANJAPREDMETA</span> <span class="n">BPP</span> 
                <span class="k">WHERE</span>   <span class="n">UK</span><span class="p">.</span><span class="n">IDPREDMETA</span> <span class="o">=</span> <span class="n">BPP</span><span class="p">.</span><span class="n">IDPREDMETA</span> <span class="k">AND</span>
                        <span class="n">UK</span><span class="p">.</span><span class="n">SKGODINA</span> <span class="o">=</span> <span class="n">BPP</span><span class="p">.</span><span class="n">SKGODINA</span>
            <span class="p">)</span> <span class="n">BROJPOLAGANJA</span> 
<span class="k">FROM</span>        <span class="n">DA</span><span class="p">.</span><span class="n">UPISANKURS</span> <span class="n">UK</span>
<span class="k">WHERE</span>       <span class="n">UK</span><span class="p">.</span><span class="n">IDPREDMETA</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">GROUP</span> <span class="k">BY</span>    <span class="n">UK</span><span class="p">.</span><span class="n">IDPREDMETA</span><span class="p">,</span>
            <span class="n">UK</span><span class="p">.</span><span class="n">SKGODINA</span>
<span class="k">WITH</span>        <span class="n">RR</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 9.8</strong>: Napisati Java program u kojem se SQL naredbe izvršavaju dinamički koji za sve ispitne rokove pronalazi položene predmet u tom ispitnom roku Za svaki predmet program pronalazi koliko je kojih ocena postignuto i te podatke unosi u tabelu <code class="language-plaintext highlighter-rouge">ISPITNIROKOVIPOLAGANJA</code>. Kreirati datu tabelu na osnovu SQL koda ispod.</p>

  <p>Pre jednog unosa podataka ispisati podatke koji ce biti uneti. Takođe, omogućiti da se podaci unose tako što korisnik mora da odobri unos podataka na svakih 20 redova (tzv. <em>batch</em> unos podataka). Napisati program tako da može da radi u višekorisničkom okruženju. Unos podataka za jedno polaganje predstavlja jednu transakciju. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi. Obraditi sve moguće greške.</p>

  <p>SQL naredbe za kreiranje i brisanje tabele sačuvati u datotekama 2a.sql i 2b.sql, redom, a <code class="language-plaintext highlighter-rouge">SELECT</code> naredbu kojim se izdvajaju potrebni podaci sačuvati u datoteci 2c.sql.</p>
</div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROKOVIPOLAGANJA</span> <span class="p">(</span>
    <span class="n">GODINA</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">OZNAKA</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">IDPREDMETA</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">OCENA</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">BROJ</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">NAZIVROKA</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
    <span class="n">NAZIVPREDMETA</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">GODINA</span><span class="p">,</span> <span class="n">OZNAKA</span><span class="p">,</span> <span class="n">IDPREDMETA</span><span class="p">,</span> <span class="n">OCENA</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">FK_PREDMET</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">IDPREDMETA</span><span class="p">)</span>
        <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">PREDMET</span> <span class="p">(</span><span class="n">ID</span><span class="p">)</span>
        <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">FK_IR</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">GODINA</span><span class="p">,</span> <span class="n">OZNAKA</span><span class="p">)</span>
        <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROK</span> <span class="p">(</span><span class="n">SKGODINA</span><span class="p">,</span> <span class="n">OZNAKAROKA</span><span class="p">)</span>
        <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Pomoć pri rešavanju zadatka: Kreirati tabelu <code class="language-plaintext highlighter-rouge">OBRADJENAPOLAGANJA</code> na osnovu SQL koda ispod koja će sadržati informacije o već obrađenim polaganjima iz tabele <code class="language-plaintext highlighter-rouge">ISPITNIROKOVIPOLAGANJA</code>. Nakon svake obrade jednog polaganja, uneti novi red u ovu tabelu i potvrditi izmene.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">OBRADJENAPOLAGANJA</span> <span class="p">(</span>
    <span class="n">GODINA</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">OZNAKA</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">IDPREDMETA</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">OCENA</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">GODINA</span><span class="p">,</span> <span class="n">OZNAKA</span><span class="p">,</span> <span class="n">IDPREDMETA</span><span class="p">,</span> <span class="n">OCENA</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">FK_POLAGANJA</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">GODINA</span><span class="p">,</span> <span class="n">OZNAKA</span><span class="p">,</span> <span class="n">IDPREDMETA</span><span class="p">,</span> <span class="n">OCENA</span><span class="p">)</span> 
        <span class="k">REFERENCES</span> <span class="n">DA</span><span class="p">.</span><span class="n">ISPITNIROKOVIPOLAGANJA</span>
        <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="ui stacked segment">
  <p><strong>Zadatak 9.9</strong>: Napisati Java program u kojem se SQL naredbe izvršavaju dinamički koji redom:</p>

  <ol>
    <li>Naredbama <code class="language-plaintext highlighter-rouge">INSERT</code> unosi podatke o nekoliko stipendija u tabelu <code class="language-plaintext highlighter-rouge">STIPENDIJA</code>. Izračunati i broj unetih redova. U slučaju da je broj unetih redova jednak nuli, ispisati poruku ”Nijedan red nije dodat”, a inače ispisati poruku u unetom broju redova. Kreirati datu tabelu na osnovu SQL koda ispod.</li>
    <li>Za svaku stipendiju, pita korisnika da li želi da promeni broj studenata za tu stipendiju i ukoliko je odgovor korisnika potvrdan, od korisnika traži da unese novi broj studenata i izvršava odgovarajuću naredbu.</li>
    <li>Za svaku stipendiju, pita korisnika da li želi da obriše tu stipendiju i ukoliko je odgovor korisnika potvrdan, izvršava odgovarajuću naredbu.</li>
  </ol>

  <p>Aplikacija treba da radi u višekorisničkom okruženju. Obrada jedne stipendije u svim zahtevima treba da predstavlja jednu transakciju. Postaviti istek vremena na 5 sekundi.</p>
</div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">STIPENDIJA</span> <span class="p">(</span>
    <span class="n">ID</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">NAZIV</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">GODINA</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">BROJSTIPENDISTA</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">VISINASTIPENDIJE</span> <span class="nb">SMALLINT</span><span class="p">,</span>
    <span class="n">MINPROSEK</span> <span class="nb">FLOAT</span><span class="p">,</span>
    <span class="n">NAPOMENA</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">ID</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

        </div>
    </div>

    <script>
        $('#pageSticky').sticky({
            context: '#pageContent'
        });

        $('#pageSticky').click(function () {
            $('#sideMenu').sidebar('toggle');
        });
    </script>
</body>

</html>